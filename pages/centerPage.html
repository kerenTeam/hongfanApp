<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>个人主页</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no"> 
		<!--<link rel="stylesheet" type="text/css" href="../css/common.css">-->
		<link rel="stylesheet" type="text/css" href="../css/index.css">
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<link rel="stylesheet" href="../css/reset.css">
		<link rel="stylesheet" href="../css/one.css">
		<link rel="stylesheet" href="../css/fontello.css">
		<link rel="stylesheet" type="text/css" href="../css/find.css" />
		<script type="text/javascript" src="../js/jquery.min.js"></script>
		<script src="../js/mui.min.js"></script>
		<script src="../js/app.js"></script>
		<script src="../js/artTemplate-native.js"></script>
		<style type="text/css">
			#upload img{width: .35rem;}
		</style>
	</head>
	<style type="text/css">
		.subActive{
			color: red!important;
		}
		#imgUpload {
			display: none;
		}
		.demo-icon{ 
		    font-size: 20px; 
		    position: relative;
		    top: -14px;
		}
		#header>*{
			color: white;
		} 
		#userBox{
				background-color: #F53C42;
				padding: 0px 0;
			    position: relative;
			    overflow: hidden;max-height: 2.5rem;
		}
		#mypic1{width: 100%;margin-top: -20%;}
		#beijing2{position: absolute;z-index:1;width: 100%;height: 100%;top: 0;background-color: rgba(255, 0, 0, 0.5);} 
		 
		.userAvator{
			border: 2px solid white;
			position: absolute;
			left: 50%;
			width: 1rem; 
			bottom: 0.5rem;
			height: 1rem; 
			-webkit-transform: translateX(-50%);
			z-index: 9;
			border-radius: 50%;
		}
		.mainInfo{ 
			position: relative;
			padding: 16px 10px 16px 15px;
			display: flex;
			align-items: center;
			justify-content: space-between;
		} 
		 .mainInfo:after{
		 	position: absolute;
		 	content: '';
		 	height: 1px;
		 	left: 10px;
		 	right: 10px;
			-webkit-transform: scaleY(.3);
			background: #C5C6C8;
			bottom: 0;
		 }
		.mainInfo button{
			font-size: 0.12rem;
			padding: 4px 8px;
		}
		.follow{
			background-color: white;
			margin: 15px 0;
			margin-bottom: 10px;
			text-align: center;
			display: flex;
			align-items: center;
			height: 60px;
			line-height: 1.5;
			justify-content: space-around;
		}
		.follow>div{
			flex-grow:1;
		}
		.fchidl b{
			font-weight: 100;
			font-size: .16rem;
		}
		.fchidl>div{
			color: darkgray;
		}
		.chidlL{
			border-right: 1px solid #EEEEEE;
		}
		.fft{
			margin: 0;
		}
		
		
		.mui-bar-tab a{
			color: #666; 
			display: table-cell;
			vertical-align: bottom;
			text-align: center;
		}
		.idhiji{
			position: absolute;
			text-align: center;
			bottom: 0.2rem;
			width: 100%;
			color: white;
			z-index: 1;
		}
		.tiename{color: #888;}	
		.ctime{margin-right: 15px;font-size: 12px;}
		.oaright{left: 0 !important;}
		.tiec, .ctime{margin-right: 0 !important;}
		.cmlist{padding: 18px 20px 20px 25px!important;background: white;}
		.noafter:after{height: 0 !important;}
		.cmlist:after{left: 25px !important;}
		.oaright p.tiec{padding: 5px !important;height: 0.6rem;overflow: hidden;background-color: rgba(242, 241, 238, 0.62);}  
		.oaright p.tiec span{display: -webkit-box;
			-webkit-box-orient: vertical;
			-webkit-line-clamp: 2;
			overflow: hidden;position: relative;top: -43px;padding-left: 0.75rem;color: #777;} 
		.tiec img{width: .7rem;}
		.noli{
			position: relative;overflow: hidden;
		}
		.noli:after, #dynamic li:after{
		    position: absolute;
		    right: 0;
		    bottom: 0;
		    left: 15px;
		    height: 1px;
		    content: '';
		    -webkit-transform: scaleY(.2);
		    transform: scaleY(.2);
		    background-color: #c8c7cc;
		}
		.fft b, .follow b{color: #555;}
		.follow>div{height: 100%;padding-top: 8px;}
	</style>

	<body style="display: none;">

		<header id="header" class="mui-bar mui-bar-transparent">
			<a id="leftbtn" class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 id="centertitle" class="mui-title">个人主页</h1>
		</header>
		<!--状态栏开始-->
		<div id="sBar" style="background-color: #9d9d9d;position: fixed;width:100%;top: 0;z-index: 9999"></div>
		<script type="text/javascript">
			var immersed = 0;
			var ms=(/Html5Plus\/.+\s\(.*(Immersed\/(\d+\.?\d*).*)\)/gi).exec(navigator.userAgent);
			if(ms&&ms.length>=3){ // 当前环境为沉浸式状态栏模式
			    immersed=parseFloat(ms[2]);// 获取状态栏的高度
			}
			var statusBar = document.getElementById('sBar');//这是模拟状态栏
			var headdiv = document.getElementById('header');//这是现有的header
			document.body.style.paddingTop =  immersed+'px';
			statusBar&&(statusBar.style.height = immersed+'px');
			headdiv&&(headdiv.style.top = immersed+'px');
		</script>
		<!--状态栏结束-->
		<!--<div id="container">-->
		<div id="main">
			<div class="clearfloat box-s box-ss" id="userBox">
	    		<img id="mypic1" src="../img/morentouxiang.jpg"/>
	    		<div id="beijing2"></div> 
	    			<img src="../img/market/atcenter.jpg" class="userAvator" id="mypic2"/> 
	    			<!--<div class="idhiji">HI集 ID:12345567</div>-->
	    	</div>
	    	<div class="content">
	    		<div class="mainInfo">
	    			<h4 style="color: #555;"> <span id="nickname">扉页</span> <img id="gender" src="../img/woman.svg" alt="" style="width: 0.15rem;"/></h4>
	    			<button type="button" class="mui-btn mui-btn-danger mui-btn-outlined editPage">
						编辑个人信息
					</button>
	    		</div> 
	    		<div class="follow fft">
					<div class="fchidl aClick">
						<b id="likenum">0</b>
						<div>赞的</div>
					</div>
					<!--<div class="fchidl aClick">
						<b id="sharenum">0</b>
						<div>分享的</div>
					</div>-->
					<div class="fchidl aClick">
						<b id="fennum">0</b>
						<div>粉丝</div>
					</div>
					<div class="fchidl aClick">
						<b id="follownum">0</b>
						<div>关注</div>
					</div>
				</div>
	    	</div>

		</div>
		<!--<div class="follow myfl">
			<div class="fchidl chidlL">
				<b>4</b>
				<div>关注</div>
			</div>
			<div class="fchidl"> 
				<b>7</b>
				<div>被关注</div>
			</div>
		</div>-->
		<p style="padding: 8px"><small>我的动态</small></p>
		<style type="text/css">
			#dynamic{background-color: #fff;}
			#spandiv{height: 40px;}
			#spandiv span{line-height: 40px;}
			#dynamic .spanL{float: left;color: #888;}
			#dynamic .spanR{float: right;color: #C0C0C0;}
			#dynamic li{margin-left: 25px;padding-right: 20px;position: relative;padding-bottom: 20px;}
			#dynamic li:after{left: 0;}
			#Dcon{padding: 8px;padding-left: 30%;background-color: rgba(242, 241, 238, 0.62);} 
			#Dcon:after{display: block;content: ' ';clear: both;}
			#Dcon .imgdiv{width: 34%;margin-left: -41%;float: left;height: 60px;max-height: 60px;overflow: hidden;}
			#Dcon .imgdiv img{width: 100%;}
			#Dcon p{padding-top: 5px;line-height:20px;display: -webkit-box;-webkit-box-orient: vertical;-webkit-line-clamp: 2;overflow: hidden;}
		</style>
		<ul id="dynamic">
			<!--<li class="">
				<div id="spandiv">
					<span id="" class="spanL">发了贴</span>
					<span id="" class="spanR">2017-09-08</span>
				</div>
				<div id="Dcon">
					<div class="imgdiv">
						<img src="../img/market/bsl.jpeg" alt="" />	
					</div>
					<p>哈哈哈哈哈哈哈哈哈哈哈哈哈哈<br/>哈哈哈哈哈哈哈哈哈哈哈哈哈哈<br/>哈哈哈哈哈哈哈哈哈哈哈哈哈哈</p>
				</div>
			</li>-->
		</ul>
		 
			<script type="text/html" id="infolist">
				<% for(var i=0; i<list.length; i++){%>
				<li class="" onclick="findInfo('<%=list[i].user_id%>','<%=list[i].news_id%>')">
					<div id="spandiv">
						<span id="" class="spanL">发了贴</span>
						<span id="" class="spanR">
							<% if(list[i].create_time){%>
					    		<%= list[i].create_time.split('T')[0]%>
					    	<% }%>
						</span>
					</div>
					<div id="Dcon" class="aClick2">
						<div class="imgdiv">
							<% if(list[i].pic){%>
								<% if(list[i].pic.indexOf('http')>-1){%>
									<img src="<%= list[i].pic%>" alt="" onerror="this.src ='../img/zhaoxiangji.svg',this.style.height = '100%'"/>
								<% }else{%>
									<img src="<%= url + list[i].pic%>" alt="" onerror="this.src ='../img/zhaoxiangji.svg',this.style.height = '100%'"/>
								<% }%>	
							<% }%>		
						</div>
						<p><%= list[i].content%></p>
					</div>
				</li>
				<% }%>	
			</script> 
			<div id="upload" style="padding-bottom: 60px;min-height: 100px; padding-top:10px;background-color: #fff;color: #999;text-align: center;"> 
			</div>
			<!--底部导航--> 
			 
			<nav class="mui-bar mui-bar-tab">
				<a onclick="gopage('Follow')">
					<!--<span class="mui-icon mui-icon-eye"></span>-->
					<i class="demo-icon icon-heart"></i>
					<!--<span class="mui-tab-label">关注</span>-->
				</a>
				<a onclick="gopage('find')">
					<!--<span class="mui-icon mui-icon-pengyouquan"></span>-->
					<i class="demo-icon icon-search"></i>
					<!--<span class="mui-tab-label">广场</span>-->
				</a>
				<a onclick="gopage('publish')">
					<!--<span class="mui-icon mui-icon-camera"></span>-->
					<i class="demo-icon icon-camera"></i>
					<!--<span class="mui-tab-label">消息</span>-->
				</a>
				<a onclick="gopage('message')">
					<!--<span class="mui-icon mui-icon-chat"></span>-->
					<i class="demo-icon icon-comment"></i>
                	<!--<span class="mui-badge mui-badge-danger">6</span>-->
	               
				</a>
				<a class="subActive">
					<!--<span class="mui-icon mui-icon-person"></span>-->
					<i class="demo-icon icon-user"></i>
					<!--<span class="mui-tab-label">个人主页</span>-->
				</a>
			</nav>
	</body>

	<script type="text/javascript">
		var falg = false; 
		//安卓返回键
//	    mui.init({
//	        beforeback: function(){
//	             backindex();
//	            return false; 
//	        }
//	    });
        function backindex(){
			falg = true;
		    //获得主页面的webview 
		    var appIndex = plus.webview.getLaunchWebview();
		    var mainweb = plus.webview.getWebviewById('main.html');
		    //触发主页面的gohome事件
		    mui.fire(appIndex,'gohome',{hrefid:'defaultTab'});
		    plus.webview.show(appIndex,"fade-in",500);
		    plus.webview.show(mainweb,"fade-in",500); 
		    var closes = ['Follow','message','centerPage','find','followed','follow','othersPage'];
		    mui.each(closes,function (index,element) {
		    	if(plus.webview.getWebviewById(element)){
			    	plus.webview.getWebviewById(element).close();
			    }
		    })
			plus.webview.currentWebview().close();
		    
		}
		
		//滚动监听
		$(window).scroll(function() { 
           var navBarHeight = 50;  
            var targetID = "#header"; 
            var scrollTo = $(window).scrollTop(); 
            if (scrollTo > navBarHeight) {
                $(targetID).css({
              		//"background-image": "url(../img/header.png)","background-size":"100%"
                });
                $('#leftbtn').css({'color':'#666'});
                $('#centertitle').css({'color':'#666'});
            } 
            if (scrollTo < navBarHeight) {
                $(targetID).css({
                    "background-image": "none"
                });
                $('#leftbtn').css({'color':'#fff'});
                $('#centertitle').css({'color':'#fff'});
            } 
        }).trigger('scroll');
		
		
		//导航切换
		function gopage(page){ 
	  		event.preventDefault();
	  		function fotrue(){
		  		if(plus.webview.getWebviewById(page)){
		        	plus.webview.show(page,"fade-in",300);
		        	plus.webview.currentWebview().hide();
		        }else{
		        	openview({
						view:page+'.html',
						id:page
					});
		        }
	  		}
	  		if(page == 'find'){
	  			fotrue();
	  		}else{
	  			if(plus.storage.getItem('myToken')){
	  				fotrue();
	  			}else{
	  				mui.toast('请登录');
					openview({
						view:'login.html'
					});
	  			}
	  		}
	  	}
	    //数据处理
	    var Spagenum = 2;//实到页数
		var Ypagenum = 1;//应到页数
		var myuserid;
	    mui.plusReady(function(){
	    	var oldtoken = plus.storage.getItem('oldToken');
			myuserid = plus.storage.getItem('userid');
			plus.nativeUI.showWaiting();
			var loadnum = 0;
			//头像名字
			mui.ajax(serverUrl+'/api/useraccount/userinfo',{
				data:{"userid":myuserid},
				type:'post',
				timeout:10000,
				headers:{"token":oldtoken},	              				
				success:function(data,type,xhr){
					console.log('获取用户数据返回', data);
					if(data.errno == 0){
						//显示头像
						if(data.data[0].avatar){
							mui('#mypic2')[0].src = serverimgUrl + JSON.parse(data.data[0].avatar)[0].picImg;
						}
						//显示昵称
						if(data.data[0].nickname != ' '){ 
							if(data.data[0].nickname.indexOf('null') == -1){
								mui('#nickname')[0].innerHTML = data.data[0].nickname;
							}else{
								mui('#nickname')[0].innerHTML = data.data[0].phone;
							}
						}else{
							mui('.denluzhuce')[0].innerHTML = data.data[0].phone;
						}
						//显示性别
						if(data.data[0].gender == '男'){
							mui('#gender')[0].src = '../img/man.svg';
							mui('#beijing2')[0].style.backgroundColor = 'rgba(140, 159, 191, 0.67)';
						}else if(data.data[0].gender == '女'){
							mui('#gender')[0].src = '../img/woman.svg';
						}
					}else{
						mui.toast('获取用户信息失败'); 
						console.log(data.errmsg); 
					}
					loadnum++;
				},
				error:function(xhr,type,errorThrown){
					loadnum++;
					mui.toast('获取用户信息响应失败');
					console.log('获取用户数据,响应失败');
				}
			});
			//赞的条数
			mui.ajax(serverUrl+'/api/news/newslike',{
				data:{"userid":myuserid},
				dataType:'json',
				type:'post',
				timeout:10000,
				headers:{"token":oldtoken},
				success:function(data,type,xhr){
					console.log('赞的条数',data)
					if(data.errno==0){
						mui('#likenum')[0].innerHTML = data.data.mylikenews.length;
					}
					loadnum++;
				},
				error:function(xhr,type,errorThrown){
					loadnum++;
					mui.toast('当前网络不好，请重试！');
					console.log('登录响应失败');
				}
			});
			//关注条数
			mui.ajax(serverUrl+'/api/news/myfollow',{
				data:{"userid":myuserid},
				dataType:'json',
				type:'post',
				timeout:10000,
				headers:{"token":oldtoken},
				success:function(data,type,xhr){
					console.log('关注条数',data)
					if(data.errno==0){
						mui('#fennum')[0].innerHTML = data.data.followMe.length;
						mui('#follownum')[0].innerHTML = data.data.myFollow.length;
					}
					loadnum++;
				},
				error:function(xhr,type,errorThrown){
					loadnum++;
					mui.toast('当前网络不好，请重试！');
					console.log('登录响应失败');
				}
			});
			//我的动态
//			document.getElementById("noinfodiv").innerHTML = '';
			mui.ajax(serverUrl+'/api/news/newslist',{ 									
				data:{currentPage:1,numsPerPage:10,userid:myuserid,categoryid:'',isMyFriendPage:true}, 
				dataType:'json',//服务器返回json格式数据
				type:'post',//HTTP请求类型 
				timeout:10000,//超时时间设置为10秒；	
				headers:{"token":oldtoken}, 
				success:function(data){
					if(data.errno == 0){ 
						console.log('动态列表返回',data); 
						
						if(data.data.totalPages){
							var dataobj = {};
							mui.each(data.data.data,function (index,ele) {
								if(ele.pic.indexOf('picImg')>-1){
									ele.pic = JSON.parse(ele.pic)[0].picImg;
								}
							})
							dataobj.list = data.data.data;
							dataobj.url = serverimgUrl;
							
							//获取并渲染用户信息
							var html=template("infolist",dataobj);
							document.getElementById("dynamic").innerHTML += html;
						}else{
							mui("#upload")[0].innerHTML = "没有动态";
							mui("#upload")[0].style.paddingTop = mui("#upload")[0].style.paddingBottom = "30px";
						}
						
						//滚动到底部加载
						$(window).scroll(function(){
						　　var scrollTop = $(this).scrollTop();
						　　var scrollHeight = $(document).height();
						　　var windowHeight = $(this).height();
						　　if(scrollTop + windowHeight == scrollHeight){//滚动条到达可以加载
								if(Spagenum<=data.data.totalPages && Spagenum==Ypagenum+1){//当前页小于等于总页数时请求下一页
									mui("#upload")[0].innerHTML = "<img src='../img/balls.svg' />";
									Ypagenum++;//满足加载情况,应到页数+1
									console.log('发起请求,实到'+Spagenum+'页');									
									console.log('发起请求,应到'+Ypagenum+'页');
									mui.ajax(serverUrl+'//api/news/newslist',{ 	
										data:{currentPage:Spagenum,numsPerPage:10,userid:myuserid,categoryid:'',isMyFriendPage:true}, 
										dataType:'json',//服务器返回json格式数据 
										type:'post',//HTTP请求类型 
										timeout:10000,//超时时间设置为10秒；	
										headers:{"token":oldtoken}, 
										success:function(data){
											console.log('下拉数据',data);
											if(data.errno == 0){
												var dataobj = {};
												mui.each(data.data.data,function (index,ele) {
													if(ele.pic.indexOf('picImg')>-1){
														ele.pic = JSON.parse(ele.pic)[0].picImg;
													}
												})
												dataobj.list = data.data.data; 
												dataobj.url = serverimgUrl;
												//获取并渲染用户信息
												var html=template("infolist",dataobj);
												document.getElementById("dynamic").innerHTML += html;
											}
											mui("#upload")[0].innerHTML = ""; 
											Spagenum++;//加载成功,当前页+1
											console.log('成功+1,实到'+Spagenum);
											console.log('成功+1,应到'+Spagenum);
										},
										error:function(xhr,type,errorThrown){
											Ypagenum--;//失败是应到-1
											mui.toast("当前网络不好请重试");
											mui("#upload")[0].innerHTML = ""; 
										}
									});
								}else if(Spagenum == data.data.totalPages+1){//当前页不小于等于总页数时请求下一页
									mui("#upload")[0].style.paddingBottom='80px';
									mui("#upload")[0].innerHTML = "没有更多了"; 
									
								}
						　　  }
						});//加载下一部分结束
					}else{
						mui("#upload")[0].innerHTML = ""; 
					}
					loadnum++;
				},
				error:function(xhr,type,errorThrown){
					loadnum++;
					mui("#upload")[0].innerHTML = ""; 
				}
			});
			//关遮罩
			var time1 = setInterval(function(){ 
				console.log(loadnum);
				if(loadnum == 4){
					var time2 = setTimeout(function(){
						plus.nativeUI.closeWaiting();
					},300) 
					mui('body')[0].style.display = 'block';
			  		clearInterval(time1);
				}
			},100)
			
			
	    })
   		//编辑个人主页
		mui('.editPage')[0].addEventListener('tap',function(){
			openview({
				view:'personal/setup.html' 
			});
		});
	    //帖子 详情
	    function findInfo(id,newsid){
    		openview({
				view: "find/findInfo.html",
				id:"findInfo",
				extrasobj: {
					userId: id,
					newsId: newsid,
				}
			})
    	}
	    //赞的
	    $(".fft .fchidl:first-child").on("tap",function(){
	    	openview({
					view:'find/like.html' 
				});
	    })
	    //分享的
//	    $(".fft .fchidl:nth-child(2)").on("tap",function(){
//	    	openview({
//					view:'find/shareList.html' 
//				});
//	    })
	    // 粉丝 
	    $(".fft .fchidl:nth-child(2)").on("tap",function(){
	    	openview({
				view:'find/followed.html',
				id:'followed',
				create:true,
				extrasobj:{idnum:myuserid} 
			});
	    })
	    //关注
	    $(".fft .fchidl:nth-child(3)").on("tap",function(){
	    	openview({
				view:'find/follow.html',
				id:'follow',
				create:true,
				extrasobj:{idnum:myuserid}
			});
	    })
	    

		
	</script>

</html>