<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>家乡话</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/mui.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/common.css"/>
		<!--<link rel="stylesheet" type="text/css" href="../../css/localHost.css"/>-->		
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script src="../../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/app.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/artTemplate-native.js" type="text/javascript" charset="utf-8"></script>
		<style type="text/css">
			/*优化显示*/
			body{padding-bottom: 0 !important;}
			
		#banner{
			position: relative;
			width: 100%;
			padding-top: 42%; 
			overflow: hidden;
			background: url(../../img/bannerback.svg) 50% 50% no-repeat;
			background-size: 20%;
		}
		.mui-slider .mui-slider-group{
			position: absolute;
		    height: 100%;
		    width: 100%;
		    top: 0;
		}
		.mui-slider .mui-slider-group .mui-slider-item img{height: 100%;}
		/*banner底部导航*/
		.mui-slider-indicator .mui-indicator{
			width: 10px !important;
			height: 10px !important;
			border-radius: 8px;
			background: black;
			margin-right: 5px;
			opacity: 0.3;
			cursor: pointer;
			border: none;
			box-shadow: none;
		}
		.mui-slider-indicator .mui-active.mui-indicator{
			background-color: rgba(245,60,66,0.8) !important;
			box-shadow: none;
			opacity: 1;
			border: none;
		}
		.mui-slider-item{
			position: relative;
			width: 100%;
			padding-top: 42%; 
			overflow: hidden;
		}
		
		.mui-slider-item img{
			position: absolute;
			width: 100%; 
			height:100%;
			top: 0;
		}
			
			.editbtn{
				background-color: #fff;
				position: absolute;
				left: 50%;
				bottom:0;
				margin-left: -7.5%;

				text-align: center;
				padding:5px 0;
				background: #EFEFF4;
			}
			.editbtn img{
				width:50px !important;
				height:50px !important;
				
			}
			
			.mui-media-body{
				white-space: normal;
				color:#333;
			}
			.newsContent{
				overflow: hidden;
				white-space: nowrap;
				text-overflow: ellipsis;
				line-height: 25px;
				margin-top: 5px;
			}
			.newsTitle{
				font-size: 16px;
				color: #666;
				line-height: 20px;
				
				/*overflow: hidden;
				white-space: nowrap;
				text-overflow: ellipsis;*/
				
				
				display: -webkit-box;
				-webkit-box-orient: vertical;
				-webkit-line-clamp: 2;
				overflow: hidden;
				min-height: 40px;
			}
			.nice{
				width: 15px;
				position: relative;
				top: 3px;
			}
			.newsNice{
				/*float: right;*/
				margin-top: 10px;
			}
			.nothing{
				background-color: #EFEFF4;
			}
			.nothing img{
				display: block;
				margin: 20px auto;
				width: 80px;
			}
			.nothing p{
				text-align: center;
				line-height: 50px;
			}
			.notice .tab-bd{
				padding-top: 0;
			}
			.newImg{
				width: 100% !important;
				height: 100%;
				float: left !important;
				margin-right: 20px;
			}
			.mui-table-view .mui-media-object.mui-pull-right{
				margin-left: 5px;
			}
			.mui-table-view .mui-media-object{
				width: 100%;
				max-width:100%;
				height: auto;
				max-height: 50px;
			}
			.mui-row{
				margin: 0 -15px !important;
			}
			#upload {
			    text-align: center;
			    font-size: 15px;
			    line-height: 30px;
			    min-height: 40px;
			    color: #999;
			     padding-top: 0 !important; 
			}
			#upload img{   
				width: 33px;
    			margin-top: 2px;
    			padding: 0 !important;
			}
			.mui-table-view-cell{
				padding: 6px 15px !important;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
		    <h1 class="mui-title">家乡话</h1>
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div id="main">
			<div id="scroller">
				<!--轮播图-->
				<div class="mui-slider" id="banner"></div>
				<!--轮播图结束-->
				<!--banner数据渲染-->
				<script type="text/html" id="banner-detail">
					<div class="mui-slider-group mui-slider-loop">
					    <!--支持循环，需要重复图片节点-->
					    <div class="mui-slider-item mui-slider-item-duplicate">
					    	<img src="<%= url %><%= bannerList[bannerList.length-1].bannerPic %>" onerror="javascript:this.src='../../img/market/banner.png';"/>
					    	<div class="titleWrap">
								<p><%=bannerList[bannerList.length-1].name %></p>
							</div>
					    </div>
						<% for(var i=0;i<bannerList.length;i++){ %> 
					    	<div class="mui-slider-item">
					    		<img src="<%= url %><%=bannerList[i].bannerPic %>" onerror="javascript:this.src='../../img/market/banner.png';"/>
					    		<div class="titleWrap">
									<p><%=bannerList[i].name %></p>
								</div>
					    	</div>
					     <% } %>
					    <!--支持循环，需要重复图片节点-->
					    <div class="mui-slider-item mui-slider-item-duplicate">
					    	<img src="<%= url %><%= bannerList[0].bannerPic %>" onerror="javascript:this.src='../../img/market/banner.png';"/>
					    	<div class="titleWrap">
								<p><%= bannerList[0].name %></p>
							</div>
					    </div>
					</div>
					<div class="mui-slider-indicator">
						<div class="mui-indicator mui-active"></div>
						<% for(var i=0;i<bannerList.length-1;i++){ %>
					    	<div class="mui-indicator"></div>
					    <% } %>
		            </div> 
				</script>
			</div>
		</div>
		<div class="infolist">
			<ul class="mui-table-view" id="news"></ul>
		</div>
		<div class="upload text-center text-xs gray" id="upload"></div>
		<!--图文列表模板开始-->
		<script type="text/html" id="newsModal">
			<% for(var i=0;i<dataList.length;i++){%>
				<li class="mui-table-view-cell mui-media openDetail" data-id="<%=dataList[i].id%>" onclick="goNews(<%=dataList[i].id%>)">
					<a href="javascript:;" class="mui-row">
						<div class="mui-col-sm-3 mui-col-xs-3">
							<img class="mui-media-object mui-pull-right"  class="newImg" src="<%=myUrl %><%=dataList[i].pic%>">
						</div>
						<div class="mui-col-sm-9 mui-col-xs-9" style="padding-left: 15px;">
							<div class="mui-media-body">
							<p class="newsTitle"><%= dataList[i].title %></p>
							<p class="newsContent"></p>
							<p class="newsNice"><%= dataList[i].create_time %>&nbsp;&nbsp; <span style="float: right;"><img src="../../img/nice.png" class="nice"/>&nbsp;<%= dataList[i].red_heart %></span></p>
						</div>
						</div>
						<!--<img class="mui-media-object mui-pull-right"  class="newImg" src="<%=myUrl %><%=dataList[i].pic%>">-->
						
					</a>
				</li>
			<%}%>
		</script>
		<!--图文列表模板结束-->
		<!--<div class="editbtn">
			<img src="../../img/bianjibtn.svg"/>
		</div>-->
		
		<script type="text/javascript">
			var Spagenum;//实到页数
			var Ypagenum;//应到页数 
			mui.plusReady(function(){
				var infolist = mui('.infolist div');
				for(var i=0; i<infolist.length; i++ ){
					infolist[i].addEventListener('tap',function(){
						openview({
							view:'listinfo.html'
						});
					})
				}
				//获取缓存
				var oldToken = plus.storage.getItem('oldToken');
				plus.nativeUI.showWaiting('加载中 ...',{width:'100px',height:'80px'});//显示等待框
				//家乡话banner
				mui.ajax(serverUrl+'/api/index/banner',{
					data:{banner_type:2},
					dataType:'json',
					type:'post',
					timeout:10000,
					headers:{"token":oldToken},	 
					success:function(data,type,xhr){
						console.log('列表',data);
						bannerObj={};
						bannerObj.bannerList = eval("("+data.data.banner+")");
						bannerObj.url = serverimgUrl;
						var html = template('banner-detail',bannerObj);
						document.getElementById('banner').innerHTML = html;
						//轮播图,获得slider插件对象
						var gallery = mui('.mui-slider');
						gallery.slider({
						  	interval:5000//自动轮播周期，若为0则不自动播放，默认为0；
						});
					},
					error:function(xhr,type,errorThrown){
						mui.toast('响应失败  !');
					}
				}); 
//				家乡报道的新闻获取
				//监听刷新
				document.addEventListener('refreshNews', function() {
					RefreshNews();
					console.log('刷新数据');
				}) 
				RefreshNews();
				function RefreshNews(){
					Spagenum = 2;//实到页数
					Ypagenum = 1;//应到页数
					mui.ajax(serverUrl+'/api/localreport/localreport',{
						data:{currentPage:1,numsPerPage:10},
						dataType:'json',//服务器返回json格式数据
						type:'post',//HTTP请求类型
						timeout:10000,//超时时间设置为10秒；
						headers:{"token":oldToken},	 
						success:function(data,type,xhr){
							console.log('data',data);
							if(data.data.data.length ==0){
								mui('.infolist')[0].innerHTML='<div class="nothing"><img src="../../img/theList/del.png"/><p>还没有家乡话信息哟！</p></div>';
							}
							//获取并渲染焦点热门信息
							for(var i=0;i<data.data.data.length;i++){
								data.data.data[i].create_time=data.data.data[i].create_time.split('.')[0].split('T')[0];
							}
							dataObj={};
							dataObj.myUrl = serverimgUrl;
							dataObj.dataList=data.data.data;
							var html=template("newsModal",dataObj);
							document.getElementById("news").innerHTML=html;
							plus.nativeUI.closeWaiting();//关闭等待框
							
							//滚动到底部加载
							function getScrollTop(){//滚动条在Y轴上的滚动距离
							　　var scrollTop = 0, bodyScrollTop = 0, documentScrollTop = 0;
							　　if(document.body){
							　　　　bodyScrollTop = document.body.scrollTop;
							　　}
							　　if(document.documentElement){
							　　　　documentScrollTop = document.documentElement.scrollTop;
							　　}
							　　scrollTop = (bodyScrollTop - documentScrollTop > 0) ? bodyScrollTop : documentScrollTop;
							　　return scrollTop;
							}
							function getScrollHeight(){//文档的总高度
							　　var scrollHeight = 0, bodyScrollHeight = 0, documentScrollHeight = 0;
							　　if(document.body){
							　　　　bodyScrollHeight = document.body.scrollHeight;
							　　}
							　　if(document.documentElement){
							　　　　documentScrollHeight = document.documentElement.scrollHeight;
							　　}
							　　scrollHeight = (bodyScrollHeight - documentScrollHeight > 0) ? bodyScrollHeight : documentScrollHeight;
							　　return scrollHeight;
							}
							function getWindowHeight(){//浏览器视口的高度
							　　var windowHeight = 0;
							　　if(document.compatMode == "CSS1Compat"){
							　　　　windowHeight = document.documentElement.clientHeight;
							　　}else{
							　　　　windowHeight = document.body.clientHeight;
							　　}
							　　return windowHeight;
							}
							window.onscroll = function(){
							　　if(getScrollTop() + getWindowHeight() == getScrollHeight()){
									if(Spagenum<=data.data.totalPages && Spagenum==Ypagenum+1){//实到页数小于等于总页数时发起请求,并且实到=应到
										mui("#upload")[0].innerHTML = "<img src='../../img/balls.svg' />";
										Ypagenum++;//满足加载情况,应到页数+1
										console.log('发起请求,实到'+Spagenum+'页');									
										console.log('发起请求,应到'+Ypagenum+'页');									
										mui.ajax(serverUrl+'/api/localreport/localreport',{
											data:{currentPage:Spagenum,numsPerPage:10},
											type:'post',
											timeout:5000, 
											headers:{"token":oldToken},	 
											success:function(data,type,xhr){
												console.log('列表返回',data);
												if(data.errno == 0){
													//获取并渲染焦点热门信息
													for(var i=0;i<data.data.data.length;i++){
														data.data.data[i].create_time=data.data.data[i].create_time.split('.')[0].split('T')[0];
													}
													dataObj={};
													dataObj.myUrl = serverimgUrl;
													dataObj.dataList=data.data.data;
													var html=template("newsModal",dataObj);
													document.getElementById("news").innerHTML+=html;
													plus.nativeUI.closeWaiting();//关闭等待框
												}
												
												
												mui("#upload")[0].innerHTML = " ";
												Spagenum++;//加载成功,当前页+1
												console.log('成功+1,实到'+Spagenum);
												console.log('成功+1,应到'+Spagenum);
											},
											error:function(xhr,type,errorThrown){
												Ypagenum--;//失败是应到-1
												mui.toast("当前网络不好请重试");
												mui("#upload")[0].innerHTML = "";
											} 
										});
									}else if(Spagenum == data.data.totalPages+1){//当前页不小于等于总页数时请求下一页
										mui("#upload")[0].innerHTML = "到底了"; 
									}
							　　}
							};//滚动加载
							
						},
						error:function(xhr,type,errorThrown){
							mui("#upload")[0].innerHTML = ""; 
							plus.nativeUI.closeWaiting();//关闭等待框
							console.log(type);
						}
					});
					
					
					
					//点击进入详情
					window.goNews = function(newsId){
						openview({
							view: "listinfo.html",
							extrasobj: {
								newsId: newsId
							}
						})
					}
				}
				
			
			
			})
		</script>
		
	</body>
	
</html>