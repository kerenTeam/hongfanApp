<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>列表详情</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/icons-extra.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/reset.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/one.css"/>
		<script src="../../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script src="../../js/app.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/artTemplate-native.js" type="text/javascript" charset="utf-8"></script>
		<!--<script type="text/javascript" src="../../js/iscroll.js"></script>

		<script src="../../js/swiper.min.js" type="text/javascript" ></script>
		<script type="text/javascript" src="../../js/index.js"></script>-->
		<style type="text/css">
			body{
				background-color: #fff;
			}
			h4{
				margin:0;
				padding:0;
				padding-top:15px;
				line-height: 25px;
				text-align: center;
			}
			.mui-pull-right{
				margin-bottom: 20px;
			}
			.nice{
				width: 25px;
			}
			.niceBtn{
				background-color: #fff;
				padding: 10px 30px;
				
			}
			.btnBottom{
				display: inline-blockblock;
				margin: 20px !important;
				float:right;
			}
			#main{
				padding-bottom: 50px;
				padding: 0 20px;
			}
			.newsContent{
				line-height: 20px;
				margin-top: 20px;
			}
			#newsModal{
				padding-bottom: 50px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
		    <h1 class="mui-title">详情</h1>
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div id="main">
			<div id="newsModal"></div>
			<!--新闻详情 模板渲染-->
			<script type="text/html" id="newsModal-detail">
				<h4 style="color: #333;"><%=dataList.title%></h4>
				<p style="color: #666;line-height: 25px;margin-top: 20px;" id="newContent"></p>
				<!--<img class="imgSize" src="<%=dataList.pic%>"/>-->
				<span class="mui-pull-right" style="margin-top: 20px;color: #666;margin-bottom: 20px;">发布时间：<%=dataList.create_time%></span>			
				<button type="button" class="mui-btn mui-btn-block" style="color: #999;" id="niceBtn"><img src="../../img/nice.png" class="nice"/>&nbsp;<%=dataList.red_heart%></button>
			</script>
		</div>
		<script type="text/javascript">
			mui.plusReady(function(){
				plus.nativeUI.showWaiting('加载中 ...',{width:'100px',height:'80px'});//显示等待框
				var newsId = plus.webview.currentWebview().newsId;
				oldToken = plus.storage.getItem('oldToken');
				//家乡报道的新闻获取
				mui.ajax(serverUrl+'/api/localreport/localreport',{
					data:{currentPage:1,numsPerPage:10},
//					dataType:'json',//服务器返回json格式数据
					type:'post',//HTTP请求类型
					timeout:10000,//超时时间设置为10秒；
					headers:{"token":oldToken},	 
					success:function(data,type,xhr){
						for(var j=0;j<data.data.data.length;j++){
							if(data.data.data[j].id==newsId){
//								alert(JSON.stringify(data.data.data[j]))
								data.data.data[j].create_time=data.data.data[j].create_time.split('.')[0].split('T')[0]
								var dataObj = {};
								dataObj.dataList = data.data.data[j];
								var html=template("newsModal-detail",dataObj);	
								document.getElementById("newsModal").innerHTML=html;
//								alert(document.getElementById('newContent').innerHTML);
								document.getElementById('newContent').innerHTML = data.data.data[j].content;
								
								//点赞
//								plus.storage.removeItem("niceIDs");//清除缓存
								var niceIDs = JSON.parse(plus.storage.getItem('niceIDs')) || [];//获取缓存
								if(niceIDs.length>0){
									for(var n=0;n<niceIDs.length;n++){
										if(niceIDs[n]==newsId){//判断该报道已经点过赞
											$('#niceBtn').addClass('mui-btn-danger');
											$('#niceBtn').css('color','#fff');
											$('#niceBtn').find('img').attr('src','../../img/afterNice.png');
											document.getElementById('niceBtn').innerHTML='<img src="../../img/afterNice.png" class="nice"/>&nbsp;'+data.data.data[j].red_heart;
											break;										
										}
										if(n==niceIDs.length-1){
											mui('#niceBtn')[0].addEventListener('tap',function(){
												nice();
											});
										}
									}
								}else{
									mui('#niceBtn')[0].addEventListener('tap',function(){
										nice();
									});
								}
								plus.nativeUI.closeWaiting();//关闭等待框
								window.nice = function(){
									var num =parseInt( $('#niceBtn').text());
									if($('#niceBtn').hasClass('mui-btn-danger')){//取消点赞
									}else{//点赞
										//新闻的评论的获取
										mui.ajax(serverUrl+'/api/localreport/redheart',{
											data:{reportsID:newsId},
											type:'post',//HTTP请求类型
											timeout:10000,//超时时间设置为10秒；
											headers:{"token":oldToken},	 
											success:function(data,type,xhr){
//												alert(JSON.stringify(data));
												if(data.data==1){
													mui.toast('点赞成功！');
													mui.fire(plus.webview.getWebviewById('Hreport/h_report.html'),'refreshNews');//打开指定页面 
													$('#niceBtn').addClass('mui-btn-danger');
													$('#niceBtn').css('color','#fff');
													$('#niceBtn').find('img').attr('src','../../img/afterNice.png');
													newNo = num + 1;
													$('#niceBtn').html('<img src="../../img/afterNice.png" class="nice"/>&nbsp;'+newNo);
													//点过赞的新闻做缓存
//													alert(typeof(niceIDs));
													
													niceIDs.push(newsId);
													plus.storage.setItem("niceIDs",JSON.stringify(niceIDs));
												}else{
													mui.toast('点赞失败，请重试！');
												}
											},
											error:function(xhr,type,errorThrown){
												console.log(type);
											}
										});
									}
									
								}
							}
						}
					},
					error:function(xhr,type,errorThrown){
						console.log(type);
						plus.nativeUI.closeWaiting();//关闭等待框
					}
				});
				
			})
		</script>
	</body>
	
</html>