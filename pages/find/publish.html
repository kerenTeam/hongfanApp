<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>发布发现</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../css/common.css">
		<link rel="stylesheet" type="text/css" href="../css/index.css">
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<link rel="stylesheet" href="../css/reset.css">
		<link rel="stylesheet" href="../css/one.css">
		<link rel="stylesheet" type="text/css" href="../css/find.css" />
		

	</head>
	<style type="text/css">
		#imgUpload {
			display: none;
			width: 0;
		}
		#preview{
			width: 30%;
		}
		.ptet {
			font-size: 12px;
			border: none;
		}
		label {
			vertical-align: top;
			width: calc((100% - 20px) * 2 / 5);
			width: -moz-calc((100% - 20px) * 2 / 5);
			width: -webkit-calc((100% - 20px) * 2 / 5);
		}
		.ptet {
			width: calc((100% - 20px) * 3 / 5);
			width: -webkit-calc((100% - 20px) * 3 / 5);
			width: -moz-calc((100% - 20px) * 3 / 5);
		}
		.publishf {
			padding: 10px;
		}
		.addbg {
			padding: 0 10px;
		}
		.mui-badge {
			padding: 5px 10px;
			margin: 5px;
			background: #eee;
		}
		.mui-badge:not(:last-child) {
			color: palevioletred;
		}
		.location {
			padding: 20px;
			border-top: 10px solid #EEEEEE;
		}
		.location img {
			width: 0.3rem;
			margin-right: 10px;
		}
		.addbgs {
			margin-right: 2px;
			color: coral;
			padding: 0 2px;
		}
		.disbg {
			border: none;
			padding: 0;
			font-size: 0.13rem;
			/*margin: 0 10px;*/
			min-height: 30px;
			line-height: 1.2;
		}
	 	/*图片上传*/
    	*{margin: 0;padding: 0;box-sizing: border-box;}
    	.clearfix:after {content: ""; display: block; clear:both;}
    	.uppics{text-align: center;background-color: #fff;padding: 10px;}
    	.uppics div.onepic{padding: 0 !important;font-size: 14px;}
	    .uppics div.onepic img{width: 90%;}
	    .uppics div.onepic input{width: 0;height: 0;position: absolute;outline: none;}

	    #uppics2 div.onepic{display: inline-block;width: 120px;#uppics2 div.onepicvertical-align: middle;position: relative;text-align: center;padding: 10px;
	    margin-right: 6px;float: left;} 
	    #uppics2 .onepic{width: 120px;}
	    #uppics2 .picimg{width: 100%;}
	    .picimg1{width: 25px;position: absolute;right: 0px;top: 2px;}
	    /*图片上传结束*/
	 
	</style>

	<body>

		<header class="mui-bar mui-bar-nav" id="header">
			<a class="mui-icon mui-pull-left bigSize back" style="font-size: 0.14rem;">取消</a>
			<h1 class="mui-title findUser">发布</h1>
			<a href="javascript:;" style="line-height: 50px;color:white;" class="fr baocun">发送</a>
		</header>
		<script src="../js/statusBar.js"></script><!--状态栏-->
		
		<div id="main">
			<div class="publishf clearfix"> 
				<div class="<!--ptet fr-->">
					<div class="apsan"></div>
					<textarea id="textCon" class="disbg" rows="5" placeholder="点击输入 文字，心情，胡思乱想。。。"></textarea>
 
				</div>
			</div>
			<style type="text/css">
				.biaoqian span{
					padding: 8px 11px;
					margin: 3px;
					display: inline-block;
					background-color: #eee;
					border-radius: 1px;					
				}
				.biaoqian span.active{background-color: #ea4242;color: #fff;}  
			</style>
			<div id="" class="biaoqian">
				<span id="" onclick="spanclick(this)">
					#标签#
				</span>
				<span id="" onclick="spanclick(this)">
					#热血#
				</span>
				<span id="" onclick="spanclick(this)">
					#豪爽#
				</span>
				<span id="" onclick="spanclick(this)">
					#标签#
				</span>
				<span id="" onclick="spanclick(this)">
					#表情#
				</span>
				<span id="" onclick="spanclick(this)">
					#表情#
				</span>
				<span id="" onclick="spanclick(this)">
					#表情#
				</span>
			</div>
			
			<div class="uppics clearfix" id="uppics2"> 
		        <div class="onepic">
		            <input type="file" id="file_input"/> 
		            <img id="nowpic" src="../img/publisf.svg">
		        </div>
		    </div> 
		    
			<!--地理定位-->
			<div class="location">
				<img src="../img/location.svg" alt="" /><span id="mapAddress">我的位置</span>
				<div class="fr">
					<span></span>
					<div class="mui-switch mui-switch-mini">
						<div class="mui-switch-handle"></div>
					</div>
				</div>
			</div>

		</div>

	</body>
<script type="text/javascript" src="../js/jquery.min.js"></script>
<script src="../js/mui.min.js"></script>
<script src="../js/app.js"></script> 
<script src="../js/common.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/image-new.js" type="text/javascript" charset="utf-8"></script>
<!--引入模板引擎-->
<script src="../js/artTemplate-native.js"></script>
<script type="text/javascript">
	//选择图片
	var onepic = document.getElementsByClassName('onepic')[0];
    var uppics = document.getElementsByClassName('uppics')[0];
    var time1 = null;
    var Apic = [],picobj = {};//存放图片数组
    onepic.onclick = function(){
    	var file_input = document.getElementById('file_input');
        uppics.id = 'uppics2';
        var imgnode = document.createElement("div");
        clearInterval(time1);
        time1 = setInterval(function(){ 
            console.log('加载中',file_input.files[0]);
            if (file_input.files[0]) {
            	if(file_input.files[0].size>0){
            		console.log(file_input.files[0]);
            		Apic = []; 
                	Apic.push(file_input.files[0]); 
	                clearInterval(time1);
	                var reader = new FileReader();
	                var picname = file_input.files[0].name;
	                reader.readAsDataURL(file_input.files[0]); 
	                reader.onload = function(e){
	                	picobj = file_input.files[0]; 
	                	mui('#nowpic')[0].src = this.result;
	                }
	                file_input.value = '';
            	}
            }
        },500)
    }
	//选择图片结束
//	mui.plusReady(function() {
//		var o = imageTool.options;
//		o.uploadUrl = 'http://demo.dcloud.net.cn/helloh5/uploader/upload.php'; //图片上传链接
//		
//		o.multiple = true; //默认只上传一张图片 ，如果要选择多张，请设置为true
//		o.maxPicsCount = 6; //默认一次最多选择10张图片,
//		o.ZoomBox = 1200; //缩放宽高，默认1200px,横图缩放宽度，高度根据比例计算，同理竖图
//		o.ZoomQuality = 89; //压缩图片的质量
//		o.isUpload = true; //默认不上传
//		var mine = plus.webview.currentWebview();
//		mui('#nowpic')[0].addEventListener('tap',function(){
//			plus.nativeUI.actionSheet({
//					cancel: "取消",
//					buttons: [{
//						title: "从手机相册选择"
//					}, {
//						title: '拍照'
//					}]
//				},
//				function(e) {
//					console.log(JSON.stringify(e));
//					if (e.index == 1) { //点击从相册选择
//						console.log("相册选择");
//						getPics();
//					} else if (e.index == 2) {
//						console.log("拍照");
//						getPics(true);
//					}
//				}
//			);
//		})
//	});
	

//	function getPics(isCamera) {//选择图片方法
//		if (!isCamera) {
//			imageTool.galleryImgs(doPics);
//		} else {
//			imageTool.camera(doPics);
//		}
//	}
	
	function spanclick(obj){
		if(obj.className == 'active'){
			obj.className = '';
		}else{
			obj.className = 'active';
		}
	}
	mui.plusReady(function() {
		//返回提示
		$(".back").on("tap", function() {
			var btnArray = ['否', '是'];
			mui.confirm('确定取消吗？', '提示', btnArray, function(e) {
				if(e.index == 1) {
					mui.back()
				} else {}
			})
		})
		
		//地图定位
		var watchId;
		function geoInf(position) {
			var str = "";
			str += "地址：" + position.addresses + "\n"; //获取地址信息
			str += "坐标类型：" + position.coordsType + "\n";
			var timeflag = position.timestamp; //获取到地理位置信息的时间戳；一个毫秒数；
			str += "时间戳：" + timeflag + "\n";
			var codns = position.coords; //获取地理坐标信息；
			var lat = codns.latitude; //获取到当前位置的纬度；
			str += "纬度：" + lat + "\n";
			var longt = codns.longitude; //获取到当前位置的经度
			str += "经度：" + longt + "\n";
			var alt = codns.altitude; //获取到当前位置的海拔信息；
			str += "海拔：" + alt + "\n";
			var accu = codns.accuracy; //地理坐标信息精确度信息；
			str += "精确度：" + accu + "\n";
			var altAcc = codns.altitudeAccuracy; //获取海拔信息的精确度；
			str += "海拔精确度：" + altAcc + "\n";
			var head = codns.heading; //获取设备的移动方向；
			str += "移动方向：" + head + "\n";
			var sped = codns.speed; //获取设备的移动速度；
			str += "移动速度：" + sped;
			console.log(JSON.stringify(position));
			longitude = (position.coords.longitude).toFixed(6);
			latitude = (position.coords.latitude).toFixed(6);
			$('#mapAddress').html(position.addresses);
			
		}
		// 通过定位模块获取位置信息
		function getGeocode() {
			plus.geolocation.getCurrentPosition(geoInf, function(e) {
				outSet("获取定位位置信息失败：" + e.message);
			}, {
				geocode: true,
				provider: 'amap'
			});
		}
		//是否显示位置
		$('.mui-switch').click(function() {
			if($(this).hasClass("mui-active")) {
				getGeocode();
			} else {
				$('#mapAddress').html("我的位置")
			}
		})

	})//plusready
		
	//发送 发布
	mui('.baocun')[0].addEventListener('tap',function(){
		var tagstr = '';
		mui.each(mui('.biaoqian')[0].getElementsByClassName('active'),function (index,element) {
			tagstr += element.innerText;
		})
		console.log('图片',Apic);
		console.log('标签',tagstr);
		var content = mui('#textCon')[0].value,mapAddress = '未知';
		if(mui('#mapAddress')[0].innerHTML != '我的位置'){mapAddress = mui('#mapAddress')[0].innerHTML};
		if(!content){
			mui.toast('请输入内容');
		}else if(!Apic.length){
			mui.toast('请选择一张照片');
		}else{
			plus.nativeUI.showWaiting('发送中 ...',{width:'100px',height:'80px'});
			mui.plusReady(function(){ 
				var myuserid = plus.storage.getItem('userid');
				var oldtoken = plus.storage.getItem('oldToken');
				//发送数据
				console.log(mapAddress);
				var fd = new FormData(); 
		        fd.append('userid',myuserid);  		
		        fd.append('content',content);  		
		        fd.append('fix',mapAddress);//地址 		
		        fd.append('pic',Apic[0]);  		
		        fd.append('tags',tagstr);  		
		        var xhr = new XMLHttpRequest();  	
		        xhr.open('POST',serverUrl+'/api/news/addnews',true); 	
		    	xhr.onreadystatechange = function(){
		    		if (xhr.readyState===4) { 
    					if (xhr.status===200) {
    						var dataobj = JSON.parse(xhr.responseText);
    						console.log('上传返回'+xhr.responseText);
    						if(dataobj.errno == 0){
								if(plus.webview.getWebviewById('Follow')){//触发关注分享刷新，并打开关注分享
									mui.fire(plus.webview.getWebviewById('Follow'),'refresh');
								}
								var time2 = setTimeout(function(){//关闭当前
									if(!plus.webview.getWebviewById('Follow')){
										openview({
											view:'Follow'+'.html',
											id:'Follow'
										});
									}
									plus.nativeUI.closeWaiting();//关闭等待框
									mui.toast('发布成功');
									plus.webview.show('Follow',"fade-in",300);
									plus.webview.currentWebview().hide();
									plus.webview.currentWebview().close();
								},1000);
    						}else{
    							mui.toast('发布失败，请重试！');	
    						}
    						
    					}else{
    						plus.nativeUI.closeWaiting();//关闭等待框
    						mui.toast('当前网络不好，请重试！');	
    					}
    				}
		        } 
		        xhr.setRequestHeader("token",oldtoken);
		        xhr.send(fd);
			})
		}
	})
</script>

</html>