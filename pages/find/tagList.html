<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>赞的</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css"> 
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css" />
		<link rel="stylesheet" href="../../css/reset.css"> 
		<script type="text/javascript" src="../../js/jquery.min.js"></script>  
		<script src="../../js/mui.min.js"></script> 
		<script src="../../js/app.js"></script>
		<!--引入模板引擎-->
		<script src="../../js/artTemplate-native.js"></script>
		<style type="text/css">
			 
			 .fTxt{
			 	font-size: 0.11rem;
			 	padding: 5px;
			 	color: rgba(0,0,0,0.8);
			 	height: 0.32rem;
			 	letter-spacing: 1px;
			 	line-height: 1.2;
			 	/*超出两行省略*/
			 	display: -webkit-box;
				-webkit-box-orient: vertical;
				-webkit-line-clamp: 2;
				overflow: hidden;

			 }
			 .findUser{
			 	padding: 5px;
			 }
			 .findUser img{
			 	width: 0.3rem!important;
			 	height: 0.3rem;
			 	border-radius: 50%!important;
			 	margin-right: 5px;
			 	/*vertical-align: middle!important;*/
			 } 
			 .findUser span{
			 	color: rgba(0,0,0,0.6);
			 	line-height: 0.3rem;
			 }
			 #mainpic {
			 	/*background-color: rgba(255,255,255,0.7);*/
			 	-webkit-column-count: 2;
			 	-moz-column-count: 2;
			 	column-count: 2;
			 	-moz-column-gap: 10px;
			 	-webkit-column-gap: 10px;
			 	column-gap:10px;
			 	padding: 10px;
			 }
			 
			 .boxf {
			 	-webkit-column-break-inside: avoid;
			 	border:none; 
			 	margin-bottom: 10px;
			 	cursor: pointer;
			 }
			 
			 .boxf img {
			 	width: 100%;
			 	vertical-align: top;
			 	border-radius: 2px;
			 }
			 
			 @media (min-width: 600px) {
			 	#mainpic {
			 		-webkit-column-count: 5;
			 		-moz-column-count: 5;
			 		column-count: 5;
			 	}
			 }
			 
			 @media (min-width: 1000px) {
			 	#mainpic {
			 		-webkit-column-count: 7;
			 		-moz-column-count: 7;
			 		column-count: 7;
			 	}
			 }
			 /*加载*/
			
			#upload {
				text-align: center;
				font-size: 15px;
				line-height: 30px;
				min-height: 40px;
			}
			
			#upload img {
				width: 60px;
				margin-top: -10px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" id="header"> 
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
		    <h1 class="mui-title"></h1>
		    <!--<a href="javascript:;" style="line-height: 50px;color:white;" class="fr baocun">发布</a>-->
		</header>
		<script src="../../js/statusBar.js"></script>
		<!--状态栏-->
		<!--<div id="container">-->
		<div id="main">
			 
			<div id="tagNews"></div>
			<script type="text/html" id="tagNewTpl">
				<div id="mainpic">
					<%for(var i=0;i<recommendData.length;i++){%>
						<div class="boxf" onclick="findInfo('<%=recommendData[i].news_id%>','<%=recommendData[i].news_id%>','<%=myUrl%><%=recommendData[i].avatar[0].picImg%>','<%=recommendData[i].nickname%>')">
							<div class="pic">
								<%if(recommendData[i].pic){%>
									<img src="<%=recommendData[i].pic%>">
									<%}else{%>
										<img src="../../img/market/nodata.svg" alt="" />
										<%}%> 
								<div class="findUser">
									<%if(recommendData[i].avatar){%>
									<img src="<%=myUrl%><%=recommendData[i].avatar[0].picImg%>" alt="" />
									<%}else{%>
										<img src="../../img/10.png" alt="" />
										<%}%>
										<%if(recommendData[i].nickname){%>
										<span><%=recommendData[i].nickname%></span> 
										<%}else{%>
											<span>匿名</span>
										<%}%>
								</div>
							</div>
						</div>
					<%}%>
				</div>
			</script>
	 		 
			<div class="upload text-center text-xs gray" id="upload"></div>
	</body>
    <script type="text/javascript">
    	function findInfo(userid,newsid,avtar,nickname){
    		if(newsid){
    			openview({
					view: "findInfo.html",
					id:"findInfo",
					extrasobj: {
						userId: userid,newsId:newsid,avtar:avtar,nickName:nickname
					}
				})
    		}
    		
    	}
        
        mui.plusReady(function(){
        	var tag = plus.webview.currentWebview().tag;
        	$(".mui-title").html(tag)
        	var tagId = plus.webview.currentWebview().tagId;
        	var oldtoken = plus.storage.getItem('oldToken');
        	
        	var Spagenum = 2; //实到页数
			var Ypagenum = 1; //应到页数  
			
        	 //根据标签 请求 贴
        	 var currentPage = 1,numsPerPage = 10;
        	 mui.ajax(serverUrl+"/api/news/tagtonews",{
    			data:{currentPage:currentPage,numsPerPage:numsPerPage,tagid:tagId},
        		dataType:'json',
				type:'post',
				timeout:10000,
				headers:{"token":oldtoken},	 
				success:function(data,type,xhr){
					
					if(data.errno == 0) { 
						var dataobj = data.data.data; 
						alert(JSON.stringify(data));
						if(dataobj.length != 0){
							for(var i=0;i<dataobj.length;i++){
								if(dataobj[i].avatar && typeof(dataobj[i].avatar) ==={}){
									dataobj[i].avatar = JSON.parse(dataobj[i].avatar) 
								}
							}
						} 
						var recommendObj = {};
						recommendObj.myUrl = serverimgUrl;
						recommendObj.recommendData = dataobj;
						document.getElementById("tagNews").innerHTML = template("tagNewTpl", recommendObj);
						mui("#upload")[0].innerHTML = ""; 
						//上滑加载
						$(window).scroll(function() {　　
							var scrollTop = $(this).scrollTop();　　
							var scrollHeight = $(document).height();　　
							var windowHeight = $(this).height();　　
							if(scrollTop + windowHeight == scrollHeight) {
								if(Spagenum <= data.data.totalPages && Spagenum == Ypagenum + 1) { //当前页小于等于总页数时请求下一页
									mui("#upload")[0].innerHTML = "<img src='../../img/balls.svg' />";
									Ypagenum++; //满足加载情况,应到页数+1
									console.log('发起请求,实到' + Spagenum + '页');
									console.log('发起请求,应到' + Ypagenum + '页');
									mui.ajax(serverUrl + '/api/news/tagtonews', {
										data:{currentPage:Spagenum,numsPerPage:numsPerPage,tagid:tagId},
						        		dataType:'json',
										type:'post',
										timeout:10000,
										headers:{"token":oldtoken},	 
										success:function(data,type,xhr){  
											if(data.errno == 0) {
												var dataobj = data.data.data
												if(dataobj.length != 0){
													for(var i=0;i<dataobj.length;i++){
														if(dataobj[i].avatar && typeof(dataobj[i].avatar) =={}){
															dataobj[i].avatar = JSON.parse(dataobj[i].avatar)
														}
													}
												}  
												var recommendObj = {}
												recommendObj.myUrl = serverimgUrl;
												recommendObj.recommendData = dataobj
												document.getElementById("tagNews").innerHTML += template("tagNewTpl", recommendObj);
											}
											mui("#upload")[0].innerHTML = "";
											Spagenum++; //加载成功,当前页+1
											console.log('成功+1,实到' + Spagenum);
											console.log('成功+1,应到' + Spagenum);
										},
										error: function(xhr, type, errorThrown) {
											Ypagenum--; //失败是应到-1
											mui.toast("当前网络不好请重试");
											mui("#upload")[0].innerHTML = "";
										}
									});
								} else if(Spagenum == data.data.totalPages + 1) { //当前页不小于等于总页数时请求下一页
									mui("#upload")[0].innerHTML = "到底了";
								}
							}
						});
					} else {
						mui("#upload")[0].innerHTML = "";
					}
					plus.nativeUI.closeWaiting(); //关闭等待框
				},
				error:function(xhr,type,errorThrown){
					plus.nativeUI.closeWaiting(); 
					mui("#upload")[0].innerHTML = "";
					console.log('响应失败  !');
				}
				 
        	})
        })
        
        
    </script>
</html> 