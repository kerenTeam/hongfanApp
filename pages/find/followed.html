<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>粉丝</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no"> 
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css" />
		<link rel="stylesheet" href="../../css/reset.css">
		<link rel="stylesheet" href="../../css/one.css">
		<link rel="stylesheet" type="text/css" href="../../css/find.css" />
		
	</head>
	<style type="text/css">
            .userAvator{  
				width: 0.4rem;  
				height: 0.4rem;  
				border-radius: 50%;
				margin-right: 10px;
			}
			 .follow{
				position: relative;
				background-color: white;
				text-align: center;
				display: flex;
				align-items: center;
				padding:8px 15px;
				justify-content: space-between;
			} 
			 
			 .follow:after{
			 	position: absolute;
			 	content: '';
			 	height: 1px;
			 	left: 10px;
			 	right: 10px;
				-webkit-transform: scaleY(.5);
				background: #F0F0F0;
				bottom: 0;
			 }
			.follow button{
				font-size: 0.12rem;
				height: 0.28rem;
				width: 0.7rem; 
			}
			
			.fchidl>div{
				color: darkgray;
			}
			 
			
		 
	</style>

	<body>

		<header class="mui-bar mui-bar-nav">
		    <a class="headbar mui-action-back mui-icon mui-icon-left-nav mui-pull-left normalSize"></a>
		    <h1 class="mui-title" id="confirmbtn1">粉丝</h1> 
		</header>
		<script src="../../js/statusBar.js"></script>
		<!--状态栏-->
		<!--<div id="container">-->
		<div id="nulldiv" style="padding-top: 50%;text-align:center;font-size: 14px;color: #999;display: none;">
			<img style="width: 30%;margin-bottom: 5%; " src="../../img/unllfabu.svg"/>
			<br />
			没有可用信息
		</div>
		<div id="main">
			<!--<div class="follow">
				<div class="fchidl">
					<img src="../../img/market/atcenter.jpg" class="userAvator" /> 到底发生的
				</div>
				<button type="button" class="mui-btn mui-btn-success mui-btn-outlined eachF hadF">
					互相关注
				</button>
			</div>-->
		</div>
		<script type="text/html" id="infolist"> 
			<% for(var i=0; i<list.length; i++){%>
				<div class="follow">
					<!--这里的注释删不得-->
					<!--//mui-btn-outlined 已关注--> 
					<!--//mui-btn-outlined eachF 互相关注-->
					<!--//eachF (是粉丝的)关注-->
					<div class="fchidl" onclick="maninfo(<%= list[i].user_id%>,'<%= list[i].status%>')">
						<%if(!list[i].avatar){ %>
							<img src="../../img/market/atcenter.jpg" class="userAvator" /> 
						<%}else{ %>
							<img src="<%= url + list[i].avatar%>" class="userAvator" />
						<%} %>	
						<%= list[i].nickname%>
					</div>
					<% if(list[i].status != 'own1'){%>
						<% for(var j=0; j<myfollow.length; j++){%>
							<% if(myfollow[j] == list[i].user_id){%>
								<button type="button" onclick="followBack(this,<%= list[i].user_id%>)" class="mui-btn mui-btn-success hadF   mui-btn-outlined eachF">
									互相关注
								</button>
								<% break;%>
							<% }%>
							<% if(j == myfollow.length-1){%>
								<button type="button" onclick="followBack(this,<%= list[i].user_id%>)" class="mui-btn mui-btn-success hadF  eachF">
									关注
								</button> 
							<% }%>	
						<% }%>	
					<% }%>	
				</div>
			<% }%>	
		</script>
		<script type="text/html" id="infolist2"> 
			<% for(var i=0; i<list.length; i++){%>
				<div class="follow">
					<div class="fchidl" onclick="maninfo(<%= list[i].user_id%>,'<%= list[i].status%>')">
						<%if(!list[i].avatar){ %>
							<img src="../../img/market/atcenter.jpg" class="userAvator" /> 
						<%}else{ %>
							<img src="<%= url+list[i].avatar%>" class="userAvator" />
						<%} %>	
						<%= list[i].nickname%>
					</div>
					<% if(list[i].status == 'own1'){%>
						<button type="button" style="display: none;" onclick="followBack(this,<%= list[i].user_id%>)" class="mui-btn mui-btn-success hadF   ">
							+关注
						</button>
					<% }else if(list[i].status == 'own2'){%>
						<button type="button" onclick="followBack(this,<%= list[i].user_id%>)" class="mui-btn mui-btn-success hadF   mui-btn-outlined">
							已关注
						</button>
					<% }else if(list[i].status == 'own3'){%>
						<button type="button" onclick="followBack(this,<%= list[i].user_id%>)" class="mui-btn mui-btn-success hadF   ">
							+关注
						</button>
					<% }else if(list[i].status == 'own4'){%>
						<button type="button" onclick="followBack(this,<%= list[i].user_id%>)" class="mui-btn mui-btn-success hadF   mui-btn-outlined eachF ">
							互相关注
						</button>
					<% }else{%>
						<button type="button" onclick="followBack(this,<%= list[i].user_id%>)" class="mui-btn mui-btn-success hadF   eachF">
							+关注
						</button>
					<% }%>	
				</div>
			<% }%>	
		</script>
		
		 
	</body>
<script type="text/javascript" src="../../js/jquery.min.js"></script>
<script src="../../js/mui.min.js"></script>
<script src="../../js/app.js"></script>
<!--引入模板引擎-->
<script src="../../js/artTemplate-native.js"></script>	
<script type="text/javascript">
	
	mui.plusReady(function(){
		console.log(plus.webview.currentWebview().id);
		var oldtoken = plus.storage.getItem('oldToken');
		var myuserid = plus.webview.currentWebview().idnum;
		var useridnow = plus.storage.getItem('userid');
		var other = plus.webview.currentWebview().type;
		plus.nativeUI.showWaiting('加载中 ...',{width:'100px',height:'80px'});
		downRe(againfun);
		againfun();
		function againfun(){
			
			if(other){//是他人的关注页 
				mui.ajax(serverUrl+'/api/news/myfollow',{
				data:{"userid":myuserid},
				dataType:'json',
				type:'post',
				timeout:10000,
				headers:{"token":oldtoken},
				success:function(data,type,xhr){
					console.log('关注返回',data);
					if(data.errno==0){
						if (data.data.followMe.length) {//铺数据
							var followme = [];
							if(data.data.followMe.length){
								//请求当前用户信息
								mui.ajax(serverUrl+'/api/news/myfollow',{
									data:{"userid":useridnow},
									dataType:'json',
									type:'post',
									timeout:10000,
									headers:{"token":oldtoken},
									success:function(data1,type,xhr){ 
										console.log('关注返回1',data1);
										if(data1.errno==0){
											//遍历给出自己和他人关注列表的关系
											var followFlag = false;//我没关注他
											mui.each(data.data.followMe,function (index,element) {
												if (element.avatar && element.avatar != " ") {
													if (element.avatar.indexOf("picImg")>-1) {
														element.avatar = JSON.parse(element.avatar)[0].picImg;
													}	
												}
												if(data1.data.myFollow.length){//判断我是否关注他
													mui.each(data1.data.myFollow,function (index1,element1) {
														if(element.user_id == element1.user_id){//我关注了他
															element.status = 'own2';//我关注他,他没关注我 =》已关注
															followFlag = true;
															return false;
														}
														if (index1 == data1.data.myFollow.length -1) {//没关注他
															element.status = 'own3';//我没关注他,他没关注我 =》'mui-btn mui-btn-success hadF  +关注（不是粉丝）'
														}
													})
												}
												if(data1.data.followMe.length){
													mui.each(data1.data.followMe,function (index2,element2) {
														if (element.user_id == element2.user_id) {//他关注了我  
															if (followFlag) {
																element.status = 'own4';//=》互相关注 
															}else{
																element.status = 'own5';//=》+关注 （是粉丝） 
															}
															return false;
														}
													})
												}
												//是否是自己
												if(element.user_id == useridnow){
													element.status = 'own1';
												}
											})
											
											var dataobj = {};
											dataobj.url = serverimgUrl;
											dataobj.list = data.data.followMe; 
											var html=template("infolist2",dataobj);
											document.getElementById("main").innerHTML = html;	
											plus.nativeUI.closeWaiting(); 
										}else{
											plus.nativeUI.closeWaiting();
											mui('#nulldiv')[0].style.display = 'block';
											mui.toast('当前网络不好，请重试！');	
										}
									},
									error:function(xhr,type,errorThrown){
										plus.nativeUI.closeWaiting();
										mui('#nulldiv')[0].style.display = 'block';
										mui.toast('当前网络不好，请重试！');
										console.log('登录响应失败');
									}
								});						
								
							} 
							
						} else{//没有数据
							mui('#nulldiv')[0].style.display = 'block';
						}
					}else{
						plus.nativeUI.closeWaiting();
						mui('#nulldiv')[0].style.display = 'block';
						mui.toast('当前网络不好，请重试！');	
					}
				},
				error:function(xhr,type,errorThrown){
					plus.nativeUI.closeWaiting();
					mui('#nulldiv')[0].style.display = 'block';
					mui.toast('当前网络不好，请重试！');
					console.log('登录响应失败');
				}
			});
			}else{
				mui.ajax(serverUrl+'/api/news/myfollow',{
					data:{"userid":myuserid},
					dataType:'json',
					type:'post',
					timeout:10000,
					headers:{"token":oldtoken},
					success:function(data,type,xhr){
						console.log('关注返回',data); 
						if(data.errno==0){
							if (data.data.followMe.length) {//铺数据
								var myfollow = [];
								if(data.data.followMe.length){
									mui.each(data.data.myFollow,function (index,element) {
										myfollow.push(element.user_id);
									})
									mui.each(data.data.followMe,function (index,element) {
										if (element.avatar && element.avatar != " ") {
											if (element.avatar.indexOf("picImg")>-1) {
												element.avatar = JSON.parse(element.avatar)[0].picImg;
											}	
										} 
										//是否是自己
										if(element.user_id == useridnow){
											element.status = 'own1';
										}
									})
								}
								var dataobj = {};
								dataobj.url = serverimgUrl;
								dataobj.list = data.data.followMe;
								dataobj.myfollow = myfollow;
								var html=template("infolist",dataobj);
								document.getElementById("main").innerHTML = html;
							} else{//没有数据
								mui('#nulldiv')[0].style.display = 'block';
							}
							plus.nativeUI.closeWaiting();
						}else{
							plus.nativeUI.closeWaiting();
							mui('#nulldiv')[0].style.display = 'block';
							mui.toast('当前网络不好，请重试！');	
						}
					},
					error:function(xhr,type,errorThrown){
						plus.nativeUI.closeWaiting();
						mui('#nulldiv')[0].style.display = 'block';
						mui.toast('当前网络不好，请重试！');
						console.log('登录响应失败');
					}
				});
			}	
		}
	})
	function maninfo(id,type){
		if (type == 'own1') {
			openview({
				view:'../centerPage.html',
				id:'centerPage',
				extrasobj:{idnum:id}
			});
		}else if(type){//他人关注列表里 打开 他人主页
			openview({
				view:'../othersPage.html',
				id:'othersPage',
				create:true,
				extrasobj:{idnum:id}
			});
		} else{
			openview({
				view:'../othersPage.html',
				create:true,
				id:'othersPage',
				extrasobj:{idnum:id}
			});
		}
	}

</script>
</html>