<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>发现详情</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css" />
		<link rel="stylesheet" href="../../css/reset.css">
		<link rel="stylesheet" href="../../css/one.css">
		<!--<link rel="stylesheet" type="text/css" href="../../css/find.css"/>-->
		<script type="text/javascript" src="../../js/jquery.min.js"></script>  
		<script src="../../js/mui.min.js"></script> 
		<script src="../../js/app.js"></script>
		<!--引入模板引擎-->
		<script src="../../js/artTemplate-native.js"></script>
		<style type="text/css">
		.comment{ 
			/*padding-bottom: 20px;*/
		}
		 	 .heart {
				background:url(../../img/market/web_heart_animation.png);
				background-position:left;
				background-repeat:no-repeat;
				height:60px;
				width:60px;
				cursor:pointer;
				position:absolute;
				left:-14px;
				top: -10px;
				background-size:2900%;
			}
			.innerheart{
				height:56px;
				width:50px;
				display: inline-block;
			    left: -36px;
			    top: -21px; 
			} 
			#main {
				background-color: white!important;
			}
			
			img {
				width: 100%;
			}
			
			.txtinfo {
				background-color: white;
				padding: 5px 10px;
				line-height: 1.4;
				letter-spacing: 1px;
			}
			
			.mark {
				color: coral;
				margin: 0 2px;
			}
			
			.view {
				padding: 5px 15px;
				color: gray;
			}
			
			.view span {
				color: lightgray;
				font-size: 20px;
			}
			
			.looker {
				overflow: hidden;
				padding: 8px;
				white-space: nowrap;
			}
			
			.looker li {
				display: inline-block;
				border: 1px solid lightgray;
				border-radius: 50%;
				padding: 1px;
				overflow: hidden;
				width: 0.38rem;
				height: 0.38rem;
				margin: 4px;
				text-align: center;
			}
			
			.looker li:last-child {
				color: white;
				line-height: 0.35rem;
				background: lightgray;
			}
			
			.looker li img {
				border-radius: 50%;
				width: 100%;
				height: 100%;
			}
			
			.noComment {
				margin: auto;
				width: 1rem;
				text-align: center;
			}
			
			.noComment p {
				padding: 0.1rem 0 0.2rem;
				font-size: 12px;
			}
			
			.commentNums {
				padding: 15px 0;
				text-align: center;
				background: #EEEEEE;
			}
			
			.oa-contact-cell.mui-table .mui-table-cell {
				padding: 11px 0;
				vertical-align: middle;
			}
			
			.oa-contact-cell {
				position: relative;
				margin: -11px 0;
			}
			
			.oa-contact-avatar {
				width: 35px;
				height: 35px!important;
			}
			
			.oa-contact-avatar img {
				border-radius: 50%;
				height: 35px;
			}
			
			.oa-contact-content {
				width: 100%;
			}
			
			.oa-contact-name {
				font-size: 14px;
				margin-right: 20px;
			}
			
			.oa-contact-name{
				float: left;
			}
			
			.comment .mui-table-view-cell:after {
				height: 0px!important;
				-webkit-transform: none;
				background-color: none;
			}
			
			.cheader {
				position: relative;
			}
			
			.cheader img {
				position: absolute;
				top: 5%;
			}
			
			.oaright {
				position: relative;
				left: 15px;
			}
			
			.oaright:after {
				position: absolute;
				right: 0;
				bottom: 0;
				content: '';
				left: 0;
				height: 1px!important;
				-webkit-transform: scaleY(0.5);
				background-color: #eee;
			}
			.oaright p {
				word-break: break-all;
				color: rgba(0, 0, 0, 0.6);
				font-size: 13px;
				padding-top: 5px;
				line-height: 1.5;
			}
			
			.ifcmt {
				padding-bottom: 40px;
			}
			
			.cocmt {
				width: 97%;
				background-color: whitesmoke;
				padding: 5px;
				border-radius: 5px;
				margin: 10px 0;
			}
			
			.cocmt span {
				color: skyblue;
			}
			
			.cocmt p:last-child {
				color: skyblue;
			}
			
			.ctime {
				font-size: 10px;
				color: #C0C0C0;
				margin-top: 5px;
			}
			
			.mui-table-view-cell.mui-active {
				background-color: none!important;
			}
			
			.cmtinput {
				position: fixed;
				bottom: 0;
				left: 0;
				height: 40px;
				display: table;
				width: 100%;
				background-color: whitesmoke;
			}
			
			.cmtinput>div {
				display: table-cell;
			}
			
			.inputmn {
				position: relative;
				background-color: white;
				color: gray;
				width: 80%;
			}
			
			.innerInput {
				margin: 10px!important;
				line-height: 20px;
				border-left: 2px solid palevioletred;
			}
			.inputmn img{
				position: absolute;
				width: 30px;
				top: 50%;
				margin-top: -15px;
				right: 0;
				height: 30px;
			}
			@media (max-width: 340px) {
				.looker li {
					width: 0.32rem;
					height: 0.32rem;
				}
				.looker li:last-child {
					line-height: 0.32rem;
				}
			}
			
			@media (min-width: 400px) {
				.looker li {
					width: 0.42rem;
					height: 0.42rem;
				}
				.looker li:last-child {
					line-height: 0.42rem;
				}
			}
			
			.heart:hover,
			.heart:focus {
				background-position: right;
			}
			
			@-webkit-keyframes heartBlast {
				0% {
					background-position: left;
				}
				100% {
					background-position: right;
				}
			}
			
			@keyframes heartBlast {
				0% {
					background-position: left;
				}
				100% {
					background-position: right;
				}
			}
			
			.heartAnimation {
				display: inline-block;
				/*-webkit-animation-name: heartBlast;
				animation-name: heartBlast;*/
				-webkit-animation-duration: .1s;
				animation-duration: .1s;
				-webkit-animation-iteration-count: 1;
				animation-iteration-count: 1;
				-webkit-animation-timing-function: steps(28);
				animation-timing-function: steps(28);
				background-position: right;
			}
			
			.feed p {
				font-family: "Microsoft YaHei", 'Georgia', Times, Times New Roman, serif;
				font-size: 25px;
			}
			.toinner{
				color: cornflowerblue;
			}
			.feed {
				margin-bottom: : 20px;
				position: relative;
			}
			
			.likeCount {
				font-size: 12px;
				display: inline-block;
				color: #999999;
				vertical-align: middle1!important;
			}
			
			.oaright:after {
				position: absolute;
				right: 0;
				bottom: 0;
				content: '';
				left: 0;
				height: 1px!important;
				-webkit-transform: scaleY(0.5);
				background-color: #ccc;
			}
			 
			.oaf:after{
				position: absolute;
				right: 0;
				bottom: 0;
				content: '';
				left: 0;
				height: 0px!important;
				-webkit-transform: none!important;
				background-color: #ccc;
			}
			.innerCml .cheader img{
				width: 30px;
				height: 30px;
			}
			.allc{
				background: whitesmoke;
				padding: 10px 20px;
				border-bottom: 1px solid white;
			}
			</style>
		</head>
	
		<body>
			<header class="mui-bar mui-bar-nav" id="header"> 
			    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
			    <h1 class="mui-title findUser">所有回复</h1>
			    <!--<a href="javascript:;" style="line-height: 50px;color:white;font-size: 25px;" class="fr baocun">+</a>-->
			</header>
			<script src="../../js/statusBar.js"></script>
			<!--状态栏-->
			<!--<div id="container">-->
			<div id="main">
			 
					<!--有评论-->
					<div class="comment"> 
						<div id="cmtAll"></div>
						<script type="text/html" id="cmtTpl">
							<ul class="mui-table-view-striped mui-table-view-condensed" style="padding: 20px 0;">
							 
								<%for(var i =cmtData.length-1;i>=0;i--){%>
									<%if(cmtData[i].to_commit_id == 0){%>
										<li class="mui-table-view-cell cmlist" data-fromUserId="<%=cmtData[i].from_user_id%>" data-commitId="<%=cmtData[i].id%>">
											<div class="mui-slider-cell">
												<div class="oa-contact-cell mui-table">
													<div class="oa-contact-avatar mui-table-cell cheader"> 
														<%if(cmtData[i].avatar){%>
														 <img src="<%=myUrl%><%=cmtData[i].avatar[0].picImg%>" onclick="gocmterPage('<%=cmtData[i].from_user_id%>')"/>
														<%}else{%>
															<img src="../../img/10.png" onclick="gocmterPage('<%=cmtData[i].from_user_id%>')"/>
															<%}%>
													</div>
													<div class="oa-contact-content mui-table-cell oaright oaf">
														<div class="mui-clearfix">
															<h4 class="oa-contact-name"><%=cmtData[i].nickname%></h4>
															<span class="mui-pull-right orp" data-friend_news_id="<%=cmtData[i].friend_news_id%>" data-to_user_id="<%=cmtData[i].from_user_id%>" data-to_commit_id="<%=cmtData[i].id%>"><img src="../../img/market/repeat.svg" style="width: 15px;margin:0 15px 0 10px;"/></span>
															<div class="feed mui-pull-right" id="feed<%=i+1%>">
																		<%if(cmtData[i].isLike == 1){%>
																			<!--红心状态-->
																			<div class="heart innerheart heartAnimation" id="like<%=i+1%>" data-id="<%=cmtData[i].id%>" rel="unlike"></div>
																		<%}else{%>
																			<div class="heart innerheart" id="like<%=i+1%>" data-id="<%=cmtData[i].id%>" rel="like"></div>
																			<%}%> 
																<div class="likeCount" id="likeCount<%=i+1%>">
																	<%if(cmtData[i].likeNums){%>
																	     <%=cmtData[i].likeNums%>
																	<%}%>
																</div>
															</div>
														</div>
				
														<div class="oa-contact-position mui-h6 ctime"><%=cmtData[i].create_time_as%></div>
														<p class="oa-contact-email mui-h6">
															<%=cmtData[i].content%>
														</p>
														 
													</div>
												</div>
											</div>
										</li>
										<%}%> 
										
								<%}%>
								 
							</ul>
						</script>
						
						<!--回复评论-->
						<div id="allRP"></div>
						<script type="text/html" id="allRPTple">
							<p class="allc">评论<span class="mui-pull-right"><%=innercmtData.length%>条</span></p>
							<ul class="mui-table-view-striped mui-table-view-condensed" style="background-color: whitesmoke;padding: 20px;">
								<%for(var i =innercmtData.length-1;i>=0;i--){%>
									<li class="mui-table-view-cell cmlist innerCml orp" data-friend_news_id="<%=innercmtData[i].friend_news_id%>" data-to_user_id="<%=innercmtData[i].from_user_id%>" data-to_user_nickname="<%=innercmtData[i].nickname%>" data-to_commit_id="<%=innercmtData[i].id%>">
										<div class="mui-slider-cell">
											<div class="oa-contact-cell mui-table">
												<div class="oa-contact-avatar mui-table-cell cheader">
													<%if(innercmtData[i].avatar){%>
														 <img src="<%=myUrl%><%=innercmtData[i].avatar[0].picImg%>" onclick="gocmterPage('<%=innercmtData[i].from_user_id%>')"/>
														<%}else{%>
															<img src="../../img/10.png" onclick="gocmterPage('<%=innercmtData[i].from_user_id%>')"/>
															<%}%>
												</div>
												<div class="oa-contact-content mui-table-cell oaright">
													<div class="mui-clearfix">
														<h4 class="oa-contact-name"><%=innercmtData[i].nickname%></h4>
														<div class="feed mui-pull-right" id="feed<%=i+1%>">
																	<%if(innercmtData[i].isLike == 1){%>
																		<!--红心状态-->
																		<div class="heart innerheart heartAnimation" id="like<%=i+1%>" data-id="<%=innercmtData[i].id%>" rel="unlike"></div>
																	<%}else{%>
																		<div class="heart innerheart" id="like<%=i+1%>" data-id="<%=innercmtData[i].id%>" rel="like"></div>
																		<%}%> 
															<div class="likeCount" id="likeCount<%=i+1%>">
																<%if(innercmtData[i].likeNums){%>
																     <%=innercmtData[i].likeNums%>
																<%}%>
															</div>
														</div>
													</div>
			 
													<div class="oa-contact-position mui-h6 ctime"><%=innercmtData[i].create_time_as%></div>
													<%if(innercmtData[i].p_commit_id){%>
														<p class="oa-contact-email mui-h6">
															回复<span class="toinner">@<%=innercmtData[i].to_user_id%></span>:<%=innercmtData[i].content%>
														</p> 
														<%}else{%>
															<p class="oa-contact-email mui-h6">
																<%=innercmtData[i].content%>
															</p> 
														<%}%>
													
													
												</div>
											</div>
										</div>
									</li> 
								<%}%>
							</ul>
						</script>
						
					</div>
			 
				
		 	
		 	    <!--评论输入框-->
		 	    <!--<div class="cmtinput">
		 	    	<div class="inputmn orp"><div class="innerInput">发射评论~</div><img src="../../img/keyboard.svg" alt="" /></div>
		 	    	<div class="feed" id="feed1"> 
						<div class="heart " id="like1" rel="like"></div> <div class="likeCount" style="visibility: hidden;" id="likeCount1">14</div>
					</div>
					 
		 	    	<div class="sharef" style="position: relative;">
		 	    		<img src="../../img/market/sharef.png" style="width: 20px;position: absolute;top: 10px;right: 10px;"/>
		 	    	</div>
		 	    </div>-->
		 	    
				
		</div>	
			
	</body>
    <script type="text/javascript">
    	
    	
    	mui.init({
			beforeback: function() { 
				//获得列表界面的webview
				var list = plus.webview.getWebviewById('findInfo'); 
					mui.fire(list,'refreshCmt');
					return true;
			}
		});
    	
    	mui.plusReady(function(){
    		var oldtoken = plus.storage.getItem('oldToken');
			var newsId = plus.webview.currentWebview().newsId;
			var news_userId = plus.webview.currentWebview().userId;
			var avtar = plus.webview.currentWebview().avtar;
			var nickName = plus.webview.currentWebview().nickName;
			var myuserid = plus.storage.getItem('userid');
			var innercmtid = plus.webview.currentWebview().innercmtid
//			评论者主页
//			window.gocmterPage = function(userId){
//	    		event.stopPropagation()
//		    	if(userId == myuserid){
//		    		openview({
//						view: "../centerPage.html",
//						extrasobj: {
//							userId: userId
//						}
//					})
//		    	}else{
//		    		openview({
//						view: "../othersPage.html",
//						extrasobj: {
//							userId: userId
//						}
//					})
//		    	}
//		    		
//	    	}  
			window.addEventListener('refreshCmt',function(event){ 
				getCmt(); 
			});
			//取得评论信息 用于news详细 和评论详细
    		getCmt();
    		function getCmt(){ 
				mui.ajax(serverUrl+"/api/news/newscommit",{
	    			data:{newsid:newsId,userid:myuserid},
	        		dataType:'json',
					type:'post',
					timeout:10000,
					headers:{"token":oldtoken},	 
					success:function(data,type,xhr){ 
								console.log(data)
						if(data.errno == 0) { 
							if(data.data){ 
								var dataobj = data.data;
								var newdata = [],innerData=[];
								for(var i=0;i<dataobj.commit.length;i++){
									
									
									
									dataobj.commit[i].news_userid = news_userId; 
									if(!dataobj.commit[i].nickname){
										dataobj.commit[i].nickname = "匿名"
									}else{
										 
										if(/^(\(\d{3,4}\)|\d{3,4}-|\s)?\d{7,14}$/.test(dataobj.commit[i].nickname)){
											dataobj.commit[i].nickname = dataobj.commit[i].nickname.substring(0,3)+"****"+dataobj.commit[i].nickname.substring(7,11)
										}
									}
									
									if(dataobj.commit[i].avatar){
										dataobj.commit[i].avatar = JSON.parse(dataobj.commit[i].avatar)
									}
									
//									dataobj.commit[i].create_time_as = formatDate(dataobj.commit[i].create_time_as, "yyyy.MM.dd hh:mm:ss")
									var dt = new Date(dataobj.commit[i].create_time_as);
										var date = [
										  [dt.getFullYear(), dt.getMonth() + 1, dt.getDate()].join('-'),
										  [dt.getHours(), dt.getMinutes(), dt.getSeconds()].join(':')
										].join(' ').replace(/(?=\b\d\b)/g, '0'); // 正则补零
										dataobj.commit[i].create_time_as = date
									for(var j=0;j<dataobj.likeNums.length;j++){
										if(dataobj.likeNums[j].field == dataobj.commit[i].id){
											dataobj.commit[i].likeNums = dataobj.likeNums[j].count 
										}
									} 
									dataobj.commit[i].thiscmtid = innercmtid;
									for(var m=0;m<dataobj.My_favorite_comments.length;m++){
										if(dataobj.My_favorite_comments[m].commit_id == dataobj.commit[i].id && dataobj.My_favorite_comments[m].commit_like_user_id == myuserid){
											dataobj.commit[i].isLike = 1; 
										}
									}
									if(innercmtid == dataobj.commit[i].id){
										newdata.push(dataobj.commit[i])
									}
									if((dataobj.commit[i].p_commit_id && dataobj.commit[i].p_commit_id == innercmtid) || dataobj.commit[i].to_commit_id == innercmtid){
										innerData.push(dataobj.commit[i])
									}
								} 
								var commentObj = {};
								commentObj.myUrl = serverimgUrl;
								commentObj.cmtData = newdata;
								commentObj.innercmtData = innerData;
								document.getElementById("cmtAll").innerHTML = template("cmtTpl", commentObj);
								document.getElementById("allRP").innerHTML = template("allRPTple", commentObj);
								
								var cmlist = document.getElementsByClassName("cmlist");
								
								//点赞 
								$('.comment .heart').on("click",function(){ 
									event.stopPropagation()
									var A=$(this).attr("id"); 
									var B=A.split("like"); 
									var messageID=B[1];
									var C=parseInt($("#likeCount"+messageID).html());
									if(!C){
										C=0;
									}
									$(this).css("background-position","")
									var commitid= $(this).attr("data-id"); 
									var D=$(this).attr("rel");
									if(D === 'like') {
										$("#likeCount"+messageID).html(C+1);
										$(this).addClass("heartAnimation").attr("rel","unlike"); 
										
										//点赞评论 
										likeCmt(commitid,myuserid,oldtoken);
										mui.toast("点赞成功")
									}
									else{  
										
										//取消点赞评论
										likeCmt(commitid,myuserid,oldtoken) 
										mui.toast("取消点赞")
										var nowLm = C-1;
										if(nowLm == 0){
											nowLm ='';
										}
										$("#likeCount"+messageID).html(nowLm);
										$(this).removeClass("heartAnimation").attr("rel","like");
										$(this).css("background-position","left");
										
									}
									
									
								});
								
								//回复跳转 
								$(".orp").click(function(){ 
									//被评人id
									var to_user_id = $(this).attr("data-to_user_id") 
									//被评论的评论id
									var to_commit_id = $(this).attr("data-to_commit_id")  
									var to_user_name = $(this).attr("data-to_user_nickname")
									//帖子id
									var friend_news_id = $(this).attr("data-friend_news_id") 
									if($(this).hasClass("innerCml")){
										//父级评论
										var p_commit_id = innercmtid;
									} else{
										var p_commit_id = 0;
									}
									
									mui.openWindow({
									    url:"repComment.html",
									    id:"repComment",
									    show:{ 
									      aniShow:"slide-in-bottom",//页面显示动画，默认为”slide-in-right“；
									      duration:"300"//页面动画持续时间，Android平台默认100毫秒，iOS平台默认200毫秒；
									    },
									     waiting:{
									      autoShow:false,//自动显示等待框，默认为true
									    },
									    extras:{
									    	to_user_id:to_user_id,friend_news_id:friend_news_id,to_commit_id:to_commit_id,p_commit_id:p_commit_id
									    }
									})
								})
				                
							}
			 
						}else{
							document.getElementById("cmtAll").innerHTML = '<p class="commentNums">评论 0</p><div class="noComment"><img src="../../img/nocmt.png" alt="" /><p>快抢沙发吧</p></div>'; 
							
						}
						
						
						
						plus.nativeUI.closeWaiting(); //关闭等待框
					},
					error:function(xhr,type,errorThrown){
						plus.nativeUI.closeWaiting(); 
						console.log('响应失败  !');
					}
					 
	        	})
			}
			
    	})
    	
    	
				
    	
    </script>
</html> 