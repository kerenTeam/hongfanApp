<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>购物车</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />

		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<link rel="stylesheet" type="text/css" href="../css/common.css">
		<link rel="stylesheet" type="text/css" href="../css/index.css">
		<link rel="stylesheet" href="../css/reset.css">

		<link rel="stylesheet" type="text/css" href="../css/cart.css" />

	</head>

	<body>
		<!--header star-->
		<header class="hasManyCity hasManyCitytwo" id="header">
			<div class="header-tit">
				购物车<span class="cartNum">(<span>0</span>)</span>
			</div>
			<a class="fr baocun editAll">编辑</a>
		</header>
		<div style="height:50px;"></div>
		<div id="cartData"></div>
		<script type="text/html" id="cartTpl">
			<%if(cates.length==0){%>
				<mark style='display:block;background:none;text-align:center;color:grey;'>购物车为空！</mark>
				<%}else{%>
					<%for(var i =0;i<cates.length;i++){%>
						<dl class="cart"> 
			<dt><div class="mui-checkbox"><input name="checkbox" class="groupCheck" type="checkbox"></div>
				<div class="shopName"><img class="cartLogo" src="../img/573a7a6742999.png"> <%=cates[i]%></div>
  <a class="edit">| 编辑</a>
 </dt>
 		<%for(var j =0;j<goodsList.length;j++){%>
 			<% if(goodsList[j].shopName ==  cates[i]){%>
			<dd>
				<div class="mui-checkbox"><input name="checkbox" type="checkbox"></div>
				<a class="goodsPic"><img src="<%=goodsList[j].goodsImg%>" /></a>
				<div class="goodsInfor">
					<h2>
    <a><%=goodsList[j].goodsName%></a>
    <span class="num"><%=goodsList[j].goodsNum%></span>
   </h2>
					<div class="priceArea">
						<div class="extraBrief"><%=goodsList[j].goodText%></div>
						<strong>￥<span class="price"><%=goodsList[j].goodsPrice%></span></strong>

					</div>
					<div class="numberWidget">
						<div class="mui-numbox" data-numbox-min='1'>
							<button class="mui-btn mui-btn-numbox-minus" type="button">-</button>
							<input class="mui-input-numbox" value="<%=goodsList[j].goodsNum%>" type="number" />
							<button class="mui-btn mui-btn-numbox-plus" type="button">+</button>
						</div>

					</div>
				</div>
				<a class="delBtn">删除</a>
			</dd>
			<%}%>
			<%}%>
		</dl>
						<%}%>
					<%}%>
		</script>
		

		<!--bottom nav-->
		<div style="height:1rem;"></div>
		<aside class="btmNav">
			<a style="position: relative;">
				<div class="mui-checkbox botCheck"><input name="checkbox" id="totalCheck" type="checkbox"></div>合计：￥<span class="totalMoney">0</span></a>
			<a class="goOrder" style="background:#f53c42;color:white;text-shadow:none;">立即下单<span class="totalVisi">(<span class="totalNum">0</span>)</span>
			</a>
			<a class="delBtnAll" style="background:#ff6910;color:white;text-shadow:none;display: none;">删除</span>
			</a>
		</aside>

		<script type="text/javascript" src="../js/jquery_cart.js"></script>
		<script src="../js/mui.min.js"></script>
		<script src="../js/artTemplate-native.js" type="text/javascript" charset="utf-8"></script>
		 
	</body>
	<script>
	
			mui.init()
	mui.plusReady(function(){
    cartload();
    function cartload(){
    	//购物车 缓存
        var cartStorage =JSON.parse(plus.storage.getItem('$cartStorage')||'[]'); 
        console.log(cartStorage);
//      cartStorage = [{"goodsId":"1","storeid":"1","shopName":"dsd","goodsName":"华为 HUAWEI nova 4GB+64GB版 香槟金（白）移动联通电信4G手机 双卡双待华为 HUAWEI nova 4GB+64GB版 香槟金（白）移动联通电信4G手机 双卡双待","goodsImg":"","goodsPrice":"2","goodsPostfee":"12","goodsNum":3,"goodText":"颜色:黑色; 内存:32G; 运存:3G; 版本:美版; "},{"goodsId":"2","storeid":"1","shopName":"dsd","goodsName":"华为 HUAWEI nova 4GB+64GB版 香槟金（白）移动联通电信4G手机 双卡双待华为 HUAWEI nova 4GB+64GB版 香槟金（白）移动联通电信4G手机 双卡双待","goodsImg":"","goodsPrice":"2","goodsPostfee":"12","goodsNum":3,"goodText":"颜色:黑色; 内存:32G; 运存:3G; 版本:美版; "},{"goodsId":"2","storeid":"2","shopName":"dsddd","goodsName":"华为 HUAWEI nova 4GB+64GB版 香槟金（白）移动联通电信4G手机 双卡双待华为 HUAWEI nova 4GB+64GB版 香槟金（白）移动联通电信4G手机 双卡双待","goodsImg":"","goodsPrice":"2","goodsPostfee":"12","goodsNum":3,"goodText":"颜色:黑色; 内存:32G; 运存:3G; 版本:美版; "}]
       //订单缓存
        var orderStorage =JSON.parse(plus.storage.getItem('$orderStorage')||'[]'); 
        console.log(cartStorage.length+" "+plus.storage.getItem('$cartStorage'));
        console.log(orderStorage.length); 
        var data = {};
			data.goodsList = cartStorage;
			var arr = [];
			for(var i = 0; i < cartStorage.length; i++) {
				arr.push(cartStorage[i].shopName);
			}
			data.cates = arr.unique1();
			 alert('cates' + data.cates);
			var html2 = template('cartTpl', data);
			document.getElementById('cartData').innerHTML = html2;
        mui(".mui-numbox").numbox();
    }
		
        var tipsCont = "<mark style='display:block;background:none;text-align:center;color:grey;'>购物车为空！</mark>"
				//计算购物车数量
			ddAll();

			function ddAll() {
				$(".cartNum span").html($("dd").length);
			}
			//show or hide:delBtn
			$(".edit").toggle(function() {
				$(this).parent().siblings("dd").find(".delBtn").fadeIn();
				$(this).html("完成");
				$(this).parentsUntil("#cartData").find(".numberWidget").show();
				$(this).parentsUntil("#cartData").find(".priceArea").hide();
			}, function() {
				$(this).parent().siblings("dd").find(".delBtn").fadeOut();
				$(this).html("| 编辑");
				$(this).parentsUntil("#cartData").find(".numberWidget").hide();
				$(this).parentsUntil("#cartData").find(".priceArea").show();
			});
			//编辑所有
			$(".editAll").toggle(function() {
				$(".edit,.delBtn").css("display", "none");
				$(".edit").html("| 编辑");
				$(".delBtnAll").css("display", "block");
				$(".goOrder").css("display", "none");
				$(this).html("完成");
				$(".numberWidget").show();
				$(".priceArea").hide();
			}, function() {
				$(".edit").css("display", "block");
				$(".delBtnAll").css("display", "none");
				$(".goOrder").css("display", "block");
				$(this).html("编辑");
				$(".numberWidget").hide();
				$(".priceArea").show();
			});
			//删除 单个
			$(".delBtn").click(function() {
				var curCart = $(this).parentsUntil("#cartData");

				$(this).parent().remove();
				//判断该组商品是否删除完

				if(curCart.find("dd").length == 0) {
					$(curCart).remove();
					if($('.cart').length == 0) {
						$('aside input').attr("checked", false);
						$("body").append(tipsCont);
					}
				}
				ddAll();
				countFuc();

			});
			//删除全部 
			$(".delBtnAll").click(function() {
				var ALLcheckLength = $("dd").find("input[type='checkbox']:checked").length;
				if(ALLcheckLength == 0) {
					mui.toast("您还未选择要删除的商品哦！")
				} else { 
					mui.confirm('确认删除这' + ALLcheckLength + '件商品吗？', '客官', ['取消', '确定'], function(e) {
						if(e.index == 1) {
							var delThis = $("dd").find("input[type='checkbox']:checked").parentsUntil("dl");
							delThis.remove();
							allCart();
							ALLcheckLength = $("dd").find("input[type='checkbox']:checked").length;

							ddAll();
							countFuc();
							if(ALLcheckLength == 0) {
								$('aside input').attr("checked", false);

							}
							if($('dd').length == 0) {
								$("body").append(tipsCont);
							}
							//购物车 缓存
        				//var cartStorage =JSON.parse(plus.storage.getItem('$cartStorage')||'[]');
							plus.storage.removeItem("$cartStorage");
							//alert(plus.storage.getItem('$cartStorage'))
						}

					})
				}

			});
			//遍历 单组下面的商品
			function allCart() {
				$(".cart").each(function() {
					if($(this).find("dd").length == 0) {
						$(this).remove()
					}
				})
			}

			//单组 全选
			$('dl dt .mui-checkbox').click(function() {

					if($(this).find("input").is(':checked')) {
						$(this).parentsUntil("#cartData").find("input").attr("checked", true);
						var allLength = $("dd").length;
						var ALLcheckLength = $("dd").find("input[type='checkbox']:checked").length;
						if(ALLcheckLength == allLength) {
							$('aside input').attr("checked", true);
						} else {
							$('aside input').attr("checked", false);
							var allLength = $("dd").length;
							var ALLcheckLength = $("dd").find("input[type='checkbox']:checked").length;
							if(ALLcheckLength == allLength) {
								$('aside input').attr("checked", true);
							} else {
								$('aside input').attr("checked", false);
							}

						}

					} else {
						$(this).parentsUntil("#cartData").find("input").attr("checked", false);
						$('aside input').attr("checked", false);
					}

					countFuc();
				})
				//单个 选择
			$('dl dd .mui-checkbox').click(function() {
					var allLength = $("dd").length;
					var length = $(this).parentsUntil("#cartData").find("dd").length;
					var checkLength = $(this).parentsUntil("#cartData").find("input[type='checkbox']:checked").length;
					var ALLcheckLength = $("dd").find("input[type='checkbox']:checked").length;
					if($(this).find("input").prop('checked') == false) {
						$(this).parentsUntil("#cartData").find(".groupCheck").attr("checked", false);
						$('aside input').attr("checked", false);
						countFuc();
					} else {
						if(length == checkLength){
							$(this).parentsUntil("#cartData").find(".groupCheck").attr("checked", true);
						}
						if(ALLcheckLength == allLength) {
							$('aside input').attr("checked", true);
						}
						countFuc();
					}

				})
				//总选
			$('aside .mui-checkbox').click(function() {
					if($(this).find("input").prop('checked') == false) {
						$("dl input").attr("checked", false);
						$(".totalNum").html(0);
						$(".totalMoney").html(0);
					} else {
						$("dl input").attr("checked", true);
						countFuc();
					}

				})
				//数量选择 
			$('.mui-numbox input').on('change', function() {
					//alert(totalFen);
					var number = $(this).val(); //当前数量
					var curPrice = $(this).parentsUntil("dd").find(".price").html();
					$(this).parentsUntil("dd").find(".num").html(number);
					//判断当前是否勾选
					//var currCheck = $(this).parentsUntil("dl").find("input[type='checkbox']"); 
					countFuc();
				})
				//计算总价和总数量
			function countFuc() {
				var fen = 0; //总份数
				var pay = 0; //总金额 
				$("dd").find("input[type='checkbox']:checked").each(function() {
						//价格  
						var price = parseFloat($(this).parentsUntil('dl').find('.price').html());
						//当前数量
						var num = parseInt($(this).parentsUntil('#cartData').find("input[type='number']").val());
						pay += num * price;
						fen += num;
					})
					//赋值
				$(".totalNum").html(fen);
				$(".totalMoney").html(pay);
			}
			//下单
			var goOrder = mui(".goOrder")[0];
			goOrder.addEventListener("tap", function() {
				var ALLcheckLength = $("dd").find("input[type='checkbox']:checked").length;
				if(ALLcheckLength == 0) {
					mui.toast("您还未选择要删除的商品哦！")
				} else {
					mui.toast("您选中了" + ALLcheckLength + "件商品")
				}
			})
        
	}) 
	
	Array.prototype.unique1 = function() {
				var res = [this[0]];
				for(var i = 1; i < this.length; i++) {
					var repeat = false;
					for(var j = 0; j < res.length; j++) {
						if(this[i] == res[j]) {
							repeat = true;
							break;
						}
					}
					if(!repeat) {
						res.push(this[i]);
					}
				}
				return res;
			}
	
	</script>

</html>