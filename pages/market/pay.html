
<html lang="zh-CN" style="font-size: 10px;">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>支付订单end</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" href="../../css/reset.css"> 
		<style>
			.zhifulist{background-color: #fff;}
			.zhifulist li{padding: 15px;padding-left: 0px;margin-left:50px;position: relative;border-bottom: 1px solid rgba(0,0,0,0.1);}
			.zhifulist li:last-child{border: none;}
			.zhifulist li img{position: absolute;width: 30px;margin-left:-40px;top: 18px;}
			.zhifulist li h4{font-size: 16px;margin-bottom: 5px;}
			.allmoney{font-size: 18px;padding: 20px;}
			.all1{border-bottom: 1px solid #eee;margin:0 10px;}
			.mui-btn-block {font-size: 18px;display: block;width: 90%;margin-bottom: 10px;padding: 8px 0;margin: 20px auto 0;}
		</style>
	</head>
	<body>
		<header class="hasManyCity hasManyCitytwo hasManyCitythree" id="header">
			<a class="fl fanhui mui-action-back"><i class="iconfont icon-fanhui"></i></a>
			<div class="header-tit" id="testzhifu">
				支付订单
			</div>			
		</header>
		
		<div id="container" style="margin-top: 50px;">		
			<div id="main">
				<div class="zhifulist" style="margin-bottom:20px;">
					<div class="allmoney all1" style="text-align: center;"> 
						<img src="../../img/market/waitPay.svg" style="width: 5rem;display: block;text-align:center;margin:auto;vertical-align: middle;margin-bottom: 1rem;" alt="" />总计 :￥<span id="payMoney"></span>
					</div> 
					<div class="allmoney" style="font-size: 12px;padding-left: 10px;"> 
						订单号 :<span id="orderId" style="display: inline-block;word-break: break-all;"></span>
					</div>
				</div>
				<div class="zhifulist">
					<ul>
						<li>
							<img src="../../img/yinghangka.svg"/>
							<h4>银行卡支付</h4>
							<p>安全急速支付, 无需开通网银</p>
						</li>
						<li id="wxpay">
							<img src="../../img/weixing.svg"/>
							<h4>微信支付</h4>
							<p>推荐安装微信6.0.2以上版本</p>
						</li>
						<li id="alipay">
							<img src="../../img/zhifubao.svg"/>
							<h4>支付宝支付</h4>
							<p>推荐有支付宝账户的用户使用</p>
						</li>
					</ul>
				</div>
				
				<button type="button" class="mui-btn mui-btn-danger mui-btn-block">模拟支付</button>
			</div>
		</div>
	</body>
<script src="../../js/mui.min.js"></script> 
<script src="../../js/app.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
var pays={}; 

mui.plusReady(function() { 

//	mui(".fanhui")[0].addEventListener("tap",function(){ 
//		if(plus.webview.getWebviewById("market/market-order.html")){
//			plus.webview.getWebviewById("market/market-order.html").close(); 
//		}else{
//			plus.webview.getWebviewById("market-order.html").close(); 
//		}
//		
//		openview({
//			view:'../personal/sc-order.html',
//			extrasobj:{pageId:"pay"}
//		}) 
//		plus.webview.currentWebview().close();
//	})


	//获取缓存
	var myuserid = plus.storage.getItem('userid'); 
	var oldtoken = plus.storage.getItem('oldToken');
	var orderId = plus.webview.currentWebview().order_id;
	console.log(orderId)
	var payMent = plus.webview.currentWebview().payMent;
	document.getElementById('payMoney').innerHTML = payMent;
	document.getElementById('orderId').innerHTML = orderId;
	//系统检测获取支付通道
	plus.payment.getChannels(function(channels){
		console.log(JSON.stringify(channels));
		for(var i in channels){
			var channel=channels[i];
			// 过滤掉不支持的支付通道：暂不支持360相关支付
			if(channel.id=='qhpay'||channel.id=='qihoo'){
				continue;
			}
			pays[channel.id]=channel;
			if(channel.id == 'alipay'){//添加支付事件
				document.getElementById('alipay').setAttribute('onclick','payfun("alipay")');
			}
			if(channel.id == 'wxpay'){
				document.getElementById('wxpay').setAttribute('onclick','payfun("wxpay")');
			}
			checkServices(channel);
		}
	},function(e){
		plus.nativeUI.alert("支付失败，请重试",null,"提示");
	});
	alert(oldtoken+" "+ orderId)
	 mui(document.body).on('tap', '.mui-btn', function(e) {
	 	plus.nativeUI.showWaiting(); 
	 	mui.ajax(serverUrl+'/api/mall/pay',{
				data:{order_id:orderId},
				dataType:'json',
				type:'post',
				timeout:1000,
				headers:{"token":oldtoken},	 
				success:function(data,type,xhr){ 
					plus.nativeUI.closeWaiting();
					alert(JSON.stringify(data)) ;
					 mui.toast("支付成功"); 
					  
					openview({
						view:"../personal/sc-order.html"
					})
					 plus.webview.getWebviewById("market/market-order.html").close();
					 plus.webview.currentWebview().close();
				},
				error:function(xhr,type,errorThrown){
					plus.nativeUI.closeWaiting()
					console.log('响应失败  !');
				}
			});
        });
	
	
	// 检测是否安装支付服务
	function checkServices(pc){ 
		if(!pc.serviceReady){
			var txt=null;
			switch(pc.id){
				case "alipay":
				txt="检测到系统未安装“支付宝快捷支付服务”，无法完成支付操作，是否立即安装？";
				break;
				default:
				txt="系统未安装“"+pc.description+"”服务，无法完成支付，是否立即安装？";
				break;
			}
			plus.nativeUI.confirm(txt,function(e){
				if(e.index==0){
					pc.installService();
				}
			},pc.description);
		}
	}
	//系统检测获取支付通道结束
});



// 支付方法
function payfun(id){
	var varpay;
	if(id=='alipay'||id=='wxpay'){//调用支付功能
		plus.nativeUI.showWaiting();
		if(id == 'alipay'){//支付宝
			var data = '后台返回数据';
			varpay = data;
			alert('调用支付宝支付一下');
			plus.payment.request(pays[id],varpay,function(result){
				//支付成功回调
				
			},function(e){
				//支付失败回调
				plus.nativeUI.closeWaiting();
				plus.nativeUI.alert("支付失败");
			});
		}else if(id=='wxpay'){//微信
			//重组的支付验证数据
			varpay = {
				retcode: 0,//5+固定调起参数
				retmsg: "ok",//5+固定调起参数
	            appid: 'sffjdlflnlndfdklk',//AppId,微信开放平台新建应用时产生
	            noncestr: 'knjdjddnjdjdj',//随机字符串，
	            package: "Sign=WXpay",//APP支付固定设置参数
	            partnerid: 'hdndnvndiv',//商户编号，微信开放平台申请微信支付时产生
	            prepayid: 'nfjbvkkjv',//由上面获取预支付流程获取
	            timestamp: 'kndnvjdnjvndj',//时间戳
	            sign: 'dbvjdvjdb'//上面关键参数加密获得
			}
			//微信
			alert('调用微信支付一下');
			plus.payment.request(pays[id],varpay,function(result){
				//支付成功回调
				
			},function(e){
				//支付失败回调
				plus.nativeUI.closeWaiting(); 
				plus.nativeUI.alert("支付失败");
			});
		} 
	}else{
		plus.nativeUI.alert("当前环境不支持此支付通道！",null,"提示");
		return;
	}
}
</script>
</html>
