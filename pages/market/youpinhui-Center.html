<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>优品汇</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" href="../../css/reset.css">
		<link rel="stylesheet" href="../../css/one.css">
		<script type="text/javascript" src="../../js/jquery.min.js"></script> 
		<style type="text/css">
			/*banner样式*/
			.mui-slider-indicator .mui-indicator{
				width: 10px;
				height: 10px;
				border-radius: 8px;
				background: black;
				margin-right: 5px;
				opacity: 0.3;
				cursor: pointer;
				border: none;
				box-shadow: none;
			}
			#banner{
				position: relative;
				width: 100%;
				padding-top: 42%; 
				overflow: hidden;
				background: url(../../img/bannerback.svg) 50% 50% no-repeat;
				background-size: 20%;
			}
			.mui-slider .mui-slider-group{
				position: absolute;
			    height: 100%;
			    width: 100%;
			    top: 0;
			}
			.mui-slider .mui-slider-group .mui-slider-item img{height: 100%;}
			/*banner样式结束*/
			.onetable{
				margin-top: 5px;
			}
			.onetable p{
				margin-top: -10px;
				font-size: 11px;
				margin-bottom: 5px;
			}
			.fontcl2{ 
				font-size: 16px;
				line-height: 18px;
			} 
			.sy_recmd_list .pub_wz{
				position: relative;
			}
			.relist .box{
				border: none;
				margin: 3px;
				box-shadow: 0px 0px 1px #ccc;
			}
			.relist .box img{
				width: 100% !important;
				margin: 0 !important;
				height: 100%;
			}
			sub{
				bottom: 0;
				font-size: 50%;
				margin-left: 5px;
			}
			.fr {
				position: absolute;
				float: right;
				display: block;
				top: 12px;
				right: 5px;
				font-size: 10px;
			}
			.sy_recmd_list .pub_wz .nr_box{
				border-top: none;
				margin-top: 0;
			}
			.mui-bar{
				height: 50px;
			}
			.mui-title,.mui-icon{
				line-height: 50px;
			}
			.mui-bar .mui-icon{
				padding: 0;
			}
			
			/*这一页*/
			.onetable{
				border-bottom: 0rem solid #e6e6e6;
				padding-bottom: 10px;
				background-color: #fff;
				box-shadow: 0px 0px 1px 0px rgba(0,0,0,0.1);
			}
		 
			.onetable .table{
				text-align: center;
			}
			.onetable .table img {
				text-align: center;
				width: 45%;
				margin: 0.15rem 0;
			}
			.onetable p {
				margin-top: -16px;
				font-size: 12px;
			}
			.market-icon{
				border-radius: 50%;
				width: 0.55rem;
				height: 0.55rem;
				display: block;
				margin: 10px auto;
			}
			.left{
				border-left: 0.03rem solid #f53c42;
				padding-left: 10px;
			}
			/*精选频道*/
			.choiceness {
				margin-top: 5px;
				padding-bottom: 5px;
			}
			.choiceness p{
				text-align: center;
				color: #333;
				line-height: 20px;
			}
			.choiceness .gray{
				color: #666;
				font-size: 11px;
			}
			.choiceness img{
				width: 16px;
				margin-top: -2px;
				margin-right: 5px;
			}
			.choicenessWrap .pub_img img {
				height: 125px;
				min-height: 1rem;
				overflow: hidden;
				border-radius: 5px;
			}
			.box{
				/*border: 1px solid #efefef;*/
				/*box-shadow: 0px 0 1px 0px rgba(0,0,0,0.1);*/
				
			}
			.sy_recmd_list .pub_img img{
				width: 88%;
				margin: 0 6%;
			}
			.sy_recmd{
				background-color: #fff;box-shadow: 0px 0px -1px 0px rgba(0,0,0,0.1); 
    			margin-bottom: 10px !important; 
			}
			.sy_recmd:last-child{
				margin-bottom: 0%!important; 
			}
			.sy_title{
				border-bottom: none;
			}
			.mui-bar-nav{
				box-shadow: none;
			}
			.rcdPadding{
				position: relative;
				display: inline-block;
				padding-top: 100%;
				width: 100%;
				overflow: hidden;
			}
			.rcdPadding img{
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
			}
			#upload{ 
				text-align: center;font-size: 15px;line-height: 30px;min-height: 40px;
			}
			#upload img{width: 60px;margin-top: -10px;
			}
		
			.sy_recmd_list .pub_wz h3 a{
				color: #666;
				line-height: 0.2rem;
				font-size: 12px;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
				width: 100%;
				display: block;
			}
			.mb10{
				border-top: none !important;
				border-bottom: 1px solid #EFEFF4;
				margin: 0 10px;
			}
			.table{
				border-bottom: none !important;
			}
			.hot{
				padding: 0 5px;
				border-right: 1px solid #EFEFF4;
				font-weight: bold;
				font-size: 20px;
			}
			.hot img{
				width: 8%;
			}
			.choicenessWrap{
				padding-top: 10px;
			}
			.hotContent{
				font-size: 14px;
				padding-left: 10px;
			}
			.hot_info{
				width: 33% !important;
			}
			.sy_recmd_list_box{
				padding-top: 10px;
			}
			.sy_title{
				padding: 0.05rem 0;
			}
			
				position: relative;
				width: 100%;
				padding-top: 65%;
				overflow: hidden;
			}
			.imgpt img{
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
			}
			.clasfyItem{
				position: absolute;
				top: 50%;
				-webkit-transform: translateY(-50%);
				left: 0;
				right: 0;
				text-align: center;
				line-height: 3;
			}
			.clasfyItem .itemName{
				color: white;
				font-size: 0.2rem;
				font-weight: 400;
			} 
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
			<h1 class="mui-title">优品汇</h1>
		</header> 
		<script src="../../js/statusBar.js"></script><!--状态栏-->
			
			<div id="main">
				<div id="scroller">
				<!--轮播图-->
				<div class="mui-slider" id="banner"></div>
				<!--轮播图结束-->
				<!--banner数据渲染-->
				<script type="text/html" id="banner-detail">
					<div class="mui-slider-group mui-slider-loop">
					    <!--支持循环，需要重复图片节点-->
					    <div class="mui-slider-item mui-slider-item-duplicate">
					    	<img src="<%= url %><%= bannerList[bannerList.length-1].bannerPic %>" onerror="javascript:this.src='../../img/market/nodata.svg';" />
					    </div>
						<% for(var i=0;i<bannerList.length;i++){ %> 
					    	<div class="mui-slider-item">
					    		<img src="<%= url %><%=bannerList[i].bannerPic %>" onerror="javascript:this.src='../../img/market/nodata.svg';" />
					    	</div>
					     <% } %>
					    <!--支持循环，需要重复图片节点-->
					    <div class="mui-slider-item mui-slider-item-duplicate">
					    	<img src="<%= url %><%= bannerList[0].bannerPic %>" onerror="javascript:this.src='../../img/market/nodata.svg';" />
					    </div>
					</div>
					<div class="mui-slider-indicator">
						<div class="mui-indicator mui-active"></div>
						<% for(var i=0;i<bannerList.length-1;i++){ %>
					    	<div class="mui-indicator"></div>
					    <% } %>
		            </div> 
				</script>
			</div>
			
			<div id="classify"></div>
			<script type="text/html" id="classifyTpl">
				<%for(var i=0;i<list.length;i++){%>
					<div class="sy_recmd typeDis" style="background-color: #fff;">
						<div class="imgpt" onclick="goList(<%=list[i].catid%>)"><!-- onclick="goList(<%=list[i].catid%>)"-->
							<%if(list[i].icon){%>
								<img src="<%=myUrl%><%=list[i].icon%>" alt="" />
								<%}else{%>
									<img src="../../img/igetc1.png" alt="" />
								<%}%>
						 	  	<div class="clasfyItem">
							 		<div class="itemName"><%=list[i].catname%></div>
							 		<button type="button" class="mui-btn itemGo" data-catId="<%=list[i].catid%>">
										入场疯抢 >
									</button>
							 	</div>
						</div>
						 
					</div>
					<%}%>
			</script>
			 
			<!--推荐列表-->
			<div class="sy_recmd">
				<!--推荐列表-->
				<div class="sy_title mb10">
					<span class="left">热门推荐</span>
					<!--<a href="#" class="fr morethree">更多&gt;&gt;</a>-->
				</div> 
				<div class="sy_recmd_list_box">
					<ul>
						<div id="moll_recommend"></div>
					</ul>
					<div class="clear"></div>
				</div> 
				<!--热门推荐-->
				<script type="text/html" id="recommendTpl">
					<%if(list.length==0){%>
						暂无推荐商品
					<%}else{%>
						<%for(var i=0;i<list.length;i++){%>
							<li class="sy_recmd_list relist">
								<div class="box">
									<div class="pub_img"> 
										<a class="rcdPadding" onclick="goInfo('<%=list[i].goods_id%>')">
											<img src="<%=myUrl %><%=list[i].thumb%>" onerror="javascript:this.src='../../img/zhaoxiangji.svg';" width="145" height="145" class="hotImg">
  
										</a>
									</div>
									<div class="pub_wz">
										<h3 class="overflow_clear"><a onclick="goInfo('<%=list[i].goods_id%>','<%=list[i].storeid%>')"><%=list[i].title%></a></h3>
										<div class="nr_box mui-row">
											<div class="mui-col-sm-5 mui-col-xs-5 ">
									        	<p class="fl fontcl2"><sub>￥</sub><%=list[i].price%></p>
									       </div>
									        <div class="mui-col-sm-7 mui-col-xs-7 saled"></p>
												<p class="fl fontcl2"><sub class="saled black9">已售<%=list[i].sales%></sub></p>
									      	</div> 
									     </div>
									</div>
								</div>
							</li> 
						<%}%>
					<%}%>
				</script> 
				<div class="upload text-center text-xs gray" id="upload"></div>
				<div id="nulldiv" style="text-align:center;margin-top: 2%;padding-bottom:15%;font-size: 14px;color: #999;display: none;">
					<img style="width: 7%;margin-bottom: 1%; " src="../../img/unllfabu.svg"/>
					暂无推荐
				</div>
			</div>
		</div>
		 
	<script src="../../js/mui.min.js"></script> 
	<script type="text/javascript" src="../../js/artTemplate-native.js"></script>
	<script src="../../js/app.js"></script>	
	<script type="text/javascript">
 		var Spagenum = 2;//实到页数
		var Ypagenum = 1;//应到页数 
//		mui("#storeRcmd")[0].addEventListener('tap',function(){
//			openview({
//			 	view:"localSpList.html"
//			})
//		})
//		mui('.loveBuy')[0].addEventListener('tap', function(){
//			openview({
//				view:'igetClassfy.html',
//			});
//		});
		//跳转详情
		function goInfo(goodsId,storeId){
		 
				 openview({
				 	view:"hometown-detail.html",
				 	extrasobj:{goodsId:goodsId}
				 })
		 
			
		}
		//获得slider插件对象
		var gallery = mui('.mui-slider');
		gallery.slider({
		  interval:5000//自动轮播周期
		});		
		mui.plusReady(function(){
			plus.nativeUI.showWaiting('加载中 ...',{width:'100px',height:'80px'});//显示等待框
			var oldToken = plus.storage.getItem('oldToken');
			 
			//获取 一级分类
			mui.ajax(serverUrl+'/api/mall/igocategory',{
				data:{pid:0},
				dataType:'json',
				type:'post',
				timeout:10000,
				headers:{"token":oldToken},	 
				success:function(data,type,xhr){
					console.log("一级分类",JSON.stringify(data))  
					if(data.errno == 0){
						if(data.data.length != 0){
							var tyepdata ={};
							tyepdata.myUrl = serverimgUrl;
							tyepdata.list = data.data;
							var html=template("classifyTpl",tyepdata);
							document.getElementById("classify").innerHTML=html;
							
							 
						}
					}
				},
				error:function(xhr,type,errorThrown){
					plus.nativeUI.closeWaiting();//关闭等待框
					mui("#upload")[0].innerHTML = ""; 
					mui('#nulldiv')[0].style.display = 'block';
				}
			});
			
			//推荐数据渲染
			var currentPage =1, numsPerPage=4;
   			//热门推荐 数据渲染 
			mui.ajax(serverUrl+'/api/mall/mallgooodslist', { 
				data: {currentPage:currentPage,numsPerPage:numsPerPage,categoryid:35,isRecommend:'',differentiate:'',storeid:'',brand:'',keyword:'',order_type:'sales',desc:'desc'},
				dataType:'json',//服务器返回json格式数据
					type:'post',//HTTP请求类型 
					timeout:10000,//超时时间设置为10秒；	
					headers:{"token":oldToken}, 
					success:function(data){ 
//						 alert(JSON.stringify(data))
						if(data.errno==0){
						plus.nativeUI.closeWaiting();//关闭等待框
							var objdata = {};
							objdata.myUrl = serverimgUrl;
							objdata.list = data.data.return.data;
							var html=template("recommendTpl",objdata);
							document.getElementById("moll_recommend").innerHTML=html;
	                    mui("#upload")[0].innerHTML = "<img src='../../img/balls.svg'/>";
	                     
	                   	$(window).scroll(function(){
						　　var scrollTop = $(this).scrollTop();
						　　var scrollHeight = $(document).height();
						　　var windowHeight = $(this).height();
						　　if(scrollTop + windowHeight == scrollHeight){

								if(Spagenum<=data.data.return.totalPages && Spagenum==Ypagenum+1){//当前页小于等于总页数时请求下一页
									mui("#upload")[0].innerHTML = "<img src='../../img/balls.svg' />";
									Ypagenum++;//满足加载情况,应到页数+1
									console.log('发起请求,实到'+Spagenum+'页');									
									console.log('发起请求,应到'+Ypagenum+'页');
									var requestfun = function(){
										mui.ajax(serverUrl+'/api/mall/mallgooodslist',{ 									
											data:{currentPage:Spagenum,numsPerPage:numsPerPage,categoryid:35,isRecommend:'',differentiate:'',storeid:'',brand:'',keyword:'',order_type:'sales',desc:'desc'}, 
											dataType:'json',//服务器返回json格式数据
											type:'post',//HTTP请求类型 
											timeout:5000,//超时时间设置为10秒；	
											headers:{"token":oldToken}, 
											success:function(data){
												if(data.errno == 0){
												var objdata = {};
													objdata.myUrl = serverimgUrl;
													objdata.list = data.data.return.data;
													var html=template("recommendTpl",objdata);
													document.getElementById("moll_recommend").innerHTML+=html;
												}
												mui("#upload")[0].innerHTML = " ";
												Spagenum++;//加载成功,当前页+1
												console.log('成功+1,实到'+Spagenum);
												console.log('成功+1,应到'+Spagenum);
											},
											error:function(xhr,type,errorThrown){
												//Ypagenum;//失败是应到-1
												console.log("当前网络不好请重试");
												requestfun();//失败继续加载
												mui("#upload")[0].innerHTML = "<img src='../../img/balls.svg' />";
											}
										});
									}
									requestfun(); 
									
								}else if(Spagenum == data.data.return.totalPages+1){//当前页不小于等于总页数时请求下一页
									mui("#upload")[0].innerHTML = "到底了";
								}
							}
						}); 
	                   	 
					}else{
						mui("#upload")[0].innerHTML = ""; 
						mui('#nulldiv')[0].style.display = 'block';
					}
					
				}, 
				error:function(xhr,type,errorThrown){
					plus.nativeUI.closeWaiting();//关闭等待框
					mui("#upload")[0].innerHTML = ""; 
					mui('#nulldiv')[0].style.display = 'block';
				}
			}); 
			
//			//家乡味道
//			mui.ajax(serverUrl+'/api/mall/mallgooodslist',{
//				data:{currentPage:1,numsPerPage:10,categoryid:35,isRecommend:'',differentiate:'',storeid:'',brand:'',keyword:'',order_type:'sales',desc:'desc'},
//				type:'post',
//				timeout:10000,
//				headers:{"token":oldToken},	 
//				success:function(data,type,xhr){  
//					alert(JSON.stringify(data)); 
//					if(data.errno == 0){ 
//						if(data.data.return.data.length!=0){ 
//							var objdata = {};
//							objdata.myUrl = serverimgUrl;
//							objdata.list = data.data.return.data;
//							var html=template("recommendTpl",objdata);
//							document.getElementById("moll_recommend").innerHTML=html;
//	//						var html2=template("sf-detail",objdata);
//	//						document.getElementById("sf").innerHTML=html2;
//						}
//					}else{
//						
//					}
//					plus.nativeUI.closeWaiting();//关闭等待框
//				},
//				error:function(xhr,type,errorThrown){
//					plus.nativeUI.closeWaiting();//关闭等待框
//				}
//			});
//			
			
			//banner
			mui.ajax(serverUrl+'/api/index/banner',{
				data:{banner_type:6},
				dataType:'json',
				type:'post',
				timeout:10000,
				headers:{"token":oldToken},	 
				success:function(data,type,xhr){
					bannerObj={};
					bannerObj.bannerList = eval("("+data.data.banner+")");
					bannerObj.url = serverimgUrl;
					var html = template('banner-detail',bannerObj);
					document.getElementById('banner').innerHTML = html;
					plus.nativeUI.closeWaiting();//关闭等待框
					//轮播图,获得slider插件对象
					var gallery = mui('.mui-slider');
					gallery.slider({
					  	interval:5000//自动轮播周期，若为0则不自动播放，默认为0；
					});
				},
				error:function(xhr,type,errorThrown){
					console.log('响应失败  !');
				}
			}); 
			
		});
	</script>	
	</body>
</html>