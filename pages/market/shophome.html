<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>商家主页</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" href="../../css/reset.css">
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script type="text/javascript" src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/app.js" ></script>
		
		<!--引入模板引擎-->
		<script src="../../js/artTemplate-native.js" type="text/javascript" ></script>
		<style type="text/css">
			#shangjia_tab a{color:#555;
			}
			.page-center-box{overflow-y: inherit;
			}
			#shangjia_tab{position: relative;
			}
			/*商品列表*/
			/*这一页*/
			.grade-eject, .Category-eject, .Sort-eject{
				height: 80px;
			}
			div.screening>ul>li{
				border-left: 1px solid #eee !important;
			}
			div.screening>ul,dl.list dt, dl.list dd,dl.list{
				border-bottom: 1px solid #eee;
			}
			.dealcard .title, .cinemacard .title{
				color: #999;
				font-size: 12px !important;
			}
			.dealcard .strong, .dealcard .strong{
				color: #999;
				font-size: 20px !important;
				line-height: 30px;
			}
			.dealcard .title, .dealcard .price{
				height: 30px;
				margin: 5px 0;
			}
			.right{
				text-align: right;
			}
			.middle{
				text-align: center;
			}
			.strong-color{
				color: #f53c42 !important;
			}
			.Lgray{
				font-size: 12px !important;
				color: #999 !important;
				margin-top: 14px;
			}
			.mui-badge-blue, .mui-badge-primary{
				background-color: #fff;
				border: 1px solid #999;
				color: #999 !important;
			}
			.dealcard .title span{
				top: 0;
				left: 0;
				position: relative;
			}
			.bage{
				width: 100%;
			}
			dl.list .dd-padding, dl.list dt, dl.list dd>.react {
				padding: 10px;
				margin: 10px 0;
			}
			.dealcard .dealcard-brand, .cinemacard .cinemacard-brand{
				font-size: 16px;
			}
			.dealcard .dealcard-brand{
				width: 100%;
				overflow: hidden;
				line-height: 22px;
				text-overflow: ellipsis;
				white-space: nowrap;
				display: block;
			}
			.dealcard .title span, .dealcard .price span {
				font-size: .1rem;
			}
			.dealcard .dealcard-img{
				width: 30%;
				height: 100%;
				max-height: 110px !important;
				/*margin-top: -10px;*/
				/*padding: 5px;*/
				border-radius: 0 !important;
			}
			.dealcard .dealcard-block-right {
				padding: 5px 2%;
				float: right;
				width: 70%;
				max-height: 110px;
				overflow: hidden;
			}
			.imgbox{
				background-image: none;
			}
			.dealcard-img img {
				max-width: 100%;
				max-height: 110px;
			}
			.moreone{
				line-height: 50px;
			}
			dl.list .db>.react{
				padding: 0;
				margin: 0;
			}
			dl.list .db{
				height: 50px;
			}
			.grade-eject>ul>li, .Category-eject>ul>li, .Sort-eject>ul>li{
				line-height: 40px;
			}
			#allGoods{
				margin-top: -1px;
			}
			#storeName{
				text-align: left;
			}
			/*加载*/
			.upload{ 
				text-align: center;margin-bottom: 30px;font-size: 15px;line-height: 40px;
			}
			.upload img{
				width: 60px;
				margin-top: 15px;
				height: 50px !important;
			}
		</style>
	</head>
	<body>
		<header class="hasManyCity hasManyCitytwo" id="header">
			<a class="fl fanhui mui-action-back"><i class="iconfont icon-fanhui"></i></a>
			<div class="header-tit">
				店铺详情
			</div>
			<a href="#" class="fr shoucang sousuo"><i class="iconfont icon-fenxiang"></i></a>						
		</header>
		<div id="container">		
			<div id="main">
				<!--店铺头部开始-->
				<div class="store-header clearfix">
					<div class="tu">
						<span></span>
						<img src="" id="storeLogo"/>
					</div>
					<div class="right fl">
						<p id="storeName"></p>
						<a href="#" class="fl shoucang"><i class="iconfont icon-xihuan1"></i></a>
					</div>
					<div class="tit">
						<span></span>
						<p id="description"></p>
					</div>
				</div>
				<!--店铺头部结束-->
				<!--头部切换开始-->
				<ul id="shangjia_tab">
					<li>
						<a class="on">推荐商品</a>
					</li>
					<li>
						<a>全部商品</a>
					</li>
					<li>
						<a>店铺详情</a>
					</li>
				</ul>
				<!--第一部分-->
				<div id="tab1" class="page-center-box dldetail">
					<dl class="dealcard" id="moll_recommend"></dl>
					<div class="upload text-center text-xs gray"></div>
			    </div>
			    <!--第二部分-->
			    <div id="tab2" class="page-center-box dldetail" style="display: none;">
					<dl class="dealcard" id="allGoods"></dl>
					<div class="upload text-center text-xs gray"></div>
			    </div>
			    <!--第三部分-->
			   	<div id="shangjia_detail" class="page-center-box dldetail" style="display: none;">          
		            <div class="imgInfor mb10">
		                <img src="" id="storeImg">
		                <div class="nr">
		                    <h2 class="overflow_clear" id="title2">我的小店</h2>
		                    <p>月售<b class="fontcl1">58</b>份&nbsp;&nbsp;总售<b class="fontcl1">102</b>份</p>
		                </div>
		            </div>
		            <div class="detailNr">
		                <h3>商家信息</h3>
		                <div class="nr mb10">
		                    <p>店铺地址：<span id="addressS"></span></p>
		                    <p>店铺具体位置：<span id="floorName"></span>楼<span id="doorNo"></span>号</p>
		                    <p>营业时间：<span id="businessH"></span></p>
		                    <p>联系电话：<span id="phoneS"></span></p>
		                    <p>营业状态：<span id="openStaus"></span></p>
		                </div>
		            </div>
		            <dl class="dealcard" id="moll_recommend2"></dl>
					<div class="upload text-center text-xs gray"></div>
			    </div>
			    <!--第一部分数据-->
			    <script type="text/html" id="recommendTpl">
					<%if(recommendData.length==0){%>
						暂无推荐商品
					<%}else{%>
						<%for(var i=0;i<recommendData.length;i++){%>
							<dd class="goodsItem react" onclick="goInfo('<%=recommendData[i].goods_id%>')" > 
								<div class="dealcard-img imgbox">
									<img src="<%=recommendData[i].thumb%>" alt="" >
								</div>
								<div class="dealcard-block-right">
									<div class="dealcard-brand single-line"><%=recommendData[i].title%></div>
									<div class="title text-block bage">
										<span class="mui-badge mui-badge-primary">64G</span>
										<span class="mui-badge mui-badge-primary">128G</span>
										<span class="mui-badge mui-badge-primary">64G</span>
									</div>
									<div class="price mui-row">
										<div class="mui-col-sm-4 mui-col-xs-4">
											<span class="strong-color">￥</span>
											<span class="strong"><%=recommendData[i].price%></span>
										</div>
										<span class="mui-col-sm-4 mui-col-xs-4 middle Lgray">评价<%=recommendData[i].comments %>条</span>
										<span class="mui-col-sm-4 mui-col-xs-4 right Lgray">已售<%=recommendData[i].sales%></span>
									</div>
								</div>
							</dd>
						<%}%>
					<%}%>
				</script>
			   	<!--第二部分数据-->
			    <script type="text/html" id="allGoods-detail">
					<% for(var i=0;i<list.length;i++){ %>
						<dd class="goodsItem react" onclick="goInfo(<%= list[i].goods_id%>)">
							<div class="dealcard-img imgbox">
								<img src="<%= list[i].thumb %>"/>
							</div>
							<div class="dealcard-block-right">
								<div class="dealcard-brand single-line"><%= list[i].title %></div>
								<div class="title text-block bage">
									<% if(list[i].tag!=null && list[i].tag!=''){ %>
										<% for(var j=0;j<list[i].tag.length;j++){ %>
											<span class="mui-badge mui-badge-primary"><%= list[i].tag[j].tag_name %></span>
										<%}%>
									<%} %>
								</div>
								<div class="price mui-row">
									<div class="mui-col-sm-4 mui-col-xs-4">
										<span class="strong-color">￥</span>
										<span class="strong"><%= list[i].price %></span>
									</div>
									<span class="mui-col-sm-4 mui-col-xs-4 middle Lgray">评价<%= list[i].comments %>条</span>
									<span class="mui-col-sm-4 mui-col-xs-4 right Lgray">已售<%= list[i].sales %></span>
								</div>
							</div>
						</dd>
					<% } %>
				</script>
				<!--第三部分人们推荐数据-->
				<script type="text/html" id="recommendTpl2">
					<%if(recommendData.length==0){%>
						暂无推荐商品
					<%}else{%>
						<%for(var i=0;i<recommendData.length;i++){%>
							<dd class="goodsItem react" onclick="goInfo('<%=recommendData[i].goods_id%>')" > 
								<div class="dealcard-img imgbox">
									<img src="<%=recommendData[i].thumb%>" alt="" >
								</div>
								<div class="dealcard-block-right">
									<div class="dealcard-brand single-line"><%=recommendData[i].title%></div>
									<div class="title text-block bage">
										<span class="mui-badge mui-badge-primary">64G</span>
										<span class="mui-badge mui-badge-primary">128G</span>
										<span class="mui-badge mui-badge-primary">64G</span>
									</div>
									<div class="price mui-row">
										<div class="mui-col-sm-4 mui-col-xs-4">
											<span class="strong-color">￥</span>
											<span class="strong"><%=recommendData[i].price%></span>
										</div>
										<span class="mui-col-sm-4 mui-col-xs-4 middle Lgray">评价<%=recommendData[i].comments %>条</span>
										<span class="mui-col-sm-4 mui-col-xs-4 right Lgray">已售<%=recommendData[i].sales%></span>
									</div>
								</div>
							</dd>
						<%}%>
					<%}%>
				</script>
			    
			</div>
		</div>
<script src="../../js/mui.min.js"></script>
<script src="../../js/jquery.min.js"></script>

<script type="text/javascript">
	(function(){
		var tablist = mui('#shangjia_tab')[0].getElementsByTagName('a');
		for(var i=0; i<tablist.length; i++){
			tablist[i].addEventListener('tap',function(){
				for(var j=0; j<tablist.length; j++){
					tablist[j].className = '';
				}
				this.className = 'on';
			})
		}
		mui('#shangjia_tab')[0].getElementsByTagName('a')[0].addEventListener('tap',function(){
			//显示第一个选项卡
			mui('#tab1')[0].style.display = 'block';
			mui('#tab2')[0].style.display = mui('#shangjia_detail')[0].style.display = 'none';
		})
		mui('#shangjia_tab')[0].getElementsByTagName('a')[1].addEventListener('tap',function(){
			//显示第二个选项卡
			mui('#tab2')[0].style.display = 'block';
			mui('#tab1')[0].style.display = mui('#shangjia_detail')[0].style.display = 'none';
		})
		mui('#shangjia_tab')[0].getElementsByTagName('a')[2].addEventListener('tap',function(){
			//显示第三个选项卡
			mui('#shangjia_detail')[0].style.display = 'block';
			mui('#tab1')[0].style.display = mui('#tab2')[0].style.display = 'none';
		})
		//滚动条
        var fangxiang;
        function scroll( fn ) {
            var beforeScrollTop = document.body.scrollTop,
                fn = fn || function() {};
            window.addEventListener("scroll", function() {
                var afterScrollTop = document.body.scrollTop,
                    delta = afterScrollTop - beforeScrollTop;
                if( delta === 0 ) return false;
                fn( delta > 0 ? "down" : "up" );
                beforeScrollTop = afterScrollTop;
            }, false);
        }
        scroll(function(direction) { 
        	fangxiang =  direction;
        });
		window.onscroll = function(){
//			alert(1);
			var Stop = document.documentElement.scrollTop || document.body.scrollTop;
			console.log(Stop);
			if(Stop >= 120){ 
				mui('#shangjia_tab')[0].style.position = 'fixed';
				mui('#shangjia_tab')[0].style.top = '50px';
			}
			if(fangxiang == 'up' && Stop<=120){
				mui('#shangjia_tab')[0].style.position = 'relative';
				mui('#shangjia_tab')[0].style.top = '170px';
			}
		}
		

	})();
</script>
<script type="text/javascript"> 
	mui.plusReady(function(){
		
		//获取token
		var oldToken=plus.storage.getItem("oldToken");
		console.log(oldToken);
		//获取页面传值 商品id
		var storeId = plus.webview.currentWebview().storeId;
//		alert(storeId);
		
		//获取店铺详情
		mui.ajax(serverUrl +'/api/mall/storeinfo',{
			data:{store_id: storeId},
			dataType:'json',
			type:'post',
			timeout:1000,
			headers:{"token":oldToken},	 
			success:function(data,type,xhr){
//				alert(JSON.stringify(data.data.pic));
				$('#storeName').html(data.data.store_name);
				$('#title2').html(data.data.secondary_name);
				$('#floorName').html(data.data.store_name);
				$('#doorNo').html(data.data.floor_name);
				$('#businessH').html(data.data.business_hours);
				$('#phoneS').html(data.data.phone);
				$('#openStaus').html(data.data.op_status);
				$('#description').html(data.data.description);
				$('#addressS').html(data.data.block_name);
				if(data.data.logo == '' || data.data.logo == null){
					$('#storeLogo').attr('src',"../../img/theList/storeLogo.png");
				}else{
					$('#storeLogo').attr('src',serverimgUrl+data.data.pic);
				}
				if(data.data.pic == '' || data.data.pic == null){
					$('#storeImg').attr('src',"../../img/theList/storeNo.jpg");
				}else{
					$('#storeImg').attr('src',serverimgUrl+data.data.pic);
				}
				
				
				//获取全部商品列表
				mui.ajax(serverUrl +'/api/mall/mallgooodslist',{
					data:{currentPage:1,numsPerPage:10,recommend:1,storeId:0,brand:'',keyword:'',order_type:'sales',desc:'desc',store_id: storeId},
					dataType:'json',
					type:'post',
					timeout:1000,
					headers:{"token":oldToken},	 
					success:function(data1,type,xhr){ 
//						 alert(data1.data.return.data[0].tag)
						 for(var m=0; m < data1.data.return.data.length; m++){ 
							if(data1.data.return.data[m].tag==''){
							 	data1.data.return.data[m].tag=null;
							}else{
								data1.data.return.data[m].tag= eval("("+data1.data.return.data[m].tag+")");
							}
						 }    
						var alldata = {}; 
						alldata.list = data1.data.return.data; 
						var html=template("allGoods-detail",alldata);
						document.getElementById("allGoods").innerHTML=html;
						
						//跳转详情
						window.goInfo =  function(goodsId){
							 openview({
							 	view:"mall-detail.html",
							 	extrasobj:{goodsId:goodsId}
							 })
						}
					},
					error:function(xhr,type,errorThrown){
						mui.toast('响应失败  !');
					}
				});
				
				//热门推荐 数据渲染 
				var currentPage =1, numsPerPage=4;
				mui.ajax(serverUrl+'/api/mall/mallgooodslist', {
					data: {currentPage:currentPage,numsPerPage:numsPerPage,recommend:1,storeId:'',brand:'',keyword:'',order_type: 'price',desc:'',store_id:storeId},
					dataType:'json',//服务器返回json格式数据
						type:'post',//HTTP请求类型 
						timeout:10000,//超时时间设置为10秒；	
						headers:{"token":oldToken}, 
						success:function(data){
//							alert(JSON.stringify(data))
							//获取并渲染  eval("("+data1+")");
							if(data.errno==0){
							plus.nativeUI.closeWaiting();//关闭等待框
							var dataobj = data.data.return.data
							var recommendObj = {}
								recommendObj.myUrl = serverimgUrl;
								recommendObj.recommendData = dataobj
		                    document.getElementById("moll_recommend").innerHTML+=template("recommendTpl",recommendObj);
		                    document.getElementById("moll_recommend2").innerHTML+=template("recommendTpl2",recommendObj);
		                    mui(".upload")[0].innerHTML = "加载更多";
//		                   	上滑加载
							  $(window).scroll(function(){
						　　var scrollTop = $(this).scrollTop();
						　　var scrollHeight = $(document).height();
						　　var windowHeight = $(this).height();
						　　if(scrollTop + windowHeight == scrollHeight){
								var nowpage = ++currentPage;
								if(nowpage<=data.data.return.totalPages){//当前页小于等于总页数时请求下一页
									mui(".upload")[0].innerHTML = "<img src='../../img/balls.svg' />";
									console.log('可以请求数据');
									mui.ajax(serverUrl+'/api/mall/mallgooodslist',{ 									
										data:{currentPage:nowpage,numsPerPage:numsPerPage,recommend:1,storeId:'',brand:'',keyword:'',order_type: 'price',desc:''}, 
										dataType:'json',//服务器返回json格式数据
										type:'post',//HTTP请求类型 
										timeout:10000,//超时时间设置为10秒；	
										headers:{"token":oldToken}, 
										success:function(data){
											if(data.errno == 0){
												var dataobj = data.data.return.data
												var recommendObj = {}
													recommendObj.myUrl = serverimgUrl;
													recommendObj.recommendData = dataobj
							                    document.getElementById("moll_recommend").innerHTML+=template("recommendTpl",recommendObj);
							                    mui(".upload")[0].innerHTML = "";
											}else{
												--currentPage;//请求失败,继续请求当前页
												plus.nativeUI.closeWaiting();
												mui.toast("获取数据失败");
											}
											plus.nativeUI.closeWaiting();//关闭等待框
										},
										error:function(xhr,type,errorThrown){
											--currentPage;//请求失败,继续请求当前页
											mui.toast("当前网络不好请重试");
										}
									});
								}else{
									mui(".upload")[0].innerHTML = "没有数据了";
								}
							//加载下一部分结束
							　　}
						});
						}else{
							plus.nativeUI.closeWaiting();
							mui.toast("获取数据失败");
						}
						
					}, 
					error:function(xhr,type,errorThrown){
						//异常处理；
						console.log("获取失败！");
						mui.toast("当前网络不好请重试");
					}
			}); 
				
			
			window.goInfo =  function(goodsId){ 
				 openview({
				 	view:"mall-detail.html",
				 	extrasobj:{goodsId:goodsId}
				 })
			}
				
			},
			error:function(xhr,type,errorThrown){
				mui.toast('响应失败  !');
			}
		});
		
		
		
		
	}) 
	</script>
</body>	
</html>
