<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>商品列表</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" href="../../css/reset.css">
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script type="text/javascript" src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/jquery.flexslider-min.js"></script>
		<script src=" ../../js/hmt.js" type="text/javascript"></script>
		<script src="../../js/other.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/app.js" type="text/javascript" ></script>
		
		<!--引入模板引擎-->
		<script src="../../js/artTemplate-native.js" type="text/javascript" ></script>
		<style type="text/css">
			/*这一页*/
			.grade-eject, .Category-eject, .Sort-eject{
				height: 120px;
			}
			div.screening>ul>li{
				border-left: 1px solid #eee !important;
			}
			div.screening>ul{
				border-bottom:1px solid #eee; 
			}
			dl.list dt, dl.list dd,dl.list{
				border-bottom: 0;
				margin: 0 5px;
				position: relative;
			}
			dl.list dt:not(:last-child):after, dl.list dd:not(:last-child):after,dl.list:not(:last-child):after{
				content: '';
				position: absolute;
				bottom: 0;
				left: 0;
				width: 100%;
				display: block;
				height: 1px;
				background-color: rgba(0,0,0,0.1);
				-webkit-transform: scaleY(0.5);
			}
			.dealcard .dealcard-block-right:after{
				content: '';
				position: absolute;
				bottom: 0;
				display: none;
				height: 1px;
				background-color: rgba(0,0,0,0.1);
				-webkit-transform: scaleY(0.5);
			}
			.dealcard .title, .cinemacard .title{
				color: #999;
				font-size: 12px !important;
			}
			.dealcard .strong, .dealcard .strong{
				color: #999;
				font-size: 20px !important;
				line-height: 30px;
			}
			.dealcard .title, .dealcard .price{
				height: 30px;
				margin: 5px 0;
			}
			.right{
				text-align: right;
			}
			.middle{
				text-align: center;
			}
			.strong-color{
				color: #f53c42 !important;
			}
			.Lgray{
				font-size: 12px !important;
				color: #999 !important;
				margin-top: 14px;
			}
			.mui-badge-blue, .mui-badge-primary{
				background-color: #fff;
				border: 1px solid #999;
				color: #999 !important;
			}
			.dealcard .title span{
				top: 0;
				left: 0;
				position: relative;
			}
			.bage{
				width: 100%;
			}
			dl.list .dd-padding, dl.list dt, dl.list dd>.react {
				padding: 10px;
				margin: 10px 0;
			}
			.dealcard .dealcard-brand, .cinemacard .cinemacard-brand{
				font-size: 16px;
			}
			.dealcard .dealcard-brand{
				width: 100%;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
				display: block;
			}
			.dealcard .title span, .dealcard .price span {
				font-size: .12rem;
			}
			.dealcard .dealcard-img{
				width: 30%;
				height: auto !important;
				max-height: 106px !important;
				margin-top: -10px;
				border-radius: 0 !important;
			}
			.dealcard .dealcard-block-right {
				padding-left: 10px;
				float: right;
				width: 70%;
				max-height: 106px;
				overflow: hidden;
			}
			.imgbox{
				background-image: none;
			}
			.dealcard-img img {
				max-width: 100%;
				max-height: 106px;
			}
			.moreone{
				line-height: 50px;
			}
			dl.list .db>.react{
				padding: 0;
				margin: 0;
			}
			dl.list .db{
				height: 50px;
			}
			.grade-eject>ul>li, .Category-eject>ul>li, .Sort-eject>ul>li{
				line-height: 40px;
			}
			.Regional{
				background-image: none !important; 
			}
			#main{padding-top: 36px !important;}
			.guess-like{padding-top: 0 !important;}
			#screendiv{
				position: fixed;left: 0;top: 50px;height: 400px;width: 100%;background-color: #fff;
				z-index: 30;color: #555;overflow-y: scroll;padding-bottom: 50px;
			}
			.mui-bar{z-index: 40 !important;}
			#Maskdiv{position: fixed;left: 0px;top: 50px;height: 100%;width: 100%;background-color: rgba(0,0,0,0.4);
				z-index: 20;}
			.badyhide{position: fixed;height: 100%;width:100%; top: 0;left: 0;overflow: hidden;}
			.screenin{padding: 10px;}
			.screenin h4{    font-size: 14px;
			    padding-left: 3px;
			    margin: 4px 1px;}
			.screenla{display: inline-block;position: relative;margin: 3px;}
			.screenla label, .screenla span{
				    display: inline-block;
				    text-align: center;
				    border-radius: 30px;
				    margin: 0 5px;
				    margin-top: 10px;
				    box-shadow: 0px 0px 3px #999;
				    padding: 9px 12px;
			}
			.screenla span{background-color: #eee;}
			.screenla label{position: absolute;width: 100%;height: 100%;border: none;box-shadow: none;}
			.screenla input{position: absolute;width: 0;height: 0;}
			.screenla input:checked~span{
				background-color: rgba(230, 31, 31, 0.82);
				color: #fff;
			}
			.screenin:after{
				content: '';
				display: block;
				height: 1px;
				background-color: #eee;
				-webkit-transform: scaleY(.5);
			}
			.screenfoot{position:fixed;z-index:31;top: 406px;left: 0; width:100%;height: 45px;line-height: 45px;background-color: #eee;font-size: 14px;}
			.screenfoot span{float: right;padding: 0 15px;}
		</style>
	</head> 
	<body class="">
		 
		<header class="mui-bar mui-bar-nav" id="header">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
		    <h1 class="mui-title" id="">商品列表</h1>
			<a class="fr mui-icon" id="screenbtn" style="font-size: 15px;padding-right: 10px;padding-top: 2px;">筛选</a>
		</header>
		<div id="Maskdiv" style="display: none;"></div>
		<div class="screenfoot" id="screenfoot" style="transform: translate3d(0px, -401px, 0px);transition: -webkit-transform 0.3s ease-out;"><span id="determine">确定</span></div>
		<div id="screendiv" style="transform: translate3d(0px, -401px, 0px);transition: -webkit-transform 0.3s ease-out;">
			<div class="screenin" id="screenin1">
				<h4>品牌</h4>
				<div id="pingpaidiv">
					<div class="screenla">
						<label for="sss"></label>
						<input type="radio" checked="" name="state" id="sss" />
						<span id="">不限</span>
					</div>
				</div>
				<script type="text/html" id="pingpai">
					<%for(var i=0; i<list.length; i++){%>
						<%if(list[i].brand){%>
							<div class="screenla">
								<label for=""></label>
								<input type="radio" name="state" id="" />
								<span id=""><%= list[i].brand%></span>
							</div>
						<%}%>
					<%}%>	
				</script>	
				
				
				<div id="" style="margin-bottom: 20px;"></div>
			</div> 
			
			
		</div>
		 
		 <div class="screening" id="screeningdiv" style="top: 50px;">
		    <ul>
		        <li class="Brand">综合</li>
		        <li class="Regional" onclick="order('sales','asc')">销量</li>
		        <li class="Sort">价格</li>
		    </ul>
		</div>
		
		<div class="Category-eject">
		    <ul class="Category-w" id="Categorytw">
		        <li onclick="order('create_time','asc')">新品</li>
		        <li onclick="order('comments','asc')">评价</li>
		    </ul>
		</div>
		<div class="Sort-eject Sort-height">
		    <ul class="Sort-Sort" id="Sort-Sort">
		        <li onclick="order('price','desc')">从高到低</li>
		        <li onclick="order('price','asc')">从低到高</li>
		    </ul>
		</div>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div id="main">
			<div class="guess-like">
				<dl class="list" id="goodsList" ></dl>
			</div>
			<div class="upload text-center text-xs gray" id="upload"></div>
			<div id="nulldiv" style="text-align:center;margin-top: 40%;font-size: 14px;color: #999;display: none;">
				<img style="width: 30%;margin-bottom: 5%; " src="../../img/unllfabu.svg"/>
				<br />
				没有相关信息
			</div>
		</div>
		
		<!--模板渲染数据-->
		<script id="goodsList-detail" type="text/html">
			<%if(list.length==0){%>
				<div style="font-size:14px;color:gray;padding: 10px;text-align: center;">暂无数据,看看别的吧</div>
			<%}else{%>
				<% for(var i=0;i<list.length;i++){ %>
				<dd class="goodsItem">
					<a class="react" onclick="goInfo(<%= list[i].goods_id %>)">
						<div class="dealcard">
							<div class="dealcard-img imgbox">
								<% if(list[i].thumb && list[i].thumb != ' '){%>
									<img src="<%=myurl%><%= list[i].thumb %>"/>
								<% }else{%>
									<img data="<%=myurl%><%= list[i].thumb %>" src="../../img/market/none.png"/>
								<% }%>	
								
							</div>
							<div class="dealcard-block-right">
								<div class="dealcard-brand single-line"><%= list[i].title %></div>
								<div class="title text-block bage">
									品牌: <%= list[i].brand %>
								</div>
								<div class="price mui-row">
									<div class="mui-col-sm-4 mui-col-xs-4">
										<span class="strong-color">￥</span><span class="strong"><%= list[i].price %></span>
									</div>
									<span class="mui-col-sm-4 mui-col-xs-4 middle Lgray">评价<%= list[i].comments %>条</span>
									<span class="mui-col-sm-4 mui-col-xs-4 right Lgray">已售<%= list[i].sales %></span>
								</div>
							</div>
						</div>
					</a>
				</dd>
			<% } %>
			<%}%>
			
		</script>
	</body>

	<script type="text/javascript">
		/*  滚动加载,修复点
		 * 1,定义全局变量can1,can2,传至 滚动加载中
		 * 2,定义实到,应到变量是全局
		 * 3,其他见代码
		 */
		var Spagenum = 2;//实到页数
		var Ypagenum = 1;//应到页数 
		mui.plusReady(function(){ 
			plus.nativeUI.showWaiting('加载中 ...',{width:'100px',height:'80px'});//显示等待框
			//获取缓存
			var oldToken = plus.storage.getItem('oldToken');
			//获取页面传值 商品分类id
			var goodcatId = plus.webview.currentWebview().goodscatId;
			var can1 = 'sales',can2 = 'desc',can3 = '';
			//显示品牌信息
			mui.ajax(serverUrl+'/api/mall/mallbrand',{ 									
				type:'post',
				timeout:5000, 
				headers:{"token":oldToken},	 
				success:function(data,type,xhr){
					console.log('品牌返回',data);
					if(data.errno == 0){
						var objdata = {};
						objdata.list = data.data;
						console.log(objdata.list);
						var html=template("pingpai",objdata);
						document.getElementById("pingpaidiv").innerHTML += html;
					}
				}
			});
			//按照选择排序
			window.order = function(orderType,sequence,brand){
				can1 = orderType,can2 = sequence,can3 = brand;
				var pagenum = 10,CcurrentPage = 1,sequence1 = sequence;
				plus.nativeUI.showWaiting('加载中 ...',{width:'100px',height:'80px'});//显示等待框
				mui.ajax(serverUrl+'/api/mall/mallgooodslist',{
					data:{
						currentPage:CcurrentPage,
						numsPerPage:pagenum,
						categoryid:goodcatId,
						recommend:'',
						differentiate:1,
						storeid:'',
						brand:can3,
						keyword:'',
						order_type:can1,
						desc:can2
					},
					type:'post',
					timeout:10000, 
					headers:{"token":oldToken},	 
					success:function(data,type,xhr){ 
					if(data.errno == 0){
						console.log('总条数'+data.data.return.totalPages);
						if(data.data.return.data.length){
							var objdata = {};
							objdata.myurl = serverimgUrl;
							objdata.list = data.data.return.data;
							var html=template("goodsList-detail",objdata);
							document.getElementById("goodsList").innerHTML=html;
							mui("#upload")[0].innerHTML = "";
						}else{	
							mui("#upload")[0].innerHTML = ""; 
							mui('#nulldiv')[0].style.display = 'block';
						}
						//滚动到底部加载
						$(window).scroll(function(){
						　　var scrollTop = $(this).scrollTop();
						　　var scrollHeight = $(document).height();
						　　var windowHeight = $(this).height();
						　　if(scrollTop + windowHeight == scrollHeight){//滚动条到达可以加载
								if(Spagenum<=data.data.return.totalPages && Spagenum==Ypagenum+1){//实到页数小于等于总页数时发起请求,并且实到=应到
									mui("#upload")[0].innerHTML = "<img src='../../img/balls.svg' />";
									Ypagenum++;//满足加载情况,应到页数+1
									console.log('发起请求,实到'+Spagenum+'页');									
									console.log('发起请求,应到'+Ypagenum+'页');									
									mui.ajax(serverUrl+'/api/mall/mallgooodslist',{ 									
										data:{
											currentPage:Spagenum,
											numsPerPage:pagenum,
											categoryid:goodcatId,
											recommend:'',
											differentiate:1,
											storeid:'',
											brand:can3,
											keyword:'',
											order_type:can1,
											desc:can2
										},
										type:'post',
										timeout:5000, 
										headers:{"token":oldToken},	 
										success:function(data,type,xhr){
											console.log('列表返回',data);
											if(data.errno == 0){
												var objdata = {};
												objdata.myurl = serverimgUrl;
												objdata.list = data.data.return.data;
												var html=template("goodsList-detail",objdata);
												document.getElementById("goodsList").innerHTML+=html;
											}
											mui("#upload")[0].innerHTML = " ";
											Spagenum++;//加载成功,当前页+1
											console.log('成功+1,实到'+Spagenum);
											console.log('成功+1,应到'+Spagenum);
										},
										error:function(xhr,type,errorThrown){
											Ypagenum--;//失败是应到-1
											mui.toast("当前网络不好请重试");
											mui("#upload")[0].innerHTML = "";
										} 
									});
								}else if(Spagenum == data.data.return.totalPages+1){//当前页不小于等于总页数时请求下一页
									mui("#upload")[0].innerHTML = "到底了";
								}
							}//加载下一部分结束
						});
						
					}else{
						mui("#upload")[0].innerHTML = ""; 
						mui('#nulldiv')[0].style.display = 'block';
					}
					plus.nativeUI.closeWaiting();//关闭等待框
				},
				error:function(xhr,type,errorThrown){
					plus.nativeUI.closeWaiting();//关闭等待框
					mui("#upload")[0].innerHTML = ""; 
					mui('#nulldiv')[0].style.display = 'block';
				}
				});
				
				$('.Category-eject').removeClass('grade-w-roll');
				$('.Sort-eject').removeClass('grade-w-roll');
				$('.grade-eject').removeClass('grade-w-roll');
			}
			order(can1,can2,can3);//初始化
			
			
			//筛选
			var Hscrollbar = 0;
			var screenin1s = mui('#screenin1')[0].getElementsByClassName('screenla');
			var upclose = function(){//关闭方法
				mui('body')[0].className = '';
				mui('#Maskdiv')[0].style.display = 'none';
				mui('#screendiv')[0].style.webkitTransform = 'translate3d(0, -401px, 0)';
				mui('#screenfoot')[0].style.webkitTransform = 'translate3d(0, -401px, 0)';
			}
			mui('#screenbtn')[0].onclick = function(){
				if(mui('body')[0].className == 'badyhide'){
					upclose();
				}else{//展开
					Hscrollbar = document.body.scrollTop;//获取滚动条高度
					mui('body')[0].className = 'badyhide';
					mui('#Maskdiv')[0].style.display = 'block';
					mui('#screendiv')[0].style.webkitTransform = 'translate3d(0, 0, 0)';
					mui('#screenfoot')[0].style.webkitTransform = 'translate3d(0, 0, 0)';
					
				}
			}
			//筛选确定
			mui('#determine')[0].onclick = function(){
				document.body.scrollTop = Hscrollbar;//设置滚动条高度
				upclose();
				for(var i=0; i<screenin1s.length; i++){
					var nowinput = screenin1s[i].getElementsByTagName('input')[0];
					if(nowinput.checked == true){
						var nowstr = screenin1s[i].getElementsByTagName('span')[0].innerHTML;
						alert(nowstr);
						order(can1,can2,nowstr);//初始化
						break;
					}
				}
					
			}
			
			//跳转详情
			window.goInfo =  function(goodsId){ 
				 openview({
				 	view:"mall-detail.html",
				 	extrasobj:{goodsId:goodsId} 
				 })
			}
		})();
	</script>
</html>