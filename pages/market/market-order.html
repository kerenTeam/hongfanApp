<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>商品订单确认</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/reset.css"> 
		<script src="../../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<style type="text/css">
			.mui-bar {
				height: 50px;
				box-shadow: none;
			}  
			
			.mui-title,
			.mui-icon {
				line-height: 50px;
			}
			
			.mui-bar .mui-icon {
				padding: 0;
			}
			
			#main {
				margin-top: 50px;
			}
			/*这一页*/
			
			.kv-line-r>h6,
			.kv-line-r>.kv-k {
				font-size: 13px;
			}
			
			.boxs {
				margin-bottom: 10px;
			}
			.boxs li{
				border-top: 0;
			}
			.boxstwo li a {
				width: 100%;
			}
			
			.mui-icon-location {
				width: 100%;
				text-align: center;
				margin-left: -7px;
			}
			
			.mui-col-sm-9 {
				padding-left: 15px;
			}
			
			.ico_arrow {
				position: absolute;
				top: 0;
				margin: 23px 0;
			}
			
			.phoneNum {
				float: right;
			}
			
			strong p {
				padding: 5px 10% 5px 0;
				line-height: 20px;
				color: #333;
			}
			
			.address {
				text-overflow: ellipsis;
				white-space: nowrap;
				overflow: hidden;
				width: ;
			}
			
			.middle-icon {
				padding: 4px 0;
			}
			
			.addBtn {
				background-color: #ff9100 !important;
				border: 1px solid #ff9100 !important;
			}
			
			.mui-numbox {
				width: 100px;
				height: 30px;
				padding: 0 30px;
			}
			
			.mui-numbox .mui-btn {
				width: 30px;
			}
			
			.addTitle {
				line-height: 30px;
			}
			.quanc{
				
				width:0.3rem;
				margin-right: 0.1rem;
				display: none;
			}
			dl.list .dd-paddingtwo {
				padding: .08rem .15rem .08rem .15rem;
			}
			
			.addTitle img {
				width: 100%;
			}
			
			dl.list {
				border: 1px solid #eee;
			}
			
			dl.list dt,
			dl.list dd {
				border-bottom: 0px solid #eee;
				position: relative;
			}
			dl.list dt:after,
			dl.list dd:after{
				content: '';display: block;height: 1px;-webkit-transform: scaleY(0.3);background-color: rgba(0,0,0,0.1);position: absolute;width: 100%;bottom: 0;left: 0;
			}
			dl.list dt:last-child:after,
			dl.list dd:last-child:after{
				height: 0;
			}
			.price {
				color: #ff5f32;
				line-height: 28px;
				font-size: 16px;
			}
			
			.kv-line-r>p span {
				color: #ff5f32;
			}
			
			.price sub {
				bottom: 0;
			}
			
			.num {
				float: right;
				color: #333;
			}
			
			p,
			h6 {
				color: #333;
			}
			
			.postWrap {
				background: #fff url(../../img/market/post.png) no-repeat bottom;
				background-size: 100%;
			}
			
			.boxstwo li a {
				margin: 10px 0;
			}
			
			#container {
				padding-bottom: 50px;
			}
			
			.goods p {
				padding: 3px 0;
				line-height: 20px;
			}
			
			.goodsDetail {
				font-size: 12px;
				color: #999;
				line-height: 15px !important;
			}
			
			.tips {
				margin-bottom: 0 !important;
				border: none !important;
				font-size: 14px;
				line-height: 16px;
			}
			
			.tipsWrap,.ztWrap {
				padding: 0 0.15rem !important;
			}
			
			.tipsWrap input,.ztWrap input {
				padding: 0 !important;
			}
			
			.tipsWrap h6,.ztWrap h6 {
				line-height: 40px;
				margin-right: 0;
			}
			
			.tipsWrap h6 .goods,.ztWrap h6 .goods {
				padding-left: 0;
			}
			
			dl.list dd dl {
				padding-left: 0;
			}
			
			dl.list dd dl>.dd-padding,
			dl.list dd dl dd>.react,
			dl.list dd dl>dt {
				padding: 0.15rem;
			}
			
			.goodsWrap {
				background-color: #fafafa;
			}
			
			.comm_btn {
				margin: 0;
				height: 50px;
				line-height: 50px;
				padding: 0;
				width: 100%;
				text-align: center;
			}
			
			.fixed .btn {
				border: none !important;
				bottom: 0;
				right: 0;
				width: 25%;
			}
			
			.fixed p {
				width: 75%;
				text-align: right;
			}
			
			.priceWrap {}
			
			.priceWrap p {
				text-align: right !important;
				display: block;
				font-size: 16px;
				width: 100%;
			}
			
			.priceWrap p sub {
				bottom: 0;
			}
			#coupon .mui-checkbox,.checkQuan .mui-checkbox{
				position: absolute;
				top: 50%;
				margin-top: -18px;
				right: 0;
			}
			.mui-checkbox input[type=checkbox]:checked:before, .mui-radio input[type=radio]:checked:before {
			    color: rgb(245, 60, 66);
			}
			.mui-card{
				margin: 0;
			}
			.checkQuan{
				padding: 2px 15px;
			    border: 1px solid #f53c42;
			    border-radius: 5px;
			    line-height: 18px;
			    margin: 5px 0;
			    position: relative;
			}
			.checkQuan .mui-col-sm-3{
				width: 28%;
				padding: 12px 5px;
    			border-right: 1px dotted #f53c42;
			}
			.checkQuan .mui-col-sm-9{
				width: 72%;
				    padding: 12px 15px;
			}
			.cred{
				color:#f53c42 ;
			}
			.dateLimit{
				font-size: 12px;
			}
			#sfzin{
				width: -moz-calc(100%-70px)!important;
				width: -webkit-calc(100%-70px)!important; 
				width: calc(100%-70px)!important;
				font-size: 12px;
			    padding: 0;
			    text-align: right;
			    background: none;
			    outline: none;
			    height: auto;
			    margin: 0;
			    line-height: 12px;
			    border: none;
			} 
			.sf:after{
				height: 0px!important;
			}
			.mui-checkbox.mui-left label, .mui-radio.mui-left label {
			    padding-right: 15px;
			    padding-left: 46px;
			    padding-top: 14px;
			}
			.mui-radio input[type=radio]:before{
				font-size: 20px;
			}
			.mui-radio input[type=radio]{
				top: 10px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav hasManyCity hasManyCitytwo">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize fl fanhui"></a>
			<div class="header-tit">
				订单确认
			</div>
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div id="container">
			<div id="main">
				<form class="wrapper-list">
					<ul class="boxs boxstwo postWrap">
						<div id="add_info"></div>
						<script type="text/html" id="addrTpl">
							<%if(obj.length==0){%>
							<li onclick="goAddr()">
								<div class="mui-row orderRow">
									<div class="mui-col-sm-1 mui-col-xs-1">
										<span class="mui-icon mui-icon-location middle-icon"></span>
									</div>
									<div class="mui-col-sm-11 mui-col-xs-11">
										<p style="line-height: 50px;">请选择收货地址</p>
										<p class="address"></p>
										<div class="fr"><i class="ico_arrow middle-icon"></i></div>
									</div>
								</div>
							</li>
							<%}else{%>
							<li onclick="goAddr()" id="addid" data-id="<%=obj[0].id%>" data-name="<%=obj[0].person%>" data-address="<%=obj[0].province%><%=obj[0].city%><%=obj[0].area%><%=obj[0].address%>" data-phone="<%=obj[0].phone%>">
								<div class="mui-row orderRow">
									<div class="mui-col-sm-1 mui-col-xs-1">
										<span class="mui-icon mui-icon-location middle-icon"></span>
									</div>
									<div class="mui-col-sm-11 mui-col-xs-11">
										<strong>									
											<p>收货人：<%=obj[0].person%><span class="phoneNum"><%=obj[0].phone%></span></p>
											<p class="address">收货地址：<%=obj[0].province%><%=obj[0].city%><%=obj[0].area%><%=obj[0].address%></p>
											<div class="fr"><i class="ico_arrow middle-icon"></i></div>
										</strong>
									</div>
								</div>
							</li>

							<%}%>
						</script>

					</ul>
					<div id="orderTpl"></div>
					<script type="text/html" id="orderData">
						<%for(var i =0;i<cates.length;i++){%>
						<dl class="list">
							<dd class="dd-padding kv-line-r">
								<h6><img src="../../img/market/shop.png" style="width: 0.2rem;vertical-align: middle;" alt="" /> <%=cates[i]%></h6>
							</dd>
							<%for(var j =0;j<goodsList.length;j++){%>
							<% if(goodsList[j].shopName ==  cates[i]){%>
							<dd class="dd-padding kv-line-r mui-row goodsWrap"> <!--onclick="goInfo('<%=goodsList[j].goodsId%>')"-->
								<% if(goodsList[j].shopName == '爱购保税'){%>
								   <h6 class="addTitle mui-col-sm-4 mui-col-xs-4"><img src="<%=goodsList[j].goodsImg%>" onerror="javascript:this.src='../../img/market/none.png';"/></h6>
								<%}else{%>
								   <h6 class="addTitle mui-col-sm-4 mui-col-xs-4"><img src="<%=myurl%><%=goodsList[j].goodsImg%>" onerror="javascript:this.src='../../img/market/none.png';"/></h6>

									<%}%>
								<div class="clearfloat fr mui-col-sm-8 mui-col-xs-8 goods">
									<p>
										<%=goodsList[j].goodsName%>
									</p>
									<p class="goodsDetail">
										<%=goodsList[j].goodText%>
									</p>
									<p class="price"><sub>￥</sub>
										<%=goodsList[j].goodsPrice%> <span class="num">×<%=goodsList[j].goodsnum%></span></p>
									<%if(shopID[i]==0){%>	
									<samll style="font-size:0.1rem;color: gray;">含税<%=goodsList[j].goodsPostfee%> </samll>
									<%}%>
								</div>
							</dd>
							<%}%>
							<%}%>
							<dd class="dd-padding kv-line-r postfeeWrap">
								<%if(shopID[i]==0){%> 
								<h6>配送方式</h6>
									<%if(arrpostFee[i]==0 || !arrpostFee[i]||arrpostFee[i]==' '){%>
											<p class="jifen">税费 免税</p>
											<%}else{%>
												<p class="jifen">税费 <%=arrpostFee[i]%>元</p>
											<%}%> 
									<%}else{%>
										
								<h6>配送方式</h6>
										<%if(arrpostFee[i]==0 || !arrpostFee[i] ||arrpostFee[i]==' '){%>
											<p class="jifen">快递 免邮</p>
											<%}else{%>
												<p class="jifen">快递 <%=arrpostFee[i]%>元</p>
											<%}%>
										<%}%>
								
								
							</dd>
							<%if(shopID[i]!=0){%>
								<dd class="dd-padding kv-line-r mui-row ztWrap" data-id="<%=shopID[i]%>">
									<input type="hidden" class="isziti" value="0"/>
									<h6 class="addTitle mui-col-sm-3 mui-col-xs-3">是否自提</h6>
									 
									<div class="clearfloat fr mui-col-sm-9 mui-col-xs-9 goods">
	 									<div class="mui-checkbox ddRadio"><input name="checkbox<%=i%>" data-shopId="<%=shopID[i]%>" data-postfee="<%=arrpostFee[i]%>" class="groupCheck" type="checkbox" style="right: 5px;"></div> 
									</div>
								</dd>
							<%}%>
							<dd class="dd-padding kv-line-r mui-row tipsWrap" data-id="<%=shopID[i]%>">
								<h6 class="addTitle mui-col-sm-1 mui-col-xs-2">备注：</h6>
								<div class="clearfloat fr mui-col-sm-11 mui-col-xs-10 goods">
									<input type="text" id="" value="" placeholder="选填（对本次交易的说明）" class="tips" />
								</div>
							</dd>
							<dd class="kv-line-r dd-padding priceWrap">
								<p>
									<sub>共计<span class="groupNum"><%=arrNum[i]%></span>件商品&nbsp;&nbsp;小计:<b style="color: #ff5f32;">￥</b></sub>
									<span class="J_total-price groupMoney" data-id="<%=arrpostFee[i]%>"><%=arrMoney[i]%></span>
								</p>
							</dd>
						</dl>

						<%}%>
						
					</script>
					
						<dl class="list">
							 
							<div id="quanData"></div>
							<script type="text/html" id="quanTpl">
								<%if(allLi.length!=0){%>
									
									<dd>
								<div class="mui-card">
										<ul class="mui-table-view">
											
											<li class="mui-table-view-cell mui-collapse">
												<a class="mui-navigate-right" style="border-bottom: 1px solid #eee;padding: 15px;" href="#">抵用券  <b class="minuMoney cred" style="display: none;">-￥<span id="minuMoney"></span></b><span class="fr" style="margin-right: 15px;">选择</span></a>
												<div class="mui-collapse-content">
													<% for(var i=0;i<allLi.length;i++){ %>
								 						<%if(allLi[i].typeid==1){%>
								 							<%if(allLi[i].salerule.overflowValue!=0){%>
								 								<div class="checkQuan mui-row" data-id="<%=allLi[i].typeid%>" data-minus="<%=allLi[i].salerule.cutValue%>">
																	 <div class="mui-col-sm-3">
																	 	<div>￥<big><b><%=allLi[i].salerule.cutValue%></b></big></div>
																	 	<div><small>满<span><%=allLi[i].salerule.overflowValue%></span>使用</small></div>
																	 </div>
																	 <div class="mui-col-sm-9">
																	 	<div class="cred"><big><%=allLi[i].name%></big> 全场满<span><%=allLi[i].salerule.overflowValue%></span>减<span><%=allLi[i].salerule.cutValue%></span></div>
																	 	<div class="dateLimit"><%=allLi[i].begin_date%> ~ <%=allLi[i].end_date%>内有效</div>
																	 </div>
																	 <div class="mui-checkbox"><img src="../../img/market/xuanze.png" class="quanc" data-id="<%=allLi[i].user_coupon_id%>" alt="" /></div>
																</div> 
								 								<%}else{%>
								 									<div class="checkQuan mui-row" data-id="<%=allLi[i].typeid%>" data-minus="<%=allLi[i].salerule.cutValue%>">
																		 <div class="mui-col-sm-3">
																		 	<div>￥<big><b><%=allLi[i].salerule.cutValue%></b></big></div>
																		 	<div><small>全场通用</small></div>
																		 </div>
																		 <div class="mui-col-sm-9">
																		 	<div class="cred"><big><%=allLi[i].name%></big> 全场通用减<span><%=allLi[i].salerule.cutValue%></span></div>
																		 	<div class="dateLimit"><%=allLi[i].begin_date%> ~ <%=allLi[i].end_date%>内有效</div>
																		 </div>
																		 <div class="mui-checkbox"><img src="../../img/market/xuanze.png" class="quanc" data-id="<%=allLi[i].user_coupon_id%>" alt="" /></div>
																	</div> 
								 									
								 									<%}%>
								 							
								 							<%}else{%>
								 							<div class="checkQuan mui-row" data-id="<%=allLi[i].typeid%>" data-minus="<%=allLi[i].discount%>">
															 <div class="mui-col-sm-3">
															 	<div><big><b><%=allLi[i].discount*10%></b></big>折</div>
															 	<div><small>全场通用</small></div>
															 </div>
															 <div class="mui-col-sm-9">
															 	<div class="cred"><big><%=allLi[i].name%></big> 全场打<span><%=allLi[i].discount*10%></span>折</div>
															 	<div class="dateLimit"><%=allLi[i].begin_date%> ~ <%=allLi[i].end_date%>内有效</div>
															 </div>
															 <div class="mui-checkbox"><img src="../../img/market/xuanze.png" class="quanc" data-id="<%=allLi[i].user_coupon_id%>" alt="" /></div>
														</div> 
								 								<%}%>
													<%}%> 
												</div>
											</li>
										</ul>
									</div>  
									
							</dd>
									
										
								<%}%>
								
							</script>
							
							
					
							<div id="coupon"></div>
								<script type="text/html" id="couponTpl">
									<%if(intergral!=0){%>
										<dd class="dd-padding kv-line-r">
											<h6>可用<%=intergral%>积分抵<span id="itMinus" style="color: #ff5f32;"><span>￥</span><%=intergral%></span></h6>
												<div class="mui-checkbox"><input name="checkbox" class="groupCheck" type="checkbox"></div>
										</dd>
										<%}else{%>
											<dd class="dd-padding kv-line-r">
											<h6>无可用积分</h6>
												<div class="mui-checkbox"><input name="checkbox" disabled class="groupCheck" type="checkbox"></div>
										</dd>
											<%}%>
									
								</script>
							
						</dl>
				</form>
			</div>
			<div class="fixed">
				<p>合计：<span class="show_delivery_fee">￥<span id="submit_order"></span></span></p>
				<span class="fr btn">
					<a onclick="goPay()" class="comm_btn">提交订单</a>
				</span>
			</div>
		</div>
	</body>
	<script src="../../js/app.js"></script>
	<script src="../../js/artTemplate-native.js"></script>
	<script type="text/javascript"> 
			mui.init({
				beforeback: function() { 
					//获得列表界面的webview
					var list = plus.webview.getWebviewById('cart.html'); 
						mui.fire(list,'refresh');
						return true;
				}
			});
			
		var myuserid,allGroup=0,quan=0,jf=0,orderSubmitData=[],arr =[],arrNum=[],arrMoney =[],arrpostFee=[],shopID=[],totalPay=0;;
		
		mui.plusReady(function() {
			window.addEventListener('readdstorage', function(event) { 
				orderAdd()
			});
			//订单缓存
			var orderStorage = JSON.parse(plus.storage.getItem('$orderStorage') || '[]');
			  console.log("orderStorage   "+plus.storage.getItem('$orderStorage'))
				//获取缓存
			     myuserid = plus.storage.getItem('userid'); 
			var oldtoken = plus.storage.getItem('oldToken');
			
			
			plus.nativeUI.showWaiting('加载中 ...', {
				width: '100px',
				height: '80px'
			});
			
			orderAdd();
			function orderAdd(){
			 
				mui.ajax(serverUrl + '/api/useraccount/addresslist', {
				data: {
					userid: myuserid,
					state: 1
				},
				dataType: 'json',
				type: 'post',
				timeout: 10000,
				headers: {
					"token": oldtoken
				},
				success: function(data, type, xhr) {
					if(data.errno == 0) { 
//						plus.nativeUI.closeWaiting()
//					  //alert("ddd "+JSON.stringify(data.data))
						var addrObj = {};
//							 //alert(plus.storage.getItem("$addressStorage"))
						if(plus.storage.getItem("$addressStorage")!=null){
							addrObj.obj = JSON.parse(plus.storage.getItem("$addressStorage")); 
						}else{
//							//alert("fd")
							addrObj.obj = data.data; 
						}
							
						document.getElementById("add_info").innerHTML = template("addrTpl", addrObj);
						plus.storage.removeItem("$addressStorage")
						
					}
				},
				error: function(xhr, type, errorThrown) {
					////alert('响应失败  !');
					plus.nativeUI.closeWaiting();
					mui.toast("网络不好请重试")
				}
			});
			}
			
			
			//订单数据模板
						var data = {};
						data.goodsList = orderStorage;
						for(var i = 0; i < orderStorage.length; i++) {
							arr.push(orderStorage[i].shopName);
						} 
						////alert(arr.length)
						data.cates = arr.unique1();
						for(var i = 0; i < orderStorage.length; i++) {
							shopID.push(orderStorage[i].shopId);
							//alert(orderStorage[i].shopId)
						}  
						
						shopID = shopID.unique1();  
						data.shopID = shopID;
						  //alert(JSON.stringify(shopID))
						for(var i= 0;i<data.shopID.length;i++){
							//分组邮费小计
							var groupPostfee=0; 
							 for(var j = 0;j<orderStorage.length;j++){
							 	if(data.shopID[i] == orderStorage[j].shopId){
							 		if(data.shopID[i] == 0){
							 			groupPostfee+=parseFloat(orderStorage[j].goodsPostfee);
							 		}else{
							 			//alert(orderStorage[j].goodsPostfee)
							 			if(orderStorage[j].goodsPostfee!=0 || !orderStorage[j].goodsPostfee || orderStorage[j].goodsPostfee!=' '){
									 		groupPostfee=parseFloat(orderStorage[j].goodsPostfee);
									 		break;
									 	}else{
									 		groupPostfee = 0;
									 	}
							 		}
							 	}
							 	
							 }
							 arrpostFee.push(parseFloat(groupPostfee).toFixed(2));
						}
						 
						 
						 
						for(var i= 0;i<data.cates.length;i++){
							//分组 金额 和 数量 小计
							var groupNum=0,groupMoney=0;
							 for(var j = 0;j<orderStorage.length;j++){
							 	if(orderStorage[j].shopName ==  data.cates[i]){
							 		groupNum+=parseFloat(orderStorage[j].goodsnum);
							 		groupMoney+=parseFloat(orderStorage[j].goodsPrice)*parseFloat(orderStorage[j].goodsnum); 
							 	} 
							 } 
							 arrNum.push(groupNum);
							 arrMoney.push(parseFloat(groupMoney)+parseFloat(arrpostFee[i]));
						}
						
						//分组商品总价
						for(var i=0;i<arrMoney.length;i++){
							allGroup+=parseFloat(arrMoney[i])
							
						}
						
						//分商店  订单数据 小计
						
						for(var i= 0;i<shopID.length;i++){ 
							var orderList={};
							    orderList.storeid=shopID[i];
							    orderList.postFee = arrpostFee[i];
							    orderList.totalNum = arrNum[i];
							    orderList.totalMoney = arrMoney[i];
							    orderList.goodsData =[]; 
						 	for(var j = 0;j<orderStorage.length;j++){
						 	 if(orderStorage[j].shopId == shopID[i]){
						 	 	orderList.goodsData.push(orderStorage[j])
						 	 }
						 	 
						 	}
							 orderSubmitData.push(orderList);
						}
						
						
						////alert("allGroup "+allGroup)
						data.arrpostFee=arrpostFee;
						data.arrNum=arrNum;
						data.arrMoney=arrMoney; 
						data.myurl = serverimgUrl;
						var html = template('orderData', data);
						document.getElementById('orderTpl').innerHTML = html;
						
						  countTotalPay();
						  function countTotalPay(){
						  	var allThis = 0
						  	var everyGroup = document.getElementsByClassName("groupMoney");
						  	for(var i=0;i<everyGroup.length;i++){
						  		allThis+=parseFloat(everyGroup[i].innerHTML);
						  	
						  		
						  	} 
						  	totalPay=allThis-jf-quan;
						  	if(totalPay<0){
						  		totalPay =0;
						  	}
						  		$("#submit_order").html(totalPay)
						  }
						  
						   
			
			
			//获取积分
			mui.ajax(serverUrl+'/api/useraccount/userinfo',{
				data:{"userid":myuserid},
				type:'post',
				timeout:10000,
				headers:{"token":oldtoken},	              				
				success:function(data,type,xhr){
					var intergral=0;
					console.log('获取用户数据返回'+JSON.stringify(data));
					if(data.errno == 0){
						   intergral = data.data[0].intergral;
						  // //alert(intergral)
						   if(intergral==null){
						   	intergral=0;
						   }
						 document.getElementById("coupon").innerHTML=template('couponTpl', {intergral:intergral});
					}else{
						mui.toast('获取用户信息失败');
						console.log(data.errmsg);
					}
					$("#coupon .mui-checkbox").click(function(){ 
						
							if($(this).find("input").prop('checked') == true){ 
								jf=parseFloat(intergral); 
							}else{ 
								jf=0; 
							}
							//alert(jf)
							countTotalPay()
//							var nowPAY =parseFloat(allGroup-jf-quan).toFixed(2);
//								if(nowPAY<=0){
//									nowPAY=0;
//								} 
						})
				},
				error:function(xhr,type,errorThrown){
				//	//alert('响应失败  !');
				}
			});
			var d = new Date();
			var str = d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate();
			 str = formatDate(str, "yyyy.MM.dd");
 				////alert(str)
			//获取抵用券
			mui.ajax(serverUrl+'/api/useraccount/mycoupon',{
					data:{userid : myuserid},
					dataType:'json',
					type:'post',
					timeout:10000,
					headers:{"token":oldtoken},	 
					success:function(data,type,xhr){
//					 alert("dfdsgfdgf  "+JSON.stringify(data.data));
						var allC = {};
						var tpldata=[];
						
						for(var i=0;i<data.data.length;i++){
							
							 
							if(data.data[i].user_coupon_state==1 && (data.data[i].typeid==1||data.data[i].typeid==2)){
								
								if(data.data[i].end_date!=null){
										data.data[i].end_date=formatDate(data.data[i].end_date, "yyyy.MM.dd");
								} 
								if(data.data[i].begin_date!=null){
									data.data[i].begin_date=formatDate(data.data[i].begin_date, "yyyy.MM.dd");
								} 
								if(data.data[i].salerule!=''){ 
									
									data.data[i].salerule = eval("("+data.data[i].salerule+")");
									if(parseFloat(data.data[i].salerule.overflowValue)<=allGroup){  
										if(data.data[i].begin_date<=str && str<=data.data[i].end_date){ 
										    tpldata.push(data.data[i])
											}
									} 
								}else{
//									data.data[i].salerule = eval("("+data.data[i].salerule+")");
									if(data.data[i].begin_date<=str && str<=data.data[i].end_date){ 
										    tpldata.push(data.data[i])
											}
								}
								
							}
						} 
						allC.allLi = tpldata;
						var html = template('quanTpl',allC);
						document.getElementById('quanData').innerHTML = html;
						
										plus.nativeUI.closeWaiting(); 
						
				//优惠券计算
						$(".checkQuan").click(function(){
							var qid = $(this).attr("data-id");
							////alert("qid "+qid)
							var qminus =$(this).attr("data-minus");
							////alert("qminus "+qminus) 
							$(this).siblings().find(".quanc").css("display","none");
							quan=0;
							if($(this).find(".quanc").css("display")=="block"){ 
								$(this).find(".quanc").css("display","none");
								$("#minuMoney").html(0);
								$(".minuMoney").css("display","none"); 
								
							}else{
								$(this).find(".quanc").css("display","block");
								if(qid==1){
									quan=parseFloat(qminus)
								}
								if(qid==2){
									quan =parseFloat(allGroup*(1-parseFloat(qminus))).toFixed(2);
								}
								$("#minuMoney").html(quan); 
								$(".minuMoney").css("display","inline-block"); 
								
							}
//							var nowPAY = parseFloat(allGroup-jf-quan).toFixed(2);
//								if(nowPAY<=0){
//									nowPAY=0;
//								}
							countTotalPay();
						
						})
				//自提 or 配送  更新 邮费 和 分组价格 和 总价 
				        $("dd .ddRadio").each(function(){  
				        	$(this).find("input[type='checkbox']").click(function(){ 
					        		var dataPostfee= parseFloat($(this).attr("data-postfee")); 
					        			if($(this).prop('checked')==true){
					        				
					        				var curPost =parseFloat($(this).parentsUntil("#orderTpl").find("dd.priceWrap .groupMoney").html());
					        				$(this).parentsUntil("#orderTpl").find("dd.priceWrap .groupMoney").html(curPost-dataPostfee);
					        				$(this).parentsUntil("#orderTpl").find("dd.postfeeWrap .jifen").html('自提')
					        				 
					        			 countTotalPay();
					        			$(this).parentsUntil("#orderTpl").find("dd.ztWrap input[type='hidden']").val(1)
					        			}else{
					        				var curPost =parseFloat($(this).parentsUntil("#orderTpl").find("dd.priceWrap .groupMoney").html());
					        				$(this).parentsUntil("#orderTpl").find("dd.priceWrap .groupMoney").html(curPost+dataPostfee)
					        				if(dataPostfee==0){
					        				   $(this).parentsUntil("#orderTpl").find("dd.postfeeWrap .jifen").html('快递 免邮')
					        					
					        				}else{
					        					$(this).parentsUntil("#orderTpl").find("dd.postfeeWrap .jifen").html('快递 '+dataPostfee+"元")

					        				}
					        				 countTotalPay();
					        			$(this).parentsUntil("#orderTpl").find("dd.ztWrap input[type='hidden']").val(0);
					        			}
					        		//	alert("自提"+$(this).parentsUntil("dl").find("input[type='hidden']").val())
					        	 
					        	  
				        		
				        	})
				        })
					},
					error:function(xhr,type,errorThrown){
						mui.toast("网络不好请重试!")
					}
				}); 
				//goPay
				window.goPay=function(){  
					if($("#addid").length!=0){
						var yourSFZ = $('#sfzin').val();
						 
							plus.nativeUI.showWaiting('加载中 ...', {
								width: '100px',
								height: '80px'
							}); 
							//地址
							var MYaddress = {};
							var addressid =$("#addid").attr("data-id");
							MYaddress.people = $("#addid").attr("data-name");
							MYaddress.addressNow = $("#addid").attr("data-address");
							MYaddress.phoneNow =  $("#addid").attr("data-phone"); 
							//买家留言
							var noticeData=[];  
							$(".tipsWrap").each(function(){
								var notice = $(this).find("input").val();
								for(var i=0;i<orderSubmitData.length;i++){
									orderSubmitData[i].sendAddress = MYaddress;
									if(orderSubmitData[i].storeid == $(this).attr("data-id")){ 
										if(orderSubmitData[i].storeid == 0 ){
											orderSubmitData[i].order_type = 2;
										}else{
											orderSubmitData[i].order_type = 1;
										}
										if(orderSubmitData[i].storeid == 0 ){
											orderSubmitData[i].isBySelf = 0;
										}else{
											 var isBySelfDIV = document.getElementsByClassName("ztWrap");
											 for(var m=0;m<isBySelfDIV.length;m++){
											 	var thisShopID = isBySelfDIV[m].getAttribute("data-id");
											 	if(orderSubmitData[i].storeid == thisShopID){
											 		var isBySelf = isBySelfDIV[m].getElementsByClassName("isziti")[0].value; 
//											 		alert(isBySelf)
											 		if(isBySelf == 0){
											 			orderSubmitData[i].isBySelf = 0;
											 		}else{
											 			orderSubmitData[i].isBySelf = 1;
											 			orderSubmitData[i].postFee = 0;
											 		}
											 	}
											 }
										}
										
										orderSubmitData[i].notice = notice;
									}
								}
								if(notice!=''){
									var noticeObj={};
									noticeObj.shopId = $(this).attr("data-id");
									noticeObj.notice = notice;
									noticeData.push(noticeObj)
								}
								
								
							});
							 
							//优惠券id
							var coupon_id='';
							$(".quanc").each(function(){
								if($(this).css("display")=="block"){
									coupon_id =$(this).attr("data-id");
								}
							}) 
//							alert("coupon_id "+coupon_id)
							//积分使用
							var isIntergal=0;
							if($("#coupon").find("input[type='checkbox']:checked").length==1){
	//							 //alert("yes");
								isIntergal=1
							}else{
	//							 //alert("no")
								isIntergal=0;
							}
							var goodsdata = JSON.stringify(orderSubmitData);
							console.log("goodsdata"+goodsdata)
							var notice = JSON.stringify(noticeData); 
							//获取总价
							var payTotal =parseFloat($("#submit_order").html()).toFixed(2);
							
							
							//提交
//							 alert("orderSubmitData 1234ewrew"+"优惠券 "+coupon_id+" "+JSON.stringify(orderSubmitData))
			 					mui.ajax(serverUrl+'/api/mall/neworder',{
									data:{userid:myuserid,addressid:addressid,paytotal:payTotal,goodsdata:goodsdata,notice:notice,coupon_id:coupon_id,isIntergal:isIntergal},
									dataType:'json',
									type:'post',
									timeout:10000,
									headers:{"token":oldtoken},	 
									success:function(data,type,xhr){
	
										//购物车 缓存 
	        							var cartStorage =JSON.parse(plus.storage.getItem('$cartStorage')||'[]');
	        							////alert(cartStorage)
	        							console.log("cartStorage   "+plus.storage.getItem('$cartStorage')) 
										//删除 购物车里 提交的这一条数据 
										console.log("orderStorage   ddsfdf "+JSON.stringify(orderStorage))
										for(var i=0;i<orderStorage.length;i++){
											
											for(var j=0;j<cartStorage.length;j++){
												if(orderStorage[i].goodsId == cartStorage[j].goodsId && orderStorage[i].goodText == cartStorage[j].goodText){
													 cartStorage.splice(j,1)
												}
												//break;
											}
											
											
										}
	//									//alert("ooooo "+JSON.stringify(cartStorage))
										plus.storage.setItem("$cartStorage",JSON.stringify(cartStorage))
										var list = plus.webview.getWebviewById('cart.html'); 
												mui.fire(list,'refresh'); 
	//									//alert(JSON.stringify(data))
										if(data.errno==0){
											alert(JSON.stringify(data.data))
											var payMents = data.data.paytotal;
//											var order_id = data.data.order_id;
//											alert(order_id)
											var uuid = data.data.order_UUID; 
											
											openview({
												view:"../market/pay.html",
												id:"pay",
												extrasobj:{payMent:payMents,uuid:uuid}
											})
//												plus.webview.currentWebview().close();

										}else{
											plus.nativeUI.closeWaiting() 
										}
									},
									error:function(xhr,type,errorThrown){
										plus.nativeUI.closeWaiting()
										console.log('响应失败  !');
									}
								}); 
//						
					}else{ 
						plus.nativeUI.closeWaiting()
						mui.toast("您还未选择收货地址哟！")
					}
					 
					
				}
				
		})
		
		//进入地址页面
		function goAddr(){ 
			openview({
				view:"../personal/address.html",
				extrasobj:{pageid:"market-order",userId:myuserid}
			})
		}
		
		//数组去重
		Array.prototype.unique1 = function() {
			var res = [this[0]];
			for(var i = 1; i < this.length; i++) {
				var repeat = false;
				for(var j = 0; j < res.length; j++) {
					if(this[i] == res[j]) {
						repeat = true;
						break;
					}
				}
				if(!repeat) {
					res.push(this[i]);
				}
			}
			return res;
		}
		
		//格式化时间戳
		function formatDate(v, format) {
		    if (!v) return "";
		    var d = v;
		    if (typeof v === 'string') {
		        if (v.indexOf("/Date(") > -1)
		            d = new Date(parseInt(v.replace("/Date(", "").replace(")/", ""), 10));
		        else
		            d = new Date(Date.parse(v.replace(/-/g, "/").replace("T", " ").split(".")[0]));//.split(".")[0] 用来处理出现毫秒的情况，截取掉.xxx，否则会出错
		    }
		    var o = {
		        "M+": d.getMonth() + 1,  //month
		        "d+": d.getDate(),       //day
		        "h+": d.getHours(),      //hour
		        "m+": d.getMinutes(),    //minute
		        "s+": d.getSeconds(),    //cond
		        "q+": Math.floor((d.getMonth() + 3) / 3),  //quarter
		        "S": d.getMilliseconds() //millisecond
		    };
		    if (/(y+)/.test(format)) {
		        format = format.replace(RegExp.$1, (d.getFullYear() + "").substr(4 - RegExp.$1.length));
		    }
		    for (var k in o) {
		        if (new RegExp("(" + k + ")").test(format)) {
		            format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
		        }
		    }
		    return format;
		};

	</script>

</html>