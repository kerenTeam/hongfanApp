<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>商品订单确认</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/reset.css">
		<!--<link href="../../css/mui.picker.min.css" rel="stylesheet" />
		<link href="../../css/mui.poppicker.css" rel="stylesheet" />-->
		<script src="../../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<!--<script type="text/javascript" src="../../js/jquery.flexslider-min.js"></script>-->
		<!--<script type="text/javascript" src="../../js/swiper.min.js"></script>-->
		<!--<script src="../../js/mui.picker.min.js"></script>
		<script src="../../js/mui.poppicker.js"></script>
		<script src="../../js/other.js" type="text/javascript" charset="utf-8"></script>-->
		<style type="text/css">
			.mui-bar {
				height: 50px;
				box-shadow: none;
			}
			
			.mui-title,
			.mui-icon {
				line-height: 50px;
			}
			
			.mui-bar .mui-icon {
				padding: 0;
			}
			
			#main {
				margin-top: 50px;
			}
			/*这一页*/
			
			.kv-line-r>h6,
			.kv-line-r>.kv-k {
				font-size: 13px;
			}
			
			.boxs {
				margin-bottom: 10px;
			}
			
			.boxstwo li a {
				width: 100%;
			}
			
			.mui-icon-location {
				width: 100%;
				text-align: center;
				margin-left: -7px;
			}
			
			.mui-col-sm-9 {
				padding-left: 15px;
			}
			
			.ico_arrow {
				position: absolute;
				top: 0;
				margin: 23px 0;
			}
			
			.phoneNum {
				float: right;
			}
			
			strong p {
				padding: 5px 10% 5px 0;
				line-height: 20px;
				color: #333;
			}
			
			.address {
				text-overflow: ellipsis;
				white-space: nowrap;
				overflow: hidden;
				width: ;
			}
			
			.middle-icon {
				padding: 4px 0;
			}
			
			.addBtn {
				background-color: #ff9100 !important;
				border: 1px solid #ff9100 !important;
			}
			
			.mui-numbox {
				width: 100px;
				height: 30px;
				padding: 0 30px;
			}
			
			.mui-numbox .mui-btn {
				width: 30px;
			}
			
			.addTitle {
				line-height: 30px;
			}
			
			dl.list .dd-paddingtwo {
				padding: .08rem .15rem .08rem .15rem;
			}
			
			.addTitle img {
				width: 100%;
			}
			
			dl.list {
				border: 1px solid #eee;
			}
			
			dl.list dt,
			dl.list dd {
				border-bottom: 1px solid #eee;
			}
			
			.price {
				color: #ff5f32;
				line-height: 28px;
				font-size: 16px;
			}
			
			.kv-line-r>p span {
				color: #ff5f32;
			}
			
			.price sub {
				bottom: 0;
			}
			
			.num {
				float: right;
				color: #333;
			}
			
			p,
			h6 {
				color: #333;
			}
			
			.postWrap {
				background: #fff url(../../img/market/post.png) no-repeat bottom;
				background-size: 100%;
			}
			
			.boxstwo li a {
				margin: 10px 0;
			}
			
			#container {
				padding-bottom: 50px;
			}
			
			.goods p {
				padding: 3px 0;
				line-height: 20px;
			}
			
			.goodsDetail {
				font-size: 12px;
				color: #999;
				line-height: 15px !important;
			}
			
			.tips {
				margin-bottom: 0 !important;
				border: none !important;
				font-size: 14px;
				line-height: 16px;
			}
			
			.tipsWrap {
				padding: 0 0.15rem !important;
			}
			
			.tipsWrap input {
				padding: 0 !important;
			}
			
			.tipsWrap h6 {
				line-height: 40px;
				margin-right: 0;
			}
			
			.tipsWrap h6 .goods {
				padding-left: 0;
			}
			
			dl.list dd dl {
				padding-left: 0;
			}
			
			dl.list dd dl>.dd-padding,
			dl.list dd dl dd>.react,
			dl.list dd dl>dt {
				padding: 0.15rem;
			}
			
			.goodsWrap {
				background-color: #fafafa;
			}
			
			.comm_btn {
				margin: 0;
				height: 50px;
				line-height: 50px;
				padding: 0;
				width: 100%;
				text-align: center;
			}
			
			.fixed .btn {
				border: none !important;
				bottom: 0;
				right: 0;
				width: 25%;
			}
			
			.fixed p {
				width: 75%;
				text-align: right;
			}
			
			.priceWrap {}
			
			.priceWrap p {
				text-align: right !important;
				display: block;
				font-size: 16px;
				width: 100%;
			}
			
			.priceWrap p sub {
				bottom: 0;
			}
			.mui-checkbox{
				position: absolute;
				top: 50%;
				margin-top: -18px;
				right: 0;
			}
			.mui-checkbox input[type=checkbox]:checked:before, .mui-radio input[type=radio]:checked:before {
			    color: rgb(245, 60, 66);
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav hasManyCity hasManyCitytwo">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize fl fanhui"></a>
			<div class="header-tit">
				订单确认
			</div>
		</header>
		<div id="container">
			<div id="main">
				<form class="wrapper-list">
					<ul class="boxs boxstwo postWrap">
						<div id="add_info"></div>
						<script type="text/html" id="addrTpl">
							<%if(obj.lenght==0){%>
							<li onclick="goAddr()">
								<div class="mui-row orderRow">
									<div class="mui-col-sm-1 mui-col-xs-1">
										<span class="mui-icon mui-icon-location middle-icon"></span>
									</div>
									<div class="mui-col-sm-11 mui-col-xs-11">
										<p style="line-height: 50px;">请选择收货地址</p>
										<div class="fr"><i class="ico_arrow middle-icon"></i></div>
									</div>
								</div>
							</li>
							<%}else{%>
							<li onclick="goAddr()" data-id="<%=obj[0].id%>">
								<div class="mui-row orderRow">
									<div class="mui-col-sm-1 mui-col-xs-1">
										<span class="mui-icon mui-icon-location middle-icon"></span>
									</div>
									<div class="mui-col-sm-11 mui-col-xs-11">
										<strong>									
													<p>收货人：<%=obj[0].person%><span class="phoneNum"><%=obj[0].phone%></span></p>
													<p class="address">收货地址：<%=obj[0].province%><%=obj[0].city%><%=obj[0].area%><%=obj[0].address%></p>
													<div class="fr"><i class="ico_arrow middle-icon"></i></div>
												</strong>
									</div>
								</div>
							</li>

							<%}%>
						</script>

					</ul>
					<div id="orderTpl"></div>
					<script type="text/html" id="orderData">
						<%for(var i =0;i<cates.length;i++){%>
						<dl class="list">
							<dd class="dd-padding kv-line-r">
								<h6><img src="../../img/market/shop.png" style="width: 0.2rem;vertical-align: middle;" alt="" /> <%=cates[i]%></h6>
							</dd>
							<%for(var j =0;j<goodsList.length;j++){%>
							<% if(goodsList[j].shopName ==  cates[i]){%>
							<dd class="dd-padding kv-line-r mui-row goodsWrap"> <!--onclick="goInfo('<%=goodsList[j].goodsId%>')"-->
								<h6 class="addTitle mui-col-sm-4 mui-col-xs-4"><img src="<%=goodsList[j].goodsImg%>"/></h6>
								<div class="clearfloat fr mui-col-sm-8 mui-col-xs-8 goods">
									<p>
										<%=goodsList[j].goodsName%>
									</p>
									<p class="goodsDetail">
										<%=goodsList[j].goodText%>
									</p>
									<p class="price"><sub>￥</sub>
										<%=goodsList[j].goodsPrice%> <span class="num">×<%=goodsList[j].goodsnum%></span></p>
								</div>
							</dd>
							<%}%>
							<%}%>
							<dd class="dd-padding kv-line-r">
								<h6>配送方式</h6>
								<%if(arrpostFee[i]==0){%>
									<p class="jifen">快递 免邮</p>
									<%}else{%>
										<p class="jifen">快递<%=arrpostFee[i]%>元</p>
										<%}%>
								
							</dd>

							<dd class="dd-padding kv-line-r mui-row tipsWrap">
								<h6 class="addTitle mui-col-sm-1 mui-col-xs-2">备注：</h6>
								<div class="clearfloat fr mui-col-sm-11 mui-col-xs-10 goods">
									<input type="text" id="" value="" placeholder="选填（对本次交易的说明）" class="tips" />
								</div>
							</dd>
							<dd class="kv-line-r dd-padding priceWrap">
								<p>
									<sub>共计<span class="groupNum"><%=arrNum[i]%></span>件商品&nbsp;&nbsp;小计:<b style="color: #ff5f32;">￥</b></sub>
									<span class="J_total-price groupMoney" data-id="<%=arrpostFee[i]%>"><%=arrMoney[i]%></span>
								</p>
							</dd>
						</dl>

						<%}%>
						
					</script>
					
						<dl class="list">
							<dd>
								<a class="react" href="#">
									<div class="more moretwo more-weak comment-headline">
										抵用券
										<span class="more-after ">使用抵用券</span>
									</div>
								</a>
							</dd>
					
							<div id="coupon"></div>
								<script type="text/html" id="couponTpl">
									<%if(intergral!=0){%>
										<dd class="dd-padding kv-line-r">
											<h6>可用<%=intergral%>积分抵<span id="itMinus" style="color: #ff5f32;"><span>￥</span><%=intergral%></span></h6>
												<div class="mui-checkbox"><input name="checkbox" class="groupCheck" type="checkbox"></div>
										</dd>
										<%}else{%>
											<dd class="dd-padding kv-line-r">
											<h6>无可用积分</h6>
												<div class="mui-checkbox"><input name="checkbox" disabled class="groupCheck" type="checkbox"></div>
										</dd>
											<%}%>
									
								</script>
							
						</dl>
				</form>
			</div>
			<div class="fixed">
				<p>合计：<span class="show_delivery_fee">￥<span id="submit_order"></span></span></p>
				<span class="fr btn">
					<a onclick="goPay()" class="comm_btn">提交订单</a>
				</span>
			</div>
		</div>
	</body>
	<script src="../../js/app.js"></script>
	<script src="../../js/artTemplate-native.js"></script>
	<script type="text/javascript">
//		function goInfo(gid) {
//			openview({
//				view: "mall-detail.html",
//				extrasobj: {
//					goodsId: gid
//				}
//			})
//		}
		var myuserid;
		mui.plusReady(function() {
			window.addEventListener('readdstorage', function(event) {
				orderAdd()
			});
			//订单缓存
			var orderStorage = JSON.parse(plus.storage.getItem('$orderStorage') || '[]');
			//alert(plus.storage.getItem('$orderStorage'))
				//获取缓存
			  myuserid = plus.storage.getItem('userid');
			console.log(myuserid)
			var oldtoken = plus.storage.getItem('oldToken');

			//加载默认地址
			plus.nativeUI.showWaiting('加载中 ...', {
				width: '100px',
				height: '80px'
			});
			
			orderAdd();
			function orderAdd(){
				mui.ajax(serverUrl + '/api/useraccount/addresslist', {
				data: {
					userid: myuserid,
					state: 1
				},
				dataType: 'json',
				type: 'post',
				timeout: 1000,
				headers: {
					"token": oldtoken
				},
				success: function(data, type, xhr) {
					if(data.errno == 0) { 
						plus.nativeUI.closeWaiting()
						//alert(JSON.stringify(data.data))
						var addrObj = {};
						if(plus.storage.getItem("$addressStorage")){
							alert(plus.storage.getItem("$addressStorage"))
							addrObj.obj = JSON.parse(plus.storage.getItem("$addressStorage")); 
						}else{
							addrObj.obj = data.data; 
						}
							
						document.getElementById("add_info").innerHTML = template("addrTpl", addrObj);
						plus.storage.removeItem("$addressStorage")
						//订单数据模板
						var data = {};
						data.goodsList = orderStorage;
						var arr =[],arrNum=[],arrMoney =[],arrpostFee=[];
						for(var i = 0; i < orderStorage.length; i++) {
							arr.push(orderStorage[i].shopName);
						} 
						//alert(arr.length)
						data.cates = arr.unique1();
						 
						for(var i= 0;i<data.cates.length;i++){
							//分组小计
							var groupPostfee=0;
							 for(var j = 0;j<orderStorage.length;j++){
							 	 
							 	if(orderStorage[j].goodsPostfee!=0){
							 		groupPostfee=orderStorage[j].goodsPostfee;
							 		break;
							 	}else{
							 		groupPostfee = 0;
							 	}
							 }
							 arrpostFee.push(groupPostfee);
						}
						 
						for(var i= 0;i<data.cates.length;i++){
							//分组小计
							var groupNum=0,groupMoney=0;
							 for(var j = 0;j<orderStorage.length;j++){
							 	if(orderStorage[j].shopName ==  data.cates[i]){
							 		groupNum+=parseFloat(orderStorage[j].goodsnum);
							 		groupMoney+=parseFloat(orderStorage[j].goodsPrice)*parseFloat(orderStorage[j].goodsnum); 
							 	} 
							 } 
							 arrNum.push(groupNum);
							 arrMoney.push(parseFloat(groupMoney)+parseFloat(arrpostFee[i]));
						}

						data.arrpostFee=arrpostFee;
						data.arrNum=arrNum;
						data.arrMoney=arrMoney;
						var html = template('orderData', data);
						document.getElementById('orderTpl').innerHTML = html;
						 //订单总价
						 var totalPay=0;
						 $(".groupMoney").each(function(){
						 	
						 	totalPay+=parseFloat($(this).html());
						 })
						 $("#submit_order").html(totalPay)
					}
				},
				error: function(xhr, type, errorThrown) {
					//alert('响应失败  !');
					plus.nativeUI.closeWaiting();
					mui.toast("网络不好请重试")
				}
			});
			}
			
			
			//获取积分
			mui.ajax(serverUrl+'/api/useraccount/userinfo',{
				data:{"userid":myuserid},
				type:'post',
				timeout:10000,
				headers:{"token":oldtoken},	              				
				success:function(data,type,xhr){
					var intergral=0;
					console.log('获取用户数据返回'+JSON.stringify(data));
					if(data.errno == 0){
						   intergral = data.data[0].intergral;
						  // alert(intergral)
						   if(intergral==null){
						   	intergral=0;
						   }
						 document.getElementById("coupon").innerHTML=template('couponTpl', {intergral:intergral});
					}else{
						mui.toast('获取用户信息失败');
						console.log(data.errmsg);
					}
					$(".mui-checkbox").click(function(){ 
						
							if($(this).find("input").prop('checked') == true){
								var nowPAY = parseFloat($("#submit_order").html())-parseFloat(intergral);
								$("#submit_order").html(nowPAY)
							}else{
								var nowPAY = parseFloat($("#submit_order").html())+parseFloat(intergral);
								$("#submit_order").html(nowPAY)
							}
						})
				},
				error:function(xhr,type,errorThrown){
					alert('响应失败  !');
				}
			});
			
			//获取抵用券
			mui.ajax(serverUrl+'/api/useraccount/mycoupon',{
					data:{userid : myuserid},
					dataType:'json',
					type:'post',
					timeout:1000,
					headers:{"token":oldtoken},	 
					success:function(data,type,xhr){
						alert(JSON.stringify(data));
//						alert(eval("("+ data.data[2].salerule +")").rule[0]);
						for(var m=0; m < data.data; m++){ 
							alert(1)
							if(data.data[m].salerule==null){
							 	data.data[m].salerule=null;
							}else{	
								data.data[m].salerule.rule1= eval("("+ data.data[m].salerule +")").rule[0];
								data.data[m].salerule.rule2= eval("("+data.data[m].salerule+")").rule[1];
							}
							 
						}   
//						var data.data[2].salerule = eval("("+ data.data[2].salerule +"")
						var allC = {};
						allC.allLi = data.data;
						var html = template('allC-detail',allC);
						document.getElementById('allC').innerHTML = html;
						var html2 = template('ableC-detail',allC);
						document.getElementById('ableC').innerHTML = html2;
						var html3 = template('disableC-detail',allC);
						document.getElementById('disableC').innerHTML = html3;
						
					},
					error:function(xhr,type,errorThrown){
						alert('响应失败  !');
					}
				});
			
		})
		
		//进入地址页面
		function goAddr(){ 
			openview({
				view:"../personal/address.html",
				extrasobj:{pageid:"market-order",userId:myuserid}
			})
		}
		//goPay
		function goPay(){
			openview({
				view:"pay.html"
			})
		}
		//数组去重
		Array.prototype.unique1 = function() {
			var res = [this[0]];
			for(var i = 1; i < this.length; i++) {
				var repeat = false;
				for(var j = 0; j < res.length; j++) {
					if(this[i] == res[j]) {
						repeat = true;
						break;
					}
				}
				if(!repeat) {
					res.push(this[i]);
				}
			}
			return res;
		}
	</script>

</html>