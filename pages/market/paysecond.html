
<html lang="zh-CN" style="font-size: 10px;">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>支付订单end</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" href="../../css/reset.css"> 
		<style>
			.zhifulist{background-color: #fff;}
			.zhifulist li{padding: 15px;padding-left: 0px;margin-left:50px;position: relative;}
			.zhifulist li img{position: absolute;width: 30px;margin-left:-40px;top: 18px;}
			.zhifulist li h4{font-size: 16px;margin-bottom: 5px;}
			.allmoney{font-size: 18px;padding: 20px;}
			.all1{border-bottom: none;margin:0 10px;position: relative;}
			.zhifulist li:after,.all1:after{content: '';display: block;height: 1px;-webkit-transform: scaleY(0.5);background-color: rgba(0,0,0,0.1);position: absolute;width: 100%;bottom: 0;left: 0;}
			.zhifulist li:last-child:after{height: 0;}
			.mui-btn-block {font-size: 18px;display: block;width: 90%;margin-bottom: 10px;padding: 8px 0;margin: 20px auto 0;}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
		    <h1 class="mui-title">支付订单</h1>  
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		
		<div id="container" style="margin-top: 50px;">		
			<div id="main">
				<div class="zhifulist" style="margin-bottom:20px;">
					<div class="allmoney all1" style="text-align: center;"> 
						<img src="../../img/market/waitPay.svg" style="width: 5rem;display: block;text-align:center;margin:auto;vertical-align: middle;margin-bottom: 1rem;" alt="" />总计 :￥<span id="payMoney"></span>
					</div> 
					<div class="allmoney" style="font-size: 12px;padding-left: 10px;"> 
						订单号 :<span id="orderId" style="display: inline-block;word-break: break-all;"></span>
					</div>
				</div>
				<div class="zhifulist">
					<ul>
						<!--<li>
							<img src="../../img/yinghangka.svg"/>
							<h4>银行卡支付</h4>
							<p>安全急速支付, 无需开通网银</p>
						</li>-->
						<li id="wxpay">
							<img src="../../img/weixing.svg"/>
							<h4>微信支付</h4>
							<p>推荐安装微信6.0.2以上版本</p>
						</li>
						<li id="alipay">
							<img src="../../img/zhifubao.svg"/>
							<h4>支付宝支付</h4>
							<p>推荐有支付宝账户的用户使用</p>
						</li>
					</ul>
				</div> 
			</div>
		</div>
	</body>
<script src="../../js/mui.min.js"></script> 
<script src="../../js/app.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
var pays={}; 
var aliPayURL = '';//唤起支付宝数据
mui.plusReady(function() { 
  
	//获取缓存
	var myuserid = plus.storage.getItem('userid'); 
	var oldtoken = plus.storage.getItem('oldToken');
	var orderId = plus.webview.currentWebview().new_qianmi_order_id;
	var billId = plus.webview.currentWebview().billId;
	var orderCost = parseFloat(plus.webview.currentWebview().orderCost).toFixed(2);
	var saleAmount = plus.webview.currentWebview().saleAmount;
	aliPayURL = plus.webview.currentWebview().aliPayURL;
	
	console.log(aliPayURL);
	document.getElementById('payMoney').innerHTML = orderCost;
	document.getElementById('orderId').innerHTML = billId;
	
	
		mui("#wxpay")[0].addEventListener('tap', function(){ 
				openview({
					view:'../daikaifa.html'
				});
			});
	
	
	//系统检测获取支付通道
	plus.payment.getChannels(function(channels){
		console.log(JSON.stringify(channels));
		for(var i in channels){
			var channel=channels[i];
			// 过滤掉不支持的支付通道：暂不支持360相关支付
			if(channel.id=='qhpay'||channel.id=='qihoo'){
				continue;
			}
			pays[channel.id]=channel;
			if(channel.id == 'alipay'){//添加支付事件
				document.getElementById('alipay').setAttribute('onclick','payfun("alipay")');
			}
			if(channel.id == 'wxpay'){
//				document.getElementById('wxpay').setAttribute('onclick','payfun("wxpay")');
			}
			checkServices(channel);
		}
	},function(e){
		plus.nativeUI.alert("支付失败，请重试",null,"提示");
	});
//	 mui(document.body).on('tap', '.mui-btn', function(e) {
//	 	plus.nativeUI.showWaiting(); 
//	 	mui.ajax(serverUrl+'/api/qianmi/paybill',{
//				data:{new_qianmi_order_id:orderId,billId:billId},
//				dataType:'json',
//				type:'post',
//				timeout:1000,
//				headers:{"token":oldtoken},	 
//				success:function(data,type,xhr){ 
//					plus.nativeUI.closeWaiting();
//					 mui.toast("支付成功"); 
//					 //mui.back();
//					 setTimeout(function(){
//					 	openview({
//							view:"../tickets/phone-record-de.html",
//							extrasobj:{qianmiOrderID:orderId}
//						})
//					 
//					 },1000)
//					 	
//					// plus.webview.currentWebview().close();
//				},
//				error:function(xhr,type,errorThrown){
//					plus.nativeUI.closeWaiting()
//					console.log('响应失败  !');
//				}
//			});
//      });
	
	
	// 检测是否安装支付服务
	function checkServices(pc){ 
		if(!pc.serviceReady){
			var txt=null;
			switch(pc.id){
				case "alipay":
				txt="检测到系统未安装“支付宝快捷支付服务”，无法完成支付操作，是否立即安装？";
				break;
				default:
				txt="系统未安装“"+pc.description+"”服务，无法完成支付，是否立即安装？";
				break;
			}
			plus.nativeUI.confirm(txt,function(e){
				if(e.index==0){
					pc.installService();
				}
			},pc.description);
		}
	}
	//系统检测获取支付通道结束
});

var w=null;
 

// 支付方法 
function payfun(id){
	var varpay;
	var dataJson;
	
	if(id=='alipay'||id=='wxpay'){//调用支付功能
		plus.nativeUI.showWaiting();
		if(id == 'alipay'){ 
			//获取后台返回数据
			
			//订单号
//			var orderId = plus.webview.currentWebview().order_id;
//			dataJson = {"dis":"AliPay","orderid":orderId};
				gopay();

		}else if(id=='wxpay'){//微信
			//重组的支付验证数据
			varpay = {
				retcode: 0,//5+固定调起参数
				retmsg: "ok",//5+固定调起参数
	            appid: 'sffjdlflnlndfdklk',//AppId,微信开放平台新建应用时产生
	            noncestr: 'knjdjddnjdjdj',//随机字符串，
	            package: "Sign=WXpay",//APP支付固定设置参数
	            partnerid: 'hdndnvndiv',//商户编号，微信开放平台申请微信支付时产生
	            prepayid: 'nfjbvkkjv',//由上面获取预支付流程获取
	            timestamp: 'kndnvjdnjvndj',//时间戳
	            sign: 'dbvjdvjdb'//上面关键参数加密获得
			}
			//微信
			alert('调用微信支付一下');
			plus.payment.request(pays[id],varpay,function(result){
				//支付成功回调
				
			},function(e){
				//支付失败回调
				plus.nativeUI.closeWaiting(); 
				plus.nativeUI.alert("支付失败");
			});
		} 
	}else{
		plus.nativeUI.alert("当前环境不支持此支付通道！",null,"提示");
		return;
	}
	
	
	function gopay(){
	// 请求支付订单
	
	
	
	var oldtoken = plus.storage.getItem('oldToken');
	var body = plus.webview.currentWebview().body;
	var subject = plus.webview.currentWebview().subject;
	var total_fee = parseFloat(plus.webview.currentWebview().orderCost).toFixed(2);
	var orderId = plus.webview.currentWebview().new_qianmi_order_id; 
//	mui.ajax(PAYSERVER,{ 
//		data:{body:body,subject:'',total_fee:total_fee,out_trade_no:orderId},
//		type:"post",
//		headers:{"token":oldtoken},	
//		timeout:10000,
//		success:function(data){
//			plus.nativeUI.closeWaiting() 
//			var data = data.data;   
//			console.log('data',data);
//			console.log("----- 请求订单成功 -----"); 
//			plus.nativeUI.showWaiting();
			
			var strstr = 'service="mobile.securitypay.pay"&partner="2088521339004065"&_input_charset="UTF-8"&out_trade_no="2616"&subject="HI 集生活"&payment_type="1"&seller_id="hijihf@163.com"&total_fee="0.99"&body="HI 集生活，充值、购票"&it_b_pay="1d"&notify_url="http%3A%2F%2Fhiji.hifete.com%3A7200%2Fapi%2Falipay%2Fpaynotify"&show_url="http%3A%2F%2Fwww.google.com"&sign="QuFaJu9vU0OlHJdseUp9Jy7QuEWdyalJ6hx1334zqa%2BIj5uXkqMtk3zOnlwDX9%2BRAaMlbYUt%2FKRnF9Qz4zODdJ6VqW8v9c1NqjcpUYuq8ne6HRgSDS5YWGIYauzTcxs0IEiJheaAFkeYvR%2B3QV6u3I3Mlb6nKtoGKDLwPyx3ylXqbaCrYy19Sb%2FlcLLfZRwn3YiF6IiDo0b7I23koZlmSJyzPXYXRBuQZiiCnNtVVrDa8xAm6E7ESc7KlgpwA3hdfK6wYE0YKSVRqF1rX7W3H52c3tJPHeex6%2B0oU2iAbXGsFOo5CijmJ6LAseoDvKRCzovAUGVs%2F9u2DI4P%2B4Xt1w%3D%3D"&sign_type="RSA"'
			console.log('正确的',strstr);
			var varpay; 
			if(id == 'wxpay'){
				
			}else{ 
				//支付宝
				varpay = aliPayURL;
				console.log('支付宝唤起数据',varpay);
				plus.nativeUI.closeWaiting();
				plus.payment.request(pays[id],varpay,function(result){
					var resultstr = JSON.stringify(result) ;
					console.log('支付成功',resultstr);
					var myuserid = plus.storage.getItem('userid');  
					var orderId = plus.webview.currentWebview().new_qianmi_order_id;
					var billId = plus.webview.currentWebview().billId; 
					 
					 plus.nativeUI.showWaiting();
					//修改状态 
					mui.ajax(serverUrl+'/api/qianmi/paybill',{
						data:{new_qianmi_order_id:orderId,billId:billId,userid:myuserid,noiftyData:resultstr},	
						dataType:'json',//服务器返回json格式数据
						type:'post',//HTTP请求类型 
						timeout:10000,//超时时间设置为10秒；
						headers:{"token":oldtoken},	
						success:function(data){ 
							plus.nativeUI.closeWaiting()
							 plus.nativeUI.alert("支付成功");
							  setTimeout(function(){
							 	openview({
									view:"../tickets/phone-record-de.html",
									extrasobj:{qianmiOrderID:orderId}
								})
							 },1000)
						},
						error:function(xhr,type,errorThrown){
							//异常处理；
							console.log(type);
						}
					});
				},function(e){
					console.log("----- 支付失败 -----");
					console.log("["+e.code+"]："+e.message);
					plus.nativeUI.closeWaiting();
					plus.nativeUI.alert("支付失败");
				});
//			 
			}
			
			
//		},
//		error:function(xhr,type,errorThrown){
//			//异常处理；
//			console.log(type);
//			console.log("----- 请求订单失败 -----");
//			console.log( xhr.status );
//			plus.nativeUI.closeWaiting();
//			plus.nativeUI.alert("获取订单信息失败！");
//		}
//	});


	}
	
	
	
}

function queryStr(str) {
    var r = str.slice(1).split("&"),
        e = {};
    return r.forEach(function(r) {
        var t;
        r && (t = r.split("="), 2 === t.length && (e[t[0]] = t[1]))
    }), e
}
</script>
</html>
