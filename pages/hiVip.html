<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>HI集会员</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">  
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" /> 
    	<link rel="stylesheet" type="text/css" href="../css/config.css"/>
		<script type="text/javascript" src="../js/jquery.min.js"></script>
		<script src="../js/mui.min.js"></script>
		<script src="../js/app.js"></script>
		<script src="../js/artTemplate-native.js"></script>
		<script src="../js/awardRotate.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			
			var turnplate = {
				restaraunts: [], //大转盘奖品名称
				colors: [], //大转盘奖品区块对应背景颜色
				outsideRadius: 192, //大转盘外圆的半径
				textRadius: 155, //大转盘奖品位置距离圆心的距离
				insideRadius: 68, //大转盘内圆的半径
				startAngle: 0, //开始角度
				bRotate: false //false:停止;ture:旋转
			};

			$(document).ready(function() {
				//动态添加大转盘的奖品与奖品区域背景颜色
				turnplate.restaraunts = ["1HI豆", "3个棒棒糖", "5HI豆", "1朵鲜花", "1辆机车", "10HI豆", "1个皇冠 ", "下次加油"];
				turnplate.colors = ["#FFF4D6", "#FFFFFF", "#FFF4D6", "#FFFFFF", "#FFF4D6", "#FFFFFF", "#FFF4D6", "#FFFFFF", "#FFF4D6", "#FFFFFF"];

				var rotateTimeOut = function() {
					$('#wheelcanvas').rotate({
						angle: 0,
						animateTo: 2160,
						duration: 8000,
						callback: function() {
							mui.toast('网络超时，请检查您的网络设置！');
						}
					});
				};

				//旋转转盘 item:奖品位置; txt：提示语;
				var rotateFn = function(item, txt) {
					var angles =  item * (360 / turnplate.restaraunts.length) - (360 / (turnplate.restaraunts.length*2));
					if(angles < 270) {
						angles = 270 - angles;
					} else {
						angles = 360 - angles + 270;
					}
					$('#wheelcanvas').stopRotate();
					$('#wheelcanvas').rotate({
						angle: 0,
						animateTo: angles + 1800,
						duration: 8000,
						callback: function() {
							alert(txt);
							turnplate.bRotate = !turnplate.bRotate;
						}
					});
				};

				$('.pointer').click(function() {
					if(!plus.storage.getItem('myToken')){ 
						mui.toast('请登录');
						openview({
							view:'login.html'
						});
					}else{//抽奖
						if(turnplate.bRotate) return;
						turnplate.bRotate = !turnplate.bRotate;
						//获取随机数(奖品个数范围内)
						var item = rnd(1, turnplate.restaraunts.length);
						//奖品数量等于10,指针落在对应奖品区域的中心角度[252, 216, 180, 144, 108, 72, 36, 360, 324, 288]
						rotateFn(item, turnplate.restaraunts[item - 1]);
					 
						console.log(item);
					}
					
				});
			});

			function rnd(n, m) {
				var random = Math.floor(Math.random() * (m - n + 1) + n);
				return random;

			}

			//页面所有元素加载完毕后执行drawRouletteWheel()方法对转盘进行渲染
			window.onload = function() {
				drawRouletteWheel();
			};

			function drawRouletteWheel() {
				var canvas = document.getElementById("wheelcanvas");
				if(canvas.getContext) {
					//根据奖品个数计算圆周角度
					var arc = Math.PI / (turnplate.restaraunts.length / 2);
					var ctx = canvas.getContext("2d");
					//在给定矩形内清空一个矩形
					ctx.clearRect(0, 0, 422, 422);
					//strokeStyle 属性设置或返回用于笔触的颜色、渐变或模式  
					ctx.strokeStyle = "#FFBE04";
					//font 属性设置或返回画布上文本内容的当前字体属性
					ctx.font = '16px Microsoft YaHei';
					for(var i = 0; i < turnplate.restaraunts.length; i++) {
						var angle = turnplate.startAngle + i * arc;
						ctx.fillStyle = turnplate.colors[i];
						ctx.beginPath();
						//arc(x,y,r,起始角,结束角,绘制方向) 方法创建弧/曲线（用于创建圆或部分圆）    
						ctx.arc(211, 211, turnplate.outsideRadius, angle, angle + arc, false);
						ctx.arc(211, 211, turnplate.insideRadius, angle + arc, angle, true);
						ctx.stroke();
						ctx.fill();
						//锁画布(为了保存之前的画布状态)
						ctx.save();

						//----绘制奖品开始----
						ctx.fillStyle = "#E5302F";
						var text = turnplate.restaraunts[i];
						var line_height = 17;
						//translate方法重新映射画布上的 (0,0) 位置
						ctx.translate(211 + Math.cos(angle + arc / 2) * turnplate.textRadius, 211 + Math.sin(angle + arc / 2) * turnplate.textRadius);

						//rotate方法旋转当前的绘图
						ctx.rotate(angle + arc / 2 + Math.PI / 2);

						/** 下面代码根据奖品类型、奖品名称长度渲染不同效果，如字体、颜色、图片效果。(具体根据实际情况改变) **/
						if(text.indexOf("元") > 0) { //现金红包
							var texts = text.split("元");
							for(var j = 0; j < texts.length; j++) {
								ctx.font = j == 0 ? 'bold 20px Microsoft YaHei' : '16px Microsoft YaHei';
								if(j == 0) {
									ctx.fillText(texts[j] + "元", -ctx.measureText(texts[j] + "元").width / 2, j * line_height);
								} else {
									ctx.fillText(texts[j], -ctx.measureText(texts[j]).width / 2, j * line_height);
								}
							}
						} else if(text.indexOf("元") == -1 && text.length > 6) { //奖品名称长度超过一定范围 
							text = text.substring(0, 6) + "||" + text.substring(6);
							var texts = text.split("||");
							for(var j = 0; j < texts.length; j++) {
								ctx.fillText(texts[j], -ctx.measureText(texts[j]).width / 2, j * line_height);
							}
						} else {
							//在画布上绘制填色的文本。文本的默认颜色是黑色
							//measureText()方法返回包含一个对象，该对象包含以像素计的指定字体宽度
							ctx.fillText(text, -ctx.measureText(text).width / 2, 0);
						}

						//添加对应图标
						if(text.indexOf("HI豆") > 0) {
							var img = document.getElementById("shan-img");
							img.onload = function() {
								ctx.drawImage(img, -15, 10);
							};
							ctx.drawImage(img, -15, 10);
						} else if(text.indexOf("谢谢参与") >= 0) {
							var img = document.getElementById("sorry-img");
							img.onload = function() {
								ctx.drawImage(img, -15, 10);
							};
							ctx.drawImage(img, -15, 10);
						}
						//把当前画布返回（调整）到上一个save()状态之前 
						ctx.restore();
						//----绘制奖品结束----
					}
				}
			}
			
			var turnplate={
					restaraunts:[],				//大转盘奖品名称
					colors:[],					//大转盘奖品区块对应背景颜色
					outsideRadius:192,			//大转盘外圆的半径
					textRadius:155,				//大转盘奖品位置距离圆心的距离
					insideRadius:68,			//大转盘内圆的半径
					startAngle:0, 
					bRotate:false				//false:停止;ture:旋转
			};
			
			$(document).ready(function(){
				//动态添加大转盘的奖品与奖品区域背景颜色
				turnplate.restaraunts = ["1HI豆", "3个棒棒糖", "5HI豆", "1朵鲜花", "1辆机车", "10HI豆", "1个皇冠 ", "下次加油"];
				 
				var rotateTimeOut = function (){
					$('#wheelcanvas').rotate({
						angle:0,
						animateTo:2160,
						duration:8000,
						callback:function (){
							alert('网络超时，请检查您的网络设置！');
						} 
					});
				};
			
				//旋转转盘 item:奖品位置; txt：提示语;
				var rotateFn = function (item, txt){
					var angles = item * (360 / turnplate.restaraunts.length) - (360 / (turnplate.restaraunts.length*2));
					if(angles<270){
						angles = 270 - angles; 
					}else{
						angles = 360 - angles + 270;
					}
					$('#wheelcanvas').stopRotate();
					$('#wheelcanvas').rotate({
						angle:0,
						animateTo:angles+1800,
						duration:8000,
						callback:function (){
							if(txt == '下次加油'){
								alert(txt);
							}else{
								alert("恭喜你"+txt);
							}
							
							turnplate.bRotate = !turnplate.bRotate;
						}
					});
				};
			
				$('.turnBtn').click(function (){
				 	$('.turnAw').css({'left':'19.6%','top':'13.1%'})
					if(turnplate.bRotate)return;
					turnplate.bRotate = !turnplate.bRotate;
					//获取随机数(奖品个数范围内)
					var item = rnd(1,turnplate.restaraunts.length);
					//奖品数量等于8,指针落在对应奖品区域的中心角度[270, 225, 180, 135, 90, 45, 360, 315]
					rotateFn(item, turnplate.restaraunts[item-1]);
					 
					console.log(item);
				});
			});
			
			function rnd(n, m){
				var random = Math.floor(Math.random()*(m-n+1)+n);
				return random;
				
			}
			
		 
		</script> 
	</head>
	<style type="text/css"> 
		#header>*{color:white}
		#userBox{background-color:#f85852;position:relative;overflow:hidden;padding-top: 15px;background:url(../img/center/biejing.png) no-repeat;background-size: 100% 100%;height: calc(100vw * 0.5 + 15px);}
		.flexr{display: flex;align-items: center;justify-content: space-between;}
		.flexr img{display: inline-block}
		.vipTop{position: absolute;width: 100%;left: 10px;top: 45%;}
		.vipRule{color: white;background: url(../img/center/vipRule.png);background-size: 100% 100%;padding: 6px 8px;}
		.vipRule img{vertical-align: middle;}
		.vipInfo{color: white;flex-grow: 1;padding: 0 15px;}
		.vipInfo img{width: 12px;}
		.mui-progressbar{height: 8px;background-color: rgba(255,255,255,0.5);border-radius: 15px!important;;}
		.mui-progressbar span{background-color: none;background:url(../img/center/baijin.png) repeat;}		
		table{text-align: center;border: 1px solid #CCCCCC;overflow-x: hidden;font-size: 13px;color: #fa4125;}
		table td{padding: 10px;}
		table td img{width: 52%;display: block;margin: auto;}
		.allRights{padding-top: 10px;border-top: 10px solid #f3f3f3;border-bottom: 10px solid #f3f3f3;}
		.turning{position: relative;}
		.turnCircle,.turnAw,.turnBtn,.pointer{position: absolute;top: 8%;-webkit-transform: translateY(-50%);left: 50%;-webkit-transform: translateX(-50%);}
		.turnCircle{width: 70%;}
		.turnAw{width: 61%;top: 13%;}
		.turnBtn{width: 21%;top:34.5%;z-index: 1;}
		.pointer{width: 6%;top:27%;}
		.hiMall{border-top: 10px solid #f3f3f3;padding-top: 10px;}
		.circleContain .circleBox{margin: 5px 5px;float: left;background: url(../img/makeFriend/friendB.png) no-repeat;background-size: 100% 100%;background-position: left top;padding: 1px;}
		.circleImg{width: calc((100vw - 24px)/2);padding-top: 100%;overflow: hidden;position: relative;}
		.circleImg img{position: absolute; top: 15%;left: 15%;width: 70%;border-radius: 3px 3px 0 0;}
		.circleName{padding:15px 10px;line-height: 1.5;}
		#wheelcanvas{transform-origin: center;}
	</style>
	
	<body style="background-color: white;">

		<header id="header" class="mui-bar mui-bar-transparent" style="padding-top: 19.5px;height: 70px;">
			<a id="leftbtn" class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 id="centertitle" class="mui-title">HI集会员</h1>
			<!--<a href="javascript:;" style="line-height: 40px;text-align: right;" class="mui-pull-right baocun ft14"><img style="width: 50%;vertical-align: middle;" src="../img/center/more.png"/></a>-->
		</header>
	   
		<div id="main">
			<div class="clearfloat box-s box-ss" id="userBox">
				<div class="flexr vipTop">
					<div class="touxiang" style="background: url(../img/makeFriend/jiaoyou.png) no-repeat;background-size: cover;width: calc(100vw / 5.5);height: calc(100vw / 5.5);border-radius: 50%;"></div>
					<div class="vipInfo">
						<div class="ft16 flexr">
							<span>the fin.</span>
							<span>HI豆:230</span>
						</div>
						<div class="flexr">
							<div>
								<img src="../img/center/vipstar.png"/>
								<img src="../img/center/vipstar.png"/>
								<img src="../img/center/vipstar.png"/>
							</div>
							<div class="ft12">
								还需购物3次
							</div>
						</div>
						<div class="">
							<div id="demo5" class="mui-demo-container">
								<p class="mui-progressbar mui-progressbar-success" data-progress="50"><span></span></p>
							</div>
						</div>
					</div>
					<div class="vipRule ft12">
						<img src="../img/center/userWhite.png" style="width: 15px;" />会员权益规则<img src="../img/youjiantou.svg" style="width: 15px;" alt="" />
					</div>
				</div>
     		</div>
			<!--权益-->
			<div class="allRights">
				<table border="1" width="100%">
					<caption><img src="../img/center/curRights.png" style="width: 40%;margin-bottom: 5px;" alt="" /></caption>
					<tr>
					  <td>
					  	<img src="../img/center/rights1.png"/>
					  </td>
					  <td>
					  	<img src="../img/center/rights2.png"/>
					  </td> 
					</tr>
					<tr> 
					  <td>
					  	<img src="../img/center/rights3.png"/>
					  </td>
					  <td>
					  	<img src="../img/center/rights4.png"/>
					  </td>
					</tr>
				</table>
			</div>
			<!--转盘-->
			<div class="turning">
				<img src="../img/center/turnBg.png" style="width: 100%;"/>
				<img src="../img/center/turnCircle.png" class="turnCircle"/>
				<img src="../img/center/turnAw.png" id="wheelcanvas" class="turnAw"/>
				<img src="../img/center/turnBtn.png" class="turnBtn"/>
				<img src="../img/center/pointer.png" class="pointer"/>
			</div>
			
			<!--HI商城-->
			<div class="hiMall">
				<img src="../img/center/hiMall.png" style="width: 40%;display: block;margin: auto;" alt="" />
					<div class="circleContain" id="SgiftDiv">
					</div>
					<script type="text/html" id="SgiftDiv2">
				    	<%for(var i = 0;i<dataList.length;i++){%>
				        	<div class="circleBox cmc" onclick="openHI('<%=dataList[i].picS%>','<%=dataList[i].title%>',<%=dataList[i].price%>,<%=dataList[i].id%>)">
								<div class="circleImg">
									<img data-src="<%=dataList[i].picS%>" class="loadPics" src=""/>
								</div>
								<div class="circleName ft14">
									<%=dataList[i].title%>
									<div class="ft18 activecl"><%=dataList[i].price%> HI豆<span class="ft10 disablecl">&nbsp;&nbsp;&nbsp;购买</span> </div>
								</div>
							</div>
				    	<%}%>
					</script>
				<div class="maincl ft14" style="text-align: center;padding: 10px;line-height: 40px;">
					没有更多了
				</div>
			</div>
		</div>
	 
	 </body>
	
	<script type="text/javascript">
 		
		mui.plusReady(function(){
			/*礼物*/
			var myuserid = plus.storage.getItem('userid');
			var oldToken = plus.storage.getItem('oldToken')
			mui.ajax(serverUrl+'/api/friends/gift/userId/'+myuserid,{
				type:'get',
				timeout:8000,
				headers:{"token":oldToken,"city":1},				
				success:function(data,type,xhr){
					console.log('所有礼物',data);
					if(data.errno == 0){
						if(data.data && data.data.isAll.length){
							for(var j = 0 ;j<data.data.isAll.length;j++){//整理内容图片
								var nowArray2 = JSON.parse(data.data.isAll[j].picImg);
								if(nowArray2.length){
									data.data.isAll[j].picS = nowArray2[0].picImg;
								}
							}
							var dataObj = {};
						 	dataObj.dataList = data.data.isAll;
							document.getElementById('SgiftDiv').innerHTML = template("SgiftDiv2", dataObj);
							lazyLoad(true);//懒加载
							
						}else{//没有礼物
							document.getElementById('SgiftDiv').innerHTML = '<img src="../../img/unllfabu.svg" style="display: block;margin:50px auto 20px;width: 100px;"/><div style="text-align: center;">暂无礼物</div>'
						}
						
					}else{
						console.log(data.errmsg); 
					}
				},
				error:function(xhr,type,errorThrown){
					console.error('我的礼物数据,响应失败');
					Fload3 = 0;
				}
			});
			
		})
 		
 		
 		
		//滚动监听
		$(window).scroll(function() { 
           var navBarHeight = 50;  
            var targetID = "#header"; 
            var scrollTo = $(window).scrollTop(); 
            if (scrollTo > navBarHeight) {
                $(targetID).css({
              		//"background-image": "url(../img/header.png)","background-size":"100%"
                });
                $('#leftbtn').css({'color':'#666'});
                $('#centertitle').css({'color':'#666'});
            } 
            if (scrollTo < navBarHeight) {
                $(targetID).css({
                    "background-image": "none"
                });
                $('#leftbtn').css({'color':'#fff'});
                $('#centertitle').css({'color':'#fff'});
            } 
        }).trigger('scroll');
		 /*HI商品详情*/
		function openHI(picS,title,price,idNum){
			openview({
		 		view:'market/jifen_detail.html',
		 		extrasobj:{
					picS: picS,
					title:title,
					price:price,
					idNum:idNum
				}
		 	})
		}
		 $('.vipRule').click(function(){
		 	openview({
		 		view:'vipRule.html'
		 	})
		 })
		 
    	//滚动条
		mui("#demo5 .mui-progressbar").each(function () {
			mui(this).progressbar({progress:this.getAttribute("data-progress")}).show();
		});
		
		
	</script>
	 
</html>