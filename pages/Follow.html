<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>好友动态</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no"> 
		<link rel="stylesheet" type="text/css" href="../css/common.css"> 
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<link rel="stylesheet" href="../css/reset.css">  
		<script type="text/javascript" src="../js/jquery.min.js"></script>
		<script src="../js/mui.min.js"></script>
		<script src="../js/app.js"></script>
		<!--引入模板引擎-->
		<script src="../js/artTemplate-native.js"></script>
		<style type="text/css">

		</style>
	</head>
	<style type="text/css">
            .userAvator{  
				width: 0.4rem;  
				height: 0.4rem;  
				border-radius: 50%;
				margin-right: 10px;
			}
			 .follow{
				position: relative;
				background-color: white;
				text-align: center;
				display: flex;
				align-items: center;
				padding:10px 15px;
				justify-content: space-between;
			} 
			 .fllmg{
			 	width: 100%;
			 }
			 
			 .follow:(not:first-child):after{
			 	position: absolute;
			 	content: '';
			 	height: 1px;
			 	left: 10px;
			 	right: 10px;
				-webkit-transform: scaleY(.3);
				background: #CACACA;
				bottom: 0;
			 }
			  
			 .follow:before{
			 	position: absolute;
			 	content: '';
			 	height: 1px;
			 	left: 10px;
			 	right: 10px;
				-webkit-transform: scaleY(.3);
				background: #CACACA;
				top: 0;
			 }
			 .follow button{
				font-size: 0.12rem;
				height: 0.28rem;
				width: 0.7rem; 
			}
			
			.fchidl{
				font-size: 0.12rem;
				/*color: darkgray;*/
			}
			.fchidl img{
				/*vertical-align: middle;*/
			}
			.fchidl>div{
				vertical-align: middle;
				display: inline-block;
			    font-size: 0.11rem;	
			    text-align: left; 
			 }
		 .fchidl>div span{
		 	color: cadetblue;
		 	font-size: 0.11rem;
		 }
		 .fchidl>div small{
		 	vertical-align: middle;
		 	color: #C0C0C0; 
		 }
		 .listt{
		 	background: white;
		 }
		 .timef{
		 	width: 0.1rem;
		 	
		 }
		 .tieCt{
		 	padding: 10px 15px;
		 }
		 .tieCt p span{
		 	color: coral;
		 	margin-right: 5px;
		 }
		 .tieCt img{
		 	width: 0.13rem; 
		 }
		 .tieCt small{
		 	vertical-align: middle;
		 	margin-right: 20px;
		 }
		 .heart {
			background: url(../img/market/web_heart_animation.png);
		    background-position: left;
		    background-repeat: no-repeat;
		    height: 65px;
		    width: 65px;
		    cursor: pointer;
		    position: absolute;
		    left: -40px;
		    top: -21px;
		    background-size: 2900%;
			}
		 .heart:hover,
			.heart:focus {
				background-position: right;
			}
			
			@-webkit-keyframes heartBlast {
				0% {
					background-position: left;
				}
				100% {
					background-position: right;
				}
			}
			
			@keyframes heartBlast {
				0% {
					background-position: left;
				}
				100% {
					background-position: right;
				}
			}
			
			.heartAnimation {
				display: inline-block;
				/*-webkit-animation-name: heartBlast;
				animation-name: heartBlast;*/
				-webkit-animation-duration: .8s;
				animation-duration: .8s;
				-webkit-animation-iteration-count: 1;
				animation-iteration-count: 1;
				-webkit-animation-timing-function: steps(28);
				animation-timing-function: steps(28);
				background-position: right;
			}
			
			.feed p {
				font-family: "Microsoft YaHei", 'Georgia', Times, Times New Roman, serif;
				font-size: 25px;
			}
			
			.feed {
				
				margin-bottom: : 20px;
				position: relative;
			}
			
			.likeCount {
				font-size: 12px;
				display: inline-block;
				color: #999999;
				vertical-align: middle!important;
			}
			.ffbot{
				display: flex;
				justify-content: flex-end;
			}
			.mui-bar-tab a{
				color: darkgray;
				display: table-cell;
				vertical-align: bottom;
				text-align: center;
			}
			#main{
				padding-bottom: 51px;
			}
			
			/*加载*/ 
			#upload {
				text-align: center;
				font-size: 15px;
				line-height: 30px;
				min-height: 40px;
			}
			
			#upload img {
				width: 60px;
				margin-top: -10px;
			}
			
	</style>

	<body>

		<header class="mui-bar mui-bar-nav">
		    <a class="headbar mui-action-back mui-icon mui-icon-left-nav mui-pull-left normalSize"></a>
		    <h1 class="mui-title" id="confirmbtn1">好友动态</h1> 
		</header>
		<script src="../js/statusBar.js"></script>
		<!--状态栏-->
		<!--<div id="container">-->
		<div id="main">
			<div id="typeNews"></div>
			<script type="text/html" id="typeNewTpl">
				<%if(recommendData.length){%>
					<%for(var i=recommendData.length-1;i>=0;i--){%> 
						<div class="listt" onclick="findInfo('<%=recommendData[i].user_id%>','<%=recommendData[i].news_id%>','<%=myUrl%><%=recommendData[i].avatar[0].picImg%>','<%=recommendData[i].nickname%>')">
							<div class="follow"> 
								<div class="fchidl"> 
									<%if(recommendData[i].avatar[0].picImg){%>
				                       		<img src="<%=myUrl%><%=recommendData[i].avatar[0].picImg%>" class="userAvator" alt="" onclick="gootpage('<%=recommendData[i].user_id%>')"/>
				                        <%}else{%>
											<img src="../img/10.png" alt="" class="userAvator" onclick="gootpage('<%=recommendData[i].user_id%>')"/>
										<%}%>
									<div><%=recommendData[i].nickname%><br><br><img src="../img/time.png" class="timef" alt="" /> <small><%=recommendData[i].create_time%></small></div>
								</div>
								
							</div>
							<img src="<%=recommendData[i].pic%>" class="fllmg" alt="" />
							
							<!--详细信息-->
							<div class="newsinfo" data-newsId="<%=recommendData[i].news_id%>"></div>
							
						</div>
						<%}%> 
					<%}%>	
			</script> 
			<!--详细信息模板-->
			<script type="text/html" id="newsInfoTpl">
				<%if(recommendData){%> 
					<div class="tieCt">
					 	<p>
					 		<%if(recommendData.tags.length){%>
						 		<%for(var j=recommendData.tags.length-1;j>=0;j--){%>
						 			<span>#<%=recommendData.tags[j].tagName%>#</span>
						 		<%}%>
						 	<%}%>
						 	<%=recommendData.newsinfodata[0].content%>
					 	<br/><br/>
						<img src="../img/grayheart.svg" alt="" /> <small><%=recommendData.liker.length%></small><!--<img src="../img/graytalking.svg" alt="" /> <small>5</small>--> 
					 	</p>
					 	<div class="ffbot">
					 		<div class="feed" id="feed<%=recommendData.newsinfodata[0].id%>">
					 			<%if(recommendData.isLike == 1){%>
									<!--红心状态-->
									<div class="heart innerheart heartAnimation" id="like<%=recommendData.newsinfodata[0].news_id%>" data-id="<%=recommendData.newsinfodata[0].news_id%>" rel="unlike"></div>
								<%}else{%>
									<div class="heart innerheart" id="like<%=recommendData.newsinfodata[0].news_id%>" data-id="<%=recommendData.newsinfodata[0].news_id%>" rel="like"></div>
									<%}%> 
								<div class="likeCount" style="visibility: hidden;" id="likeCount<%=recommendData.newsinfodata[0].news_id%>">5</div>
							</div>
							<span class="mui-pull-right orp" data-friend_news_id="<%=recommendData.newsinfodata[0].news_id%>" data-to_user_id="<%=recommendData.newsinfodata[0].user_id%>"><img src="../img/market/repeat.svg" style="width: 20px;margin:0 15px 0 10px;"/></span>
							<div class="sharef">
								<img src="../img/market/sharef.png" style="width: 20px;" />
							</div>
					 	</div>
					</div> 
				<%}%>
			</script>
			<div class="upload text-center text-xs gray" id="upload"></div>
			<!--底部导航-->
			 
			<nav class="mui-bar mui-bar-tab">
				<a class="subActive">
					<span class="mui-icon mui-icon-eye"></span>
					<!--<span class="mui-tab-label">关注</span>-->
				</a>
				<a onclick="gopage('find')">
					<span class="mui-icon mui-icon-pengyouquan"></span>
					
					<!--<span class="mui-tab-label">广场</span>-->
				</a>
				<a onclick="gopage('publish')">
					<span class="mui-icon mui-icon-camera"></span>
					<!--<span class="mui-tab-label">消息</span>-->
				</a>
				<a onclick="gopage('message')">
					<span class="mui-icon mui-icon-chat">
	                	<!--<span class="mui-badge mui-badge-danger">6</span>-->
	                </span>
				</a>
				<a onclick="gopage('centerPage')">
					<span class="mui-icon mui-icon-person"></span>
					<!--<span class="mui-tab-label">个人主页</span>-->
				</a>
			</nav>
		</div>
		
		 
	</body>
  <script type="text/javascript">
  	var falg = false; 
  	//安卓返回键
    mui.init({
        beforeback: function(){
             backindex();
            return false; 
        }
    });
    //自定义事件
    document.addEventListener('refresh', function() {
		mui.toast('刷新数据');
	})
    function backindex(){
    	falg = true;
        //获得主页面的webview 
        var appIndex = plus.webview.getLaunchWebview();
        var mainweb = plus.webview.getWebviewById('main.html');
        //触发主页面的gohome事件
        mui.fire(appIndex,'gohome',{hrefid:'defaultTab'});
        plus.webview.show(appIndex,"fade-in",500);
        plus.webview.show(mainweb,"fade-in",500); 
        if(plus.webview.getWebviewById('Follow')){
        	plus.webview.getWebviewById('Follow').close();
        }
        if(plus.webview.getWebviewById('message')){
        	plus.webview.getWebviewById('message').close();
        }
        if(plus.webview.getWebviewById('centerPage')){
        	plus.webview.getWebviewById('centerPage').close();
        }
        if(plus.webview.getWebviewById('find')){
        	plus.webview.getWebviewById('find').close();
        }
    	plus.webview.currentWebview().close();
        
    }
  	//导航切换
  	function gopage(page){ 
  		event.preventDefault();
  		function fotrue(){
	  		if(plus.webview.getWebviewById(page)){
	        	plus.webview.show(page,"fade-in",300);
	        	plus.webview.currentWebview().hide();
	        }else{
	        	openview({
					view:page+'.html',
					id:page
				});
	        }
  		}
  		if(page == 'find'){
  			fotrue();
  		}else{
  			if(plus.storage.getItem('myToken')){
  				fotrue();
  			}else{
  				mui.toast('请登录');
				openview({
					view:'login.html'
				});
  			}
  		}
  	}
  	
  	//贴子详情
	function findInfo(userid,newsid,avtar,nickname) {
            openview({
                view: "find/findInfo.html",
                id:"findInfo",
                extrasobj: {
                    userId: userid,newsId:newsid,avtar:avtar,nickName:nickname
                }
            })
        }
 
	
	//关注者 主页
    function gootpage(userId){
    	event.stopPropagation()
		openview({
			view: "othersPage.html",
			extrasobj: {
				userId: userId
			}
		})
	}
    
    
    mui.plusReady(function(){
    	
    	var oldtoken = plus.storage.getItem('oldToken');
        var myuserid = plus.storage.getItem('userid');
    	
		var Spagenum = 2; //实到页数
		var Ypagenum = 1; //应到页数 
		
    	//获取好友动态列表
    	getNews();
    	
    	function getNews(){
    		var currentPage = 1,numsPerPage = 10;
    		mui.ajax(serverUrl+"/api/news/newslist",{
    			data:{currentPage:currentPage,numsPerPage:numsPerPage,userid:myuserid,categoryid:'',isMyFriendPage:true},
        		dataType:'json',
				type:'post',
				timeout:10000,
				headers:{"token":oldtoken},	 
				success:function(data,type,xhr){ 	
						
					if(data.errno == 0) { 
						var dataobj = data.data.data; 
						if(dataobj.length != 0){
							for(var i=0;i<dataobj.length;i++){ 
								dataobj[i].avatar = JSON.parse(dataobj[i].avatar)
								dataobj[i].create_time = formatDate(dataobj[i].create_time, "yyyy.MM.dd hh:mm:ss"); 
							} 
							var recommendObj = {};
							recommendObj.myUrl = serverimgUrl;
							recommendObj.recommendData = dataobj; 
							document.getElementById("typeNews").innerHTML = template("typeNewTpl", recommendObj);
							var cmlist = document.getElementsByClassName("newsinfo");
								for(var t=0;t<cmlist.length;t++){
									var fuserid = cmlist[t].getAttribute("data-newsId");  
										getInfo(t,fuserid)
								}
						}   
						mui("#upload")[0].innerHTML = "";
//						上滑加载
						$(window).scroll(function() {　　
							var scrollTop = $(this).scrollTop();　　
							var scrollHeight = $(document).height();　　
							var windowHeight = $(this).height();　　
							if(scrollTop + windowHeight == scrollHeight) {
								if(Spagenum <= data.data.totalPages && Spagenum == Ypagenum + 1) { //当前页小于等于总页数时请求下一页
									mui("#upload")[0].innerHTML = "<img src='../img/balls.svg' />";
									Ypagenum++; //满足加载情况,应到页数+1
									console.log('发起请求,实到' + Spagenum + '页');
									console.log('发起请求,应到' + Ypagenum + '页');
									mui.ajax(serverUrl + '/api/news/newslist', {
										data:{currentPage:Spagenum,numsPerPage:numsPerPage,userid:myuserid,categoryid:ctid,isMyFriendPage:""},
						        		dataType:'json',
										type:'post',
										timeout:10000,
										headers:{"token":oldtoken},	 
										success:function(data,type,xhr){  
											if(data.errno == 0) {
												var dataobj = data.data.data
												if(dataobj.length != 0){
													for(var i=0;i<dataobj.length;i++){
														dataobj[i].avatar = JSON.parse(dataobj[i].avatar)
														dataobj[i].create_time = formatDate(dataobj[i].create_time, "yyyy.MM.dd hh:mm:ss");
//												 
													}
												} 
												var recommendObj = {}
												recommendObj.myUrl = serverimgUrl;
												recommendObj.recommendData = dataobj
												document.getElementById("typeNews").innerHTML += template("typeNewTpl", recommendObj);
												var cmlist = document.getElementsByClassName("newsinfo");
												for(var t=0;t<cmlist.length;t++){
													var fuserid = cmlist[t].getAttribute("data-newsId");  
														getInfo(t,fuserid)
												}
											}
											mui("#upload")[0].innerHTML = "";
											Spagenum++; //加载成功,当前页+1
											console.log('成功+1,实到' + Spagenum);
											console.log('成功+1,应到' + Spagenum);
										},
										error: function(xhr, type, errorThrown) {
											Ypagenum--; //失败是应到-1
											mui.toast("当前网络不好请重试");
											mui("#upload")[0].innerHTML = "";
										}
									});
								} else if(Spagenum == data.data.totalPages + 1) { //当前页不小于等于总页数时请求下一页
									mui("#upload")[0].innerHTML = "到底了";
								}
							}
						}); 
					} else {
						mui("#upload")[0].innerHTML = "";
					}
					plus.nativeUI.closeWaiting(); //关闭等待框 
					//发布者主页
					$(".findUser").click(function(){
						event.stopPropagation()
						openview({
							view: "centerPage.html",
							extrasobj: {
								userId: $(this).attr("data-userId")
							}
						})
					}) 
					
				},
				error:function(xhr,type,errorThrown){
					plus.nativeUI.closeWaiting();
					mui("#upload")[0].innerHTML = "";
					console.log('响应失败  !');
				}
				 
        	}) 
    		
    	}
        function getInfo(t,newId){
        	mui.ajax(serverUrl+"/api/news/newsinfo",{
    			data:{newsid:newId},
        		dataType:'json',
				type:'post',
				timeout:10000,
				headers:{"token":oldtoken},	 
				success:function(data,type,xhr){
					if(data.errno == 0) { 
						if(data.data){ 
							if(data.data.liker){
								for(var i=0;i<data.data.liker.length;i++){
									if(data.data.liker[i].user_id == myuserid){
										data.data.isLike = 1;   
									}
									 
								}
							}
						}
						var recommendObj = {}
							recommendObj.myUrl = serverimgUrl;
							recommendObj.recommendData = data.data;
						document.getElementsByClassName("newsinfo")[t].innerHTML = template("newsInfoTpl", recommendObj);
						
						//点赞 
						$('.comment .heart').on("click",function(){
							events.stopPropagation()
							if(plus.storage.getItem('myToken')){
								var A=$(this).attr("id"); 
								var B=A.split("like"); 
								var messageID=B[1];
								var C=parseInt($("#likeCount"+messageID).html());
								if(!C){
									C=0;
								}
								$(this).css("background-position","")
								var commitid= $(this).attr("data-id"); 
								var D=$(this).attr("rel");
								if(D === 'like') {
									$("#likeCount"+messageID).html(C+1);
									$(this).addClass("heartAnimation").attr("rel","unlike"); 
									
									//点赞评论 
									likeCmt(commitid,myuserid,oldtoken) 
								}
								else{  
									
									//取消点赞评论
									likeCmt(commitid,myuserid,oldtoken) 
									
									var nowLm = C-1;
									if(nowLm == 0){
										nowLm ='';
									}
									$("#likeCount"+messageID).html(nowLm);
									$(this).removeClass("heartAnimation").attr("rel","like");
									$(this).css("background-position","left");
									
								}
							}else{
								mui.toast('请登录');
								openview({
									view:'../login.html'
								});
							}
							
							
						});
						//回复跳转
						$(".orp").click(function(){ 
							event.stopPropagation()
							var to_user_id = 0; 
							var to_commit_id = ''
							//帖子id
							var friend_news_id = $(this).attr("data-friend_news_id")
							mui.openWindow({
							    url:"find/repComment.html",
							    id:"repComment",
							    show:{ 
							      aniShow:"slide-in-bottom",//页面显示动画，默认为”slide-in-right“；
							      duration:"300"//页面动画持续时间，Android平台默认100毫秒，iOS平台默认200毫秒；
							    },
							     waiting:{
							      autoShow:false,//自动显示等待框，默认为true
							    },
							    extras:{
							    	to_user_id:to_user_id,friend_news_id:friend_news_id,to_commit_id:to_commit_id
							    }
							})
						})
					}
				},
				error:function(xhr,type,errorThrown){
					plus.nativeUI.closeWaiting(); 
					console.log('响应失败  !');
				}
			})
        }
    })
    
    
    
  </script>
</html>