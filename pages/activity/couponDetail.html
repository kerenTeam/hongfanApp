<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>优惠详情</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/reset.css">
		<style type="text/css">
			
			.mui-bar{height: 50px;
			}
			.mui-title,.mui-icon{line-height: 50px;
			}
			.mui-bar .mui-icon{padding: 0;
			}
			.mui-bar-nav.mui-bar .mui-icon,.mui-title,.mui-icon{color: #fff;
			}
			.mui-bar-nav{box-shadow: none;
			}
			.mui-icon{line-height: 50px;
			}	
			.mui-icon .iconfont{font-size: 18px;
			}
			.dealcard, .cinemacard{margin-top: 50px;
			}
			.dealcard .dealcard-img img{height: 60px;
				overflow: hidden;
			}
		 	.shoucang .iconfont{font-size: 18px;
			}
			
			#main{margin-top: 50px;
			}
			.dealcard, .cinemacard{margin-top: 45px;
			}
			.dealcard, .cinemacard{margin-top: 45px;
			}
			/*banner图片固定高度比例*/
			.goodsImg{
				position: relative;
				display: inline-block;
				width: 100%;
				overflow: hidden;
			}
			.list,.bottom{
				border-bottom: 1px solid #EFEFF4 !important;
				border-top: 1px solid #EFEFF4 !important;
			}
			.top,.farm{
				border-bottom: none !important;
			}
			.farmtc .bt{
				border-top: 1px solid #EFEFF4 !important;
			} 
			.merchant .biz-call .phone{margin-top: -7px;}
			.rentingtopbot {padding-bottom: 40px !important;}
			
			.red1{
				color: #f53c42 !important;
				margin-bottom: 10px;
				font-size: 18px !important;
				display: inline-block;
			}
			.time img{
				width: 15px;
				margin-right: 5px;
			}
			.mui-btn-block {
				font-size: 16px;
				display: block;
				width: 90%;
				margin: 10px 5%;
				padding: 10px 0;
			}
			.farm{
				position: relative;
			}
			.biz-call img{
				width: 60%;
			}
			.biz-call p{
				line-height: 30px;
				float: right;
				font-size: 11px !important;
				width: 100%;
				text-align: center;
				color: #999 !important;
			}
			.merchant .biz-call{
				width: 20%;
				height: auto !important;
				line-height: inherit;
			}
			.biz-detail{
				margin-top: 10px;
			}
			.greencss{
				color: #32B16C !important;
			}
			.picWrap{
				padding: 10px 10px 0 10px;
				position: relative;
			}
			.cc{
				width: 100%;
			}
			.ccW{
				position: absolute;
				top: -10px;
				left: -15px;
				width: 0%;
			}
			.cLeft{
				position: absolute;
				top: 25px;
				left: 25px;
				/*z-index: 99;*/
			}
			.cLeft p{
				line-height: 22px;
			}
			.cRight{
				position: absolute;
				top: 10px;
				right: 10px;
				height: 100%;
				width: 21%;
				/*padding: 28px 22px;*/
			}
			.cRight p{
				line-height: 20px;
				font-size: 16px;
				color: #fff;
			}
			.got{
				position: absolute;
				right: 0px;
				top: 3px;
				width: 95px;
			}
			.yellowT{
				/*margin-bottom: 10px;*/
				font-size: 18px !important;
				color: #f2af2d!important;
			}
			.waitGet{
				display: block;
				margin: 0 auto;
				left: 50%;
				position: absolute;
				margin-left: -16px;
				top: 50%;
				margin-top: -20px;
			}
			#activityContent img{max-width: 100%;}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" id="header"> 
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
		    <h1 class="mui-title">优惠详情</h1>
			<a href="setup.html" class="fr shoucang sousuo mui-icon"><i class="iconfont icon-fenxiang"></i></a>
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		
		<!--详情内容-->
		<div id="main"></div>
		<!--模板渲染数据-->
		<script type="text/html" id="main-detail">
			<% if(!objData.system_activity.picImg || objData.system_activity.picImg == ''){ %>
				<img src="../../img/market/nodata.svg" class="goodsImg">
			<% }else{ %>
				<img src="<%=myUrl %><%= objData.system_activity.picImg %>" class="goodsImg">
			<% } %>
			<div class="farm clearfloat">
				<div class="top rentingtop clearfloat box-s">
					<p class="yellowT"><%= objData.system_activity.title %></p>
					<div class="merchant">
						<div class="biz-detail">
							<p class="time">
								<img src="../../img/time.png"/>活动时间：<%= objData.system_activity.begin_time.split('T')[0] %>&nbsp;~&nbsp;<%= objData.system_activity.end_time.split('T')[0] %>
							</p>
							<p class="time greencss">
								<img src="../../img/add.png"/>活动地点：<%= objData.system_activity.floor_name %>楼<%= objData.system_activity.door_no %>号
							</p>
							<p class="time ">
								<img src="../../img/liulan.svg"/>浏览次数：<%= objData.system_activity.read%>  次
							</p>
						</div>
						<div class="biz-call" style="display: none;" onclick="goStore(<%= objData.system_activity.storeid %>)">
							<img src="../../img/store.png"/>
							<p>查看商户</p>
						</div>
					</div>
				</div>
			</div>
			<% if(!objData.shop_coupon || objData.shop_coupon == ""){ %>
								
			<% }else{ %>
				<% for(var i = 0;i< objData.shop_coupon.length;i++ ){ %>
					<div class="picWrap">
						<img src="../../img/cc.png" class="cc"/>
						<div class="cLeft">
							<b class="red1"><%= objData.shop_coupon[i].name %></b>
							<p>使用时间：
								<%= objData.shop_coupon[i].begin_date %> ~ <%= objData.shop_coupon[i].begin_date %>
							</p>
							<p>使用条件：
								<% if(!objData.shop_coupon[i].salerule || objData.shop_coupon[i].salerule == ""){ %>
									无限制
								<% }else{ %>
									满<%= objData.shop_coupon[i].salerule1 %>减<%= objData.shop_coupon[i].salerule2 %>
								<% } %>
							</p>
							<img src="../../img/ccW.png"/ class="ccW">
						</div>
						<div class="cRight" onclick="getCoupon(this,<%= objData.shop_coupon[i].id %>)">
							<div class="waitGet">
								<p>立即</p>
								<p>领取</p>
							</div>
							<img src="../../img/got.png" class="got" style="display: none;"/>
						</div>
					</div>
				<% } %>
			<% } %>
			<div class="farmtc clearfloat mt10">
				<p class="bt box-s">活动详情</p>
			</div>
			<div class="farm clearfloat">
				<div class="top rentingtop rentingtopbot clearfloat box-s" id="activityContent"></div>					
			</div>
			
		</script>
		
		
	</body>
	<script src="../../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/app.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/artTemplate-native.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		//点击查看商户
		function goStore(storeId){
			openview({
				view:'../market/shophome.html',
				extrasobj:{storeId:storeId}
			})
		}
		function parseDom(arg) { //节点转换方法
			var objE = document.createElement("div");　　
			objE.innerHTML = arg;　　
			return objE;
		};
		mui.plusReady(function(){
			var storeCouponId = plus.webview.currentWebview().storeCouponId;
			plus.nativeUI.showWaiting("加载中...",{width:'100px',height:'80px'});
			var oldToken = plus.storage.getItem('oldToken');
			//数据渲染
			mui.ajax(serverUrl+'/api/index/couponoractivityinfo',{
				data:{id:storeCouponId},
				dataType:'json',
				type:'post',
				timeout:10000,
				headers:{"token":oldToken},	 
				success:function(data,type,xhr){
					console.log('详情',data);
					var gotCouponId =JSON.parse(plus.storage.getItem("$gotCoupon") || '[]');//获取已经领取的缓存
					var dateObj={};
			       	//处理获取的数据
					for(var j = 0;j < data.data.shop_coupon.length;j++){
						if(!data.data.shop_coupon[j].salerule || data.data.shop_coupon[j].salerule == ''){
							data.data.shop_coupon[j].salerule = null;
						}else{
							data.data.shop_coupon[j].salerule1 = eval("("+ data.data.shop_coupon[j].salerule +")").overflowValue;
			       			data.data.shop_coupon[j].salerule2 = eval("("+data.data.shop_coupon[j].salerule+")").cutValue;
						}
			       		
					}
					dateObj.objData=data.data;
					dateObj.myUrl=serverimgUrl;
					mui('#main')[0].innerHTML = template('main-detail',dateObj);
					
					if(data.data.system_activity.content) {
						var detailsdom = parseDom(data.data.system_activity.content);
						var detailsimg = detailsdom.getElementsByTagName('img');
						mui.each(detailsimg, function(index, element) {
							if(element.src.indexOf('pages/activity')>-1){
								element.src = serverimgUrl + element.src.split('pages/activity')[1];
								element.onerror = function() {
									element.src = '../../img/market/nodata.svg';
								}
							}
						})
						document.getElementById("activityContent").appendChild(detailsdom);
					}else{
						document.getElementById("activityContent").innerHTML = '<div style="font-size:0.12rem;color:gray;padding:5%;text-align: center;">暂无详情</div>'
					}
					
//					mui('#activityContent')[0].innerHTML = data.data.system_activity.content;
					plus.nativeUI.closeWaiting();
					//已领取的缓存，修改样式，点击禁用
					for(var k = 0;k<gotCouponId.length;k++){
						for(var n = 0;n < data.data.shop_coupon.length;n++){
							if(gotCouponId[k]==data.data.shop_coupon[n].id){
								mui('.waitGet')[n].style.display = 'none';
								mui('.got')[n].style.display = 'block';
								mui('.cRight')[n].onclick = function(){}
							}else{
							}
						}
					}
					//点击领取优惠券
					window.getCoupon = function(e,getCouponId){
						//判断是否登录并获取缓存token
						plus.nativeUI.showWaiting("加载中...",{width:'100px',height:'80px'});
						if(plus.storage.getItem('myToken')){
							var userId = plus.storage.getItem("userid");
							mui.ajax(serverUrl+'/api/index/getcoupon',{
								data:{id:getCouponId,userid:4},
								dataType:'json',
								type:'post',
								timeout:10000,
								headers:{"token":oldToken},	 
								success:function(data,type,xhr){
									if(data.errno == 0){
										mui.toast("领取成功！");
										e.getElementsByClassName('waitGet')[0].style.display = 'none';
										e.getElementsByClassName('got')[0].style.display = 'block';
										e.onclick = function(){}
										//已领取的存缓存
										gotCouponId.push(getCouponId);
										plus.storage.setItem('$gotCoupon', JSON.stringify(gotCouponId)); 
										plus.nativeUI.closeWaiting();
									}else{
										alert("领取失败，请重试！")
										plus.nativeUI.closeWaiting();
									}
								},
								error:function(xhr,type,errorThrown){
									alert('响应失败  !');
								}
							});
						}else{
							mui.toast('请登录！');
							openview({
								view:'../login.html'
							})
						}
					}
				},
				error:function(xhr,type,errorThrown){
					alert('响应失败  !');
				}
			});
		});
	</script>
</html>