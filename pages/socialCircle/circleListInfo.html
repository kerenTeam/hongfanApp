<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>动态详情</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">  
		<link rel="stylesheet" type="text/css" href="../../css/common.css"> 
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/> 
		<link rel="stylesheet" type="text/css" href="../../css/config.css"/> 
		 
	</head>
	<style type="text/css">
		.baocun{text-align:right;}
		.baocun img{margin:0 9pt;width:25%;vertical-align:middle;}
		.listCon{border-bottom: 10px solid #f3f3f3;}
		.listCon p{padding:10px 0 0}
		.follow{position:relative;}
		.follow{background-color:#fff;padding:15px 10px;}
		.follow:after{position:absolute;right:10px;bottom:0;left:10px;height:1px;background:#cacaca;content:'';-webkit-transform:scaleY(.3);}
		.follow:last-child:after{height:0;}
		.fchidl{display:flex;align-items:center;justify-content:space-between;}
		.userAvator{margin-right:10px;width:2.5rem;height:2.5rem;border-radius:50%;}
		.userAvator3{margin-right:10px;width:2rem;height:2rem;border-radius:50%;}
		.fchidl>div{display:flex;vertical-align:middle;text-align:left;font-size:15px;align-items:center;}
		.text{color:#999;}
  		.flexrr{display: flex;justify-content: space-between;align-items: center;padding: 15px 0;}
  		.flexrr>div img{width: 20px;vertical-align: middle;}
  		.cmtall img{width: 25px;margin-right: 5px;}
  		.cmtflex{display: flex;justify-content: space-between;align-items: center;}
  		.ctc span{color: #fb7e23;}
  		.jubao{background-color: white;} 
		.jubao li a{padding: 18px;line-height: 15px;text-align: center;border-bottom: 1px solid #EEEEEE;display: block;color: black;}
		.jubao li:last-child a{color: rgb(153,153,153);}
	   	ul{list-style: none;padding: inherit;margin: 0;}
	   	.diybtn{background: url(../../img/makeFriend/follow.png) no-repeat;background-size: 100% 100%;background-position: left top;color: white;padding: 4px 22px;}
  		.diybtn2{background: url(../../img/makeFriend/unfollw.png) no-repeat;background-size: 100% 100%;background-position: left top;color: #31c58b;padding: 4px 22px;}
		.yhm{width:calc((100vw - 50px)/3);height: calc((100vw - 20px)/3);margin-left: 5px;margin-top:10px ;}
		.giveBk{background: url(../../img/makeFriend/give.png) no-repeat;background-size: 100% 100%;background-position: left top;color: #31c58b;padding: 6px 25px;color: white;}
		.fchidl2{display: flex;align-items:;}
		.fchidl2 .butright{flex-grow: 1;}
		.fchidl2 .btop{display: flex;justify-content: space-between;align-items: center;}
		.fchidl3 .btop{display: flex;justify-content: flex-start!important;align-items: center;}
		.opbot{display: flex;padding: 10px;align-items:center;position: fixed;bottom: 0;left: 0;right: 0;background-color: white;box-shadow: 0px 1px 1px 1px #EEEEEE;}
		.writecmt{flex-grow: 1;background: url(../../img/makeFriend/cmtbor.png) no-repeat bottom;padding: 5px;max-height: 80px;overflow-y: scroll;}
		.opbot img{width: 28px;margin: 0 5px;}
		/*为空时显示 element attribute content*/
		.writecmt:empty:before{
		    content: attr(placeholder);   /* element attribute*/
		    /*content: ‘this is content‘;*/
		    color:#999;
		}
		/*焦点时内容为空*/
		.writecmt:focus:before{
		    content:none;
		}
		.follow .maincl{letter-spacing: 0.4px;line-height: 1.5;margin-bottom: 10px;}
		.follow b{font-weight: 600;color: #FD6363;}
		.fchidl3{padding: 10px 10px;border-left: 1px solid #ccc;}
		.DTcontent{overflow: hidden;}
		.dynamicPic{float: left;position: relative;overflow: hidden;border-right: 2px solid #fff;}
		.dynamicPic1{width: 70%;padding-top: 68%;}
		.dynamicPic2{width: 50%;padding-top: 48%;}
		.dynamicPic3{width: 33%;padding-top: 31%;}
		.dynamicPic img{width: 100%;}
		.dynamicPic span{display: inline-block;position: absolute;top: 2%;left: 2%;width: 96%;height: 96%;background-color: #F3F3F3;overflow: hidden;}
	</style>

	<body style="background-color: white;">

		<header class="mui-bar mui-bar-nav" id="header">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize back"></a>
			<h1 class="mui-title findUser">详情</h1>
			<a href="javascript:;" style="line-height: 50px;" class="mui-pull-right baocun"><img src="../../img/answer/share.png"/></a>
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div id="main">
		 
    		<div class="listCon" id="listInfoS"></div><!--内容-->
			<script type="text/html" id="listDataS">
				<div class="follow">
					<div class="fchidl">
						<div>
							<img src="<%=dataList.avatar%>" class="userAvator mr25"/>
							<div>
								<%=dataList.nickname%> <div class="disablecl ft12"> <%=dataList.create_time%>  <span style="color: #5d86b2;"><%=dataList.read%></span>阅读 </div>
							</div>
						</div> 
						<div class="butright">
							<div class="diybtn2" style="display: none;">
								聊天
							</div> 
							<div class="diybtn">
								关注
							</div> 
			           </div> 
					</div>  
					
					<div class="DTcontent">
						<p class="ft15 maincl"><%=dataList.content%></p>
						<%for(var j=0;j<dataList.picS.length;j++){%>
							<%if(dataList.picS.length == 1){ %>
								<div class="dynamicPic dynamicPic1">
									<span><img onload="imgHeight(this)" class="loadPics" data-src="<%=dataList.picS%>" /></span>
								</div>
							<%}else if(dataList.picS.length == 2){%>
								<div class="dynamicPic dynamicPic2">
									<span><img onload="imgHeight(this)" class="loadPics" data-src="<%=dataList.picS%>" /></span>
								</div>
							<%}else{%>
								<div class="dynamicPic dynamicPic3">
									<span><img onload="imgHeight(this)" class="loadPics" data-src="<%=dataList.picS%>" /></span>
								</div>
							<%}%>	
						<%}%>
					</div>
					
					<div class="flexrr">
						<div class="disablecl ft14">
							<img src="../../img/makeFriend/corn.png"/> 感谢您的赏脸阅读
						</div> 
						<div class="disablecl ft14 giveBk">
							<img src="../../img/makeFriend/cornw.png"/> 赏
						</div>
					</div> 
				</div>
			</script>
		 	<!--评论--> 
			<div class="follow cmtflex">
				<div style="text-align: center;line-height: 0.8;"> 
					<div class="ft14">评论</div> 
					<img style="width: 30px;margin: 0;" src="../../img/makeFriend/cmt.png"/>
				</div>
			</div>
			<div id="curShow"></div>
		 	<script type="text/html" id="cmtTpl">
		 		
		 		<%for(var i=0;i<list.length;i++){%>
					<%if(!list[i].commontid){%>
						 
						<div class="follow ft12"> 
							<div class="fchidl2">
								<div class="ctc" onclick="goCircleIndex(<%=list[i].user_id%>)">
									<img src="<%=list[i].avatar%>" class="userAvator"/>
								</div> 
								<div class="butright">
									<div class="ft12 btop">
					            		<b class="ft14"><%=list[i].nickname%></b> <span class="disablecl"><%=list[i].create_time%></span>
					            	</div>
					            	<div class="maincl ft14"><%=list[i].commont%></div>
					            	<div class="cmtChild" data-curUserId="<%=list[i].user_id%>" data-curCmtId="<%=list[i].id%>"></div>
					           </div> 
							</div>
						</div>
						
						<%}%>
					<%}%>
		 	</script> 
			
			<!--子评论-->
			<script type="text/html" id="cmtChildTpl">
				
				<%for(var i=0;i<list.length;i++){%> 
						 
						<div class="fchidl2 fchidl3">
							<div class="ctc" onclick="goCircleIndex(<%=list[i].user_id%>)">
								<img src="<%=list[i].avatar%>" class="userAvator3"/>
							</div> 
							<div class="butright">
								<div class="ft12 btop">
				            		<b><%=list[i].nickname%></b>
				            	</div>
				            	<div class="maincl ft12"><%=list[i].commont%></div>
				           </div> 
						</div>
						<div class="cmtChild2" data-curUserId="<%=list[i].user_id%>" data-curCmtId="<%=list[i].id%>"></div>
					<%}%>
 
			</script>
			<!--子评论-->
			<script type="text/html" id="cmtChild2Tpl">
				
				<%for(var i=0;i<list.length;i++){%> 
						 
						<div class="fchidl2 fchidl3">
							<div class="ctc" onclick="goCircleIndex(<%=list[i].user_id%>)">
								<img src="<%=list[i].avatar%>" class="userAvator3"/>
							</div> 
							<div class="butright">
								<div class="ft12 btop">
				            		<b><%=list[i].nickname%></b>&nbsp;&nbsp;回复&nbsp;&nbsp;<b><%=list[i].TO_nickname%></b>
				            	</div>
				            	<div class="maincl ft12"><%=list[i].commont%></div>
				           </div> 
						</div> 
					 
					<%}%> 
			</script>
		 
			<!--<div class="follow ft12"> 
				<div class="fchidl2">
					<div class="ctc">
						<img src="../../img/mainHtml/touxiang2.png" class="userAvator"/>
					</div> 
					<div class="butright">
						<div class="ft12 btop">
		            		<b class="ft14">陶丘的树枝</b> <span class="disablecl">1分钟前</span>
		            	</div>
		            	<div class="maincl ft14">发呆发呆</div>
		            	<div class="fchidl2 fchidl3">
							<div class="ctc">
								<img src="https://b-ssl.duitang.com/uploads/people/201708/21/20170821154449_RyBKi.thumb.600_0_c.jpeg" class="userAvator3"/>
							</div> 
							<div class="butright">
								<div class="ft12 btop">
				            		<b>蒸汽波***~</b>
				            	</div>
				            	<div class="maincl ft12">什么年代啊</div>
				           </div> 
						</div>
						<div class="fchidl2 fchidl3">
							<div class="ctc">
								<img src="https://b-ssl.duitang.com/uploads/item/201708/20/20170820000631_GYHQz.thumb.300_0.jpeg" class="userAvator3"/>
							</div> 
							<div class="butright">
								<div class="ft12 btop">
				            		<b>the fin.</b>&nbsp;&nbsp;回复&nbsp;&nbsp;<b>蒸汽波***~</b>
				            	</div>
				            	<div class="maincl ft12">今晚月色真美</div>
				           </div> 
						</div>
		           </div> 
				</div>
			</div>-->
		 
		</div>
		
		
		
		<!--操作表-->
		<div id="sheet1" class="mui-popover mui-popover-bottom mui-popover-action ">
		    <!-- 可选择菜单 -->
		    <ul class="jubao">
		      <li>
		        <a href="#">加入黑名单</a>
		      </li>
		      <li>
		        <a href="#">举报</a>
		      </li>
		      <li>
		        <a href="#sheet1">取消</a>
		      </li>
		    </ul>
		</div>
		
		<!--底部评论-->
		<div class="opbot">
			<div class="writecmt ft14" placeholder="写评论" contenteditable="true" ></div>
			<div id='cmtedup'>
				<img src="../../img/makeFriend/message.png" alt="" />
			</div>
			<div>
				<img src="../../img/makeFriend/zan.png" alt="" />
			</div>
		</div>
	 </body>
	<script type="text/javascript" src="../../js/jquery.min.js"></script>
	<script src="../../js/mui.min.js"></script>
	<script src="../../js/app.js"></script>
	<script src="../../js/artTemplate-native.js"></script>
	<script type="text/javascript">
		function imgHeight(obj){
			if(obj.offsetHeight<obj.parentNode.offsetHeight){
				obj.style.height = '100%';
				obj.style.width = 'auto';
			}
		}
		
	</script>
	<script type="text/javascript">
		mui.plusReady(function(){
			var cityNum = plus.storage.getItem('cityNum'),
			    oldToken = plus.storage.getItem('oldToken'),
				infiId = plus.webview.currentWebview().infoid,
				toCmt = plus.webview.currentWebview().isCmt;
				 
				if(toCmt){ 
					var main = document.getElementById('main');
	  				main.scrollTop = main.scrollHeight;
					//自动弹出输入法
					var nativeWebview, imm, InputMethodManager;
					var initNativeObjects = function() {
						if(mui.os.android) {
							var main = plus.android.runtimeMainActivity();
							var Context = plus.android.importClass("android.content.Context");
							InputMethodManager = plus.android.importClass("android.view.inputmethod.InputMethodManager");
							imm = main.getSystemService(Context.INPUT_METHOD_SERVICE);
						} else {
							nativeWebview = plus.webview.currentWebview().nativeInstanceObject();
						}
					};
					var showSoftInput = function() {
						if(mui.os.android) {
							imm.toggleSoftInput(0, InputMethodManager.SHOW_FORCED);
						} else {
							nativeWebview.plusCallMethod({
								"setKeyboardDisplayRequiresUserAction": false
							});
						}
						//此处可写具体逻辑设置获取焦点的input
						setTimeout(function() {
							$('.writecmt').focus();
						}, 0);
					};
					initNativeObjects();
					showSoftInput();

				}
				
			mui.ajax(serverUrl + '/api/friends/newsinfo/newsId/'+infiId, {
				dataType: 'json',
				type: 'get',
				timeout: 8000,
				headers: {"token": oldToken,'city': cityNum},
				success: function(data, type, xhr) {
					console.error('动态详情', data);
					if(data.errno == 0) {
						var dataObj = {}, nowArray = data.data;
						
						if(nowArray.avatar && nowArray.avatar!='null'){
							if(JSON.parse(nowArray.avatar)[0].picImg.indexOf('http') == -1){
								nowArray.avatar = serverimgUrl + JSON.parse(nowArray.avatar)[0].picImg;
							}else{
								nowArray.avatar = JSON.parse(nowArray.avatar)[0].picImg
							}
						}else{
							nowArray.avatar = '../../img/10.png'
						}
						
						if(!nowArray.nickname){
							nowArray.nickname = '匿名'
						}
						if(!nowArray.read){
							nowArray.read = 0
						}else if((nowArray.read / 1000)>1){
							nowArray.read = parseInt(nowArray.read / 1000) +'K+'
						}
						 
						var dt = new Date(nowArray.create_time).getTime(); 
						nowArray.create_time = getDateDiff(dt);
						
						
						//整理内容图片
						var nowArray2 = JSON.parse(JSON.parse(nowArray.pic));
						if(nowArray2.length){
							var picS = [];
							for(var k = 0 ;k<nowArray2.length;k++){
								picS.push(nowArray2[k].picImg);
							}
							nowArray.picS = picS;
						}
						
						dataObj.dataList = data.data;
						document.getElementById("listInfoS").innerHTML = template("listDataS", dataObj);
						lazyLoad(true);//懒加载
					}else{
						mui.toast('当前网络不好,请重试');
					}
				},
				error: function(xhr, type, errorThrown) {
					console.error('交友列表,响应失败');
					mui.toast('当前网络不好,请重试');
				}
			});
			
			//评论
			mui.ajax(serverUrl + '/api/friends/newscomment/newsId/'+infiId, {
				dataType: 'json',
				type: 'get',
				timeout: 8000,
				headers: {"token": oldToken,'city': cityNum},
				success: function(data, type, xhr) {
					console.error('评论详情', data);
					 
					if(data.errno == 0) {
						var cmtArray = data.data; 
						if(cmtArray && cmtArray.length>0){
							 
								for(var i = 0;i<cmtArray.length;i++){
									if(!cmtArray[i].nickname){ 
										cmtArray[i].nickname =  '匿名'
									}
									
									if(cmtArray[i].avatar && cmtArray[i].avatar!='null'){
										if(JSON.parse(cmtArray[i].avatar)[0].picImg.indexOf('http') == -1){
											cmtArray[i].avatar = serverimgUrl + JSON.parse(cmtArray[i].avatar)[0].picImg;
										}else{
											cmtArray[i].avatar = JSON.parse(cmtArray[i].avatar)[0].picImg
										}
									}else{
										cmtArray[i].avatar = '../../img/10.png'
									}
									
									var dt = new Date(cmtArray[i].create_time).getTime(); 
									cmtArray[i].create_time = getDateDiff(dt); 
								}   
								$('#curShow').html(template('cmtTpl',{list:cmtArray}));
								
								//子评论
								$('.cmtChild').each(function(){
									var curCmt = $(this);
									var curUserId = curCmt.attr('data-curUserId');
									var curCmtId = curCmt.attr('data-curCmtId');  
									mui.ajax(serverUrl + '/api/friends/newscomment/newsId/'+infiId, {
										dataType: 'json',
										type: 'get',
										timeout: 8000,
										headers: {"token": oldToken,'city': cityNum},
										success: function(data, type, xhr) {
											console.error('评论详情', data);
											 
											if(data.errno == 0) {
												var cmtArray = data.data; 
												var childArray = [];
												if(cmtArray && cmtArray.length>0){
													 
														for(var i = 0;i<cmtArray.length;i++){
															if(!cmtArray[i].nickname){ 
																cmtArray[i].nickname =  '匿名'
															}
															
															if(cmtArray[i].avatar && cmtArray[i].avatar!='null'){
																if(JSON.parse(cmtArray[i].avatar)[0].picImg.indexOf('http') == -1){
																	cmtArray[i].avatar = serverimgUrl + JSON.parse(cmtArray[i].avatar)[0].picImg;
																}else{
																	cmtArray[i].avatar = JSON.parse(cmtArray[i].avatar)[0].picImg
																}
															}else{
																cmtArray[i].avatar = '../../img/10.png'
															}
															
															var dt = new Date(cmtArray[i].create_time).getTime(); 
															cmtArray[i].create_time = getDateDiff(dt); 
															if(cmtArray[i].commontid == curCmtId){
																childArray.push(cmtArray[i])
															}
														}   
														console.log('子评论',childArray)
														curCmt.html(template('cmtChildTpl',{list:childArray}));
													 
															$('.cmtChild2').each(function(){
																var curCmt = $(this);
																var curUserId = curCmt.attr('data-curUserId');
																var curCmtId = curCmt.attr('data-curCmtId');  
																mui.ajax(serverUrl + '/api/friends/newscomment/newsId/'+infiId, {
																	dataType: 'json',
																	type: 'get',
																	timeout: 8000,
																	headers: {"token": oldToken,'city': cityNum},
																	success: function(data, type, xhr) {
																		console.error('评论详情', data);
																		 
																		if(data.errno == 0) {
																			var cmtArray = data.data; 
																			var childArray = [];
																			if(cmtArray && cmtArray.length>0){
																				 
																					for(var i = 0;i<cmtArray.length;i++){
																						if(!cmtArray[i].nickname){ 
																							cmtArray[i].nickname =  '匿名'
																						}
																						if(cmtArray[i].avatar && cmtArray[i].avatar!='null'){
																							if(JSON.parse(cmtArray[i].avatar)[0].picImg.indexOf('http') == -1){
																								cmtArray[i].avatar = serverimgUrl + JSON.parse(cmtArray[i].avatar)[0].picImg;
																							}else{
																								cmtArray[i].avatar = JSON.parse(cmtArray[i].avatar)[0].picImg
																							}
																						}else{
																							cmtArray[i].avatar = '../../img/10.png'
																						}
																						
																						var dt = new Date(cmtArray[i].create_time).getTime(); 
																						cmtArray[i].create_time = getDateDiff(dt); 
																						if(cmtArray[i].commontid == curCmtId){
																							childArray.push(cmtArray[i])
																						}
																					}   
																					console.log('子评论',childArray)
																					curCmt.html(template('cmtChild2Tpl',{list:childArray}));
																				 
																					  
																			}
																			
																		 
																		}else{
																			mui.toast('当前网络不好,请重试');
																		}
																	},
																	error: function(xhr, type, errorThrown) {
																		console.error('评论列表,响应失败');
																		mui.toast('当前网络不好,请重试');
																	}
																});
															})  
												}
												
											 
											}else{
												mui.toast('当前网络不好,请重试');
											}
										},
										error: function(xhr, type, errorThrown) {
											console.error('评论列表,响应失败');
											mui.toast('当前网络不好,请重试');
										}
									});
								})
								
							
						}
						
					 
					}else{
						mui.toast('当前网络不好,请重试');
					}
				},
				error: function(xhr, type, errorThrown) {
					console.error('评论列表,响应失败');
					mui.toast('当前网络不好,请重试');
				}
			});
		
		})
		//发布时间判断 
		var minute = 1000 * 60;
		var hour = minute * 60;
		var day = hour * 24;
		var halfamonth = day * 15;
		var month = day * 30;
		function getDateDiff(dateTimeStamp){ 
			var now = new Date().getTime(); 
			var diffValue = now - dateTimeStamp; 
			var monthC =diffValue/month;
			var weekC =diffValue/(7*day);
			var dayC =diffValue/day;
			var hourC =diffValue/hour;
			var minC =diffValue/minute;
			if(monthC>=1){
			 result=parseInt(monthC) + "个月前";
			 }
			 else if(weekC>=1){
			 result=parseInt(weekC) + "周前";
			 }
			 else if(dayC>=1){
			 result=parseInt(dayC) +"天前";
			 }
			 else if(hourC>=1){
			 result=parseInt(hourC) +"个小时前";
			 }
			 else if(minC>=1){
			 result=parseInt(minC) +"分钟前";
			 }else{ 
			 result="刚刚";
			 }
			return result;
		}
	</script>
	<script type="text/javascript">
      	//操作表
		$('.goanswer').click(function(){
		 	mui('#sheet1').popover('toggle');
		 	$('body').css('background-color','white')
		})
		
		$('.diybtn').click(function(){
    		$(this).css('display','none'); 
    		$(this).siblings('.diybtn2').css('display','block')
    		 
    	})
		
		$('.diybtn2').click(function(){
    		event.preventDefault()
			alert('聊天')
		})
		
	    //数据处理 
		var myuserid;
	    mui.plusReady(function(){
	    	$('#cmtedup').click(function(){
//	    		if($('.writecmt').html() != ;){
	    			$('.writecmt').html('');
	    			mui.toast('评论成功')
//	    		}
	    		
	    	})
	    	
	    	$('.giveBk').click(function(){
	    		event.preventDefault()
				openview({
					view:'../answerBoard/reward.html'
				})
			})
	    	
	    	//回复 或 评论
	    	$('.butright .maincl').click(function(){
	    		event.stopPropagation();
	    		$('.writecmt').focus();
	    		$('.writecmt').html('回复：xxx')
	    	})
	    
	    	
	    })
   	 
	</script>

</html>