<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>编辑资料</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black"> 
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" href="../../css/reset.css">
		<link rel="stylesheet" type="text/css" href="../../css/config.css"/>
		<style type="text/css">
			#userMessContainer{margin-top: 50px;
			}
			i{ont-style: normal;
			}
			i.container{position: relative;
			}
			i.imgContainer .upload{position: absolute;
				top:0;left:0;bottom:0;right:0;
				z-index:999;
			}
			#main{margin-bottom: 100px;
			}
			select{display: inline-block !important;
				float:right !important;
				font-size: 14px !important;
				margin-top:10px;
			}
			input{border:none !important;
			}
			.box-s{padding-left:5%;
			}
			.muibackdrop{width:80%;
				height:100px;
				padding:15px 50px;
				line-height: 30px;
				position: absolute;
				top:20%;
				left:10%;
				border:1px solid #F53C42;
				background: #ffffff;
			}
			.saveMessage{color:#FFFFFF;
				margin-right: 20px;
				line-height: 50px;
				font-size: 14px;
			}
			.muibackdrop{display: none;
			}
			.selectbtn{float: right !important;
				width: 17%;
				margin: 0;
			}
			.data ul li .shuru{margin-bottom: 0;
			}
			.data ul li img { 
			    width: 100px;
			    max-height: none; 
			}
			.wx_type_img{position: relative;
			}
			.wx_type_img input#imgUpload{margin: 0;cursor: pointer;position: absolute;top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				opacity: 0;
				filter: alpha(opacity=0);
			}
			#imgUpload{display: none;
			}
			.plist ul li{
				border-bottom: none;
				
			 	border-bottom: 10px solid #F3F3F3;
			}
			 
			.renting-footer{height: 50px;}
			.data ul li .shuru{
				line-height: 14px;
			}
			.data ul li .shuru::placeholder{
				padding-top:4px;
			}
			.diybut{color: #999;background:url(../../img/makeFriend/cc.png) no-repeat;background-size: 100% 100%;background-position: left top;width: 70px;text-align: center;padding: 8px 0;display: inline-block;margin-right: 5px;margin-bottom: 5px;} 
			.diybuted{background:url(../../img/makeFriend/dd.png) no-repeat;color: white;background-size: 100% 100%;background-position: left top;width: 70px;text-align: center;padding: 8px 0;display: inline-block;margin-right: 5px;margin-bottom: 5px;}
	    
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
		    <h1 class="mui-title">编辑资料</h1>  
		    <a href="javascript:;" style="line-height: 50px;color:white;" class="fr baocun" id="Preservation">保存</a>
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div id="main"> 
	    	<div class="plist clearfloat data" id="userMessContainer">
				<ul>
					<li class="clearfloat">
						<a href="#">
							<p class="fl">昵称</p>
							<input type="text" class="fr shuru" name="" id="nkname" placeholder="填写" />
						</a>
					</li>
					<li class="clearfloat">
						<a href="#">
							<p class="fl">个性签名</p>
							<input type="text" class="fr shuru" name="" id="explain" placeholder="填写" />
						</a>
					</li>
					<li class="clearfloat">
						<a href="#">
							<p class="fl">性别</p>
			    			<select class="mui-btn mui-btn-block selectbtn" id="Nextbtn" dir="rtl">
								<option value="item-1">点击选择</option>
								<option value="item-2">男</option> 
								<option value="item-2">女</option>
							</select>
						</a>
					</li>
					<li class="clearfloat">
						<a href="#">
							<p class="fl">星座</p>
							<input type="text" class="fr shuru" name="" id="horoscope" placeholder="填写" />
						</a>
					</li>
					<li class="clearfloat">
						<a href="#">
							<p class="fl">年龄</p>
							<input type="number" class="fr shuru" name="" id="age" placeholder="填写" />
						</a>
					</li>
					 
					<li class="clearfloat touxiang">
						<a>
							<p>更换背景图片</p>
							<label style="display: block;">
								<span>
									<div class="text-center gray" id="preview"><img id="mypic1" src="../../img/answer/editset.png"/></div>
								</span>
								<input type="file" accept="image/png,image/gif,image/jpg,image/jpeg" id="imgUpload" name="img[]" onchange="previewImage(this)" class="upload-add">
							</label>
						</a>
					</li>
					<li class="clearfloat touxiang">
						<a>
							<p>个性标签</p>
							<div id="psLabel">
							 
							</div>
							
						</a>
					</li> 
				 
				</ul>
			</div>
	    </div>
	    
		 
	</body>
	<script src="../../js/mui.min.js"></script>
	<script src="../../js/app.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/artTemplate-native.js"></script>
	<script src="../../js/jquery.min.js"></script> 
	<script type="text/javascript">
		var idnum = 0;
		mui.plusReady(function(){
		 
			var myuserid = plus.storage.getItem('userid');
			var cityNum = plus.storage.getItem('cityNum');
			var oldToken = plus.storage.getItem('oldToken');
			//显示既有信息
			mui.ajax(serverUrl+'/api/friends/friendhome/userId/'+myuserid,{
				type:'get',
				timeout:8000,
				headers:{"token":oldToken,"city":cityNum},	              				
				success:function(data,type,xhr){
					console.log('获取用户数据返回',data);
					if(data.errno == 0){
						
						if(/^(\(\d{3,4}\)|\d{3,4}-|\s)?\d{7,14}$/.test(data.data.username)){
							data.data.username = data.data.username.substring(0,3)+"****"+data.data.username.substring(7,11)
						}
						
//						//显示头像
//						if(data.data.avatar){
//							mui('#mypic2')[0].src = serverimgUrl + JSON.parse(data.data.avatar)[0].picImg;
//						}
//						
					 
						if(data.data.bgImg && JSON.parse(data.data.bgImg).length>0){ 
								$('#mypic1').attr('src',JSON.parse(data.data.bgImg)[0].picImg)
						}
						
						if(data.data.explain && data.data.explain!=null){ 
							$('#explain').val(data.data.explain)
						} 
						if(data.data.age){ 
							$('#age').val(data.data.age)
						}else{
							$('#age').val('填写')
						}
						
						if(data.data.horoscope && data.data.horoscope!=null){ 
							$('#horoscope').val(data.data.horoscope)
						}else{
							$('#horoscope').val('填写')
						}
//						显示昵称
						if(data.data.username && data.data.username != ' '){  
								$('#nkname').val(data.data.username) 
						}
						//显示性别
						switch (data.data.gender){//Nextbtn
							case '男':
							mui('#Nextbtn')[0].getElementsByTagName('option')[1].selected = true;
							break;
							case '女':
							mui('#Nextbtn')[0].getElementsByTagName('option')[2].selected = true;
							break;
							case '择'|| null:
							mui('#Nextbtn')[0].getElementsByTagName('option')[0].selected = true;
							break;
						}
						
					}else{
						//mui.toast('获取用户信息失败'); 
						console.log(data.errmsg); 
					}
				},
				error:function(xhr,type,errorThrown){
					//mui.toast('获取用户信息响应失败');
					console.log('获取用户数据,响应失败');
				}
			}); 
			//获取标签
			mui.ajax(serverUrl+'/api/friends/lable/userId/'+myuserid,{
				type:'get',
				timeout:8000,
				headers:{"token":oldToken,"city":cityNum},	              				
				success:function(data,type,xhr){
					console.log('获取用户数据返回',data);
					if(data.errno == 0){ 
						var dataObj=data.data;
						if(dataObj && dataObj.length){
							[].forEach.call(dataObj,function(ele){
								if(ele.lableName){
									$('#psLabel').append('<div data-id="'+ele.id+'" class="diybut">'+ele.lableName+'</div> ')
								}
							}) 
							
							mui.ajax(serverUrl+'/api/friends/userlable/userId/'+myuserid,{
								type:'get',
								timeout:8000,
								headers:{"token":oldToken,"city":cityNum},	              				
								success:function(data,type,xhr){
									console.log('获取用户数据返回',data);
									if(data.errno == 0){ 
										var dataObj=data.data;
										if(dataObj && dataObj.length){
											[].forEach.call(dataObj,function(ele){
												[].forEach.call($('.diybut'),function(ele2,index){
													if(ele2.innerText==ele.lableName){
														$('.diybut').eq(index).addClass('diybuted');
													}
												})
											}) 
										}
										
									}else{
										//mui.toast('获取用户信息失败'); 
										console.log(data.errmsg); 
									}
								},
								error:function(xhr,type,errorThrown){
									console.log('获取用户数据,响应失败');
								}
							});
							
						} 
						
					}else{
						//mui.toast('获取用户信息失败'); 
						console.log(data.errmsg); 
					}
					
		            $('.diybut').click(function(){ 
		                if($('.diybuted').length>5){
		                    if($(this).hasClass('diybuted')){
		                        var spanId = $(this).attr("data-id");  
		                        //删除标签
		                        var curSp = $(this);
		                        mui.ajax(serverUrl+'/api/friends/userlable/userId/'+myuserid,{
									data:{lableID:spanId},
									type:'delete',
									timeout:8000,
									headers:{"token":oldToken,"city":cityNum},	              				
									success:function(data,type,xhr){
										 
										console.log('获取用户数据返回',data);
										if(data.errno == 0){ 
		                        			curSp.removeClass('diybuted');
										}else{
											//mui.toast('获取用户信息失败'); 
											console.log(data.errmsg); 
										}
										 
									},
									error:function(xhr,type,errorThrown){
										console.log('获取用户数据,响应失败');
									}
								});
		                        
		                    }else{
		                        alert('最多只能选6个标签');
		                    } 
		                    return;
		                }else{ 
		                    var spanId = $(this).attr("data-id"); 
		                    if($(this).hasClass('diybuted')){
		                    	var curSp = $(this);
		                    	
		                        //删除标签
		                        mui.ajax(serverUrl+'/api/friends/userlable',{
									data:{lableID:spanId,userId:myuserid},
									type:'DELETE',
									timeout:8000,
									headers:{"token":oldToken,"city":cityNum},	              				
									success:function(data,type,xhr){ 
										console.log('获取用户数据返回',data);
										if(data.errno == 0){ 
		                       			 	curSp.removeClass('diybuted');
										}else{
											//mui.toast('获取用户信息失败'); 
											console.log(data.errmsg); 
										}
										 
									},
									error:function(xhr,type,errorThrown){
										console.log('获取用户数据,响应失败');
									}
								});
		                        
		                    }else{
		                    	var curSp = $(this);
		                    	//新增标签
		                        mui.ajax(serverUrl+'/api/friends/userlable/userId/'+myuserid,{
									data:{lableID:spanId,userId:myuserid},
									type:'POST',
									timeout:8000,
									headers:{"token":oldToken,"city":cityNum},	              				
									success:function(data,type,xhr){ 
										console.log('获取用户数据返回',data);
										if(data.errno == 0){ 
											curSp.addClass('diybuted');
										}else{
											//mui.toast('获取用户信息失败'); 
											console.log(data.errmsg); 
										}
										 
									},
									error:function(xhr,type,errorThrown){
										console.log('获取用户数据,响应失败');
									}
								});
		                        
		                    }
		                }
		            })

					
//					$('.diybut').click(function(){
//						if($('.diybuted').length>6){
//							mui.toast('最多只能添加6个标签哦')
//						}else{
//							mui.prompt('','请输入标签名','添加签名',['确认','取消'],function(e) {
//								if(e.index == 0) { 
//									if(e.value=='' || e.value==' '){
//										return false;
//									}else{
//										//新增标签
//										mui.ajax(serverUrl+'/api/friends/userlable',{
//											data:{lableName:e.value,userId:myuserid},
//											type:'post',
//											timeout:8000,
//											headers:{"token":oldToken,"city":cityNum},	              				
//											success:function(data,type,xhr){
//												console.log('获取用户数据返回',data);
//												if(data.errno == 0){ 
//													mui.toast('新增成功');
//													$('#psLabel').append('<div data-lableid="'+data.data.id+'" class="diybuted">'+e.value+'</div> ')
//													
//												}else{
//													//mui.toast('获取用户信息失败'); 
//													console.log(data.errmsg); 
//												}
//												$('#goLabel').click(function(){
//													openview({
//														view:'friendSet.html',
//														id:'friendSet'
//													})
//												})
//												
//											},
//											error:function(xhr,type,errorThrown){
//												console.log('获取用户数据,响应失败');
//											}
//										});
//									} 
//								} 
//							},'div')
//						}
//					})
					
					
				},
				error:function(xhr,type,errorThrown){
					console.log('获取用户数据,响应失败');
				}
			});
		
			//修改
			 
		})
		var filepic = {};
		//保存数据
		mui('#Preservation')[0].addEventListener('tap',function(){ 
			plus.nativeUI.showWaiting('保存中 ...',{width:'100px',height:'80px'});
			var explain = mui('#explain')[0].value || '';
			var horoscope = mui('#horoscope')[0].value || '';
			var touxiang = mui('#imgUpload')[0].files[0] || {};
			var age = $('#age').val() || '';
			var Nextbtnval = document.getElementById("Nextbtn").options[window.document.getElementById("Nextbtn").selectedIndex].text;
			var username = $('#nkname').val();
			 
			mui.plusReady(function(){ 
				var myuserid = plus.storage.getItem('userid');
				var cityNum = plus.storage.getItem('cityNum');
				var oldToken = plus.storage.getItem('oldToken');

				upfun1();
			 
				function upfun1(){
					var fd = new FormData(); 
					if(touxiang.name){
						fd.append('bgImg',touxiang);
					}
					fd.append('age',age);  
			        fd.append('username',username);  		
			        fd.append('userId',myuserid);  		
			        fd.append('horoscope',horoscope);
			        fd.append('gender',Nextbtnval[Nextbtnval.length-1]);
			        fd.append('explain',explain); 		
			        var xhr = new XMLHttpRequest();  	
			        xhr.open('PUT',serverUrl+'/api/friends/friendhome',true); 	
			    	xhr.onreadystatechange = function(){
			    		if (xhr.readyState===4) { 
	    					if (xhr.status===200) {
	    						plus.nativeUI.closeWaiting();//关闭等待框
	    						var dataobj = JSON.parse(xhr.responseText);
	    						console.log('修改'+xhr.responseText);
	    						if(dataobj.errno == 0){
	    							mui.toast('修改成功');	 
	    							//触发跳转页面刷新
									mui.fire(plus.webview.getWebviewById('mycircleIndex'),'refresh');
									 
									var time2 = setTimeout(function(){
										plus.webview.currentWebview().close();
									},500)
	    						}else{
	    							mui.toast('保存失败');	
	    						}
	    					}else{
	    						mui.toast('响应失败');	
	    					}
	    				}
			        } 
			        xhr.setRequestHeader("token",oldToken);
			        xhr.setRequestHeader("city",cityNum);
			        
			        xhr.send(fd);
				}
			})
		})
		//新的图片上传方法
		
		
		
		//图片上传文件方法	
		function previewImage(file) {
			var MAXWIDTH = 350;
			var MAXHEIGHT = 249;
			var div = findPreview(file.parentNode);
			if(file.files && file.files[0]) {
				filepic = file.files[0];
				div.innerHTML = '<img id=imghead>';
				var img = div.lastChild;
				img.onload = function() {
					var rect = clacImgZoomParam(MAXWIDTH, MAXHEIGHT, img.offsetWidth, img.offsetHeight);
					img.width = rect.width;
					img.height = rect.height;
				}
				var reader = new FileReader();
				reader.onload = function(evt) {
					img.src = evt.target.result;
				}
				reader.readAsDataURL(file.files[0]);
			}
		}

		function clacImgZoomParam(maxWidth, maxHeight, width, height) {
			var param = {
				top: 0,
				left: 0,
				width: width,
				height: height
			};
			if(width > maxWidth || height > maxHeight) {
				rateWidth = width / maxWidth;
				rateHeight = height / maxHeight;
	
				if(rateWidth > rateHeight) {
					param.width = maxWidth;
					param.height = Math.round(height / rateWidth);
				} else {
					param.width = Math.round(width / rateHeight);
					param.height = maxHeight;
				}
			}
			param.left = Math.round((maxWidth - param.width) / 2);
			param.top = Math.round((maxHeight - param.height) / 2);
			return param;
		}
		function findPreview(parent) {
			var childs = parent.childNodes;
			for(var i = 0; i < childs.length; i++) {
				if(childs[i].id == "preview")
					return childs[i];
			}
			return div = document.getElementById('preview');
		}
	</script>
	
	
</html>
