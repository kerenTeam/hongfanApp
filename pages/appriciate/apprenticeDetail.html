<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>为民服务-一见钟情详情</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" href="../../css/reset.css">
		<!--<link rel="stylesheet" type="text/css" href="../../css/localHost.css"/>-->
		<link rel="stylesheet" type="text/css" href="../../css/apprentice.css"/> 
		<script src="../../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/app.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/artTemplate-native.js" type="text/javascript" charset="utf-8"></script>
	</head>
	<style>
		.goinfl{
			    font-size: 18px;
			    display: block;
			    width: 38%;
			    margin: auto;
			    padding: 8px 0;
			    margin-top: 5%;
			    margin-bottom: 10%;
		}
		.acl{
			font-size: 0.14rem;
		}
		.acl:after{
			margin: 2.5% 0;
			content: '';
			display: block;
			height: 1px;
			background-color: rgba(0,0,0,0.1);
			-webkit-transform: scaleY(.5);
		}
		.acl img{
			width: 6%;
			vertical-align: middle;
		}
		.grayd{  
			font-size: 0.14rem; 
			color: rgba(0,0,0,0.6);
			margin-top: 6%;  
		}
		#content img{
			width: 100%;
		}
	</style>
	<body>
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
		    <h1 class="mui-title">一键钟情</h1>
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div class="mui-content" id="activity"></div>
		
		<script type="text/html" id="activity-detail">
			<div class="imgBox">
				<img src="<%=myUrl %><%= objData.picImg %>"/>
			</div>
			<div class="ceremonyContent" style="background-color: white;">
				<article class="xiangqinPara">
					<div class="black" style="margin-top: 5%;"><b><%= objData.title %></b></div>
					<div class="gray"><small><%= objData.numberofpeople %>人已参加</small></div>
					<button type="button" onclick="gosub(<%= objData.id %>,<%= objData.charge %>)" class="mui-btn mui-btn-danger mui-btn-block mui-btn-outlined goinfl" id="goinfl">要参加</button>
					
					<div class="black acl"><img src="../../img/serveForPeople/actime.png" alt="" /> 活动时间<small class="fr gray"><%= objData.times %></small></div>
					<div class="black acl"><img src="../../img/serveForPeople/mybm.png" alt="" /> 报名时间<small class="fr gray"><%= objData.start_time %> 到 <%= objData.end_time %></small></div>
					<div class="black acl"><img src="../../img/serveForPeople/baom.png" alt="" /> 报名费用<small class="fr gray">
						<% if(objData.charge >0){ %>
							￥<%= objData.charge %>
						<% }else{ %>
							免费
						<% } %>
					</small></div>
					<div class="black acl"><img src="../../img/serveForPeople/acmap.png" alt="" /> 活动地点<small class="fr gray"><%= objData.address %></small></div>
					<div class="black acl"><img src="../../img/serveForPeople/ban.png" alt="" /> 活动承办方<small class="fr gray"><%= objData.hostparty %></small></div>
					 
					<div class="grayd">活动详情：
						<ul class="listContent">
							<li id="content"></li>
						</ul>
					</div> 
				</article>
			</div> 
		</script>
	</body>
	<script type="text/javascript">
        function gosub(id,fee){
			if(plus.storage.getItem('myToken')){ 
					openview({
						view:'apprenticeSub.html',
						id:'apprenticeSub',
						extrasobj:{apprenticeId:id,apprenticeFee:fee}
					});
				}else{//没登陆直接打开登录页面
					mui.toast('请登录');
					openview({
						view:'../login.html'
					});
				}
 
		}
		mui.plusReady(function(){
			
			window.addEventListener("refreash",function(){
				load();
			})
			load();
			
			function load(){
				
			//铺数据
			plus.nativeUI.showWaiting("加载中...",{width:'100px',height:'80px'});
			var oldToken = plus.storage.getItem('oldToken');
			var activityId = plus.webview.currentWebview().activityId;
 
			console.log(oldToken);
			mui.ajax(serverUrl+'/api/localservice/marriagelist',{
//				data:{id:activityId},
				dataType:'json',
				type:'post',
				timeout:10000,
				headers:{"token":oldToken},	 
				success:function(data,type,xhr){
					if(data.errno==0){
						var dateObj={};
				       		data.data[0].create_time = data.data[0].create_time.split('T')[0]; 
				       		data.data[0].start_time = data.data[0].start_time.split('T')[0]; 
				       		data.data[0].end_time = data.data[0].end_time.split('T')[0]; 
							dateObj.objData=data.data[0];
							dateObj.myUrl=serverimgUrl;
							
							var joined = parseFloat(data.data[0].numberofpeople);
							var limit = parseFloat(data.data[0].persons_limit);
							
							mui('#activity')[0].innerHTML = template('activity-detail',dateObj);
							 
							if(joined==limit){
								 mui("#goinfl")[0].innerHTML="人数已满";
							     document.getElementById("goinfl").removeAttribute("onclick")
							}
							
					    if(data.data[0].content) {
							console.log('详情', data.data[0].content);
							var detailsdom = parseDom(data.data[0].content);
							console.log('转化节点',detailsdom);
							var detailsimg = detailsdom.getElementsByTagName('img');
							mui.each(detailsimg, function(index, element) {
								if(element.src.indexOf('pages/appriciate')>-1){
									console.log(element.src.split('pages/appriciate')[1]);
									element.src = serverimgUrl + element.src.split('pages/appriciate')[1];
									element.onerror = function() {
										element.src = '../../img/market/nodata.svg';
									}
								}
							})
							console.log('节点', detailsdom);
							//			                     	document.getElementById("textInfo").innerHTML=data.data.goodsInfo.content;
							document.getElementById("content").appendChild(detailsdom);
						} else {
							document.getElementById("content").innerHTML = '<div style="font-size:0.12rem;color:gray;padding:5%;text-align: center;">暂无详情</div>'
						}
							
						   
							plus.nativeUI.closeWaiting();
							
						   var acstorage = JSON.parse(plus.storage.getItem('$acstorage')||'[]');
					 
						   if(acstorage.length!=0){
							  mui("#goinfl")[0].innerHTML="已参加";
							  document.getElementById("goinfl").removeAttribute("onclick")
							  
							} 
					}
					
					
//			
					
					
				},
				error:function(xhr,type,errorThrown){
					mui.toast('响应失败  !');
					plus.nativeUI.closeWaiting();
				}
			});
			}
			function parseDom(arg) { //节点转换方法
				var objE = document.createElement("div");　　
				objE.innerHTML = arg;　　
				return objE;
			};
		});
	</script>
</html>
