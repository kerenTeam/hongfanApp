<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>发现</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../css/common.css">
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<link rel="stylesheet" href="../css/reset.css">
		<link rel="stylesheet" type="text/css" href="../css/fontello.css"/>
		<link rel="stylesheet" href="../css/imgload.css">
		<script type="text/javascript" src="../js/jquery.min.js"></script>
		<script src="../js/mui.min.js"></script>
		<script src="../js/md5.min.js" charset="utf-8"></script>
		<script src="../js/imgload.js" charset="utf-8"></script>
		<script src="../js/app.js"></script>
		<!--引入模板引擎-->
		<script src="../js/artTemplate-native.js"></script>
		<style type="text/css">
		/*banner样式*/
			
			.mui-slider-indicator .mui-indicator {
				width: 10px;
				height: 10px;
				border-radius: 8px;
				background: black;
				margin-right: 5px;
				opacity: 0.3;
				cursor: pointer;
				border: none;
				box-shadow: none;
			}
			
			#banner {
				position: relative;
				width: 100%;
				padding-top: 42%;
				overflow: hidden;
				background: url(../../img/bannerback.svg) 50% 50% no-repeat;
				background-size: 20%;
			}
			
			.mui-slider .mui-slider-group {
				position: absolute;
				height: 100%;
				width: 100%;
				top: 0;
			}
			
			.mui-slider .mui-slider-group .mui-slider-item img {
				height: 100%;
			}
			/*banner样式结束*/
			
			img {
				width: 100%;
			}
			
			.findType {
				overflow-x: scroll;
				white-space: nowrap;
				background-color: white;
				height: 45px;
			}
			.findType::-webkit-scrollbar {display:none}
			.findType li {
				font-size: 13px;
				display: inline-block;
				padding: 0 15px;
				height: 45px !important;
				line-height: 45px;
				color: gray;
			}
			
			.findType .active { 
				color: red; 
				border-bottom: 1px solid red;
			}
			
			.fTxt { 
				font-size: 12px;
			    padding: 0px 5px;
			    color: #666;
			    /* height: 0.32rem; */
			    letter-spacing: 0px;
			    line-height: 1.5;
			    display: -webkit-box;
			    -webkit-box-orient: vertical;
			    -webkit-line-clamp: 2;
			    overflow: hidden;
			}
			
			.findUser {
				padding: 5px;
			}
			
			.findUser img {
				width: 0.25rem!important;
				height: 0.25rem;
				border-radius: 50%!important;
				margin-right: 5px;
				/*vertical-align: middle!important;*/
			}
			
			.findUser span {
				color:#777;
				line-height: 0.3rem;
			}
			
			#mainpic {
				background-color: rgba(236, 236, 236, 0.16);  
				-webkit-column-count: 2;
				-moz-column-count: 2;
				column-count: 2;
				-moz-column-gap: 10px; 
				-webkit-column-gap: 10px;
				column-gap: 10px;
				padding: 10px;

			}
			
			.boxf {
				-webkit-column-break-inside: avoid;
				column-break-inside: avoid;
				border: none;
				margin-bottom: 10px;
				background-color: #fff;	
				border-radius: 2px;	 		
			}
			
			.boxf img {
				width: 100%;
				vertical-align: top;
				border-top-left-radius: 2px;
				border-top-bottom-radius: 2px;
			}
			
			.center {
				display: block;
				text-align: center;
				margin: 0.8rem 0;
				color: gray;
			}
			
			@media (min-width: 600px) {
				#mainpic {
					-webkit-column-count: 2;
					-moz-column-count: 2;
					column-count: 2;
				}
			}
			
			@media (min-width: 1000px) {
				#mainpic {
					-webkit-column-count: 3;
					-moz-column-count: 3;
					column-count: 3;
				}
			}
			
			.ftop {
				display: flex;
				justify-content: space-around;
				align-items: center;
				;
			}
			
			figure {
				width: 50%;
				padding-top: 30%;
				overflow: hidden;
				margin: auto;
				position: relative;
			}
			
			figure img {
				width: 100%;
				height: 100%;
				position: absolute;
				top: 0;
				left: 0;
			}
			
			figure figcaption {
				position: absolute;
				font-size: 0.16rem;
				color: white;
				top: 50%;
				left: 50%;
				-webkit-transform: translate(-50%, -50%);
				z-index: 9;
			}
			
			.fmask {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background-color: rgba(0, 0, 0, 0.2);
			}
			
			.mui-bar-tab a {
				color: #666;
				display: table-cell;
				vertical-align: bottom;
				text-align: center;
			}
			
			#main {
				padding-bottom: 51px;
			}
			
			.baocun img {
				width: 0.2rem;
				vertical-align: middle;
				margin-top: 5px;
				margin-right: 5px;
			}
		}
		/*加载*/
		#upload {

			text-align: center;
			font-size: 15px;
			line-height: 30px;
			min-height: 40px;
		}
		#upload img {
			width: 60px;
			margin-top: -10px;
		}
		.demo-icon{ 
		    font-size: 20px; 
		    position: relative;
		    top: -14px;
		}
		#header{
			box-shadow: 0 0 0px rgba(175, 166, 166, 0.85) !important;
		}
		.sticky {
			position: -webkit-sticky; position:sticky; top: 74px;  
		}
		
		</style>
	</head>

	<body style="padding-bottom: 50px;">
		<header class="mui-bar mui-bar-nav" id="header">
			<a class="goBack mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
			<h1 class="mui-title">发现</h1>
			<a href="javascript:;" style="line-height: 50px;color:white;" class="fr baocun"><img src="../img/sousuo.svg" alt="" /></a>
		</header>
		<script src="../js/statusBar.js"></script>
		<!--状态栏-->
		<!--<div id="container">-->
		<!--轮播图-->
		<div class="mui-slider" id="banner" style="margin-top: 50px;"></div>
		<!--轮播图结束-->
		<!--banner数据渲染-->
		<script type="text/html" id="banner-detail">
			<div class="mui-slider-group mui-slider-loop">
				<!--支持循环，需要重复图片节点-->
				<div class="mui-slider-item mui-slider-item-duplicate">
					<img src="<%= bannerList[bannerList.length-1].pic%>" dataurl='<%= bannerList[bannerList.length-1].pic%>' data-qtid='<%= bannerList[bannerList.length-1].q_id%>' onerror="javascript:this.src='../img/market/nodata.svg';" />
				</div>
				<% for(var i=0;i<bannerList.length;i++){ %> 
				<div class="mui-slider-item">
					<img src="<%=bannerList[i].pic %>" dataurl="<%=bannerList[i].pic %>" data-qtid='<%= bannerList[i].q_id%>' onerror="javascript:this.src='../img/market/nodata.svg';" />
				</div>
				<% } %>
				<!--支持循环，需要重复图片节点-->
				<div class="mui-slider-item mui-slider-item-duplicate">
					<img src="<%= bannerList[0].pic %>" dataurl="<%= bannerList[0].pic %>" data-qtid='<%= bannerList[0].q_id%>' onerror="javascript:this.src='../img/market/nodata.svg';" />
				</div>
			</div>
			<div class="mui-slider-indicator">
				<div class="mui-indicator mui-active"></div>
				<% for(var i=0;i<bannerList.length-1;i++){ %>
				<div class="mui-indicator"></div>
				<% } %>
			</div>
		</script>
		<!--分类栏目-->
		<div id="newsType" class="sticky"></div>
		<script type="text/html" id="newsTypeTpl">
			<ul class="findType">
				<li class="active aClick" data-ctid="">所有</li>
				<%for(var i = 0;i<tpdata.length;i++){%>
				<li class="aClick" data-ctid="<%=tpdata[i].cate_id%>">
					<%= tpdata[i].cate_name%>
				</li>
				<%}%>
			</ul>
		</script>
		<div id="mainpic">
		</div>
		<script type="text/html" id="typeNewTpl">

			<%if(!recommendData){%>
			<div class="center">看看其他类别呢</div>
			<%}else{%>
			
				<%for(var i=0;i<recommendData.length;i++){%>
				<div class="boxf" onclick="findInfo('<%=recommendData[i].user_id%>','<%=recommendData[i].news_id%>','<%=recommendData[i].avatar%>','<%=recommendData[i].nickname%>')">
					<div class="pic wrappic">
						<div class="paddingpic">
							<%if(recommendData[i].pic){%>
							<img class="img_contain" src="../img/loading.jpg" data-src="<%=recommendData[i].pic%>" onload="load(this)"/>
							<%}%>
						</div>
						<p class="fTxt">
							<%if(recommendData[i].content){%>
							<%=recommendData[i].content%>
							<%}%>
						</p>
						<div class="findUser" data-userId="<%=recommendData[i].user_id%>">
							<%if(recommendData[i].avatar){%>
							<img src="<%=recommendData[i].avatar%>" alt="<%=recommendData[i].avatar%>" onerror="javascript:this.src='../img/zhaoxiangji.svg';" alt="" /><span><%=recommendData[i].nickname%></span>
							<%}else{%>
							<li><img src="../img/10.png" alt="" /><span><%=recommendData[i].nickname%></span></li>
							<%}%>
						</div>
					</div>

				</div>

				<%}%>
			<%}%>

		</script>
		<div class="upload text-center text-xs gray" id="upload"></div>
		<!--底部导航-->
		<nav class="mui-bar mui-bar-tab">
			<a onclick="gopage('Follow')">
				<!--<span class="mui-icon mui-icon-eye"></span>-->
				<i class="demo-icon icon-heart"></i>
				<!--<span class="mui-tab-label">关注</span>-->
			</a>
			<a class="subActive">
				<!--<span class="mui-icon mui-icon-pengyouquan"></span>-->
				<i class="demo-icon icon-search"></i>
				<!--<span class="mui-tab-label">广场</span>-->
			</a>
			<a onclick="gopage('publish')">
				<!--<span class="mui-icon mui-icon-camera"></span>-->
				<i class="demo-icon icon-camera"></i> 
				<!--<span class="mui-tab-label">消息</span>-->
			</a>
			<a onclick="gopage('message')">
				<!--<span class="mui-icon mui-icon-chat">-->
					<i class="demo-icon icon-comment"></i>
                	<!--<span class="mui-badge mui-badge-danger">6</span>-->
				<!--<span class="mui-tab-label">消息</span>-->
			</a>
			<a onclick="gopage('centerPage')">
				<!--<span class="mui-icon mui-icon-person"></span>-->
				<i class="demo-icon icon-user"></i>
				<!--<span class="mui-tab-label">个人主页</span>-->
			</a>
		</nav>
		
	</body>
	<script type="text/javascript">
		statisticsfun('发现主页');//统计代码
		//苹果监听 右滑返回
//		var falg = false;
//	  	plus.webview.currentWebview().addEventListener( "popGesture", function(){
//	  		var time11 = setTimeout(function(){
//	  			if(!falg){
//	  				backindex();
//	  			}
//	  		},200);
//	  		
//	  		function funfun(){
//	  			console.log(1111);
//	  		}
//		}, false );
		//安卓返回键
//		mui.init({
//			beforeback: function() {
//				backindex();
//				return false;
//			}
//		}); 

		//导航切换
		function gopage(page) {
			event.preventDefault();

			function fotrue() {
				if(plus.webview.getWebviewById(page)) {
					plus.webview.show(page, "fade-in", 300);
					plus.webview.currentWebview().hide();
				} else {
					openview({
						view: page + '.html',
						id: page
					});
				}
			}
			if(page == 'find') {
				fotrue();
			} else {
				if(plus.storage.getItem('myToken')) {
					fotrue();
				} else {
					mui.toast('请登录');
					openview({
						view: 'login.html'
					});
				}
			}
		}

		function findInfo(userid, newsid, avtar, nickname) {
			openview({
				view: "find/findInfo.html",
				id: "findInfo",
				extrasobj: {
					userId: userid,
					newsId: newsid,
					avtar: avtar,
					nickName: nickname
				}
			})
		}
		$(".baocun").click(function() {
			openview({
				view: "find/findSearch.html",
			})
		})

//		$(".goBack").click(function() {
//			backindex();
//		})



		mui.plusReady(function() {
			var oldtoken = plus.storage.getItem('oldToken');
			var myuserid = plus.storage.getItem('userid');
			var ctidAlls= '';
			window.addEventListener('refreshNews',function(event){
				getNews(ctidAlls);
			})
			
			//banner
			//请求 专题 数据 
	    		mui.ajax(serverUrl+"/api/news/activitylist",{
	    			data:{act_id:1},
	        		dataType:'json',
	        		type:'post',
	        		timeout:10000,
					headers:{"token":oldtoken},	 
					success:function(data,type,xhr){ 
						if(data.errno == 0){
							var dataobj = [];
							if(data.data.length != 0){  
								for(var i = 0;i<data.data.length;i++){
									
									if(data.data[i].pic.indexOf('http')<=-1){
										data.data[i].pic = serverimgUrl + data.data[i].pic;
									}
									if(data.data[i].banner_state == 1){
										dataobj.push(data.data[i]);
									}
								}
								
	        					var theameObj = {};
	        					theameObj.url = serverimgUrl;
	        					theameObj.bannerList = dataobj;
	        					var html = template('banner-detail', theameObj);
								document.getElementById('banner').innerHTML = html;
								$("#banner img").click(function(){
									openview({
										view: "find/themalist.html",
										extrasobj: {
											qid:$(this).attr("data-qtid")
										}
									})
								})
								plus.nativeUI.closeWaiting(); //关闭等待框
								//轮播图,获得slider插件对象
								var gallery = mui('.mui-slider');
								gallery.slider({
									interval: 5000 //自动轮播周期，若为0则不自动播放，默认为0；
								});
							}else{
								plus.nativeUI.closeWaiting(); 
							}
						}
						
					},
					error:function(xhr,type,errorThrown){
						plus.nativeUI.closeWaiting()
						console.log('响应失败  !');
					}
	        }) 
		 
			// 发现动态的分类  
			mui.ajax(serverUrl + "/api/news/category", {
				dataType: 'json',
				type: 'post',
				timeout: 10000,
				headers: { "token": oldtoken },
				success: function(data, type, xhr) {
					if(data.errno == 0) {
						if(data.data.length != 0) {
							var newType = {};
							newType.tpdata = data.data;
							document.getElementById("newsType").innerHTML = template("newsTypeTpl", newType);
							//默认加载第一类的动态列表
							getNews(ctidAlls);
							
							//点击分类 切换动态
							$(".findType li").on("click", function() {
								var bannerH = mui('#banner')[0].offsetHeight || 100;
								if(!$(this).hasClass("active")) {
									document.body.scrollTop = bannerH; 
									mui('#newsType')[0].style.boxShadow = '0 0 2px rgba(175, 166, 166, 0.85)';
									getNews($(this).attr("data-ctid"))
								}

								$(".findType li").removeClass("active")
								$(this).addClass("active");
							})

						}
					}

				},
				error: function(xhr, type, errorThrown) {
					plus.nativeUI.closeWaiting()
					console.log('响应失败  !');
				}

			})
			
			// 获取状态栏的高度
			var immersed = 0;
			var ms = (/Html5Plus\/.+\s\(.*(Immersed\/(\d+\.?\d*).*)\)/gi).exec(navigator.userAgent);
			if(ms && ms.length >= 3) { // 当前环境为沉浸式状态栏模式
				immersed = parseFloat(ms[2]); // 获取状态栏的高度
			}
			//滚动 动态显示 tap
			var fangxiang;
			function scroll(fn) {
				var beforeScrollTop = document.body.scrollTop,
					fn = fn || function() {}; 
				window.addEventListener("scroll", function() {
					var afterScrollTop = document.body.scrollTop,
						delta = afterScrollTop - beforeScrollTop;
					if(delta === 0) return false;
					fn(delta > 0 ? "down" : "up");
					beforeScrollTop = afterScrollTop;
				}, false);
			}
			scroll(function(direction) {
				fangxiang = direction;
			});
			window.onscroll = function() {
				var bannerH = mui('#banner')[0].offsetHeight || 100;
				var Stop = document.body.scrollTop;
				if(Stop >= bannerH) { 
					mui('#newsType')[0].style.top = 50 + immersed + 'px';
					mui('#newsType')[0].style.left = 0 + 'px'; 
					mui('#newsType')[0].style.boxShadow = '0 0 2px rgba(175, 166, 166, 0.85)';
					
				}
				if(fangxiang == 'up' && Stop <= bannerH) { 
					mui('#newsType')[0].style.boxShadow = '0 0 0px rgba(175, 166, 166, 0.85)';
				}
			}
			

			var Spagenum = 2; //实到页数
			var Ypagenum = 1; //应到页数 
			var allpage = 0;//总页数
			var ajax = null,ajax2 = null; 
			//获取动态列表
			function getNews(ctid) {
				
				ajax && ajax.abort();
				ajax2 && ajax2.abort();
				allpage = 0;
				Spagenum = 2; //实到页数
				Ypagenum = 1; //应到页数 
				ctidAlls = ctid;
				plus.nativeUI.showWaiting()
				var currentPage = 1,
					numsPerPage = 8;
				ajax1 = mui.ajax(serverUrl + "/api/news/newslist", {
					data: { currentPage: currentPage, numsPerPage: numsPerPage, categoryid: ctidAlls, isMyFriendPage: "" },
					dataType: 'json',
					type: 'post',
					timeout: 10000,
					headers: { "token": oldtoken },
					success: function(data, type, xhr) { 
						console.log('初始数据',data);
						//console.log('总页数前' + data.data.totalPages); 
						allpage = data.data.totalPages;
						if(data.errno == 0) {
							var dataobj = data.data.data;
							if(dataobj.length != 0) {
								mui.each(dataobj,function (index,element) {
									if(/^(\(\d{3,4}\)|\d{3,4}-|\s)?\d{7,14}$/.test(element.nickname)){
										element.nickname = element.nickname.substring(0,3)+"****"+element.nickname.substring(7,11)
									} 
									if(element.avatar && element.avatar.indexOf('[{')>-1){
										element.avatar = serverimgUrl + JSON.parse(element.avatar)[0].picImg;
									}else if(element.avatar && element.avatar.indexOf('{')>-1){
										element.avatar = serverimgUrl + JSON.parse(element.avatar).picImg;
									} 
									if(element.pic && element.pic.indexOf('picImg')>-1){
										element.pic = serverimgUrl + JSON.parse(element.pic)[0].picImg;
									} 
								}) 
								console.log('获取图片尺寸',dataobj);
								
							}
							var recommendObj = {};
							recommendObj.myUrl = serverimgUrl;
							recommendObj.recommendData = dataobj;
							document.getElementById("mainpic").innerHTML = template("typeNewTpl", recommendObj);
							mui("#upload")[0].innerHTML = "";
							plus.nativeUI.closeWaiting(); //关闭等待框 
							//上滑加载
							$(window).scroll(function() {　　
								var scrollTop = $(this).scrollTop();　　
								var scrollHeight = $(document).height();　　
								var windowHeight = $(this).height();　
								
								if(scrollTop + windowHeight >= scrollHeight-200) {  
									if(Spagenum <= allpage && Spagenum == Ypagenum + 1) { //当前页小于等于总页数时请求下一页
										mui("#upload")[0].innerHTML = "<img src='../img/balls.svg' />";
										Ypagenum++; //满足加载情况,应到页数+1
										//console.error('总页数' + allpage);
										console.log('发起请求,实到' + Spagenum + '页');
										console.log('发起请求,应到' + Ypagenum + '页'); 
										ajax2 = mui.ajax(serverUrl + "/api/news/newslist", { 
											data: { currentPage: Spagenum, numsPerPage: numsPerPage, categoryid: ctidAlls, isMyFriendPage: "" },
											dataType: 'json',
											type: 'post',
											timeout: 10000,
											headers: { "token": oldtoken },
											success: function(data, type, xhr) {
												console.log('下拉加载',data);
												if(data.errno == 0) {
													var dataobj = data.data.data
													if(dataobj.length != 0) {
														mui.each(dataobj,function (index,element) {
															if(/^(\(\d{3,4}\)|\d{3,4}-|\s)?\d{7,14}$/.test(element.nickname)){
																element.nickname = element.nickname.substring(0,3)+"****"+element.nickname.substring(7,11)
															}
															if(element.avatar && element.avatar.indexOf('picImg')>-1){
																element.avatar = serverimgUrl + JSON.parse(element.avatar)[0].picImg;
															} 
															if(element.pic && element.pic.indexOf('picImg')>-1){
																element.pic = serverimgUrl + JSON.parse(element.pic)[0].picImg;
															}
														}) 
													}
													var recommendObj = {}
													recommendObj.myUrl = serverimgUrl;
													recommendObj.recommendData = dataobj
													document.getElementById("mainpic").innerHTML += template("typeNewTpl", recommendObj);
												}
												mui("#upload")[0].innerHTML = "";
												Spagenum++; //加载成功,当前页+1
												console.log('成功+1,实到' + Spagenum);
												console.log('成功+1,应到' + Spagenum);
											},
											error: function(xhr, type, errorThrown) {
												Ypagenum--; //失败是应到-1
												mui.toast("当前网络不好请重试");
												mui("#upload")[0].innerHTML = "";
											}
										});
									} else if(Spagenum == data.data.totalPages + 1) { //当前页不小于等于总页数时请求下一页
										mui("#upload")[0].innerHTML = "到底了";
									}
								}
							});
						} else {
							plus.nativeUI.closeWaiting();
							mui("#upload")[0].innerHTML = "";
						}
						
						//发布者主页
						$(".findUser").click(function() {
							event.stopPropagation()
							if($(this).attr("data-userId") == myuserid){
								openview({
									view: "centerPage.html",
									extrasobj:{
										idnum:$(this).attr("data-userId")
									}
								})
							}else{
								openview({
									view: "othersPage.html",
									extrasobj:{
										idnum:$(this).attr("data-userId")
									}
								})
							}
							
						})
					},
					error: function(xhr, type, errorThrown) {
						plus.nativeUI.closeWaiting();
						mui("#upload")[0].innerHTML = "";
						console.log('响应失败  !');
					}

				})

			}
		})
	</script>

</html>