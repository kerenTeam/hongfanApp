<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>发现</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../css/common.css">
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<link rel="stylesheet" href="../css/reset.css">
		<script type="text/javascript" src="../js/jquery.min.js"></script>
		<script src="../js/mui.min.js"></script>
		<script src="../js/app.js"></script>
		<!--引入模板引擎-->
		<script src="../js/artTemplate-native.js"></script>
		<style type="text/css">
		/*banner样式*/
			
			.mui-slider-indicator .mui-indicator {
				width: 10px;
				height: 10px;
				border-radius: 8px;
				background: black;
				margin-right: 5px;
				opacity: 0.3;
				cursor: pointer;
				border: none;
				box-shadow: none;
			}
			
			#banner {
				position: relative;
				width: 100%;
				padding-top: 42%;
				overflow: hidden;
				background: url(../../img/bannerback.svg) 50% 50% no-repeat;
				background-size: 20%;
			}
			
			.mui-slider .mui-slider-group {
				position: absolute;
				height: 100%;
				width: 100%;
				top: 0;
			}
			
			.mui-slider .mui-slider-group .mui-slider-item img {
				height: 100%;
			}
			/*banner样式结束*/
			
			img {
				width: 100%;
			}
			
			.findType {
				overflow-x: scroll;
				white-space: nowrap;
				background-color: white;
				height: 45px;
			}
			.findType::-webkit-scrollbar {display:none}
			.findType li {
				font-size: 13px;
				display: inline-block;
				padding: 0 15px;
				height: 45px !important;
				line-height: 45px;
				color: gray;
			}
			
			.findType .active {
				color: black;
			}
			
			.fTxt {
				font-size: 0.11rem;
				padding: 5px;
				color: rgba(0, 0, 0, 0.8);
				height: 0.32rem;
				letter-spacing: 1px;
				line-height: 1.2;
				/*超出两行省略*/
				display: -webkit-box;
				-webkit-box-orient: vertical;
				-webkit-line-clamp: 2;
				overflow: hidden;
			}
			
			.findUser {
				padding: 5px;
			}
			
			.findUser img {
				width: 0.3rem!important;
				height: 0.3rem;
				border-radius: 50%!important;
				margin-right: 5px;
				/*vertical-align: middle!important;*/
			}
			
			.findUser span {
				color: rgba(0, 0, 0, 0.6);
				line-height: 0.3rem;
			}
			
			#mainpic {
				background-color: rgba(255, 255, 255, 0.7);
				-webkit-column-count: 2;
				-moz-column-count: 2;
				column-count: 2;
				-moz-column-gap: 10px;
				-webkit-column-gap: 10px;
				column-gap: 10px;
				padding: 10px;
			}
			
			.boxf {
				-webkit-column-break-inside: avoid;
				column-break-inside: avoid;
				border: none;
				margin-bottom: 10px;
				cursor: pointer;
			}
			
			.boxf img {
				width: 100%;
				vertical-align: top;
				border-radius: 2px;
			}
			
			.center {
				text-align: center;
				margin: 0.8rem 0;
				color: gray;
			}
			
			@media (min-width: 600px) {
				#mainpic {
					-webkit-column-count: 2;
					-moz-column-count: 2;
					column-count: 2;
				}
			}
			
			@media (min-width: 1000px) {
				#mainpic {
					-webkit-column-count: 3;
					-moz-column-count: 3;
					column-count: 3;
				}
			}
			
			.ftop {
				display: flex;
				justify-content: space-around;
				align-items: center;
				;
			}
			
			figure {
				width: 50%;
				padding-top: 30%;
				overflow: hidden;
				margin: auto;
				position: relative;
			}
			
			figure img {
				width: 100%;
				height: 100%;
				position: absolute;
				top: 0;
				left: 0;
			}
			
			figure figcaption {
				position: absolute;
				font-size: 0.16rem;
				color: white;
				top: 50%;
				left: 50%;
				-webkit-transform: translate(-50%, -50%);
				z-index: 9;
			}
			
			.fmask {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background-color: rgba(0, 0, 0, 0.2);
			}
			
			.mui-bar-tab a {
				color: darkgray;
				display: table-cell;
				vertical-align: bottom;
				text-align: center;
			}
			
			#main {
				padding-bottom: 51px;
			}
			
			.baocun img {
				width: 0.2rem;
				vertical-align: middle;
				margin-top: 5px;
				margin-right: 5px;
			}
		}
		/*加载*/
		#upload {
			text-align: center;
			font-size: 15px;
			line-height: 30px;
			min-height: 40px;
		}
		#upload img {
			width: 60px;
			margin-top: -10px;
		}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" id="header">
			<a class="goBack mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
			<h1 class="mui-title">发现</h1>
			<a href="javascript:;" style="line-height: 50px;color:white;" class="fr baocun"><img src="../img/sousuo.svg" alt="" /></a>
		</header>
		<script src="../js/statusBar.js"></script>
		<!--状态栏-->
		<!--<div id="container">-->
		<!--轮播图-->
		<div class="mui-slider" id="banner" style="margin-top: 50px;"></div>
		<!--轮播图结束-->
		<!--banner数据渲染-->
		<script type="text/html" id="banner-detail">
			<div class="mui-slider-group mui-slider-loop">
				<!--支持循环，需要重复图片节点-->
				<div class="mui-slider-item mui-slider-item-duplicate">
					<img src="<%= url %><%= bannerList[bannerList.length-1].bannerPic %>" onerror="javascript:this.src='../img/market/nodata.svg';" />
				</div>
				<% for(var i=0;i<bannerList.length;i++){ %>
				<div class="mui-slider-item">
					<img src="<%= url %><%=bannerList[i].bannerPic %>" onerror="javascript:this.src='../img/market/nodata.svg';" />
				</div>
				<% } %>
				<!--支持循环，需要重复图片节点-->
				<div class="mui-slider-item mui-slider-item-duplicate">
					<img src="<%= url %><%= bannerList[0].bannerPic %>" onerror="javascript:this.src='../img/market/nodata.svg';" />
				</div>
			</div>
			<div class="mui-slider-indicator">
				<div class="mui-indicator mui-active"></div>
				<% for(var i=0;i<bannerList.length-1;i++){ %>
				<div class="mui-indicator"></div>
				<% } %>
			</div>
		</script>

		<div id="theame"></div>
		<script type="text/html" id="theameTpl">
			<div class="ftop" style="margin: 10px 0;">
				<figure id="1" data-actid="<%=theameData[0].act_id%>">
					<div class="fmask"></div>
					<figcaption>专题</figcaption>
					<img src="<%=theameData[0].act_pic%>" style="width: 100%;" onerror="javascript:this.src='../img/center/zt.jpg';" />
				</figure>
				<figure id="2" data-actid="<%=theameData[1].act_id%>">
					<div class="fmask"></div>
					<figcaption>活动</figcaption>
					<img src="<%=theameData[1].act_pic%>" style="width: 100%;" onerror="javascript:this.src='../img/center/acf.png';" />
				</figure>
			</div>
		</script>

		<!--分类栏目-->
		<div id="newsType"></div>
		<script type="text/html" id="newsTypeTpl">
			<ul class="findType">
				<li class="active aClick" data-ctid="0">所有</li>
				<%for(var i = 0;i<tpdata.length;i++){%>
				<li class="aClick" data-ctid="<%=tpdata[i].cate_id%>">
					<%= tpdata[i].cate_name%>
				</li>
				<%}%>
			</ul>
		</script>
		<div id="typeNews"></div>
		<script type="text/html" id="typeNewTpl">

			<%if(recommendData.length==0){%>
			<div class="center">看看其他类别呢</div>
			<%}else{%>
			<div id="mainpic">
				<%for(var i=0;i<recommendData.length;i++){%>
				<div class="boxf" onclick="findInfo('<%=recommendData[i].user_id%>','<%=recommendData[i].news_id%>','<%=recommendData[i].avatar%>','<%=recommendData[i].nickname%>')">
					<div class="pic">
						<%if(recommendData[i].pic){%>
						<img src="<%=recommendData[i].pic%>" onerror="javascript:this.src='../img/zhaoxiangji.svg';">
						<%}%>
						<p class="fTxt">
							<%if(recommendData[i].content){%>
							<%=recommendData[i].content%>
							<%}%>
						</p>
						<div class="findUser" data-userId="<%=recommendData[i].userid%>">
							<%if(recommendData[i].avatar){%>
							<img src="<%=recommendData[i].avatar%>" onerror="javascript:this.src='../img/zhaoxiangji.svg';" alt="" /><span><%=recommendData[i].nickname%></span>
							<%}else{%>
							<li><img src="../img/10.png" alt="" /><span><%=recommendData[i].nickname%></span></li>
							<%}%>
						</div>
					</div>

				</div>

				<%}%>
			</div>
			<%}%>

		</script>
		<div class="upload text-center text-xs gray" id="upload"></div>
		<!--底部导航-->

		<nav class="mui-bar mui-bar-tab">
			<a onclick="gopage('Follow')">
				<span class="mui-icon mui-icon-eye"></span>
				<!--<span class="mui-tab-label">关注</span>-->
			</a>
			<a class="subActive">
				<span class="mui-icon mui-icon-pengyouquan"></span>

				<!--<span class="mui-tab-label">广场</span>-->
			</a>
			<a onclick="gopage('publish')">
				<span class="mui-icon mui-icon-camera"></span>
				<!--<span class="mui-tab-label">消息</span>-->
			</a>
			<a onclick="gopage('message')">
				<span class="mui-icon mui-icon-chat">
                	<!--<span class="mui-badge mui-badge-danger">6</span>-->
				</span>
				<!--<span class="mui-tab-label">消息</span>-->
			</a>
			<a onclick="gopage('centerPage')">
				<span class="mui-icon mui-icon-person"></span>
				<!--<span class="mui-tab-label">个人主页</span>-->
			</a>
		</nav>
	</body>
	<script type="text/javascript">
		statisticsfun('发现主页');//统计代码
		//苹果监听 右滑返回
//		var falg = false;
//	  	plus.webview.currentWebview().addEventListener( "popGesture", function(){
//	  		var time11 = setTimeout(function(){
//	  			if(!falg){
//	  				backindex();
//	  			}
//	  		},200);
//	  		
//	  		function funfun(){
//	  			console.log(1111);
//	  		}
//		}, false );
		//安卓返回键
//		mui.init({
//			beforeback: function() {
//				backindex();
//				return false;
//			}
//		}); 

		//导航切换
		function gopage(page) {
			event.preventDefault();

			function fotrue() {
				if(plus.webview.getWebviewById(page)) {
					plus.webview.show(page, "fade-in", 300);
					plus.webview.currentWebview().hide();
				} else {
					openview({
						view: page + '.html',
						id: page
					});
				}
			}
			if(page == 'find') {
				fotrue();
			} else {
				if(plus.storage.getItem('myToken')) {
					fotrue();
				} else {
					mui.toast('请登录');
					openview({
						view: 'login.html'
					});
				}
			}
		}

		function findInfo(userid, newsid, avtar, nickname) {
			openview({
				view: "find/findInfo.html",
				id: "findInfo",
				extrasobj: {
					userId: userid,
					newsId: newsid,
					avtar: avtar,
					nickName: nickname
				}
			})
		}
		$(".baocun").click(function() {
			openview({
				view: "find/findSearch.html",
			})
		})

//		$(".goBack").click(function() {
//			backindex();
//		})



		mui.plusReady(function() {
			var oldtoken = plus.storage.getItem('oldToken');
			var myuserid = plus.storage.getItem('userid');

			//banner
			mui.ajax(serverUrl + '/api/index/banner', {
				data: { banner_type: 10 },
				dataType: 'json',
				type: 'post',
				timeout: 10000,
				headers: { "token": oldtoken },
				success: function(data, type, xhr) {
					bannerObj = {};
					bannerObj.bannerList = eval("(" + data.data.banner + ")");
					bannerObj.url = serverimgUrl;
					var html = template('banner-detail', bannerObj);
					document.getElementById('banner').innerHTML = html;
					plus.nativeUI.closeWaiting(); //关闭等待框
					//轮播图,获得slider插件对象
					var gallery = mui('.mui-slider');
					gallery.slider({
						interval: 5000 //自动轮播周期，若为0则不自动播放，默认为0；
					});
				},
				error: function(xhr, type, errorThrown) {
					console.log('响应失败  !');
				}
			});

			//获取海报信息
			mui.ajax(serverUrl + "/api/news/activity", {
				dataType: 'json',
				type: 'post',
				timeout: 10000,
				headers: { "token": oldtoken },
				success: function(data, type, xhr) {
					if(data.errno == 0) {
						console.log("海报信息 ", JSON.stringify(data));
						if(data.data.length != 0) {
							for(var i = 0; i < data.data.length; i++) {
								if(data.data[i].act_pic.indexOf('http') == -1) {
									data.data[i].act_pic = serverimgUrl + data.data[i].act_pic;
									console.log("fsd" + data.data[i].act_pic);
								}
							}

							var theameObj = {};
							theameObj.myurl = serverimgUrl;
							theameObj.theameData = data.data;
							document.getElementById("theame").innerHTML = template("theameTpl", theameObj);

							//专题 活动切换
							$("figure").click(function() {
								var type = $(this).attr("id");
								var acid = $(this).attr("data-actid")
								openview({
									view: "find/thematicActivities.html",
									extrasobj: {
										type: type,
										acid: acid
									}
								})
							})
						}
					}

				},
				error: function(xhr, type, errorThrown) {
					plus.nativeUI.closeWaiting()
					console.log('响应失败  !');
				}
			})

			// 发现动态的分类  
			mui.ajax(serverUrl + "/api/news/category", {
				dataType: 'json',
				type: 'post',
				timeout: 10000,
				headers: { "token": oldtoken },
				success: function(data, type, xhr) {
					if(data.errno == 0) {
						if(data.data.length != 0) {
							var newType = {};
							newType.tpdata = data.data;
							document.getElementById("newsType").innerHTML = template("newsTypeTpl", newType);

							//默认加载第一类的动态列表 
							getNews($(".findType li:first-child").attr("data-ctid"))

							//点击分类 切换动态
							$(".findType li").on("tap", function() {

								if(!$(this).hasClass("active")) {
									getNews($(this).attr("data-ctid"))
								}

								$(".findType li").removeClass("active")
								$(this).addClass("active");
							})

						}
					}

				},
				error: function(xhr, type, errorThrown) {
					plus.nativeUI.closeWaiting()
					console.log('响应失败  !');
				}

			})

			var Spagenum = 2; //实到页数
			var Ypagenum = 1; //应到页数 
			//获取动态列表
			function getNews(ctid) {
				plus.nativeUI.showWaiting()
				var currentPage = 1,
					numsPerPage = 10;
				mui.ajax(serverUrl + "/api/news/newslist", {
					data: { currentPage: currentPage, numsPerPage: numsPerPage, userid: myuserid, categoryid: ctid, isMyFriendPage: "false" },
					dataType: 'json',
					type: 'post',
					timeout: 10000,
					headers: { "token": oldtoken },
					success: function(data, type, xhr) {
						if(data.errno == 0) {
							var dataobj = data.data.data;
							if(dataobj.length != 0) {
								for(var i = 0; i < dataobj.length; i++) {
									if(dataobj[i].avatar.indexOf("[") != -1) {
										dataobj[i].avatar = serverimgUrl + JSON.parse(dataobj[i].avatar)[0].picImg;
									}
									if(dataobj[i].pic.indexOf("http") == -1) {
										dataobj[i].pic = serverimgUrl + JSON.parse(dataobj[i].pic)[0].picImg;
									}
								}
							}
							var recommendObj = {};
							recommendObj.myUrl = serverimgUrl;
							recommendObj.recommendData = dataobj;
							document.getElementById("typeNews").innerHTML = template("typeNewTpl", recommendObj);
							mui("#upload")[0].innerHTML = "";
							//上滑加载
							$(window).scroll(function() {　　
								var scrollTop = $(this).scrollTop();　　
								var scrollHeight = $(document).height();　　
								var windowHeight = $(this).height();　　
								if(scrollTop + windowHeight == scrollHeight) {
									if(Spagenum <= data.data.totalPages && Spagenum == Ypagenum + 1) { //当前页小于等于总页数时请求下一页
										mui("#upload")[0].innerHTML = "<img src='../img/balls.svg' />";
										Ypagenum++; //满足加载情况,应到页数+1
										console.log('发起请求,实到' + Spagenum + '页');
										console.log('发起请求,应到' + Ypagenum + '页');
										mui.ajax(serverUrl + '/api/news/newslist', {
											data: { currentPage: Spagenum, numsPerPage: numsPerPage, userid: myuserid, categoryid: ctid, isMyFriendPage: "" },
											dataType: 'json',
											type: 'post',
											timeout: 10000,
											headers: { "token": oldtoken },
											success: function(data, type, xhr) {
												if(data.errno == 0) {
													var dataobj = data.data.data
													if(dataobj.length != 0) {
														if(dataobj[i].avatar.indexOf("[") != -1) {
															dataobj[i].avatar = serverimgUrl + JSON.parse(dataobj[i].avatar)[0].picImg;
														}
														if(dataobj[i].pic.indexOf("http") == -1) {
															dataobj[i].pic = serverimgUrl + JSON.parse(dataobj[i].pic)[0].picImg;
														}
													}
													var recommendObj = {}
													recommendObj.myUrl = serverimgUrl;
													recommendObj.recommendData = dataobj
													document.getElementById("typeNews").innerHTML += template("typeNewTpl", recommendObj);
												}
												mui("#upload")[0].innerHTML = "";
												Spagenum++; //加载成功,当前页+1
												console.log('成功+1,实到' + Spagenum);
												console.log('成功+1,应到' + Spagenum);
											},
											error: function(xhr, type, errorThrown) {
												Ypagenum--; //失败是应到-1
												mui.toast("当前网络不好请重试");
												mui("#upload")[0].innerHTML = "";
											}
										});
									} else if(Spagenum == data.data.totalPages + 1) { //当前页不小于等于总页数时请求下一页
										mui("#upload")[0].innerHTML = "到底了";
									}
								}
							});
						} else {
							plus.nativeUI.closeWaiting();
							mui("#upload")[0].innerHTML = "";
						}
						plus.nativeUI.closeWaiting(); //关闭等待框 
						//发布者主页
						$(".findUser").click(function() {
							event.stopPropagation()
							openview({
								view: "centerPage.html",
								extrasobj: {
									userId: $(this).attr("data-userId")
								}
							})
						})
					},
					error: function(xhr, type, errorThrown) {
						plus.nativeUI.closeWaiting();
						mui("#upload")[0].innerHTML = "";
						console.log('响应失败  !');
					}

				})

			}
		})
	</script>

</html>