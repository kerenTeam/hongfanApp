<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>他人主页</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no"> 
		<!--<link rel="stylesheet" type="text/css" href="../css/common.css">-->
		<link rel="stylesheet" type="text/css" href="../css/index.css">
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<link rel="stylesheet" href="../css/reset.css">
		<link rel="stylesheet" href="../css/one.css">
		<link rel="stylesheet" type="text/css" href="../css/find.css" />
		<script type="text/javascript" src="../js/jquery.min.js"></script>
		<script src="../js/mui.min.js"></script>
		<script src="../js/app.js"></script>
		<!--引入模板引擎-->
		<script src="../js/artTemplate-native.js"></script>
		<style type="text/css">

		</style>
	</head>
	<style type="text/css">
	 
	 
		#imgUpload {
			display: none;
		}
		header{
			z-index: 99999;
		}
		#header>*{
			color: white;
			z-index: 9999; 
		} 
		#userBox{
				background-color: #F53C42;
				padding: 0px 0;
			    position: relative;
			    overflow: hidden;
		        max-height: 2.5rem; 
		}
		/*#beijing{position: absolute;z-index:10;width: 100%;height: 100%;top: 0;overflow: hidden; -webkit-filter: blur(5px);}*/
			#mypic1{width: 100%;margin-top: -20%;}
			#beijing2{position: absolute;z-index:1;width: 100%;height: 100%;top: 0;background-color: rgba(255, 0, 0, 0.5);} 
			 
			.userAvator{
				border: 2px solid white;
				position: absolute;
				left: 50%;
				width: 1rem; 
				bottom: 0.5rem;
				height: 1rem; 
				-webkit-transform: translateX(-50%);
				z-index: 9;
				border-radius: 50%;
			}
			.mainInfo{ 
				position: relative;
				padding: 16px 10px 16px 15px;
				display: flex;
				align-items: center;
				justify-content: space-between;
			} 
			 
			.mainInfo button{
				font-size: 0.12rem;
				padding: 4px 8px;
			}
			.follow{
				background-color: white;
				margin: 15px 0;
				margin-bottom:5px;
				text-align: center;
				display: flex;
				align-items: center;
				height: 60px;
				line-height: 1.5;
				justify-content: space-around;
			}
			.follow>div{
				flex-grow:1;
			}
			.fchidl b{
				font-weight: 100;
				font-size: .16rem;
			}
			.fchidl>div{
				color: darkgray;
			}
			.chidlL{
				border-right: 1px solid #EEEEEE;
			}
			 .cmlist{
			 	padding: 18px 15px 11px!important;
			 	background: white;
			 }
			 .ctime{
			 	margin-right: 15px;
			 }
		 .idhiji{
				position: absolute;
				text-align: center;
				bottom: 0.2rem;
				width: 100%;
				color: white;
				z-index: 1;
			}
		.tiename{color: #888;}	
		.ctime{margin-right: 15px;font-size: 12px;}
		.oaright{left: 0 !important;}
		.tiec, .ctime{margin-right: 0 !important;}
		.cmlist{padding: 18px 20px 20px 25px!important;background: white;}
		.noafter:after{height: 0 !important;}
		.cmlist:after{left: 25px !important;}
		.oaright p.tiec{padding: 5px !important;height: 0.6rem;overflow: hidden;background-color: rgba(242, 241, 238, 0.62);}  
		.oaright p.tiec span{display: -webkit-box;
			-webkit-box-orient: vertical;
			-webkit-line-clamp: 2;
			overflow: hidden;position: relative;top: -43px;padding-left: 0.75rem;color: #777;} 
		.tiec img{width: .7rem;}
		.noli{
			position: relative;overflow: hidden;
		}
		.noli:after, #dynamic li:after{
		    position: absolute;
		    right: 0;
		    bottom: 0;
		    left: 15px;
		    height: 1px;
		    content: '';
		    -webkit-transform: scaleY(.2);
		    transform: scaleY(.2);
		    background-color: #c8c7cc;
		}
		.fft b, .follow b{color: #555;}
		.follow>div{height: 100%;padding-top: 8px;}
	</style>

	<body style="display: none;">
		<header id="header" class="mui-bar mui-bar-transparent">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">xxxxxx</h1>
		</header>
		<script src="../js/statusBar.js"></script><!--状态栏-->
		<div id="wrapmain" >
		<div id="main">
			<div class="clearfloat box-s box-ss" id="userBox">
	    		<img id="mypic1" src="../img/morentouxiang.jpg"/>
	    		<div id="beijing2"></div> 
	    			<img src="../img/market/atcenter.jpg" class="userAvator"/>
	    			<!--<div class="idhiji">HI集 ID:55667788</div>-->
	    	</div>
	    	<div class="content">
	    		<div class="mainInfo">
	    			<h4><span id="nickname">扉页 </span> <img id="gender" src="../img/woman.svg" alt="" style="width: 0.15rem;"/></h4>
	    			<div>
	    				<button type="button" class="mui-btn mui-btn-warning mui-btn-outlined chat">
							私信
						</button> 
						<!--这里的注释删不得-->
						<!--//mui-btn-outlined 已关注--> 
						<!--//mui-btn-outlined eachF 互相关注-->
						<!--//eachF (是粉丝的)关注--> 
						<!--//  关注-->
						  <button id="followbtn" type="button" class="mui-btn mui-btn-success hadF  ">
							+关注
						</button> 
	    			</div>
	    		</div> 
	    	</div>
		</div>
		<div class="follow">
			<div class="fchidl chidlL aClick" id="follow">
				<b id="follownum">4</b>
				<div>关注</div>
			</div>
			<div class="fchidl aClick" id="followed">
				<b id="fennum">7</b>
				<div>粉丝</div>
			</div>
		</div>
	<p style="padding:0 10px 10px;"><small>TA的动态</small></p>
		<style type="text/css">
			#dynamic{background-color: #fff;}
			#spandiv{height: 40px;}
			#spandiv span{line-height: 40px;}
			#dynamic .spanL{float: left;color: #888;}
			#dynamic .spanR{float: right;color: #C0C0C0;}
			#dynamic li{margin-left: 25px;padding-right: 20px;position: relative;padding-bottom: 20px;}
			#dynamic li:after{left: 0;}
			#Dcon{padding: 8px;padding-left: 30%;background-color: rgba(242, 241, 238, 0.62);} 
			#Dcon:after{display: block;content: ' ';clear: both;}
			#Dcon .imgdiv{width: 34%;margin-left: -41%;float: left;height: 60px;max-height: 60px;overflow: hidden;}
			#Dcon .imgdiv img{width: 100%;}
			#Dcon p{padding-top: 5px;line-height:20px;display: -webkit-box;-webkit-box-orient: vertical;-webkit-line-clamp: 2;overflow: hidden;}
			#upload img{width: .35rem;}
		</style>
 		<ul id="dynamic">
			<!--<li class="">
				<div id="spandiv">
					<span id="" class="spanL">发了贴</span>
					<span id="" class="spanR">2017-09-08</span>
				</div>
				<div id="Dcon">
					<div class="imgdiv">
						<img src="../img/market/bsl.jpeg" alt="" />	
					</div>
					<p>哈哈哈哈哈哈哈哈哈哈哈哈哈哈<br/>哈哈哈哈哈哈哈哈哈哈哈哈哈哈<br/>哈哈哈哈哈哈哈哈哈哈哈哈哈哈</p>
				</div>
			</li>-->
		</ul>
			<script type="text/html" id="infolist">
				<% for(var i=0; i<list.length; i++){%>
				<li class="" onclick="findInfo()">
					<div id="spandiv">
						<span id="" class="spanL">发了贴</span>
						<span id="" class="spanR">
							<% if(list[i].create_time){%>
					    		<%= list[i].create_time.split('T')[0]%>
					    	<% }%>
						</span>
					</div>
					<div id="Dcon" class="aClick2">
						<div class="imgdiv">
							<% if(list[i].pic){%>
								<% if(list[i].pic.indexOf('http')>-1){%>
									<img src="<%= list[i].pic%>" alt="" onerror="this.src ='../img/zhaoxiangji.svg',this.style.height = '100%'"/>
								<% }else{%>
									<img src="<%= url + list[i].pic%>" alt="" onerror="this.src ='../img/zhaoxiangji.svg',this.style.height = '100%'"/>
								<% }%>	
							<% }%>		
						</div>
						<p><%= list[i].content%></p>
					</div>
				</li>
				<% }%>	
			</script>
			<div id="upload" style="padding-bottom: 20px;min-height: 50px;padding-top:10px;background-color: #fff;color: #999;text-align: center;"> 
			</div>
		</div>
	</body>
	<script type="text/javascript">
	//滚动监听
	$(window).scroll(function() { 
        var targetPercentage = 70; 
        var navBarHeight = 50; 
        var targetID = "#header"; 
        var scrollTo = $(window).scrollTop(), 
            docHeight = $(document).height(),
            windowHeight = $(window).height(); 
        if (scrollTo > navBarHeight) {
            $(targetID).css({
                "background-image": "url(../img/header.png)","background-size":"100%"
            });
        } 
        if (scrollTo < navBarHeight) {
            $(targetID).css({
                "background-image": "none"
            });
        } 
    }).trigger('scroll'); 
    //帖子 详情
    function findInfo(){
		openview({
			view: "find/findInfo.html",
			extrasobj: {
				userId: 1
			}
		})
	}
//数据处理
	var otherid;
	var Spagenum = 2;//实到页数
	var Ypagenum = 1;//应到页数
	mui.plusReady(function(){ 
		var oldtoken = plus.storage.getItem('oldToken');
		var myuserid = plus.storage.getItem('userid');
		otherid = plus.webview.currentWebview().idnum;
		plus.nativeUI.showWaiting();
		var loadnum = 0;
		//1.头像名字
		mui.ajax(serverUrl+'/api/useraccount/userinfo',{
			data:{"userid":otherid},
			type:'post',
			timeout:10000,
			headers:{"token":oldtoken},	              				
			success:function(data,type,xhr){
				console.log('获取用户数据返回', data);
				if(data.errno == 0){
					//显示头像
					if(data.data[0].avatar){
						mui('.userAvator')[0].src = serverimgUrl + JSON.parse(data.data[0].avatar)[0].picImg;
						var Avater = serverimgUrl + JSON.parse(data.data[0].avatar)[0].picImg;
					}
					
					//显示昵称
					if(data.data[0].nickname != ' '){ 
						if(data.data[0].nickname.indexOf('null') == -1){
							mui('#nickname')[0].innerHTML = mui('.mui-title')[0].innerHTML = data.data[0].nickname;
						}else{
							mui('#nickname')[0].innerHTML = data.data[0].phone;
						}
					}else{
						mui('.denluzhuce')[0].innerHTML = data.data[0].phone;
					}
					//显示性别
					if(data.data[0].gender == '男'){
						mui('#gender')[0].src = '../img/man.svg';
						mui('#beijing2')[0].style.backgroundColor = 'rgba(140, 159, 191, 0.67)';
					}else if(data.data[0].gender == '女'){
						mui('#gender')[0].src = '../img/woman.svg';
					}
					
					//私信
					 mui('.chat')[0].addEventListener('tap',function(){
					 	//我的请求头像  
						mui.ajax(serverUrl+'/api/useraccount/userinfo',{
							data:{"userid":myuserid},
							type:'post',
							timeout:10000,
							headers:{"token":oldtoken},	              				
							success:function(data,type,xhr){
								console.log('获取用户数据返回'+JSON.stringify(data));
								if(data.errno == 0){
									//显示头像
									
									if(data.data[0].avatar){
									    myAvatar =  serverimgUrl + JSON.parse(data.data[0].avatar)[0].picImg;
							            openview({
											view:'find/chat.html',
											extrasobj:{'fromUserId':otherid,'fromAvater':Avater,'myavatar':myAvatar}
										});
									} 
									
								}else{
									mui.toast('获取用户信息失败'); 
									console.log(data.errmsg);
								}
							},
							error:function(xhr,type,errorThrown){
								console.log('获取用户数据,响应失败');
							}
						});	 
						
					});
				}else{
					mui.toast('获取用户信息失败'); 
					console.log(data.errmsg); 
				}
				loadnum++;
			},
			error:function(xhr,type,errorThrown){
				loadnum++;
				mui.toast('获取用户信息响应失败');
				console.log('获取用户数据,响应失败');
			}
		});
		//2.显示我对他的关注状态
		mui.ajax(serverUrl+'/api/news/myfollow',{
			data:{"userid":myuserid},
			dataType:'json',
			type:'post',
			timeout:10000,
			headers:{"token":oldtoken},
			success:function(data,type,xhr){
				loadnum++;
				var followFlag = false;//我没关注他
				console.log('关注返回',data);
				if(data.errno==0){
					if (data.data.myFollow.length) {
						mui.each(data.data.myFollow,function (index,element) {//判断我是否关注他
							if (element.user_id == otherid) {//我关注了他
								mui('#followbtn')[0].className = 'mui-btn mui-btn-success hadF  mui-btn-outlined';
								mui('#followbtn')[0].innerHTML = '已关注';   
								followFlag = true;
								return false;  
							}
							if (index == data.data.myFollow.length -1) {//没关注他
								mui('#followbtn')[0].className = 'mui-btn mui-btn-success hadF  ';
								mui('#followbtn')[0].innerHTML = '+关注'; 
							}
						})
					}
					if(data.data.followMe.length){
						mui.each(data.data.followMe,function (index,element) {//判断他是否关注我
							if (element.user_id == otherid) {//他关注了我  
								if (followFlag) {
									mui('#followbtn')[0].className = 'mui-btn mui-btn-success hadF  mui-btn-outlined eachF';
									mui('#followbtn')[0].innerHTML = '互相关注';  
								} else{
									mui('#followbtn')[0].className = 'mui-btn mui-btn-success hadF  eachF';
									mui('#followbtn')[0].innerHTML = '+关注';
								}
								return false;
							}
						})
					}	
					//关注操作
					mui('#followbtn')[0].onclick = function(){
						followBack(this,otherid);
					}
				}
			},
			error:function(xhr,type,errorThrown){
				loadnum++;
			}
		});
		//3.显示他的关注·粉丝数量
		mui.ajax(serverUrl+'/api/news/myfollow',{
			data:{"userid":otherid},
			dataType:'json',
			type:'post',
			timeout:10000,
			headers:{"token":oldtoken},
			success:function(data,type,xhr){
				console.log('关注条数',data)
				if(data.errno==0){
					mui('#fennum')[0].innerHTML = data.data.followMe.length;
					mui('#follownum')[0].innerHTML = data.data.myFollow.length;
				}
				loadnum++;
			},
			error:function(xhr,type,errorThrown){
				loadnum++;
				mui.toast('当前网络不好，请重试！');
				console.log('登录响应失败');
			}
		});
		//4.他的动态
		mui.ajax(serverUrl+'/api/news/newslist',{ 									
			data:{currentPage:1,numsPerPage:10,userid:otherid,categoryid:'',isMyFriendPage:true}, 
			dataType:'json',//服务器返回json格式数据
			type:'post',//HTTP请求类型 
			timeout:10000,//超时时间设置为10秒；	
			headers:{"token":oldtoken}, 
			success:function(data){
				if(data.errno == 0){ 
					console.log('动态列表返回',data); 
					
					if(data.data.totalPages){
						var dataobj = {};
						mui.each(data.data.data,function (index,ele) {
							if(ele.pic.indexOf('picImg')>-1){
								ele.pic = JSON.parse(ele.pic)[0].picImg;
							}
						})
						dataobj.list = data.data.data;
						dataobj.url = serverimgUrl;
						
						//获取并渲染用户信息
						var html=template("infolist",dataobj);
						document.getElementById("dynamic").innerHTML += html;
					}else{
						mui("#upload")[0].innerHTML = "没有动态";
						mui("#upload")[0].style.paddingTop = mui("#upload")[0].style.paddingBottom = "30px";
					}
					
					//滚动到底部加载
					$(window).scroll(function(){
					　　var scrollTop = $(this).scrollTop();
					　　var scrollHeight = $(document).height();
					　　var windowHeight = $(this).height();
					　　if(scrollTop + windowHeight == scrollHeight){//滚动条到达可以加载
							if(Spagenum<=data.data.totalPages && Spagenum==Ypagenum+1){//当前页小于等于总页数时请求下一页
								mui("#upload")[0].innerHTML = "<img src='../img/balls.svg' />";
								Ypagenum++;//满足加载情况,应到页数+1
								console.log('发起请求,实到'+Spagenum+'页');									
								console.log('发起请求,应到'+Ypagenum+'页');
								mui.ajax(serverUrl+'//api/news/newslist',{ 	
									data:{currentPage:Spagenum,numsPerPage:10,userid:otherid,categoryid:'',isMyFriendPage:true}, 
									dataType:'json',//服务器返回json格式数据 
									type:'post',//HTTP请求类型 
									timeout:10000,//超时时间设置为10秒；	
									headers:{"token":oldtoken}, 
									success:function(data){
										console.log('下拉数据',data);
										if(data.errno == 0){
											var dataobj = {};
											mui.each(data.data.data,function (index,ele) {
												if(ele.pic.indexOf('picImg')>-1){
													ele.pic = JSON.parse(ele.pic)[0].picImg;
												}
											})
											dataobj.list = data.data.data; 
											dataobj.url = serverimgUrl;
											//获取并渲染用户信息
											var html=template("infolist",dataobj);
											document.getElementById("dynamic").innerHTML += html;
										}
										mui("#upload")[0].innerHTML = ""; 
										Spagenum++;//加载成功,当前页+1
										console.log('成功+1,实到'+Spagenum);
										console.log('成功+1,应到'+Spagenum);
									},
									error:function(xhr,type,errorThrown){
										Ypagenum--;//失败是应到-1
										mui.toast("当前网络不好请重试");
										mui("#upload")[0].innerHTML = ""; 
									}
								});
							}else if(Spagenum == data.data.totalPages+1){//当前页不小于等于总页数时请求下一页
								mui("#upload")[0].innerHTML = "没有更多了"; 
							}
					　　  }
					});//加载下一部分结束
				}else{
					mui("#upload")[0].innerHTML = ""; 
				}
				loadnum++;
			},
			error:function(xhr,type,errorThrown){
				loadnum++;
				mui("#upload")[0].innerHTML = ""; 
			}
		});
		
		//关遮罩
		var time1 = setInterval(function(){ 
			if(loadnum == 4){
				var time2 = setTimeout(function(){
					plus.nativeUI.closeWaiting();
				},300)
		  		mui('body')[0].style.display = 'block';
		  		clearInterval(time1);
			}
		},100)
	})
    // 粉丝 
    $("#followed").on("tap",function(){
    	openview({
			view:'find/followed.html',
			create:true,
			id:'followed',
			extrasobj:{idnum:otherid,type:'other'}
		});
    })
    //关注
    $("#follow").on("tap",function(){
    	openview({
			view:'find/follow.html',
			create:true,
			id:'follow',
			extrasobj:{idnum:otherid,type:'other'}
		});
    })
		

	
	</script>

</html>