<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>机票列表</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" href="../../css/reset.css">
		<script type="text/javascript" src="../../js/mui.min.js"></script>
		<script src="../../js/app.js" type="text/javascript" ></script>
		<script src="../../js/artTemplate-native.js" type="text/javascript" ></script>
		<link href="../../css/calendar.css" rel="stylesheet" />
		<script src="../../js/calendar.js" type="text/javascript" charset="utf-8"></script>
		<style type="text/css">
			.mui-bar{
				height: 50px;
				box-shadow: none;
			}
			.mui-title,.mui-icon{
				line-height: 50px;
			}
			.mui-bar .mui-icon{
				padding: 0;
			}
			
			/*这一页*/
			.grade-eject, .Category-eject, .Sort-eject{
				height: 164px;
			}
			div.screening>ul>li{
				border-left: 1px solid #eee !important;
			}
			dl.list dt, dl.list dd{
				border-bottom: 1px solid #eee;
				background-color: #fff;
				margin-bottom: 4%;
				box-shadow: 0px 0px 6px #ccc;
				margin: 10px;
			}
			.guess-like,dl.list{
				border-bottom: 1px solid #eee;
				background-color: #EFEFF4;
			}
			.right{
				text-align: right;
			}
			.middle{
				text-align: center;
			}
			.strong-color{
				color: #f53c42 !important;
			}
			.Lgray{
				font-size: 12px !important;
				color: #999 !important;
				margin-top: 14px;
			}
			.mui-badge-blue, .mui-badge-primary{
				background-color: #fff;
				border: 1px solid #999;
				color: #999 !important;
			}
			
			.moreone{
				line-height: 50px;
			}
			dl.list .db>.react{
				padding: 0;
				margin: 0;
			}
			dl.list .db{
				height: 50px;
			}
			.grade-eject>ul>li, .Category-eject>ul>li, .Sort-eject>ul>li{
				line-height: 40px;
			}
			
			/*这一页*/
			.timeBox{
				position: relative;
			}
			.timeBox p{
				font-size: 24px;
				color: #333;
				line-height: 22px;
			}
			.timeBox .ad{
				font-size: 12px;
				color: #999;
				font-weight: normal;
				line-height: 24px;
			}
			.timeBox .bage{
				position: absolute;
				font-size: 12px;
				line-height: 10px;
				right: 15px;
				top: 10px;
				color: #666;
			}
			.price{
				text-align: right;
				font-size: 24px;
				line-height: 30px;
				color: #f53c42;
			}
			.airTip p{
				text-align: right;
				line-height: 24px;
				font-size: 12px !important;
			}
			.Achange {
				color: #333;
			}
			.Achange span{
				color: #ff5601;
				font-size: 14px !important;
			}
			.inputWrap{
				border: none;
				border-radius: 3px;
				color: #666;
				line-height: 50px;
				background-color: rgba(255,255,255,0.8);
				margin: 10px 0;
			}
			.ad img{
				width: 15%;
				margin-top: -3px;
			}
			.dot{
				background-color: #bfbfbf;
				width: 5px;
				height: 5px;
				padding: 4px;
				margin: 0 5px;
				border-radius: 50%;
				display: inline-block;
			}
			.line{
				width: 3px;
				height: 10px;
				position: absolute;
				left: 8px;
				top: 35px;
				background-color: #ddd;
			}
			/*这一页*/
			.timeBox{
				position: relative;
			}
			.timeBox p{
				font-size: 24px;
				color: #333;
				line-height: 22px;
			}
			.timeBox .ad{
				font-size: 12px;
				color: #999;
				font-weight: normal;
				line-height: 20px;
			}
			.timeBox .bage{
				position: absolute;
				font-size: 12px;
				line-height: 10px;
				right: 15px;
				top: 10px;
				color: #666;
			}
			.price{
				text-align: right;
				font-size: 24px;
				line-height: 30px;
				color: #f53c42;
			}
			.airTip p{
				text-align: right;
				line-height: 24px;
				font-size: 12px !important;
			}
			.Achange {
				color: #333;
			}
			.Achange span{
				color: #ff5601;
				font-size: 14px !important;
			}
			.order-bottom{
				background-color: #f7f7f7;
				border-top: 1px solid #f7f7f7;
				text-align: right;
				height: 40px;
				line-height: 40px;
			}
			.order-bottom p{
				font-size: 12px;
				line-height: 40px !important;
			}
			.inputWrap{
				border: none;
				border-radius: 3px;
				color: #666;
				line-height: 50px;
				background-color: rgba(255,255,255,0.8);
				margin: 10px 0;
			}
			.head{
				background-color: #dcd5d5;
			    position: fixed;
			    top: 50px;
			    left: 0;
			    z-index: 100;
			}
			.hLeft{
				text-align: right;
				padding: 5px 20px 5px 10px;
			}
			.hLeft span{
				display: inline-block;
				float: left;
				font-size: 16px;
				line-height: 40px;
			}
			.hMiddle{
				text-align: center;
			}
			.hRight{
				text-align: left;
				padding: 5px 10px 5px 20px;
			}
			.hRight span{
				display: inline-block;
				float: right;
				font-size: 16px;
				line-height: 40px;
			}
			.iconWrap{
				position: relative;
			}
			.iconWrap input{
				border: none;
				width: 100%;
				margin: 5px 0;
				font-size: 16px;
				/*text-indent: 20px;*/
				text-align: center;
			}
			.cIcon{
				position: absolute;
				top: 12px;
				right: 4%;
				width: 12%;
			}
			.guess-like{
				padding-top: 0;
			}
			div.screening>ul{
				border-bottom: none;
			}
			/*header样式*/
			/*.mui-bar-nav {
				background-color: #FFF !important;
			}
			.hasManyCitytwo .header-tit{
				color: #333;
			}
			.hasManyCitytwo .fanhui{
				color: #333;
			}*/
			div.screening{
				border-top: 1px solid #EFEFF4;
			}
			.hasManyCitytwo .header-tit{
				left: 39% !important;
			}
		</style>
	</head>
	<body>
		<header id="header" class="mui-bar mui-bar-nav hasManyCity hasManyCitytwo">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize fl fanhui"></a>
		    <div class="header-tit" id="headstate"></div> 
		</header>
		<div class="head" id="head" style="top: 50px;width: 100%;">
			<div class="mui-row">
			    <div class="mui-col-sm-3 mui-col-xs-3 hLeft">
					<div class="timeBox">
						<span class="mui-icon mui-icon-arrowleft"></span>
						<p class="ad black" id="frontday" style="font-size:14px;line-height: 40px;position: relative;top: 1px;">前一天</p>
						<!--<p class="ad black">￥360</p>-->
					</div>
		       	</div>
		        <div class="mui-col-sm-6 mui-col-xs-6 hMiddle">
		        	<div class="timeBox iconWrap">
			        	<input type="text" class="calendars2" readonly="readonly"  value=""><br>
			        	<!--<img src="../../img/tickets/calender.png"/ class="cIcon">-->
					</div>
		        </div>
		         <div class="mui-col-sm-3 mui-col-xs-3 hRight">
					<div class="timeBox">
						<span class="mui-icon mui-icon-arrowright"></span>
						<p class="ad black" id="backday" style="font-size:14px;line-height: 40px;position: relative;top: 1px;">后一天</p>
						<!--<p class="ad black">￥390</p>-->
					</div>
		       	</div>
			</div>
		</div>
		<!--这是单独加模拟状态栏的方法-->
		<div id="sBar" style="background-color: #f53c42;position: fixed;width:100%;top: 0;z-index: 9999"></div>
		<script type="text/javascript">
			var immersed = 0;
			var ms=(/Html5Plus\/.+\s\(.*(Immersed\/(\d+\.?\d*).*)\)/gi).exec(navigator.userAgent);
			if(ms&&ms.length>=3){ // 当前环境为沉浸式状态栏模式
			    immersed=parseFloat(ms[2]);// 获取状态栏的高度
			}
			var statusBar = document.getElementById('sBar');//这是模拟状态栏
			var headdiv = document.getElementById('header');//这是现有的header
			var headdiv2 = document.getElementById('head');//这是现有的head
			document.body.style.paddingTop =  immersed+'px';
			statusBar&&(statusBar.style.height = immersed+'px');
			headdiv&&(headdiv.style.top = immersed+'px');
			headdiv2&&(headdiv2.style.top = parseInt(headdiv2.style.top) + immersed+'px');
		</script>
		<div class="screening" style="display: none;">
		    <ul>
		        <li class="Brand">时间排序</li>
		        <li class="Regional">车型</li>
		        <li class="Sort">筛选</li>
		    </ul>
		</div>
		<div class="Category-eject">
		    <ul class="Category-w" id="Categorytw">
		        <li>最早发车</li>
		        <li>最晚发车</li>
		    </ul>
		</div>
		<div class="grade-eject">
		    <ul class="grade-w" id="gradew">
		        <li>全部车型</li>
		        <li>高铁动车（G/D/C）</li>
		        <li>特快直达（T/Z）</li>
		        <li>其他车型</li>
		    </ul>
		</div>
		<div class="Sort-eject Sort-height">
		    <ul class="Sort-Sort" id="Sort-Sort">
		        <li>不限</li>
		        <li>硬座</li>
		        <li>硬卧</li>
		        <li>软卧</li>
		        <li>二等座</li>
		        <li>一等座</li>
		        <li>其他</li>
		    </ul>
		</div>	
		<div id="main" style="padding-top: 2px;margin-top: 100px;">
			<div class="guess-like">
				<dl class="list" id="goodsList"></dl>
				<script type="text/html" id="infolist">
					<% for(var i=0; i<list.length; i++){%>
						<% if(list[i].hide != 'hide'){%>
							<dd class="goodsItem" name='<%= list[i].hide%>' onclick="goTrain(<%= list[i].details%>)">
								<a class="react mui-row">
									<div class="mui-col-sm-4 mui-col-xs-4">
										<div class="timeBox">
											<p class="ad black"><%= list[i].trainNumber%></p>
											<p><%= list[i].startTime%> </p>
											<p class="ad"><%= list[i].endTime%>次日</p>
										</div>
							       </div>
							        <div class="mui-col-sm-4 mui-col-xs-4">
							        	<div class="timeBox">
											<p class="ad black"><img src="../../img/tickets/time.png"/><%= list[i].runTime%></p>
											<p class="ad black"><span class="dot"></span><%= list[i].currentStartStationName%></p>
											<div class="line"></div>
											<p class="ad black"><span class="dot"></span><%= list[i].currentEndStationName%></p>
											
										</div>
							        </div>
							        <div class="mui-col-sm-4 mui-col-xs-4 airTip">
							        	<% if(list[i].Yprice>0){%>
							        		<p><span class="price"><sub>￥</sub><%= list[i].Yprice%></span></p>
							        	<% }else{%>
							        		<p><span style="color: #999;" class="price"><sub>￥</sub><%= list[i].Yprice%></span></p>
							        	<% }%>	
							        	
							        	<p class="Achange"><%= list[i].Yname%></p>
							        	<p><%= list[i].Ynum%>张</p>
							        </div>
								</a>
							</dd>
						<% }%>	
							
						
					<%}%>	
				</script>	
			</div>
			<div id="nulldiv" style="text-align:center;margin-top: 40%;font-size: 14px;color: #999;display: none;">
				<img style="width: 30%;margin-bottom: 5%; " src="../../img/unllfabu.svg"/>
				<br />
				没有相关信息
			</div>
		</div>
	</body>
	<script type="text/javascript">
		window.goTrain = function(details){
			mui.plusReady(function(){
				var time = plus.webview.currentWebview().time;
				openview({  
					view:'trainDetail.html',
					extrasobj:{details:details,timeattr:time}
				})
			})
			
		}
	</script>
	<!--数据渲染-->
	<script type="text/javascript">
		//事件转化	
		 function formatSeconds(value) {
            var theTime = parseInt(value);// 秒
            var theTime1 = 0;// 分
            var theTime2 = 0;// 小时
            if(theTime > 60) {
                theTime1 = parseInt(theTime/60);
                theTime = parseInt(theTime%60);
                if(theTime1 > 60) {
                    theTime2 = parseInt(theTime1/60);
                    theTime1 = parseInt(theTime1%60);
                }
            }
//          var result = ""+parseInt(theTime)+"秒";
            var result = "";
            if(theTime1 > 0) {
                result = ""+parseInt(theTime1)+"分"+result;
            }
            if(theTime2 > 0) {
                result = ""+parseInt(theTime2)+"小时"+result;
            }
            return result;
        }
		mui.plusReady(function(){
			
			var from = plus.webview.currentWebview().from;
			var arrive = plus.webview.currentWebview().arrive;
			var time = plus.webview.currentWebview().time;
			mui('.calendars2')[0].value = time;
			var oldToken = plus.storage.getItem('oldToken');
			mui('#headstate')[0].innerHTML = from + ' - ' + arrive;
			loadfun(time);//初始化加载方法
			//前一天
			mui('#frontday')[0].onclick = function(){
				aroundfun('front');
			}
			//后一天
			mui('#backday')[0].onclick = function(){
				aroundfun('back');
			}
			
			function aroundfun(type){
				var nowdate = mui('.calendars2')[0].value; 
				var date = new Date(nowdate);
				if(type == 'front'){
					date.setDate(date.getDate() - 1);
				}else if(type == 'back'){
					date.setDate(date.getDate() + 1);
				}
				var endmonth,endday,timestr = date.toLocaleDateString();
				if(timestr.split('/')[1].length == 1){
					endmonth = '0' + timestr.split('/')[1];
				}else{
					endmonth = timestr.split('/')[1];
				}
				if(timestr.split('/')[2].length == 1){
					endday = '0' + timestr.split('/')[2];
				}else{
					endday = timestr.split('/')[2];
				}
				var time2 = timestr.split('/')[0] +'-'+ endmonth +'-'+ endday;
				mui('.calendars2')[0].value = time2;
				loadfun(time2);
			}
			function loadfun(time1){
				plus.nativeUI.showWaiting('加载中 ...',{width:'100px',height:'80px'});
				document.getElementById("goodsList").innerHTML = '';
				mui('#nulldiv')[0].style.display = 'none';
				mui.ajax(serverUrl+'/api/qianmi/trainlineslist',{
					data:{"from":from,"date":time1,'to':arrive},
					type:'post',
					timeout:10000,
					headers:{"token":oldToken},	              				
					success:function(data,type,xhr){
						console.log('火车列表返回',data);
						console.log('火车列表返回'+JSON.stringify(data));
						if(data.errno == 0){
							var Tlist;
							if(data.data.trainlines_list_response.trainlines && data.data.trainlines_list_response.trainlines != undefined){
								Tlist = data.data.trainlines_list_response.trainlines.trainline;//信息条数
								if(Tlist.length || Tlist != null){ 
									var dataobj = {};
									for(var i=0;i<Tlist.length;i++){ 
										//保存详情数据
										Tlist[i].details = JSON.stringify(Tlist[i]);
										//时间格式调整
										Tlist[i].runTime = formatSeconds(Tlist[i].runTime);
										//优先 硬座(5),其次 硬卧(7), 软卧(8) , 高级软卧,  二等座(0) , 一等座(1), 无座(4) , 商务座(3),
										var ridetype = Tlist[i].trainSeats.trainSeat;
										if(ridetype != null){
											console.log('测试',Tlist[i])
											for(var j=0;j<ridetype.length;j++){
												var funchange = function(){//更改数据代码块
													Tlist[i].Yprice = ridetype[j].seatPrice;
													Tlist[i].Yname = ridetype[j].seatName;
													if(ridetype[j].remainderTrainTickets>100){
														Tlist[i].Ynum = 100;
													}else{
														Tlist[i].Ynum = ridetype[j].remainderTrainTickets;
													}
												}
												if(ridetype[j].seatId==5 && ridetype[j].remainderTrainTickets>0){
													funchange();
													break;
												}
												if(ridetype[j].seatId==7 && ridetype[j].remainderTrainTickets>0){
													funchange();
													break;
												}
												if(ridetype[j].seatId==8 && ridetype[j].remainderTrainTickets>0){
													funchange();
													break;
												}
												if(ridetype[j].seatId==0 && ridetype[j].remainderTrainTickets>0){
													funchange(); 
													break;
												}
												if(ridetype[j].seatId==1 && ridetype[j].remainderTrainTickets>0){
													funchange();
													break;
												}
												if(ridetype[j].seatId==4 && ridetype[j].remainderTrainTickets>0){
													funchange();
													break;
												}
												if(ridetype[j].seatId==3 && ridetype[j].remainderTrainTickets>0){
													funchange(); 
													break;
												}
												if(ridetype[j].seatId==2 && ridetype[j].remainderTrainTickets>0){
													funchange(); 
													break;
												}
												if(ridetype[j].seatId==6 && ridetype[j].remainderTrainTickets>0){
													funchange(); 
													break;
												}else{
													Tlist[i].Yprice = 0;
													Tlist[i].Yname = '没有票';
													Tlist[i].Ynum = 0; 
												}
											} 
										}else{
											console.log('Tlist',Tlist);
											Tlist[i].hide = 'hide';
										}
									}
									
									dataobj.list = Tlist; 
									//获取并渲染用户信息
									var html=template("infolist",dataobj);
									document.getElementById("goodsList").innerHTML = html;
									
								}else{
									
								}
							}else{
								mui('#nulldiv')[0].style.display = 'block';
							}
						}else{
							mui.toast('获取信息失败'); 
							mui('#nulldiv')[0].style.display = 'block';
						}
						plus.nativeUI.closeWaiting();
					},
					error:function(xhr,type,errorThrown){
						plus.nativeUI.closeWaiting();
						mui.toast('获取信息失败'); 
						mui('#nulldiv')[0].style.display = 'block';
					}
				});
			}	
		})
	</script>
</html>