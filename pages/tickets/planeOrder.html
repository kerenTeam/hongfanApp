<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>机票订单</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" href="../../css/reset.css">
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script type="text/javascript" src="../../js/mui.min.js"></script>
		<!--<script type="text/javascript" src="../../js/jquery.flexslider-min.js"></script>-->
		<!--<script src=" ../../js/hmt.js" type="text/javascript"></script>-->
		<!--<script src="../../js/other.js" type="text/javascript" charset="utf-8"></script>-->
		<script src="../../js/app.js" type="text/javascript" ></script>
		<!--引入模板引擎-->
		<script src="../../js/artTemplate-native.js" type="text/javascript" ></script>
		<style type="text/css">
			*{
				font-family: "微软雅黑";
			}
			.mui-bar{
				height: 50px;
				box-shadow: none;
			}
			.mui-title,.mui-icon{
				line-height: 50px;
			}
			.mui-bar .mui-icon{
				padding: 0;
			}
			#main{
				margin-top: 50px;
				/*padding-bottom: 60px !important;*/
			}
			
			.guess-like,dl.list{
				border-bottom: 1px solid #eee;
				background-color: #EFEFF4;
			}
			.right{
				text-align: right;
			}
			.middle{
				text-align: center;
			}
			.strong-color{
				color: #f53c42 !important;
			}
			.Lgray{
				font-size: 12px !important;
				color: #999 !important;
				margin-top: 14px;
			}
			.mui-badge-blue, .mui-badge-primary{
				background-color: #fff;
				border: 1px solid #999;
				color: #999 !important;
			}
			
			.moreone{
				line-height: 50px;
			}
			dl.list .db>.react{
				padding: 0;
				margin: 0;
			}
			dl.list .db{
				height: 50px;
			}
			.grade-eject>ul>li, .Category-eject>ul>li, .Sort-eject>ul>li{
				line-height: 40px;
			}
			
			/*这一页*/
			.timeBox{
				position: relative;
			}
			.timeBox p{
				font-size: 24px;
				color: #333;
				line-height: 22px;
			}
			.timeBox .ad{
				font-size: 12px;
				color: #999;
				font-weight: normal;
				line-height: 24px;
			}
			.timeBox .bage{
				position: absolute;
				font-size: 12px;
				line-height: 10px;
				right: 15px;
				top: 10px;
				color: #666;
			}
			.price{
				text-align: right;
				font-size: 24px;
				color: #f53c42;
			}
			.guess-like{
				padding-top:50px;
			}
			.react >div{
				line-height: 40px !important;
			}
			.airTip button{
				margin-left: 15px !important;
				background-color: #f53c42;
				color: #fff;
				border: none;
			}
			dl.list {
				border-top: none;
				margin-bottom: 10px; 
			}
			.react{
				padding: 0 .15rem !important;
			}
			dl.list dt, dl.list dd{
				background-color: #fff;
			}
			.lineL{
				border-left: 1px solid #DDD8CE;
			}
			.phone{
				border: none;
			}
			.title{
				font-size:16px;
				font-weight: bold;
			}
			.tiny{
				font-size: 12px;
				line-height: 14px;
				margin-top: -5px;
				margin-bottom: 10px;
			}
			.bo{
				color: #ffc900;
			}
			.addMan{
				background-color: #ffc900;
				border: none;
				color: #fff;
				margin-top: 10%;
				line-height: 24px;
				font-size: 15px;
				margin-left: 15%;
			}
			dl.list dt, dl.list dd{
				border-bottom: 1px solid #EFEFF4;
			}
			.delete{
				width: 60%;
				margin-top: 20px;
			}
			/*header样式*/
			/*.mui-bar-nav {
				background-color: #FFF !important;
				border-bottom: 1px solid #EFEFF4;
			}
			.hasManyCitytwo .header-tit{
				color: #333;
			}
			.hasManyCitytwo .fanhui{
				color: #333;
			}*/
			.footerone .left{
				width: 60%;
			}
			.footerone p{
				text-align: left;
				font-size: 16px;
				text-indent: 15px;
				line-height: .5rem;
			}
			.red1{
				color: #f53c42;
			}
			.footerone .right{
				width: 40%;
			}
			.footerone .right .btn {
				 width: 100%; 
			}
			.gray{
				color: #999;
			}
			small{
				line-height: 12px !important;
				color: #666 !important;
			}
			input[type=text]{
				border: none;
				margin-bottom: 0;
				padding: 0;
				font-size: 14px;
			}
			.hLeft{
				text-align: right;
			}
			.hMiddle{
				text-align: center;
			}
			.hRight{
				text-align: left;
			}
			.head{
				background-color: #dcd5d5;
				margin-top: 50px !important;
				padding: 20px 0;
			}
			.toLine{
				width: 60%;
				height: 1px;
				margin: 10px 20%;
				background-color: #000;
			}
			dl.list{
				margin-top: 0;
			}
			.last{
				margin: 10px 15px;
				padding-bottom: 60px;
			}
			.last p{
				line-height: 20px;
			}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
		    <h1 class="mui-title">机票订单</h1>  
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div id="main">
			<div class="head">
				<div class="mui-row">
				    <div class="mui-col-sm-4 mui-col-xs-4 hLeft">
						<div class="timeBox">
							<p class="ad black"><span id="orgCityName"></p>
							<p><span id="depTime"></p>
							<p class="ad black"><span id="orgCityName2"></p>
						</div>
			       	</div>
			        <div class="mui-col-sm-4 mui-col-xs-4 hMiddle">
			        	<div class="timeBox">
							<p class="ad black"><span id="flightNo" style="font-size: 10px;"></p>
							<div class="toLine"></div>
							<p class="ad black"><span id="flightCompanyName" style="margin-top: 10px;font-size: 10px;"></span></p>
						</div>
			        </div>
			         <div class="mui-col-sm-4 mui-col-xs-4 hRight">
						<div class="timeBox">
							<p class="ad black"><span id="dstCityName"></p>
							<p><span id="arriTime"></p>
							<p class="ad black"><span id="dstCityName2"></p>
						</div>
			       	</div>
				</div>
			</div>
			<dl class="list" id="goodsList">
				<dd class="goodsItem" id="order1">
					<a class="react mui-row">
						<div class="mui-col-sm-12 mui-col-xs-12">
							<p class="black title"><span id="fromTime"></span>&nbsp;<span id="weekday"></span>&nbsp;<span id="depTime"></span>&nbsp;<span id="seatMsg"></span> </p>
				       </div>
					</a>
				</dd>
				<dd class="goodsItem" id="order2">
					<a class="react mui-row">
						<div class="mui-col-sm-6 mui-col-xs-6">
							<p class="black">成人票&nbsp;￥<span id="settlePrice"></span></p>
				       	</div>
				        <div class="mui-col-sm-6 mui-col-xs-6">
				        	<p class="black">基建燃油&nbsp;￥<span id="adultAirportTax"></span>+￥<span id="adultFuelTax"></span></p>
				        </div>
					</a>
				</dd>
			</dl>
			<dl class="list" id="goodsList">
				<dd class="goodsItem">
					<a class="react mui-row">
						<div class="mui-col-sm-8 mui-col-xs-8">
							<p class="black">添加/修改乘机人 </p>
							<p class="tiny">请确保姓名证件填写正确</p>
				       </div>
				        <div class="mui-col-sm-4 mui-col-xs-4">
				        	<button class="addMan" onclick="addPerson()">添加乘机人</button>
				        </div>
					</a>
				</dd>
					<!--<dd class="goodsItem persons">
						<a class="react mui-row aPerson">
							<div class="mui-col-sm-2 mui-col-xs-2">
								<img src="../../img/tickets/delete.png" class="delete" onclick="deletePerson(this)"/>
							</div><div class="mui-col-sm-10 mui-col-xs-10">
								<p class="black nameM">名字1</p>
								<p class="tiny black">身份证&nbsp;<span class="idM">身份证1</span></p>
								<p class="tiny black">手机号&nbsp;<span class="phoneM">手机号1</span></p>
							</div>
						</a>
					</dd>-->
				<dd class="goodsItem persons">
					<!--添加联系人位置-->
				</dd>
			</dl>
			<dl class="list" id="goodsList">
				<dd class="goodsItem">
					<a class="react mui-row">
						<div class="mui-col-sm-3 mui-col-xs-3">
							<p class="black">联系人 </p>
				       </div>
				        <div class="mui-col-sm-9 mui-col-xs-9">
				        	<input type="text" name="" id="contactPerson" value="" class="phone" placeholder="联系人姓名"/>
				        </div>
					</a>
				</dd>
				<dd class="goodsItem">
					<a class="react mui-row">
						<div class="mui-col-sm-3 mui-col-xs-3">
							<p class="black">手机号码 </p>
				       	</div>
				        <div class="mui-col-sm-9 mui-col-xs-9">
				        	<input type="text" name="" id="contactPhone" value="" class="phone" placeholder="用于接收短信(必填)" style="font-family: '微软雅黑';"/>
				        </div>
					</a>
				</dd>
			</dl>
			<dl class="list LastList" id="goodsList">
				<dd class="goodsItem">
					<a class="react mui-row">
						<div class="mui-col-sm-3 mui-col-xs-3">
							<p>改签规则</p>
				       </div>
				        <div class="mui-col-sm-9 mui-col-xs-9">
				        	<p id="changeStipulate" style="line-height: 20px;font-size: 12px;margin: 10px 0;"></p>
				        </div>
					</a>
				</dd>
				<dd class="goodsItem">
					<a class="react mui-row">
						<div class="mui-col-sm-3 mui-col-xs-3">
							<p>退票规则</p>
				       	</div>
				        <div class="mui-col-sm-9 mui-col-xs-9">
				        	<p id="refundStipulate" style="line-height: 20px;font-size: 12px;margin: 10px 0;"></p>
				        </div>
					</a>
				</dd>
			</dl>
		</div>
		<dl class="list last">
			<p><span class="red1">*</span>购票须知</p>
			<p>1.机票相关业务处理时间为8:00-22:00。</p>
			<p>2.机票业务不做改签处理</p>
			<p>3.机票支持在线申请退废票和自愿退票，非自愿退票请根据平台规则联系客服处理。</p>
			<p>4.出票当日提交"退废票"，具体以航司规定为准。</p>
			<p>5.请仔细核对用户身份证号以及姓名，以免造成不必要的损失。</p>
			<p>6.行程单(报销凭证)机场提供打印服务。</p>
			<p>7.目前不支持飞机票保险货源。</p>
		</dl>
		<!--footerone star-->
		<div class="footerone clearfloat">
			<div class="left">
				<p class="red1"><sub>￥</sub><span id="subPrice"></span><sub class="gray">（共<span id="subPerson">1</span>人）</sub></p>
			</div>
			<div class="right ">
                <a onClick="goBuy()" class="btn btnone fl">立即购买</a>
			</div>
		</div>
		<!--footerone end-->
	</body>
	<script type="text/javascript">
		window.addPerson = function(){
			openview({ 
				view:'planeAddPerson.html'
			})
		}
	</script>
	<!--数据渲染-->
	<script type="text/javascript">
		var settlePrice,passagers;
		mui.plusReady(function(){
			var oldToken = plus.storage.getItem('oldToken');
			var userid = plus.storage.getItem('userid');
			var passagers = [];
			//从机票详情获取的数据
			var flightNo = plus.webview.currentWebview().flightNo;
			var fromPlace = plus.webview.currentWebview().fromPlace;
			var arrivePlace = plus.webview.currentWebview().arrivePlace;
			var fromTime = plus.webview.currentWebview().fromTime;
			var itemId = plus.webview.currentWebview().itemId;
			var seatCode = plus.webview.currentWebview().seatCode;//舱位编码
			var seatMsg = plus.webview.currentWebview().seatMsg;//舱位信息
			var flightCompanyCode = plus.webview.currentWebview().flightCompanyCode;//航空公司编码
			settlePrice = plus.webview.currentWebview().settlePrice;//价格
			var changeStipulate = plus.webview.currentWebview().changeStipulate;//改签规则
			var refundStipulate = plus.webview.currentWebview().refundStipulate;//退票规则
			var adultAirportTax = plus.webview.currentWebview().adultAirportTax;//基建费
			var adultFuelTax = plus.webview.currentWebview().adultFuelTax//燃油费
			var depTime = plus.webview.currentWebview().depTime//起飞时间
			var arriTime = plus.webview.currentWebview().arriTime//降落时间
			var orgCityName = plus.webview.currentWebview().orgCityName//起飞地点
			var dstCityName = plus.webview.currentWebview().dstCityName//降落地点
			var flightCompanyName = plus.webview.currentWebview().flightCompanyName//航空公司名字
			mui('#flightNo')[0].innerHTML = flightNo;				
			mui('#seatMsg')[0].innerHTML = seatMsg;				
			mui('#fromTime')[0].innerHTML = fromTime;	
			//修改星期日期时间
			var dateTime = fromTime.replace(/\-/g,'/');//将获取的日期如2017-01-01改为2017/01/01
			var date = new Date(dateTime).getDay();//获取具体周几
			var weekday=new Array(7);
				weekday[1]="周一";
				weekday[2]="周二";
				weekday[3]="周三";
				weekday[4]="周四";
				weekday[5]="周五";
				weekday[6]="周六";
				weekday[7]="周日";
			document.getElementById('weekday').innerHTML = weekday[date];
			//修改星期日期时间结束
			mui('#flightCompanyName')[0].innerHTML = flightCompanyName;//航空公司名字
			mui('#adultAirportTax')[0].innerHTML = adultAirportTax;//机场建设价
			mui('#adultFuelTax')[0].innerHTML = adultFuelTax;//燃油价
			mui('#depTime')[0].innerHTML = depTime;			
			mui('#arriTime')[0].innerHTML = arriTime;			
			mui('#orgCityName2')[0].innerHTML = orgCityName.replace("航站楼:","");	
			mui('#orgCityName')[0].innerHTML = orgCityName.split('(')[0];	
			mui('#dstCityName2')[0].innerHTML = dstCityName.replace("航站楼:","");	
			mui('#dstCityName')[0].innerHTML = dstCityName.split('(')[0];	
			mui('#adultFuelTax')[0].innerHTML = adultFuelTax;				
			mui('#adultAirportTax')[0].innerHTML = adultAirportTax;
			//总价计算
			var acountP = mui('.aPerson').length;
//			alert(adultFuelTax+adultAirportTax+parseFloat(settlePrice));
			if(acountP==0){
				$('#subPerson').html(0);
				mui('#subPrice')[0].innerHTML = 0.00;//总票价
				mui('#subPerson')[0].innerHTML = 0;//总人数
			}else{
				mui('#subPrice')[0].innerHTML = parseFloat(settlePrice) +adultAirportTax+adultFuelTax;//总票价
				
			}
			mui('#settlePrice')[0].innerHTML = settlePrice;//票价
			settlePrice = adultFuelTax+adultAirportTax+parseFloat(settlePrice);
			settlePrice = settlePrice.toFixed(2);
			mui('#changeStipulate')[0].innerHTML = changeStipulate;			
			mui('#refundStipulate')[0].innerHTML = refundStipulate;	
			
			//从添加乘机人获取的详情
			document.addEventListener('refreshPerson', function(obj) {
				var newName = obj.detail.newName;
				var idNo = obj.detail.idNo;
				var idPhone = obj.detail.idPhone;
				var persons = mui('.persons')[0];
				persons.insertAdjacentHTML('beforebegin', '<dd class="goodsItem persons"><a class="react mui-row aPerson"><div class="mui-col-sm-2 mui-col-xs-2"><img src="../../img/tickets/delete.png" class="delete" onclick="deletePerson(this)"/></div><div class="mui-col-sm-10 mui-col-xs-10"><p class="black nameM">'+newName+'</p><p class="tiny black idM">身份证&nbsp;'+idNo+'</p><p class="tiny black phoneM">联系电话&nbsp;'+idPhone+'</p></div></a></dd>'); 
				//组乘客信息

				if(!passagers || passagers==''){//如果为空
					passagers += newName +'!'+ idPhone +'!'+ idNo +'!';
				}else{
					passagers += '@@' + newName +'!'+ idPhone +'!'+ idNo +'!';
				}
//				alert(passagers);
				//重新计算人数和价格
				var acountP = $('.aPerson').length;
				$('#subPerson').html(acountP);
				var newPrice = settlePrice*acountP;//总价计算
				$('#subPrice').html(newPrice.toFixed(2));
				
				
			})
			
			//点击立即购买
			window.goBuy = function(){
//				plus.nativeUI.showWaiting('加载中 ...',{width:'100px',height:'80px'});//显示等待框
				
				var contactPerson = mui('#contactPerson')[0].value;
				var contactPhone = mui('#contactPhone')[0].value;
				var reg_phone = /^1((3|4|5|8|7){1}\d{1}|70)\d{8}$/;//手机号正则
				
//				alert(oldToken);
				if(!passagers || passagers==''){
					mui.toast('请添加乘机人 !');
				}else if(contactPerson == ''){
					mui('#contactPerson')[0].focus(); 
					mui.toast('联系人人不能为空!');
				}else if(!reg_phone.test(contactPhone)){
					mui('#contactPhone')[0].focus(); 
					mui.toast('请输入正确的手机号码 !');
				}else{
//					alert("userid:"+userid+"//date:"+fromTime+"//passagers:"+passagers);
//					alert("seatCode:"+seatCode+"//itemId:"+itemId+"//contactPhone:"+contactPhone+"//contactPerson:"+contactPerson+"//flightNo:"+flightNo+"//fromPlace:"+fromPlace+"//flightCompanyCode:"+flightCompanyCode+"//arrivePlace:"+arrivePlace);
					//提交生成订单
					plus.nativeUI.showWaiting("加载中...",{width:'100px',height:'80px'});
					mui.ajax(serverUrl +'/api/qianmi/airordercreate',{
					data:{userid:userid,seatCode:seatCode,passagers:passagers,itemId:itemId,contactName:contactPerson,flightNo:flightNo,date:fromTime,from:fromPlace,to:arrivePlace,companyCode:flightCompanyCode,contactTel:contactPhone},
//						data:{userid:userid,seatCode:'U',passagers:'王菲!15708434450!51303019930216752X',itemId:'5500301',contactName:'王菲',flightNo:'CZ6101',date:'2017-01-12',from:'SHE',to:'PEK',companyCode:'CZ',contactTel:15708434450},
						dataType:'json',
						type:'post',
						timeout:15000,
						headers:{"token":oldToken},
						success:function(data,type,xhr){
							plus.nativeUI.closeWaiting();//关闭等待框
							if(data.data.body.air_order_create_response.ticketTrade || !data.data.body.air_order_create_response.ticketTrade ==''){
								var planeOrder = data.data.body.air_order_create_response.ticketTrade.tradeNo;
								Orderidfanhui1 = data.data.new_qianmi_order_id;
								openview({
									view:'planeRecordDetail.html',
									id:'planeRecordDetail',
									extrasobj:{tradeNo:planeOrder,Orderidfanhui:Orderidfanhui1}
								})
							}else{
								mui.toast("提交订单失败！");
							}
						},
						error:function(xhr,type,errorThrown){
							console.log('响应失败  !');
							plus.nativeUI.closeWaiting();//关闭等待框
							mui.toast("提交订单失败！");
						}
					});
					
				}
				
			}
		})
		//点击删除，删除乘机人
		function deletePerson(thisP){
			mui.confirm('确认删除该乘机人？','',['取消','确认'],function (e) {
				if(e.index == 1) { 
					$(thisP).parents('.aPerson').remove();
					//重新计算人数和价格
					var acountP = $('.aPerson').length;
					if(acountP==0){
						$('#subPerson').html(0);
						$('#subPrice').html(0.00);
					}else{
						$('#subPerson').html(acountP);
						var newPrice = settlePrice*acountP;//总价计算
						$('#subPrice').html(newPrice.toFixed(2));
					}
					
				}
			})
		}
		
		
	</script>

</html>