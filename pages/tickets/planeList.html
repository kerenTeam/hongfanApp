<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>机票列表</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" href="../../css/reset.css">
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script type="text/javascript" src="../../js/mui.min.js"></script>
		<!--<script type="text/javascript" src="../../js/jquery.flexslider-min.js"></script>-->
		<!--<script src=" ../../js/hmt.js" type="text/javascript"></script>-->
		<script src="../../js/other.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/app.js" type="text/javascript" ></script>
		
		<!--引入模板引擎-->
		<script src="../../js/artTemplate-native.js" type="text/javascript" ></script>
		<!--日历选择插件-->
		<link href="../../css/calendar.css" rel="stylesheet" />
		<script src="../../js/calendar.js" type="text/javascript" charset="utf-8"></script>
		<style type="text/css">
			.mui-bar{
				height: 50px;
				box-shadow: none;
			}
			.mui-bar .mui-icon{
				padding: 0;
			}
			
			/*这一页*/
			.grade-eject, .Category-eject, .Sort-eject{
				height: 164px;
			}
			div.screening>ul>li{
				border-left: 1px solid #eee !important;
			}
			dl.list dt, dl.list dd{
				border-bottom: 1px solid #eee;
				background-color: #fff;
				margin-bottom: 4%;
				box-shadow: 0px 0px 6px #ccc;
				margin: 10px;
			}
			.guess-like,dl.list{
				border-bottom: 1px solid #eee;
				background-color: #EFEFF4;
			}
			.right{
				text-align: right;
			}
			.middle{
				text-align: center;
			}
			.strong-color{
				color: #f53c42 !important;
			}
			.Lgray{
				font-size: 12px !important;
				color: #999 !important;
				margin-top: 14px;
			}
			.mui-badge-blue, .mui-badge-primary{
				background-color: #fff;
				border: 1px solid #999;
				color: #999 !important;
			}
			
			.moreone{
				line-height: 50px;
			}
			dl.list .db>.react{
				padding: 0;
				margin: 0;
			}
			dl.list .db{
				height: 50px;
			}
			.grade-eject>ul>li, .Category-eject>ul>li, .Sort-eject>ul>li{
				line-height: 40px;
			}
			
			/*这一页*/
			.timeBox{
				position: relative;
			}
			.timeBox p{
				font-size: 24px;
				color: #333;
				line-height: 22px;
			}
			.timeBox .ad{
				font-size: 12px;
				color: #999;
				font-weight: normal;
				line-height: 20px;
			}
			.timeBox .bage{
				position: absolute;
				font-size: 12px;
				line-height: 10px;
				right: 8px;
				top: 0px;
				color: #666;
			}
			.price{
				text-align: right;
				font-size: 24px;
				line-height: 30px;
				color: #f53c42;
			}
			.airTip p{
				text-align: right;
				line-height: 24px;
				font-size: 12px !important;
			}
			.Achange {
				color: #333;
			}
			.Achange span{
				color: #ff5601;
				font-size: 14px !important;
			}
			.order-bottom{
				background-color: #f7f7f7;
				border-top: 1px solid #f7f7f7;
				text-align: right;
				height: 40px;
				line-height: 40px;
			}
			.order-bottom p{
				font-size: 12px;
				line-height: 40px !important;
			}
			.inputWrap{
				border: none;
				border-radius: 3px;
				color: #666;
				line-height: 50px;
				background-color: rgba(255,255,255,0.8);
				margin: 10px 0;
			}
			.head{
				background-color: #dcd5d5;
				margin-top: 50px;
			}
			.hLeft,.hMiddle{
				text-align: right;
				padding: 5px 20px 5px 10px;
			}
			.hLeft span{
				display: inline-block;
				float: left;
				font-size: 16px;
				line-height: 40px;
			}
			.hMiddle{
				text-align: center;
			}
			.iconWrap{
				position: relative;
			}
			.iconWrap input{
				border: none;
				width: 100%;
				margin: 5px 0;
				font-size: 16px;
				text-align: center;
			}
			.cIcon{
				position: absolute;
				top: 12px;
				right: 10%;
				width: 8%;
			}
			.guess-like{
				padding-top: 0;
			}
			div.screening>ul{
				border-bottom: none;
			}
			div.screening{
				border-top: 1px solid #EFEFF4;
			}
			#main{
				margin-top: 10px;
			}
			.goTime{
				line-height: 40px;
				font-size: 14px;
			}
			.calendars{
				background-color: #fff;
			}
			.mui-bar-nav.mui-bar .mui-icon, .mui-title, #theSearch{margin: 0;}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
		    <h1 class="mui-title">机票</h1>  
		</header>
		<div class="head" id="head" style="top: 50px;">
			<div class="mui-row">
			    <div class="mui-col-sm-3 mui-col-xs-3 hLeft">
					<p class="black goTime">出发时间</p>
		       	</div>
		        <div class="mui-col-sm-9 mui-col-xs-9 hMiddle">
		        	<p type="text" class="black goTime calendars"><span id="calendars"></span>&nbsp;&nbsp;<span id="weekday"></span></p>
		        	<img src="../../img/tickets/calender.png"/ class="cIcon">
		        </div>
			</div>
		</div>
		<!--这是单独加模拟状态栏的方法-->
		<div id="sBar" style="background-color: #e93128;position: fixed;width:100%;top: 0;z-index: 9999"></div>
		<script type="text/javascript">
			var immersed = 0;
			var ms=(/Html5Plus\/.+\s\(.*(Immersed\/(\d+\.?\d*).*)\)/gi).exec(navigator.userAgent);
			if(ms&&ms.length>=3){ // 当前环境为沉浸式状态栏模式
			    immersed=parseFloat(ms[2]);// 获取状态栏的高度
			}
			var statusBar = document.getElementById('sBar');//这是模拟状态栏
			var headdiv = document.getElementById('header');//这是现有的header
			var headdiv2 = document.getElementById('head');//这是现有的head
			document.body.style.paddingTop =  immersed+'px';
			statusBar&&(statusBar.style.height = immersed+'px');
			headdiv&&(headdiv.style.top = immersed+'px');
			headdiv2&&(headdiv2.style.top = parseInt(headdiv2.style.top) + immersed+'px');
		</script>
		<div id="main">
			<div class="guess-like">
				<dl class="list" id="goodsList"></dl>
				<script type="text/html" id="goodsList-detail">
					<% for(var i = 0;i<adLi.length;i++){ %>
						<dd class="goodsItem" onclick="goPlane('<%= adLi[i].flightNo %>','<%= adLi[i].flightCompanyCode %>')">
							<a class="react mui-row">
								<div class="mui-col-sm-3 mui-col-xs-3">
									<div class="timeBox">
										<p><%= adLi[i].depTime %></p>
										<p class="ad"><%= adLi[i].orgCityName.replace("航站楼:","")  %></p>
									</div>
						        </div>
						        <div class="mui-col-sm-1 mui-col-xs-1">-</div>
						        <div class="mui-col-sm-3 mui-col-xs-3">
						        	<div class="timeBox">
										<p><%= adLi[i].arriTime %></p>
										<p class="ad"><%= adLi[i].dstCityName.replace("航站楼:","") %></p>
									</div>
						        </div>
						        <div class="mui-col-sm-5 mui-col-xs-5 airTip">
						        	<p><%= adLi[i].flightCompanyName %><%= adLi[i].flightNo %></p>
						        </div>
							</a>
							<div class="order-bottom clearfloat box-s tip">
								<p>原价（点击查看优惠价格）<span class="price"><sub>￥</sub><%= adLi[i].basePrice %></span></p>
							</div>
						</dd>
					<% } %>
				</script>
			</div>
		</div>
	</body>
	<script type="text/javascript">
		mui.init({
			swipeBack:true //启用右滑关闭功能
		});
		(function($) {
			$('#scroll').scroll({
				indicators: true //是否显示滚动条
			});
			var segmentedControl = document.getElementById('segmentedControl');
			$('.mui-input-group').on('change', 'input', function() {
				if (this.checked) {
					var styleEl = document.querySelector('input[name="style"]:checked');
					var colorEl = document.querySelector('input[name="color"]:checked');
					if (styleEl && colorEl) {
						var style = styleEl.value;
						var color = colorEl.value;
						segmentedControl.className = 'mui-segmented-control' + (style ? (' mui-segmented-control-' + style) : '') + ' mui-segmented-control-' + color;
					}
				}
			});
		})(mui);
	</script>
	<!--数据渲染-->
	<script type="text/javascript">
		mui.plusReady(function(){
			var from = plus.webview.currentWebview().from;
			var arrive = plus.webview.currentWebview().arrive;
			var fromTime = plus.webview.currentWebview().fromTime;
			mui('#calendars')[0].innerHTML = fromTime;
			
			//修改星期日期时间
			var dateTime = fromTime.replace(/\-/g,'/');//将获取的日期如2017-01-01改为2017/01/01
			var date = new Date(dateTime).getDay();//获取具体周几
			var weekday=new Array(7);
				weekday[1]="周一";
				weekday[2]="周二";
				weekday[3]="周三";
				weekday[4]="周四";
				weekday[5]="周五";
				weekday[6]="周六";
				weekday[7]="周日";
			document.getElementById('weekday').innerHTML = weekday[date];
			//修改星期日期时间结束
			
			//获取缓存
			var oldToken = plus.storage.getItem('oldToken');
			console.log(oldToken);
			plus.nativeUI.showWaiting("加载中...",{width:'100px',height:'80px'});
			//获取所有站点的三字码
			var fromPlace,arrivePlace,itemId;
			mui.ajax(serverUrl +'/api/qianmi/airstationslist',{
				dataType:'json',
				type:'post',
				timeout:10000,
				headers:{"token":oldToken},	 
				success:function(data,type,xhr){
					console.log('三字码获取成功')
					dataReturn = data.data.air_stations_list_response.stations.station;
					for(var i = 0;i<dataReturn.length;i++){
						//起飞地点三字码
						if(from == dataReturn[i].name){
							fromPlace = dataReturn[i].code;
						}
						//目的地三字码
						if(arrive == dataReturn[i].name){
							arrivePlace = dataReturn[i].code;
						}
					}
					
					//获取标准商品序列号
					mui.ajax(serverUrl +'/api/qianmi/airitemslist',{
						data:{pageNo : 0,itemName:'',itemId:'',pageSize:10},
						dataType:'json',
						type:'post',
						timeout:10000,
						headers:{"token":oldToken},	 
						success:function(data,type,xhr){
							console.log('标准商品序列号获取成功')
							numReturn = data.data.air_items_list_response.items.item;
							for(var j = 0;j<numReturn.length;j++){
								itemId = numReturn[j].itemId;
								//获取航线列表
								mui.ajax(serverUrl +'/api/qianmi/airlineslist',{
									data:{from:fromPlace,itemId:itemId,date:fromTime,to:arrivePlace},
									dataType:'json',
									type:'post',
									timeout:30000,
									headers:{"token":oldToken},	 
									success:function(data,type,xhr){
										console.log('列表', data);
										var dataObj = data.data.airlines_list_response.airlines;
										if(!dataObj || dataObj == ''){
											plus.nativeUI.closeWaiting();
											mui.toast('没有航线信息,请重新输入航线！');
											plus.webview.currentWebview().close();
										}else{
											dataObj = data.data.airlines_list_response.airlines.airline;
											var adObj = {};
											adObj.adLi = data.data.airlines_list_response.airlines.airline;
											var html = template('goodsList-detail',adObj);
											document.getElementById('goodsList').innerHTML = html;
											plus.nativeUI.closeWaiting();
											//点击机票进入详情
											window.goPlane = function(flightNo,flightCompanyCode){
												openview({ 
													view:'planeDetail.html',
													extrasobj:{flightNo:flightNo,flightCompanyCode:flightCompanyCode,fromPlace:fromPlace,arrivePlace:arrivePlace,fromTime:fromTime,itemId:itemId}
												})
											}
										}
									},
									error:function(xhr,type,errorThrown){
										console.log('当前网络不好，请重试!');
										mui.toast('请求超时，请重试!');
										plus.nativeUI.closeWaiting();
										plus.webview.currentWebview().close();
									}
								});
							}
						},
						error:function(xhr,type,errorThrown){
							console.log('标准商品序列号响应失败  !');
							mui.toast('请求超时，请重试!');
							plus.nativeUI.closeWaiting();
							plus.webview.currentWebview().close();
						}
					});
				},
				error:function(xhr,type,errorThrown){
					console.log('三字码响应失败  !');
					mui.toast('请求超时，请重试!');
					plus.nativeUI.closeWaiting(); 
					plus.webview.currentWebview().close();
				}
			});
		})
	</script>
</html>