<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>机票订单详情</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" href="../../css/reset.css">
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script type="text/javascript" src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/jquery.flexslider-min.js"></script>
		<script src=" ../../js/hmt.js" type="text/javascript"></script>
		<script src="../../js/other.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/app.js" type="text/javascript" ></script>
		<!--引入模板引擎-->
		<script src="../../js/artTemplate-native.js" type="text/javascript" ></script>
		<style type="text/css">
			.mui-bar{
				height: 50px;
				box-shadow: none;
			}
			.mui-title,.mui-icon{
				line-height: 50px;
			}
			.mui-bar .mui-icon{
				padding: 0;
			}
			#main{
				margin-top: 50px;
			}
			
			.guess-like,dl.list{
				border-bottom: 1px solid #eee;
				background-color: #EFEFF4;
			}
			.right{
				text-align: right;
			}
			.middle{
				text-align: center;
			}
			.strong-color{
				color: #f53c42 !important;
			}
			.Lgray{
				font-size: 12px !important;
				color: #999 !important;
				margin-top: 14px;
			}
			.mui-badge-blue, .mui-badge-primary{
				background-color: #fff;
				border: 1px solid #999;
				color: #999 !important;
			}
			
			.moreone{
				line-height: 50px;
			}
			dl.list .db>.react{
				padding: 0;
				margin: 0;
			}
			dl.list .db{
				height: 50px;
			}
			.grade-eject>ul>li, .Category-eject>ul>li, .Sort-eject>ul>li{
				line-height: 40px;
			}
			
			/*这一页*/
			.timeBox{
				position: relative;
			}
			.timeBox p{
				font-size: 24px;
				color: #333;
				line-height: 22px;
			}
			.timeBox .ad{
				font-size: 12px;
				color: #999;
				font-weight: normal;
				line-height: 24px;
			}
			.timeBox .bage{
				position: absolute;
				font-size: 12px;
				line-height: 10px;
				right: 15px;
				top: 10px;
				color: #666;
			}
			.price{
				text-align: right;
				font-size: 24px;
				color: #f53c42;
			}
			.airTip p{
				text-align: right;
				line-height: 40px !important;
			}
			.Achange {
				color: #333;
			}
			.Achange span{
				color: #ff5601;
				font-size: 14px !important;
			}
			.inputWrap{
				border: none;
				border-radius: 3px;
				color: #666;
				line-height: 50px;
				background-color: rgba(255,255,255,0.8);
				margin: 10px 0;
			}
			.ad img{
				width: 15%;
				margin-top: -3px;
			}
			.dot{
				background-color: #bfbfbf;
				width: 5px;
				height: 5px;
				padding: 4px;
				margin: 0 5px;
				border-radius: 50%;
				display: inline-block;
			}
			.line{
				width: 3px;
				height: 12px;
				position: absolute;
				left: 8px;
				top: 42px;
				background-color: #ddd;
			}
			.guess-like{
				padding-top:50px;
			}
			.react >div{
				line-height: 40px !important;
			}
			.airTip button{
				margin-left: 15px !important;
				background-color: #f53c42;
				color: #fff;
				border: none;
			}
			dl.list {
				border-top: none;
				margin-top: 10px; 
			}
			.react{
				padding: 0 .15rem !important;
			}
			dl.list dt, dl.list dd{
				background-color: #fff;
			}
			.lineL{
				border-left: 1px solid #DDD8CE;
			}
			.phone{
				border: none;
			}
			.state{
				font-size:18px !important;
				font-weight: bold;
				line-height: 50px;
				color: #f53c42;
			}
			.title{
				font-size: 24px !important;
			}
			.tiny{
				font-size: 12px;
				line-height: 20px;
				margin-top: -5px;
			}
			.addMan{
				color: #999;
				margin: 10px 0;
				line-height: 16px;
				font-size: 12px;
				float: right;
				width: 25%;
				margin-left: 10px;
			}
			.goPay{
				/*color: #999;*/
				margin: 10px 0;
				line-height: 16px;
				font-size: 12px;
				float: right;
				width: 25%;
				border: 1px solid #d72d22;
				margin-left: 10px;
			}
			dl.list dt, dl.list dd{
				border-bottom: 1px solid #EFEFF4;
			}
			.colRight{
				text-align: right;
			}
			.red1{
				color: #f53c42;
			}
			.tip p{
				text-align: center;
				margin-bottom: 20px;
				font-size: 11px !important;
				line-height: 16px;
			}
			.theRule{
				margin-top: 6px;
			}
			.theline{
				width: 50%;
				position: absolute;
				top: 20px;
				left: 25%;
			}
			.lineTop{
				text-align: center;
				margin-top: 2px;
			}
			.react2{
				margin: 10px 0;
			}
			.react2 p{
				line-height: 25px !important;
			}
			.order{
				border-top: 1px solid #EFEFF4;
				padding: 10px!important;
				margin: 0;
			}
			#orderNo,#totalPayCash{
				color: #333 !important;
				font-size: 14px;
				
			}
			#stateName{
				color: #d72d22 !important;
			}
			.last{
				margin: 10px 15px;
				padding-bottom: 20px;
			}
			.last p{
				line-height: 20px;
			}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
		    <h1 class="mui-title">机票订单详情</h1>  
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div id="main">
			<dl class="list" id="goodsList">
				<dd class="goodsItem">
					<div class="react mui-row">
						<div class="mui-col-sm-9 mui-col-xs-9">
							<p class="state"><span id="stateName"></span></p>
				        </div>
				        <div class="mui-col-sm-3 mui-col-xs-3"></div>
					</div>
				</dd>
			</dl>
			<dl class="list" id="goodsList">
				<dd class="goodsItem">
					<div class="react mui-row">
						<div class="mui-col-sm-9 mui-col-xs-9">
							<p class="black"><span id="startTime1"></span>&nbsp;<span id="weekday"></span>&nbsp;<span id="title"></span></p>
				        </div>
				        <div class="mui-col-sm-3 mui-col-xs-3"></div>
					</div>
					<div class="react mui-row" style="margin-top: 10px;">
						<div class="mui-col-sm-3 mui-col-xs-3">
							<p class="black title"><span id="startTime"></span></p>
							<p class="tiny red1"><span class="mui-icon mui-icon-location tiny"></span><span id="startStation"></span></p>
				        	<p class="tiny">
								<span id="startTime2"></span>
							</p>
						</div>
				         <div class="mui-col-sm-6 mui-col-xs-6">
				        	<img src="../../img/tickets/line.png"/ class="theline">
				        </div>
				        <div class="mui-col-sm-3 mui-col-xs-3 colRight">
				        	<p class="black title"><span id="recevieTime"></span></p>
							<p class="tiny red1"><span class="mui-icon mui-icon-location tiny"></span><span id="recevieStation"></span></p>
				        	<p class="tiny">
								<span id="recevieTime2"></span>
							</p>
				        </div>
					</div>
					<div class="tip">
						<p><span id="trainNo"></span></p>
					</div>
				</dd>
				<dd class="goodsItem">
					<a class="react mui-row">
			        	<button type="button" id="zhifu" style="display: none;" class="mui-btn mui-btn-blue goPay" onclick="goPay()">去支付</button>
			        	<button class="addMan" id="quxiao" style="display: none;" onclick="cancelPlane()">取消订单</button>
			        	<button class="addMan goReturn" style="display: none;" id="tuipiao" onclick="returnPlane()">退票</button>
					</a>
				</dd>
			</dl>
			<dl class="list">
				<dd>
					<div class="orderbh box-s">
						<span class="black">乘客（<span id="orderNo"></span>人）</span>
						<span class="fr">
							<div class="pricetwo">
								<p class="black big">¥&nbsp;<span id="totalPayCash"></span></p>
							</div>	
						</span>
					</div>
					<div id="orderList"></div>
					
				</dd>
			</dl>
			<dl class="list">
				<dd>
					<a class="react mui-row react2">
						<span>联系手机</span>
						<span class="black fr"><span id="contactTel"></span></span>		
					</a>
				</dd>
			</dl>
			<dl class="list">
				<dd>
					<a class="react mui-row react2">
						<span>订单号</span>
						<span class="gray fr"><span id="tradeNo"></span></span>		
					</a>
				</dd>
			</dl>
			<dl class="list last">
				<p><span class="red1">*</span>温馨提示</p>
				<p>1.机票相关业务处理时间为8:00-22:00。</p>
				<p>2.机票业务不做改签处理</p>
				<p>3.机票支持在线申请退废票和自愿退票，非自愿退票请根据平台规则联系客服处理。</p>
				<p>4.出票当日提交"退废票"，具体以航司规定为准。</p>
				<p>5.请仔细核对用户身份证号以及姓名，以免造成不必要的损失。</p>
				<p>6.行程单(报销凭证)机场提供打印服务。</p>
				<p>7.目前不支持飞机票保险货源。</p>
			</dl>
			<script type="text/html" id="orderList-detail">
				<% for(var i=0;i<orderList.length;i++){ %>
					<a class="react mui-row react2 order">
						<div class="mui-col-sm-9 mui-col-xs-9">
							<p class="black big"><%= orderList[i].passengerName %>&nbsp;</p>
						</div>
						<div class="mui-col-sm-3 mui-col-xs-3">
							<div class="fr">
								<p><%= orderList[i].passengerTel %></p>
							</div>	
						</div>
						<div class="mui-col-sm-9 mui-col-xs-9">
							<p class="black">身份证号：<%= orderList[i].idcardNo %></p>
						</div>
						<div class="mui-col-sm-3 mui-col-xs-3">
							<div class="fr">
								<p class="black">￥<%= orderList[i].payCash %></p>
							</div>	
						</div>
						<div class="mui-col-sm-9 mui-col-xs-9">
							<p class="black ">订单自编号：<%= orderList[i].orderNo %></p>
						</div>
						<div class="mui-col-sm-3 mui-col-xs-3">
							
						</div>
					</a>
				<% } %>
			</script>
		</div>
	</body>
	<script type="text/javascript">
		var tradeNo,body1,total_fee1,orderNos;
		mui.plusReady(function(){
			plus.nativeUI.showWaiting('加载中 ...',{width:'100px',height:'80px'});//显示等待框
			var oldToken = plus.storage.getItem('oldToken');
			tradeNo = plus.webview.currentWebview().tradeNo;
			var Orderidfanhuiagen = plus.webview.currentWebview().Orderidfanhui;//订单id
			var loadfun = function(){
				mui.ajax(serverUrl +'/api/qianmi/airorderdetail',{
					data:{tradeNo:tradeNo},//订单主编号
					dataType:'json',
					type:'post',
					timeout:15000,
					headers:{token:oldToken},	 
					success:function(data,type,xhr){
						console.log('飞机详情',data);
						var planeOrder = data.data.air_order_detail_response.ticketTrade;
						//将数据铺入
						mui('#tradeNo')[0].innerHTML=planeOrder.tradeNo;
						tradeNo = planeOrder.tradeNo;
						console.log('飞机详情里面',planeOrder);
						body1 = planeOrder.title;
						total_fee1 = planeOrder.totalPayCash;
						console.log(tradeNo);
						mui('#title')[0].innerHTML=planeOrder.title;
						mui('#orderNo')[0].innerHTML=planeOrder.ticketOrders.ticketOrder.length;
						//订单状态 -----弃用
//						if(planeOrder.billState == 0){//待支付
//							mui('#stateName')[0].innerHTML="待支付";
//							mui('.goReturn')[0].remove();
//						}else if(planeOrder.state == 2 && !planeOrder.billState == 0){
//							mui('#stateName')[0].innerHTML="预定中";//预定中
//							mui('.goPay')[0].remove();
//							mui('.goReturn')[0].remove();
//						}else if(planeOrder.state == 1 && planeOrder.billState == 1){
//							mui('#stateName')[0].innerHTML=planeOrder.stateName;//可退票
//							mui('.goPay')[0].remove();
//							mui('.addMan')[0].remove();
//						}else{
//							mui('#stateName')[0].innerHTML=planeOrder.stateName;
//							mui('.addMan')[0].remove();
//							mui('.goPay')[0].remove();
//							mui('.goReturn')[0].remove();
//						}
						//显示状态
						if(planeOrder.stateName.indexOf('预定')>-1){
							mui('#zhifu')[0].style.display = 'inline-block';
							mui('#quxiao')[0].style.display = 'inline-block';
						}else if(planeOrder.stateName.indexOf('完成')>-1){
							mui('#tuipiao')[0].style.display = 'inline-block';
						}
						//退票子订单
						var suborder = planeOrder.ticketOrders.ticketOrder;
						mui.each(suborder,function (index,element) {
							if(index == 0){
								orderNos = element.orderNo;
								if(element.stateName == '已退款'){
									mui('#tuipiao')[0].style.display = 'none';
									mui('#zhuangtai')[0].innerText =  '已退款';
								}
							}else{
								orderNos += ','+element.orderNo;
							}
						})
						mui('#stateName')[0].innerHTML=planeOrder.stateName;
						mui('#trainNo')[0].innerHTML=planeOrder.trainNo;
						mui('#contactTel')[0].innerHTML=planeOrder.contactTel;
						mui('#startStation')[0].innerHTML=planeOrder.startStation;
						mui('#recevieStation')[0].innerHTML=planeOrder.recevieStation;
						mui('#startTime')[0].innerHTML=planeOrder.startTime.substring(11);
						//修改星期日期时间
						var dateTime = planeOrder.startTime.replace(/\-/g,'/');//将获取的日期如2017-01-01改为2017/01/01
						var date = new Date(dateTime).getDay();//获取具体周几
						var weekday=new Array(7);
							weekday[1]="周一";
							weekday[2]="周二";
							weekday[3]="周三";
							weekday[4]="周四";
							weekday[5]="周五";
							weekday[6]="周六";
							weekday[7]="周日";
						document.getElementById('weekday').innerHTML = weekday[date];
						//修改星期日期时间结束
						mui('#startTime1')[0].innerHTML=planeOrder.startTime.substring(11,planeOrder.startTime.toString().Length-11);
						mui('#recevieTime')[0].innerHTML=planeOrder.recevieTime.substring(11);
						mui('#totalPayCash')[0].innerHTML=planeOrder.totalPayCash;
						mui('#startTime2')[0].innerHTML=planeOrder.startTime.substring(11,planeOrder.startTime.toString().Length-11);
						mui('#recevieTime2')[0].innerHTML=planeOrder.recevieTime.substring(11,planeOrder.startTime.toString().Length-11);
			//			mui('#totalOtherFee')[0].innerHTML=planeOrder.totalOtherFee;
						//乘机人信息
						var orderObj = {};
						orderObj.orderList = planeOrder.ticketOrders.ticketOrder;
						var html = template('orderList-detail',orderObj);
						document.getElementById('orderList').innerHTML = html;
						plus.nativeUI.closeWaiting();//关闭等待框
						//点击取消订单
						window.cancelPlane = function(){
							mui.confirm('确认取消该订单？','',['取消','确认'],function (e) {
								if(e.index == 1) { 
									mui.ajax(serverUrl +'/api/qianmi/airordercancel',{
										data:{tradeNo:tradeNo},//订单主编号
										dataType:'json',
										type:'post',
										timeout:15000,
										headers:{token:oldToken},	 
										success:function(data,type,xhr){
											console.log('取消返回',data);
											if(data.data.air_order_cancel_response.result==1){
												mui.fire(plus.webview.getWebviewById('TPRecord'),'refresh',{type:'plane'});
												var timequxiao = setTimeout(function(){
													plus.webview.currentWebview().close();
												},500)
												mui.toast('取消成功');
											}else{
												mui.toast("取消订单失败！")
											}
											plus.nativeUI.closeWaiting();
										},
										error:function(xhr,type,errorThrown){
											console.log('响应失败  !');
										}
									});
								}
							})
						}
						
						//点击退票
						window.returnPlane = function(){
							mui.confirm('确认退票？','',['取消','确认'],function (e) {
								if(e.index == 1) { 
									mui.ajax(serverUrl +'/api/qianmi/airorderrefund',{
										data:{tradeNo:tradeNo,orderNos:orderNos,returnType:3},//订单主编号
										dataType:'json',
										type:'post',
										timeout:15000,
										headers:{token:oldToken},	 
										success:function(data,type,xhr){
											console.log('退票',data);
											if(data.data.subErrors){
												mui.toast(data.data.subErrors[0].message);
											}else{
												if(data.data.air_order_refund_response.result==1){
													mui.fire(plus.webview.getWebviewById('TPRecord'),'refresh',{type:'plane'});
													var timequxiao = setTimeout(function(){
													mui.toast("退票成功！");
														plus.webview.currentWebview().close();
													},500)
												}else{
													mui.toast("退票失败！")
												}
											}	
											plus.nativeUI.closeWaiting();
										},
										error:function(xhr,type,errorThrown){
											console.log('响应失败  !');
										}
									});
								}
							})
							
						}
						window.goPay = function(){
							openview({
								view:"payTickets.html",
								id:"payTickets",
								extrasobj:{body:body1,total_fee:total_fee1,Orderidnum:tradeNo,Orderidfanhui:Orderidfanhuiagen,typestr:"feiji"}
							})
						}
						
					},
					error:function(xhr,type,errorThrown){
						plus.nativeUI.closeWaiting();
						mui.toast('响应失败  !');
					}
				});
			};	
			loadfun();
			document.addEventListener('refresh', function() {
				loadfun();//加载方法
			});
			
		})
	</script>
</html>