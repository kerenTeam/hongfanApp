<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>火车票订单详情</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" href="../../css/reset.css">
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script type="text/javascript" src="../../js/mui.min.js"></script>
		<script src="../../js/app.js" type="text/javascript" ></script>
		<!--引入模板引擎-->
		<script src="../../js/artTemplate-native.js" type="text/javascript" ></script>
		<style type="text/css">
			.mui-bar{
				height: 50px;
				box-shadow: none;
			}
			.mui-title,.mui-icon{
				line-height: 50px;
			}
			.mui-bar .mui-icon{
				padding: 0;
			}
			#main{
				margin-top: 50px;
			}
			
			.guess-like,dl.list{
				border-bottom: 1px solid #eee;
				background-color: #EFEFF4;
			}
			.right{
				text-align: right;
			}
			.middle{
				text-align: center;
			}
			.strong-color{
				color: #f53c42 !important;
			}
			.Lgray{
				font-size: 12px !important;
				color: #999 !important;
				margin-top: 14px;
			}
			.mui-badge-blue, .mui-badge-primary{
				background-color: #fff;
				border: 1px solid #999;
				color: #999 !important;
			}
			
			.moreone{
				line-height: 50px;
			}
			dl.list .db>.react{
				padding: 0;
				margin: 0;
			}
			dl.list .db{
				height: 50px;
			}
			.grade-eject>ul>li, .Category-eject>ul>li, .Sort-eject>ul>li{
				line-height: 40px;
			}
			
			/*这一页*/
			.timeBox{
				position: relative;
			}
			.timeBox p{
				font-size: 24px;
				color: #333;
				line-height: 22px;
			}
			.timeBox .ad{
				font-size: 12px;
				color: #999;
				font-weight: normal;
				line-height: 24px;
			}
			.timeBox .bage{
				position: absolute;
				font-size: 12px;
				line-height: 10px;
				right: 15px;
				top: 10px;
				color: #666;
			}
			.price{
				text-align: right;
				font-size: 24px;
				color: #f53c42;
			}
			.airTip p{
				text-align: right;
				line-height: 40px !important;
			}
			.Achange {
				color: #333;
			}
			.Achange span{
				color: #ff5601;
				font-size: 14px !important;
			}
			.inputWrap{
				border: none;
				border-radius: 3px;
				color: #666;
				line-height: 50px;
				background-color: rgba(255,255,255,0.8);
				margin: 10px 0;
			}
			.ad img{
				width: 15%;
				margin-top: -3px;
			}
			.dot{
				background-color: #bfbfbf;
				width: 5px;
				height: 5px;
				padding: 4px;
				margin: 0 5px;
				border-radius: 50%;
				display: inline-block;
			}
			.line{
				width: 3px;
				height: 12px;
				position: absolute;
				left: 8px;
				top: 42px;
				background-color: #ddd;
			}
			.guess-like{
				padding-top:50px;
			}
			.react >div{
				line-height: 40px !important;
			}
			.airTip button{
				margin-left: 15px !important;
				background-color: #f53c42;
				color: #fff;
				border: none;
			}
			dl.list {
				border-top: none;
				margin-top: 10px; 
			}
			.react{
				padding: 0 .15rem !important;
			}
			dl.list dt, dl.list dd{
				background-color: #fff;
			}
			.lineL{
				border-left: 1px solid #DDD8CE;
			}
			.phone{
				border: none;
			}
			.state{
				font-size:18px !important;
				font-weight: bold;
				line-height: 50px;
				color: #f53c42;
			}
			.title{
				font-size: 24px !important;
			}
			.tiny{
				font-size: 12px;
				line-height: 20px;
				margin-top: -5px;
			}
			.addMan{
				color: #077eb9;
				border-color: #077eb9;
				margin: 10px 0;
				line-height: 16px;
				font-size: 12px;
				float: right;
				margin-left: 12px;
			}
			dl.list dt, dl.list dd{
				border-bottom: 1px solid #EFEFF4;
			}
			/*.delete{
				width: 90%;
				margin-top: 15px;
			}*/
			/*header样式*/
			/*.mui-bar-nav {
				background-color: #FFF !important;
				border-bottom: 1px solid #EFEFF4;
			}
			.hasManyCitytwo .header-tit{
				color: #333;
			}
			.hasManyCitytwo .fanhui{
				color: #333;
			}*/
			.colRight{
				text-align: right;
			}
			.red1{
				color: #f53c42;
			}
			.tip p{
				text-align: center;
				margin-bottom: 20px;
				font-size: 11px !important;
				line-height: 16px;
			}
			.theRule{
				margin-top: 6px;
			}
			.theline{
				width: 50%;
				position: absolute;
				top: 30px;
				left: 25%;
			}
			.lineTop{
				text-align: center;
				margin-top: 8px;
			}
			.lineBottom{
				text-align: center;
				margin-top: 10px;
			}
			.orderbh{
				border-bottom: 1px solid #EFEFF4;
			}
			.react2{
				margin: 5px 0;
				padding-top: 8px !important;
				padding-bottom: 8px !important;
			}
			.address{
				line-height: 14px;
			}
			.react2 p,.react2 span{
				line-height: 22px !important;
			}
			.gray{
				color: #999;
			}
			.tinyIcon{
				font-size: 16px;
				line-height: 16px !important;
			}
			#zhuangtai{font-size: 16px;font-weight: normal;}
			#daoda{font-size: 14px;font-weight: normal;color: #555555;}
			.hasManyCitytwo .header-tit{left: 45%;}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav hasManyCity hasManyCitytwo">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize fl fanhui"></a>
		    <div class="header-tit">
				火车票订单详情
			</div>
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div id="main">
			<dl class="list" id="goodsList">
				<dd class="goodsItem">
					<div class="react mui-row">
						<div class="mui-col-sm-9 mui-col-xs-9">
							<p class="state" id="Tstate" style="min-height: 50px;">
								<span id="zhuangtai"></span>
								<span id="daoda"></span>
							</p>
				        </div>
				        <div class="mui-col-sm-3 mui-col-xs-3">
				        	
				        </div>
					</div>
				</dd>
			</dl>
			<dl class="list" id="goodsList">
				<dd class="goodsItem" style="min-height: 110px;display: none;">
					<div class="react mui-row" style="margin: 20px 0;">
						<div class="mui-col-sm-3 mui-col-xs-3">
							<p class="black address" id="Tkaishi"></p>
							<p class="black title" id="Tkaishishi"></p>
							<!--<p class="tiny">12-11&nbsp;周日</p>-->
				        </div>
				         <div class="mui-col-sm-6 mui-col-xs-6">
				         	<p class="tiny lineTop" id="Tname"></p>
				        	<img src="../../img/tickets/line.png"/ class="theline">
				         	<p class="tiny lineBottom"></p>
				        </div>
				        <div class="mui-col-sm-3 mui-col-xs-3 colRight">
				        	<p class="black address" id="Tjieshu"></p>
							<p class="black title" id="Tjieshushi"></p>
							<!--<p class="tiny">12-11&nbsp;周日</p>-->
				        </div>
					</div>
				</dd>
				<dd class="goodsItem">
					<a class="react mui-row">
						<!--<div class="mui-col-sm-8 mui-col-xs-8">
							<p class="theRule red1" onclick="planeRule()">退票规则</p>
							<p class="tiny">请确保姓名证件填写正确</p>
				       </div>-->
				        <div class="">
				        	<button class="addMan" id="zhifu" style="display: none;" onclick="zhifufun()">立即支付</button>
				        	<button class="addMan" id="tuipiao" style="display: none;" onclick="tuipiaofun()">申请退票</button>
				        	<button class="addMan" id="quxiao" style="display: none;" onclick="quxiaofun()">取消订票</button>
				        </div>
					</a>
				</dd>
			</dl>
			<dl class="list">
				<dd>
					<div class="orderbh box-s">
						<span class="black chengkerenshu">乘客（人）</span>
						<span class="fr">
							<div class="pricetwo">
								<p class="black big zongjia"></p>
							</div>	
						</span>
					</div>
					<div id="infolistdiv"></div>
					<script type="text/html" id="infolist">
						<% for(var i=0; i<list.length; i++){%> 
							<a class="react mui-row react2" id="">
								<div class="mui-col-sm-9 mui-col-xs-9">
									<p class="black big"><%= list[i].passengerName%><sub class="gray"></sub></p>
								</div>
								<div class="mui-col-sm-3 mui-col-xs-3">
									<div class="fr">
										<p class="black"><%= list[i].seatName%></p>
									</div>	
								</div>
								<div class="mui-col-sm-9 mui-col-xs-9">
									<p class="black big"><%= list[i].idcardNo%></p>
								</div>
								<div class="mui-col-sm-3 mui-col-xs-3">
									<div class="fr">
										<p class="black">￥<%= list[i].facePrice%></p>
									</div>	
								</div>
								<div class="mui-col-sm-9 mui-col-xs-9">
									<p class="black big"><%= list[i].seatInfo%></p>
								</div>
							</a>
						<% }%>	
					</script>
				</dd>
			</dl>
			<dl class="list">
				<dd>
					<a class="react mui-row react2">
						<span>联系手机</span>
						<span class="black fr" id="Tshouji"></span>		
					</a>
				</dd>
			</dl>
			<dl class="list">
				<!--<dd>
					<a class="react mui-row react2">
						<span>取票、退票须知</span>
						<span class="fr mui-icon mui-icon-arrowright gray tinyIcon"></span>		
					</a>
				</dd>-->
				<dd>
					<a class="react mui-row react2">
						<span>订单号</span>
						<span class="gray fr" id="Tdindan"></span>		
					</a>
				</dd>
			</dl>
			
			<dl class="list LastList" id="goodsList">
				<dd class="goodsItem">
					<a class="react mui-row">
				        <div class="">
				        	<h5 style="margin: 10px;margin-left: -2px;color: #000;">购票须知</h5>
				        	<p id="changeStipulate" style="line-height: 20px;font-size: 12px;margin: 10px 0;">
				        		  1.火车票相关业务处理时间为8:00-22:00。 <br />
							      2.发车前4小时以内退款不做处理，请自行去火车站退票。 <br />
							      3.不受理改签业务，需用户自行在发车前去车站办理 。<br />
							      4.火车票新版上线，支持购买卧铺票、硬座，不支持指定无座。 <br />
							      5.禁止代理商向用户收取票面价格以外的手续费。 <br />
							      6.提交订单时如提示身份证待核验，乘车人需带二代身份证到火车站通过身份认证才能网上购票。 <br />
				        	</p>
				        </div>
					</a>
				</dd>
			</dl>
			
		</div>
	</body>
	<script type="text/javascript">
		
		mui.plusReady(function(){
			var Orderid = 0,Totalnum = 0,suborderstr = '',Orderidfanhui1 = '';
			var Orderidfanhui1 =  plus.webview.currentWebview().Orderidfanhui;
			var body1,total_fee1;//支付所需参数
			var TorderD = plus.webview.currentWebview().Tordernum;
			var oldToken = plus.storage.getItem('oldToken');
			
			var loadfun = function(){
				plus.nativeUI.showWaiting('加载中 ...',{width:'100px',height:'80px'});
				mui.ajax(serverUrl+'/api/qianmi/trainorderdetail',{//获取详情
					data:{tradeNo:TorderD},
					type:'post',
					timeout:10000,
					headers:{"token":oldToken},	              				
					success:function(data){
						console.log(data);
						console.log('详情返回'+JSON.stringify(data));
						if(data.errno == 0){
							var Tdatail = data.data.train_order_detail_response.ticketTrade;
							console.log(Tdatail);
							mui('#zhuangtai')[0].innerText =  Tdatail.stateName;
							mui('#daoda')[0].innerHTML = "( " + Tdatail.startStation +" - " +Tdatail.recevieStation + " )";
							mui('#Tshouji')[0].innerHTML = Tdatail.contactTel;
							mui('#Tdindan')[0].innerHTML = Orderid = Tdatail.tradeNo;
							mui('.zongjia')[0].innerHTML = '￥'+Tdatail.totalPayCash;
							Totalnum = Tdatail.totalSalePrice;
							mui('.chengkerenshu')[0].innerHTML = '乘客（'+Tdatail.ticketOrders.ticketOrder.length+'人）';
							//显示按钮
							if(Tdatail.stateName.indexOf('预定')>-1){
								mui('#zhifu')[0].style.display = 'inline-block';
								mui('#quxiao')[0].style.display = 'inline-block';
							}else if(Tdatail.stateName.indexOf('完成')>-1){
								mui('#tuipiao')[0].style.display = 'inline-block';
							}
							//退票子订单
							var suborder = Tdatail.ticketOrders.ticketOrder;
							mui.each(suborder,function (index,element) {
								if(index == 0){
									suborderstr = element.orderNo;
									if(element.stateName == '已退款'){
										mui('#tuipiao')[0].style.display = 'none';
										mui('#zhuangtai')[0].innerText =  '已退款';
									}
								}else{
									suborderstr += ','+element.orderNo;
								}
							})
							//支付参数赋值
							body1 = Tdatail.title;
							total_fee1 = Tdatail.totalPayCash;
							
							var dataobj = {};
							dataobj.list = Tdatail.ticketOrders.ticketOrder; 
							var html=template("infolist",dataobj);
							document.getElementById("infolistdiv").innerHTML = html;
						}else{
							mui.toast('订单信息获取失败,请重试');
						}
						plus.nativeUI.closeWaiting();
					},
					error:function(xhr,type,errorThrown){ 
						plus.nativeUI.closeWaiting();
						mui.toast('保险信息获取失败,请重试');
					}
				});
			};
			loadfun();//加载方法
			document.addEventListener('refresh', function() {
				loadfun();//加载方法
			});
			
			window.tuipiaofun = function(){//点击申请退票
				plus.nativeUI.showWaiting('退票中 ...',{width:'100px',height:'80px'});
				mui.ajax(serverUrl+'/api/qianmi/trainorderrefund',{
					data:{orderNos:suborderstr},
					type:'post',
					timeout:10000,
					headers:{"token":oldToken},	              				
					success:function(data){
						console.log('退票',data);
						if(data.errno == 0){ 
							if(data.data.train_order_refund_response.result == 1){
								mui.fire(plus.webview.getWebviewById('TPRecord'),'refresh',{type:'train'});
								var timequxiao = setTimeout(function(){
									plus.webview.currentWebview().close();
								},500)
								mui.toast('退票成功');
							}else{ 
								plus.nativeUI.closeWaiting();
								mui.toast('取消失败,请重试');
							}
						}else{
							plus.nativeUI.closeWaiting();
							mui.toast('取消失败,请重试');
						}
					},
					error:function(xhr,type,errorThrown){ 
						plus.nativeUI.closeWaiting();
						mui.toast('取消失败,请重试');
					}
				});
			}
			window.zhifufun = function(){//点击支付
				if(mui('#zhuangtai')[0].innerText == '预定中'){
					mui.toast('还在预定中,请稍候尝试!');
					loadfun();//加载方法
				}else{
					openview({
						view:"payTickets.html",
						id:"payTickets",
						extrasobj:{body:body1,total_fee:total_fee1,Orderidnum:Orderid,Orderidfanhui:Orderidfanhui1}
					})
				}
				
			}
			window.quxiaofun = function(){//点击取消
				plus.nativeUI.showWaiting('取消中 ...',{width:'100px',height:'80px'});
				mui.ajax(serverUrl+'/api/qianmi/trainordercancel',{
					data:{tradeNo:Orderid},
					type:'post',
					timeout:10000,
					headers:{"token":oldToken},	              				
					success:function(data){
						if(data.errno == 0){ 
							if(data.data.train_order_cancel_response.result == 1){
								mui.fire(plus.webview.getWebviewById('TPRecord'),'refresh',{type:'train'});
								var timequxiao = setTimeout(function(){
									plus.webview.currentWebview().close();
								},500)
								mui.toast('取消成功');
							}else{
								plus.nativeUI.closeWaiting();
								mui.toast('取消失败,请重试');
							}
						}else{
							plus.nativeUI.closeWaiting();
							mui.toast('取消失败,请重试');
						}
					},
					error:function(xhr,type,errorThrown){ 
						plus.nativeUI.closeWaiting();
						mui.toast('取消失败,请重试');
					}
				});
				
			}
				
		})//read
	</script>

</html>