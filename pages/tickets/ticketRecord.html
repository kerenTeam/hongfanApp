<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>购票记录</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" href="../../css/reset.css"> 
		<script type="text/javascript" src="../../js/jquery.min.js"></script>  
		<script src="../../js/hmt.js" type="text/javascript"></script>
		<script src="../../js/mui.min.js" type="text/javascript"></script>
		<style type="text/css">
			.notice .tab-hd,.orderbh,dl.list dt, dl.list dd,dl.list{
				box-sizing: border-box;
				-webkit-box-sizing: border-box;
				overflow-y: hidden;
			}
			.notice .tab-bd .tab-pal{
				border-top: 1px solid #eee;
			}
			.notice .tab-bd .tab-pal dl{
				background-color: #efeff4;
			}
			.notice .tab-bd{
				padding-top: 10px;
			}
			.notice li.active{
				border-bottom: 2px solid red;
				box-sizing: border-box;
				color: red;
			}
			dl.list dt, dl.list dd, dl.list{
				margin-bottom: 10px;
				background-color: #fff;
				border: none!important;
			}
			dl.listtwo dd>.react{
				border-top: 1px solid #EFEFF4;
			}
			dl.listtwo dd{
				padding: 0;
			}
			.pricetwo{
				position: absolute !important;
				top: 0;
				right: 0;
				display: inline-block !important;
				text-align: right;
				line-height: 20px;
			}
			.react:last-child{
				margin-bottom: 0;
			}
			.state{
				color: #ff5601 !important;
				font-size: 12px !important;
			}
			.tab-hd{
				height: 41px !important;
				border-bottom: 1px solid #EFEFF4 !important;
			}
			.tab-nav li{
				height: 40px !important;
			}
			.tab-hdtwo{
				overflow-x: scroll;
				white-space: nowrap;
				background: none;
			}
			.notice .tab-hdtwo li {
				float: none!important;
			    width: 15.5%;
			    display: inline-block;
			    white-space: nowrap;
			    height: auto;
			    line-height: 40px !important;
		    }
		    ::-webkit-scrollbar {
				width: 0!important;
				opacity: 1!important;
			}
			.poi-name{
				word-break: break-all;
				white-space: normal;
				color: #32B16C;
				font-size: 14px;
			}
			/*Bjiang*/
			.ticketT{
				padding-left: 10px;
				font-size: 14px !important;
			}
			.gray{
				color: #999;
			}
			.big{
				font-size: 16px;
				margin-bottom: 15px;
			}
			.tiny{
				font-size: 12px;
				line-height: 18px;
			}
			.dark{
				color: #666;
			}
			.nothing{
				display: block;
				background-color: #EFEFF4;
				margin-top: 60px;
				text-align: center;
			}
			.nothing img{
				display: block;
				margin: 20px auto;
				width: 80px;
			}
			.nothing p{
				text-align: center;
			}
		</style>
	</head>
	<body>
		<header class="hasManyCity hasManyCitytwo" id="header">
			<a class="fl fanhui mui-action-back"><i class="iconfont icon-fanhui"></i></a>
			<div class="header-tit">
				购票记录
			</div>		
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div id="main"> 
			<div class="notice">
				<div class="tab-hd tab-hdtwo">
					<ul class="tab-nav">
					  <li class="active" onclick="ListRefresh(this,0)">预定中</li>
					  <li onclick="ListRefresh(this,1)">待支付</li>
					  <li onclick="ListRefresh(this,2)">已取消</li>
					  <li onclick="ListRefresh(this,3)">出票中</li>
					  <li onclick="ListRefresh(this,4)">已出票</li>
					  <li onclick="ListRefresh(this,5)">出票失败</li>
					</ul>
				</div>
				<div class="tab-bd">
					<div class="tab-pal">
						<dl class="list listtwo list-in" id="planeList">
							<dd id="test" style="background-color: #EFEFF4;"></dd>
							<!--<dd onclick="planRe()">
								<div class="orderbh box-s">
									<img src="../../img/tickets/p.png" style="width: 0.2rem;vertical-align: middle;" /><span class="ticketT black">机票</span>
									<span class="fr state"><span id="stateName"></span></span>
								</div>
								<a class="react mui-row">
									<div class="mui-col-sm-6 mui-col-xs-6">
										<p class="black big"><span id="startStation"></span>&nbsp;<span class="gray">→</span>&nbsp;<span id="recevieStation"></span></p>
									</div>
									<div class="mui-col-sm-6 mui-col-xs-6">
										<div class="pricetwo">
											<p class="black big">¥<span id="totalSalePrice"></span></p>
										</div>	
									</div>
									<div class="mui-col-sm-12 mui-col-xs-12">
										<p class="dark tiny"><span id="startTime"></span> <span id="startTime1"></span> - <span id="recevieTime"></span></p>
									</div>
									<div class="mui-col-sm-12 mui-col-xs-12">
										<p class="tiny">海南航空<span id="trainNo"></span></p>
									</div>
								</a>
							</dd>-->
							<!--<dd onclick="trainRe()">
								<div class="orderbh box-s">
									<img src="../../img/tickets/t.png" style="width: 0.2rem;vertical-align: middle;" /><span class="ticketT black">火车票</span>
									<span class="fr state">交易完成</span>
								</div>
								<a class="react mui-row">
									<div class="mui-col-sm-6 mui-col-xs-6">
										<p class="black big">成都&nbsp;<span class="gray">→</span>&nbsp;邻水</p>
									</div>
									<div class="mui-col-sm-6 mui-col-xs-6">
										<div class="pricetwo">
											<p class="black big">¥50</p>
										</div>	
									</div>
									<div class="mui-col-sm-12 mui-col-xs-12">
										<p class="dark tiny">2016-12-22 11:30 - 12:30</p>
									</div>
									<div class="mui-col-sm-12 mui-col-xs-12">
										<p class="tiny">车次 C56</p>
									</div>
								</a>
							</dd>-->
						</dl>
					</div>
					
				</div>
			</div>
		</div>
	</body>  
	<script src="../../js/app.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/artTemplate-native.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		//点击查看机票订单详情
		function planRe(tradeNoId){
			var tradeNo = $(tradeNoId).attr('id');
			alert(tradeNo);
			openview({
				view:'planeRecordDetail.html',
				extrasobj:{tradeNo:tradeNo}
			})
		}
		
		//点击查看火车票订单详情
		function trainRe(){
			openview({
				view:'trainRecord.html'
			})
		}
	</script>
	<script type="text/javascript">
	var orderNos = [];
		mui.plusReady(function(){
			var oldToken = plus.storage.getItem('oldToken'); 
			console.log(oldToken);
			var userid = plus.storage.getItem('userid'); 
			//加载订单 
			plus.nativeUI.showWaiting('加载中 ...', {width: '100px',height: '80px'});
			//获取用户千米网信息
			mui.ajax(serverUrl+'/api/qianmi/billorder',{
				data:{userid:userid,type:4},
				dataType:'json',
				type:'post',
				timeout:10000,
				headers:{"token":oldToken},	 
				success:function(data,type,xhr){ 
//					plus.nativeUI.closeWaiting(); 
//					alert(JSON.stringify(data.data));
					var dataobj=data.data;
					if(dataobj.length>0){
						for(var i=0;i<dataobj.length;i++){
							var tradeNo = JSON.parse(dataobj[i].data);
							if(!tradeNo.errorToken){
								var orderItem = tradeNo.air_order_create_response.ticketTrade.tradeNo;
								orderNos.push(orderItem);
							}
						}
						//初始进入获取"预定中"数据
						if(orderNos.length>0){
							for(var j=0;j<orderNos.length;j++){
								mui.ajax(serverUrl+'/api/qianmi/airorderslist',{
			//						data:{tradeNo:orderNos[j],startTime:'',endTime:'',sort:'desc',supUserId:'',pageNo:'',pageSize:'',orderStatus:orderStatus},
									data:{tradeNo:orderNos[j],startTime:'',endTime:'',sort:'desc',supUserId:'',pageNo:'',pageSize:'',orderStatus:0},
									dataType:'json',
									type:'post',
									timeout:10000,
									headers:{"token":oldToken},	 
									success:function(data,type,xhr){ 
										plus.nativeUI.closeWaiting(); 
//										alert(JSON.stringify(data.data.air_orders_list_response.ticketTrades.ticketTrade));
										var ticketTrade = data.data.air_orders_list_response.ticketTrades.ticketTrade;
										if(ticketTrade.length>0){
											for(var m=0;m<ticketTrade.length;m++){
		         								var stateName = ticketTrade[m].stateName;
												var startStation = ticketTrade[m].startStation;
												var recevieStation = ticketTrade[m].recevieStation;
												var startTime = ticketTrade[m].startTime.substring(11,ticketTrade[m].startTime.toString().Length-11);
												var startTime1  = ticketTrade[m].startTime.substring(11);
												var recevieTime = ticketTrade[m].recevieTime.substring(11);
												var totalSalePrice = ticketTrade[m].totalSalePrice;
												var trainNo = ticketTrade[m].trainNo;
												var tradeNo = ticketTrade[m].tradeNo;
												var planList = mui('#test')[0];
												planList.insertAdjacentHTML('beforebegin','<dd onclick="planRe('+'this'+')" class="listItem" id="'+tradeNo+'"><div class="orderbh box-s"><img src="../../img/tickets/p.png" style="width: 0.2rem;vertical-align: middle;" /><span class="ticketT black">机票</span><span class="fr state">'+stateName+'</span></div><a class="react mui-row"><div class="mui-col-sm-6 mui-col-xs-6"><p class="black big">'+startStation+'&nbsp;<span class="gray">→</span>&nbsp;'+recevieStation+'</p></div><div class="mui-col-sm-6 mui-col-xs-6"><div class="pricetwo"><p class="black big">¥'+totalSalePrice+'</p></div></div><div class="mui-col-sm-12 mui-col-xs-12"><p class="dark tiny">'+startTime+startTime1+'-'+recevieTime+'</p></div><div class="mui-col-sm-12 mui-col-xs-12"><p class="tiny">'+trainNo+'</p></div></a></dd>')
											}
										}else{
											var planList = mui('#test')[0];
											$('#test').html('<div class="nothing listItem" style="background-color: #EFEFF4;margin-top: 60px;"><img src="../../img/market/order.png" style="display: block;margin: 20px auto;width: 80px;"/><p style="text-align: center;">该状态不存在订单！</p></div>');
										}
									},
									error:function(xhr,type,errorThrown){
			//							plus.nativeUI.closeWaiting()
										console.log('响应失败  !');
									}
								});
							}
						}else{
							var planList = mui('#test')[0];
							planList.insertAdjacentHTML('beforebegin','<div class="nothing listItem" style="background-color: #EFEFF4;margin-top: 60px;"><img src="../../img/market/order.png" style="display: block;margin: 20px auto;width: 80px;"/><p style="text-align: center;">该状态不存在订单！</p></div>')
							
						}
						
						//点击切换查询飞机票订单列表
						window.ListRefresh = function(thisStatus,orderStatus){
							plus.nativeUI.showWaiting('加载中 ...', {width: '100px',height: '80px'});
							$(thisStatus).addClass('active');
							$(thisStatus).siblings().removeClass('active');
							$(thisStatus).parents('.notice').find('.listItem').remove();
//							alert(orderStatus);
							if(orderNos.length>0){
								for(var j=0;j<orderNos.length;j++){
									mui.ajax(serverUrl+'/api/qianmi/airorderslist',{
				//						data:{tradeNo:orderNos[j],startTime:'',endTime:'',sort:'desc',supUserId:'',pageNo:'',pageSize:'',orderStatus:orderStatus},
										data:{tradeNo:orderNos[j],startTime:'',endTime:'',sort:'desc',supUserId:'',pageNo:'',pageSize:'',orderStatus:orderStatus},
										dataType:'json',
										type:'post',
										timeout:10000,
										headers:{"token":oldToken},	 
										success:function(data,type,xhr){ 
											plus.nativeUI.closeWaiting(); 
	//										alert(JSON.stringify(data.data.air_orders_list_response.ticketTrades.ticketTrade));
											var ticketTrade = data.data.air_orders_list_response.ticketTrades.ticketTrade;
											if(ticketTrade.length>0){
												for(var m=0;m<ticketTrade.length;m++){
			         								var stateName = ticketTrade[m].stateName;
													var startStation = ticketTrade[m].startStation;
													var recevieStation = ticketTrade[m].recevieStation;
													var startTime = ticketTrade[m].startTime.substring(11,ticketTrade[m].startTime.toString().Length-11);
													var startTime1  = ticketTrade[m].startTime.substring(11);
													var recevieTime = ticketTrade[m].recevieTime.substring(11);
													var totalSalePrice = ticketTrade[m].totalSalePrice;
													var trainNo = ticketTrade[m].trainNo;
													var tradeNo = ticketTrade[m].tradeNo;
													var planList = mui('#test')[0];
													planList.insertAdjacentHTML('beforebegin','<dd onclick="planRe('+'this'+')" class="listItem" id="'+tradeNo+'"><div class="orderbh box-s"><img src="../../img/tickets/p.png" style="width: 0.2rem;vertical-align: middle;" /><span class="ticketT black">机票</span><span class="fr state">'+stateName+'</span></div><a class="react mui-row"><div class="mui-col-sm-6 mui-col-xs-6"><p class="black big">'+startStation+'&nbsp;<span class="gray">→</span>&nbsp;'+recevieStation+'</p></div><div class="mui-col-sm-6 mui-col-xs-6"><div class="pricetwo"><p class="black big">¥'+totalSalePrice+'</p></div></div><div class="mui-col-sm-12 mui-col-xs-12"><p class="dark tiny">'+startTime+startTime1+'-'+recevieTime+'</p></div><div class="mui-col-sm-12 mui-col-xs-12"><p class="tiny">'+trainNo+'</p></div></a></dd>')
												}
											}else{
												var planList = mui('#test')[0];
											$('#test').html('<div class="nothing listItem" style="background-color: #EFEFF4;margin-top: 60px;"><img src="../../img/market/order.png" style="display: block;margin: 20px auto;width: 80px;"/><p style="text-align: center;">该状态不存在订单！</p></div>');
											}
										},
										error:function(xhr,type,errorThrown){
				//							plus.nativeUI.closeWaiting()
											console.log('响应失败  !');
										}
									});
								}
							}else{
								var planList = mui('#test')[0];
								planList.insertAdjacentHTML('beforebegin','<div class="nothing listItem" style="background-color: #EFEFF4;margin-top: 60px;"><img src="../../img/market/order.png" style="display: block;margin: 20px auto;width: 80px;"/><p style="text-align: center;">该状态不存在订单！</p></div>')
								
							}
						}
					}
				},
				error:function(xhr,type,errorThrown){
					plus.nativeUI.closeWaiting()
					console.log('响应失败  !');
				}
			});
		})
	</script>
</html>
