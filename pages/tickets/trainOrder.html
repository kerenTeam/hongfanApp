<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>火车票订单</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" href="../../css/reset.css">
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script type="text/javascript" src="../../js/mui.min.js"></script>
		<!--<script type="text/javascript" src="../../js/jquery.flexslider-min.js"></script>-->
		<!--<script src=" ../../js/hmt.js" type="text/javascript"></script>-->
		<!--<script src="../../js/other.js" type="text/javascript" charset="utf-8"></script>-->
		<script src="../../js/app.js" type="text/javascript" ></script>
		<!--引入模板引擎-->
		<script src="../../js/artTemplate-native.js" type="text/javascript" ></script>
		<style type="text/css">
			.mui-bar{
				height: 50px;
				box-shadow: none;
			}
			.mui-title,.mui-icon{
				line-height: 50px;
			}
			.mui-bar .mui-icon{
				padding: 0;
			}
			#main{
				margin-top: 50px;
			}
			
			.guess-like,dl.list{
				border-bottom: 1px solid #eee;
				background-color: #EFEFF4;
			}
			.right{
				text-align: right;
			}
			.middle{
				text-align: center;
			}
			.strong-color{
				color: #f53c42 !important;
			}
			.Lgray{
				font-size: 12px !important;
				color: #999 !important;
				margin-top: 14px;
			}
			.mui-badge-blue, .mui-badge-primary{
				background-color: #fff;
				border: 1px solid #999;
				color: #999 !important;
			}
			
			.moreone{
				line-height: 50px;
			}
			dl.list .db>.react{
				padding: 0;
				margin: 0;
			}
			dl.list .db{
				height: 50px;
			}
			.grade-eject>ul>li, .Category-eject>ul>li, .Sort-eject>ul>li{
				line-height: 40px;
			}
			
			/*这一页*/
			.timeBox{
				position: relative;
			}
			.timeBox p{
				font-size: 24px;
				color: #333;
				line-height: 22px;
			}
			.timeBox .ad{
				font-size: 12px;
				color: #999;
				font-weight: normal;
				line-height: 24px;
			}
			.timeBox .bage{
				position: absolute;
				font-size: 12px;
				line-height: 10px;
				right: 15px;
				top: 10px;
				color: #666;
			}
			.price{
				text-align: right;
				font-size: 24px;
				color: #f53c42;
			}
			.airTip p{
				text-align: right;
				line-height: 40px !important;
			}
			.Achange {
				color: #333;
			}
			.Achange span{
				color: #ff5601;
				font-size: 14px !important;
			}
			.inputWrap{
				border: none;
				border-radius: 3px;
				color: #666;
				line-height: 50px;
				background-color: rgba(255,255,255,0.8);
				margin: 10px 0;
			}
			.ad img{
				width: 15%;
				margin-top: -3px;
			}
			.dot{
				background-color: #bfbfbf;
				width: 5px;
				height: 5px;
				padding: 4px;
				margin: 0 5px;
				border-radius: 50%;
				display: inline-block;
			}
			.line{
				width: 3px;
				height: 12px;
				position: absolute;
				left: 8px;
				top: 42px;
				background-color: #ddd;
			}
			.guess-like{
				padding:50px 0;
			}
			.react >div{
				line-height: 50px !important;
			}
			.airTip button{
				margin-left: 15px !important;
				background-color: #f53c42;
				color: #fff;
				border: none;
			}
			.hLeft{
				text-align: right;
			}
			.hMiddle{
				text-align: center;
			}
			.hRight{
				text-align: left;
			}
			.head{
				background-color: #dcd5d5;
			}
			dl.list {
				border-top: none;
				margin-top: 10px; 
			}
			.react{
				padding: 0 .15rem !important;
			}
			dl.list dt, dl.list dd{
				background-color: #fff;
			}
			.lineL{
				border-left: 1px solid #EFEFF4;
			}
			.phone{
				border: none;
			}
			dl.list dt, dl.list dd{
				border-bottom: 1px solid #EFEFF4;
			}
			.toLine{
				width: 60%;
				height: 1px;
				margin: 10px 20%;
				background-color: #000;
			}
			.tiny{
				font-size: 12px;
				line-height: 14px;
				margin-top: -5px;
				margin-bottom: 10px;
			}
			.addMan{
				background-color: #ffc900;
				border: none;
				color: #fff;
				margin-top: 10%;
				line-height: 24px;
				font-size: 15px;
				margin-left: 15%;
			}
			.delete{
				width: 90%;
				margin-top: 15px;
			}
			/*header样式*/
			.mui-col-sm-11 p,.mui-col-xs-11 p{
				/*padding-left: 10px;
			}
			.mui-bar-nav {
				background-color: #FFF !important;
			}
			.hasManyCitytwo .header-tit{
				color: #333;
			}
			.hasManyCitytwo .fanhui{
				color: #333;
			}*/
			.footerone .left{
				width: 60%;
			}
			.footerone p{
				text-align: left;
				font-size: 16px;
				text-indent: 15px;
				line-height: .5rem;
			}
			.red1{
				color: #f53c42;
			}
			.footerone .right{
				width: 40%;
			}
			.footerone .right .btn {
				 width: 100%; 
			}
			.gray{
				color: #999;
			}
			.mui-checkbox input[type=checkbox]:before, .mui-radio input[type=radio]:before{font-size: 18px;color: red !important;}
			.baoxian:after{
				content: '';
				display: block;
				height: 1px;
				background-color: #eee;
				-webkit-transform: scaleY(.5);
			}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav hasManyCity hasManyCitytwo">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize fl fanhui"></a>
		    <div class="header-tit">
				火车票订单
			</div>
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div class="guess-like">
			<div class="head" style="min-height: 50px;">
				<div class="mui-row">
				    <div class="mui-col-sm-4 mui-col-xs-4 hLeft">
						<div class="timeBox">
							<p class="ad black" id="Tfrom"></p>
							<p id="Stime"> </p>
							<p class="ad black" id="Sdate"></p>
						</div>
			       	</div>
			        <div class="mui-col-sm-4 mui-col-xs-4 hMiddle">
			        	<div class="timeBox">
							<p class="ad black" id="Tname"></p>
							<div class="toLine"></div>
							<p class="ad black" id="tuntime"></p>
						</div>
			        </div>
			         <div class="mui-col-sm-4 mui-col-xs-4 hRight">
						<div class="timeBox">
							<p class="ad black" id="End"></p>
							<p id="Etime"> </p>
							<p class="ad black" id="Edate"></p>
						</div>
			       	</div>
				</div>
			</div>
			<dl class="list" id="goodsList">
				<dd class="goodsItem"    style="min-height: 40px;">
					<a class="react mui-row">
						<div class="mui-col-sm-2 mui-col-xs-2">
							<p id="Ttype"> </p>
				       </div>
				        <div class="mui-col-sm-10 mui-col-xs-10">
				        	<p class="black" id="Tprice"></p>
				        </div>
					</a>
				</dd>
			</dl>
			<dl class="list" id="goodsList">
				<dd class="goodsItem">
					<a class="react mui-row">
						<div class="mui-col-sm-8 mui-col-xs-8">
							<p class="black">添加乘车人 </p>
							<p class="tiny">请确保姓名证件填写正确</p>
				       </div>
				        <div class="mui-col-sm-4 mui-col-xs-4">
				        	<button class="addMan" onclick="addPerson()">添加乘车人</button>
				        </div>
					</a>
				</dd>
				<dd class="goodsItem"  id="persons">
					<!--<a class="react mui-row">
						<div class="mui-col-sm-1 mui-col-xs-1">
							<img src="../../img/tickets/delete.png" class="delete"/>
				       	</div>
				        <div class="mui-col-sm-11 mui-col-xs-11">
				        	<p class="black">柯南</p>
				        	<p class="tiny black">身份证&nbsp;51245781466666666</p>
				        </div>
					</a>-->
				</dd>
			</dl>
			<dl class="list" id="goodsList">
				<dd class="goodsItem">
					<a class="react mui-row">
						<div class="mui-col-sm-3 mui-col-xs-3">
							<p class="black">订票人 </p>
				       </div>
				        <div class="mui-col-sm-9 mui-col-xs-9">
				        	<input style="font-size: 14px;" type="" name="" id="Orderpeople" placeholder="请输入订票人" value="" class="phone"/>
				        </div>
					</a>
				</dd>
				<dd class="goodsItem">
					<a class="react mui-row">
						<div class="mui-col-sm-3 mui-col-xs-3">
							<p class="black">联系手机 </p>
				        </div>
				        <div class="mui-col-sm-9 mui-col-xs-9">
				        	<input style="font-size: 14px;" type="" name="" id="Orderphone" placeholder="请输入手机号" value="" class="phone"/>
				        </div>
					</a>
				</dd>
			</dl>
			<dl class="list" id="goodsList">
				<dd class="goodsItem">
					<a class="react mui-row" id="infolistdiv" style="display: none;"></a>
					<script type="text/html" id="infolist">
						<% for(var i=0; i<list.length; i++){%>
							<div class="mui-input-row mui-radio mui-left baoxian" onclick="baoxianfun(<%= list[i].itemId%>)">
								<label style="padding-left: 23px;"><%= list[i].itemName%></label>
								<% if(list[i].Rcheak){%>
									<input name="radio1" type="radio" checked style="top: 10px;left: -1px;">
								<% }else{%>
									<input name="radio1" type="radio" style="top: 10px;left: -1px;">
								<% }%>	
							</div>
						<% }%>	
					</script>	
					
				</dd>
			</dl>
			<dl class="list LastList" id="goodsList">
				<dd class="goodsItem">
					<a class="react mui-row">
				        <div class="">
				        	<h5 style="margin: 10px;margin-left: -2px;color: #000;">购票须知</h5>
				        	<p id="changeStipulate" style="line-height: 20px;font-size: 12px;margin: 10px 0;">
				        		  1.火车票相关业务处理时间为8:00-22:00。 <br />
							      2.发车前4小时以内退款不做处理，请自行去火车站退票。 <br />
							      3.不受理改签业务，需用户自行在发车前去车站办理 。<br />
							      4.火车票新版上线，支持购买卧铺票、硬座，不支持指定无座。 <br />
							      5.禁止代理商向用户收取票面价格以外的手续费。 <br />
							      6.提交订单时如提示身份证待核验，乘车人需带二代身份证到火车站通过身份认证才能网上购票。 <br />
				        	</p>
				        </div>
					</a>
				</dd>
			</dl>
			
		</div>
		<!--footerone star-->
		<div class="footerone clearfloat" style="line-height: .5rem;padding-left: 15px;">
			<div class="left">
				<p class="red1"><sub style="color: red;">￥</sub><span style="color: red;" id="subPrice">0</span><sub class="gray">（共<span id="subPerson">0</span>人）</sub></p>
			</div>
			<div class="right ">
                <a class="btn btnone fl" id="purchase" style="float: right;">立即购买</a>
			</div>
		</div>
		<!--footerone end-->
	</body>
	<script type="text/javascript">
		
		mui.plusReady(function(){
			var settlePrice;//票价
			var bookingstr = '';
			var baoxianid;//保险编号
			var reg_phone = /^1((3|4|5|8|7){1}\d{1}|70)\d{8}$/;//手机号正则
			var oldToken = plus.storage.getItem('oldToken');
			var userid = plus.storage.getItem('userid');
			//获取上页面数据,并显示
			var details1 = plus.webview.currentWebview().details;  
			mui('#Tfrom')[0].innerHTML = details1.from;
			mui('#Stime')[0].innerHTML = details1.Stime;
			mui('#Tname')[0].innerHTML = details1.name;
			mui('#tuntime')[0].innerHTML = details1.runtime;
			mui('#End')[0].innerHTML = details1.End;
			mui('#Etime')[0].innerHTML = details1.Etime;
			mui('#Ttype')[0].innerHTML = details1.type;
			mui('#Tprice')[0].innerHTML = settlePrice = details1.Price;
			mui('#Sdate')[0].innerHTML = details1.Sdate + details1.Sweek;
			mui('#Edate')[0].innerHTML = details1.Edate + details1.Eweek;
			
//			plus.nativeUI.showWaiting('加载中 ...',{width:'100px',height:'80px'});
			mui.ajax(serverUrl+'/api/qianmi/traininsurslist',{//获取保险信息
				type:'post',
				timeout:10000,
				headers:{"token":oldToken},	              				
				success:function(data){
					console.log(data);
					console.log('保险返回'+JSON.stringify(data));
					if(data.errno == 0){
						var dataobj = {};
						dataobj.list = data.data.train_insurs_list_response.items.item; 
						if(dataobj.list.length > 3){
							dataobj.list.length = 3;
						}
						console.log(dataobj.list);
						dataobj.list[0].Rcheak = 'cheak';//第一个默认选中
						baoxianid = dataobj.list[0].itemId;//默认保险编号 
						var html=template("infolist",dataobj);
						document.getElementById("infolistdiv").innerHTML = html; 
					}else{
						mui.toast('保险信息获取失败,请重试');
					}
					plus.nativeUI.closeWaiting();
				},
				error:function(xhr,type,errorThrown){
					plus.nativeUI.closeWaiting();
					mui.toast('保险信息获取失败,请重试');
				}
			});
			window.baoxianfun = function(itemid){//获取保险标号
				baoxianid = itemid;//点击更换保险标号		
			}
			
			document.addEventListener('refreshPerson', function(obj) {//从添加乘机人获取的详情
				var newName = obj.detail.newName;
				var idNo=obj.detail.idNo;
				var phonenum=obj.detail.phonenum;
				var persons = document.getElementById('persons');
				//组乘客信息
				if(!bookingstr){//如果为空
					bookingstr += newName +'!'+ phonenum +'!'+ idNo +'!'+ details1.type;
				}else{
					bookingstr += '@@' + newName +'!'+ phonenum +'!'+ idNo +'!'+ details1.type;
				}
				persons.insertAdjacentHTML('beforebegin', '<dd class="goodsItem" id="persons"><a class="react mui-row aPerson"><div class="mui-col-sm-1 mui-col-xs-1"><img src="../../img/tickets/delete.png" class="delete" onclick="deletePerson(this)"/></div><div class="mui-col-sm-11 mui-col-xs-11"><p class="black">'+newName+'</p><p class="tiny black">身份证&nbsp;'+idNo+'</p></div></a></dd>'); 
				//重新计算人数和价格
				var acountP = $('.aPerson').length;
				$('#subPerson').html(acountP);
				var numnum = settlePrice.split('￥')[1];
				var newPrice = numnum*acountP;//总价计算
				$('#subPrice').html(newPrice);
			})
			
			window.deletePerson = function(thisP){//点击删除，删除乘机人
				mui.confirm('确认删除该乘车人？','',['取消','确认'],function (e) {
					if(e.index == 1) { 
						$(thisP).parents('.aPerson').remove();
						//重新计算人数和价格
						var acountP = $('.aPerson').length;
						$('#subPerson').html(acountP);
						var numnum = settlePrice.split('￥')[1];
						var newPrice = numnum*acountP;//总价计算
						$('#subPrice').html(newPrice);
					}
				})
			}
			
			
			
			mui('#purchase')[0].onclick = function(){//立即购买
				
				var acountP = $('.aPerson').length;
				var Orderpeople = mui('#Orderpeople')[0].value;
				var Orderphone = mui('#Orderphone')[0].value;
				
				if(!acountP || acountP == undefined){
					mui.toast('至少添加一位乘客');
				}else if(!Orderpeople){
					mui.toast('请输入订票人姓名');
					mui('#Orderpeople')[0].focus();
				}else if(!reg_phone.test(Orderphone)){
					mui.toast('请输入正确的手机号');
					mui('#Orderphone')[0].focus();
				}else{//开始支付
					plus.nativeUI.showWaiting('加载中 ...',{width:'100px',height:'80px'});
					mui.ajax(serverUrl+'/api/qianmi/trainitemslist',{//获取标号
						type:'post',
						timeout:10000,
						headers:{"token":oldToken},	              				
						success:function(data,type,xhr){
							console.log(data);
							console.log('获取标号'+JSON.stringify(data));
							if(data.data.train_items_list_response.items.item[0].itemId){
								var gradenum = data.data.train_items_list_response.items.item[0].itemId;//标号
								mui.ajax(serverUrl+'/api/qianmi/trainordercreate',{//开始预定
									data:{
										userid:userid,
										from:details1.from,
										to:details1.End,
										date:details1.timeall,
										trainNumber:details1.name,
										itemIdInsur:9200601,//保险编号
										contactName:Orderpeople,
										contactTel:Orderphone,
										passagers:bookingstr,
										itemIdTrain:gradenum,
										startTime:details1.Stime
									},
									type:'post',
									timeout:10000,
									headers:{"token":oldToken},	              				
									success:function(data,type,xhr){
										console.log('预定返回'+JSON.stringify(data));
										console.log(data);
										if(data.errno == 0){
											console.log('预定',data); 
											if(data.data.body.subErrors){
												plus.nativeUI.closeWaiting();
												mui.toast(data.data.body.subErrors[0].message);
											}else{
//												var TorderD = data.data.body.train_order_create_response.ticketTrade; 
												var Tordernum11 = data.data.body.train_order_create_response.ticketTrade.tradeNo;
												var Orderidfanhui2 = data.data.new_qianmi_order_id;
												openview({
													view:'trainRecord.html',
													id:'trainRecord',
													extrasobj:{Tordernum:Tordernum11,Orderidfanhui:Orderidfanhui2}
												})
											}
										}else{
											plus.nativeUI.closeWaiting();
											mui.toast('预定失败,请重试');
										}
										
									},
									error:function(xhr,type,errorThrown){
										plus.nativeUI.closeWaiting();
										mui.toast('预定失败,请重试'); 
									}
								});
							}
						},
						error:function(xhr,type,errorThrown){
							plus.nativeUI.closeWaiting();
							mui.toast('预定失败,请重试'); 
						}
					});
				}
			}
			window.addPerson = function(){//添加联系人
				openview({ 
					view:'trainAddPerson.html'
				})
			}
		});//ready
	</script>
</html>