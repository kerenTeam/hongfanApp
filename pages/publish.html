<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>发布发现</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes"> 
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../css/common.css">
		<link rel="stylesheet" type="text/css" href="../css/index.css">
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<link rel="stylesheet" href="../css/reset.css">
		<link rel="stylesheet" href="../css/one.css">
		<link rel="stylesheet" type="text/css" href="../css/find.css" />
		

	</head>
	<style type="text/css">
		#imgUpload {
			display: none;
			width: 0;
		}
		#preview{
			width: 30%;
		}
		.ptet {
			font-size: 12px;
			border: none;
		}
		label {
			vertical-align: top;
			width: calc((100% - 20px) * 2 / 5);
			width: -moz-calc((100% - 20px) * 2 / 5);
			width: -webkit-calc((100% - 20px) * 2 / 5);
		}
		.ptet {
			width: calc((100% - 20px) * 3 / 5);
			width: -webkit-calc((100% - 20px) * 3 / 5);
			width: -moz-calc((100% - 20px) * 3 / 5);
		}
		.publishf {
			padding: 10px;
		}
		.addbg {
			padding: 0 10px;
		}
		.mui-badge {
			padding: 5px 10px;
			margin: 5px;
			background: #eee;
		}
		.mui-badge:not(:last-child) {
			color: palevioletred;
		}
		.location {
			padding: 20px;
			border-top: 10px solid #EEEEEE;
		}
		.location img {
			width: 0.3rem;
			margin-right: 10px;
		}
		.addbgs {
			margin-right: 2px;
			color: coral;
			padding: 0 2px;
		}
		.disbg {
			border: none;
			padding: 0;
			font-size: 0.13rem;
			/*margin: 0 10px;*/
			min-height: 30px;
			line-height: 1.2;
		}
	 	/*图片上传*/
    	*{margin: 0;padding: 0;box-sizing: border-box;}
    	.clearfix:after {content: ""; display: block; clear:both;}
    	.uppics{text-align: center;background-color: #fff;padding: 10px;}
    	.uppics div.onepic{padding: 0 !important;font-size: 14px;}
	    .uppics div.onepic img{width: 90%;}
	    .uppics div.onepic input{width: 0;height: 0;position: absolute;outline: none;}
	    #uppics2 div.onepic{display: inline-block;width: 120px;#uppics2 div.onepicvertical-align: middle;position: relative;text-align: center;padding: 10px;
	    margin-right: 6px;float: left;} 
	    #uppics2 .onepic{width: 120px;}
	    #uppics2 .picimg{width: 100%;}
	    .picimg1{width: 25px;position: absolute;right: 0px;top: 2px;}
	    /*图片上传结束*/
	 
	</style>

	<body>

		<header class="mui-bar mui-bar-nav" id="header">
			<a class="mui-icon mui-pull-left bigSize back" style="font-size: 0.14rem;">取消</a>
			<h1 class="mui-title findUser">发布</h1>
			<a href="javascript:;" style="line-height: 50px;color:#666;" class="fr baocun">发送</a>
		</header>
		<script src="../js/statusBar.js"></script><!--状态栏-->
		
		<div id="main">
			<div class="publishf clearfix"> 
				<div class="<!--ptet fr-->">
					<div class="apsan"></div>
					<textarea id="textCon" class="disbg" rows="5" placeholder="点击输入 文字，心情，胡思乱想。。。"></textarea>
 
				</div>
			</div>
			<style type="text/css">
				.biaoqian span{
					padding: 8px 11px;
					margin: 3px;
					display: inline-block;
					background-color: #eee;
					border-radius: 1px;					
				}
				.biaoqian span.active{background-color: #ea4242;color: #fff;}  
			</style>
			<div id="mainpic" class="biaoqian">
			 
			</div>
			<script type="text/html" id="infolist">
				<%for(var i=0;i<list.length;i++){%>
					<span id="<%=list[i].tag_id%>" onclick="spanclick(this)">
					#<%=list[i].tagName%>#
				</span>
				<%}%>
			</script>
			<div class="uppics clearfix" id="uppics2"> 
		        <div class="onepic">
		            <!--<input type="file" id="file_input"/>--> 
		            <img id="nowpic" src="../img/publisf.svg">
		        </div> 
		    </div> 
		    
			<!--地理定位-->
			<div class="location">
				<img src="../img/location.svg" alt="" /><span id="mapAddress">我的位置</span>
				<div class="fr">
					<span></span>
					<div class="mui-switch mui-switch-mini">
						<div class="mui-switch-handle"></div>
					</div>
				</div>
			</div>
			 
		</div>
			<div id="publishInfo" style="color: coral;padding: 15px;font-size: 0.13rem;">
				发帖声明
			</div>
			<div id="" style="color: gray;line-height: 1.5;padding: 10px;">
				Hi集提倡：
1. 分享、互助和开放的内容； 
2. 宽容和理性地对待不同的看法、喜好和意见； 
3. 尊重他人的隐私和个人空间。 

Hi集不欢迎: 
1. 针对种族、国家、民族、宗教、性别、年龄、地缘、性取向、生理特征的歧视和仇恨言论； 
2. 不雅词句、人身攻击、故意骚扰和恶意使用； 
3. 色情、激进时政、意识形态方面的话题。 

Hi集不允许: 
1. 违反中国或Hi集会员所在地法律法规的行为和内容（相关政策法规）； 
2. 威胁他人或Hi集会员自身的人身安全、法律安全的行为； 
3. 对网站的运营安全有潜在威胁的内容。 

Hi集管理员的指导原则：
1. 管理员有责任和义务及时删除Hi集不欢迎、不允许的内容； 
2. Hi管理员不参与处理用户之间私下话题之间的争执事项； 
3. Hi集不允许的内容管理人员有责权介入；
4. 发布的主题或主要内容属于Hi集不欢迎、不允许的范围，将被直接删除。

用户管理细则 
使用Hi集你需要了解的 ：
1. 你的行为和发布的内容应该符合Hi集的指导原则； 
2. 管理员有权利删除违反原则的内容；
3. 帐号发布含有违反相关法律法规或管理规定的内容，将被停用。停用期间的帐号无法发表和编辑
   任何内容，停用期结束后，帐号使用恢复正常。
有下列行为，账号立即停用： 
1. 群发广告、恶意刷屏、使用程序操作、冒充其他用户、滥用行为；
2. 遇到特殊情况或政府相关机构要求时，Hi集保留直接停用或注销帐号的权利。 

图片政策 
上传照片或图片前你需要了解的 ：
1. 请勿上传涉及他人隐私、淫秽色情、暴力、血腥、 违反国家法律法规及可能对APP运营带来潜在威胁的照片或图片； 
2. 你需要对所上传的照片或图片版权负责， APP不承担因此带来的任何第三方责任及法律风险； 
3. 违反使用规则的内容以及根据用户据实投诉， Hi集有可能删除你发布的内容，并保留对你帐户的
  处理权利； 
4. 本规则适用于Hi集APP的所有图片。

			</div>
	</body>
<script type="text/javascript" src="../js/jquery.min.js"></script>
<script src="../js/mui.min.js"></script>
<script src="../js/app.js"></script> 
<script src="../js/common.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/image-new.js" type="text/javascript" charset="utf-8"></script>
<!--引入模板引擎-->
<script src="../js/artTemplate-native.js"></script>
<script type="text/javascript">
	//选择图片
	var Apic = [];//图片存放数组 
	var qid;
	mui.plusReady(function() {
		qid=plus.webview.currentWebview().qqid;
		mui('#nowpic')[0].addEventListener('tap',function(){
			plus.nativeUI.actionSheet({
					cancel: "取消",
					buttons: [{
						title: "相册选择"
					}, {
						title: '拍照'
					}]
				},
				function(e) {
					if (e.index == 1) { //点击从相册选择
						galleryImgsSelected();
					} else if (e.index == 2) {
						getImage();
					}
				}
			);
		})
		var oldtoken = plus.storage.getItem('oldToken');
		
		mui.ajax(serverUrl+'/api/news/tags',{//请求id列表
			dataType:'json',
			type:'post',
			timeout:10000,
			headers:{"token":oldtoken},
			success:function(data,type,xhr){ 
				console.log('列表',data);
				if(data.errno==0){
					var dataobj = {};
					if(data.data.length){
						 
						dataobj.list = data.data;
						mui('#mainpic')[0].innerHTML = template('infolist',dataobj);
						console.log(template('infolist',dataobj))
					} 
				}else{
					mui.toast('当前网络不好，请重试！');	
				}
				plus.nativeUI.closeWaiting();
			},
			error:function(xhr,type,errorThrown){
				plus.nativeUI.closeWaiting(); 
				mui.toast('当前网络不好，请重试！');
				console.log('登录响应失败');
			}
		});
		 
		function getImage(){//拍照并保存
			var cmr = plus.camera.getCamera();
			cmr.captureImage( function ( path ) {
				plus.io.resolveLocalFileSystemURL(path,function(entry){ 
					//把拍摄图片的路径转化成 本地文件url
					path = plus.io.convertLocalFileSystemURL(path);
					if(0!=path.indexOf("file://")){
						path="file://"+path;
					} 
		    		var nowpic = Math.random().toString(36).substr(2) + '.jpg';
		    		var endpic = path.split('.')[0]+"/"+nowpic;
		    		console.error(path);
		    		console.error(endpic);
					plus.zip.compressImage({//压缩方法
						src:path,
						dst:endpic,
						overwrite:true,
						quality:30
					},
					function() { 
						showImg(endpic);
						Apic = [];
						Apic.push(endpic); 
					},function(error) {
						mui.toast('图片获取错误，请重试'); 
					}); 
					//无压缩
					//showImg(path);
					//Apic = [];
					//Apic.push(path);
					//plus.gallery.save( path ); 
				});
			}, function ( e ) { 
			}, {filename:"_doc/gallery/",index:1} );
		}
		//var lfs=null;// 保留上次选择图片列表
		function galleryImgsSelected(){//从相册中选择图片
		    plus.gallery.pick( function(e){
		    	lfs=e.files;
		    	for(var i in e.files){
		    		if(0!=e.files[i].indexOf("file://")){
						e.files[i]="file://"+e.files[i];
					} 
		    		var nowpic = Math.random().toString(36).substr(2) + '.jpg';
		    		var endpic = e.files[i].split('.')[0]+"/"+nowpic;
		    		console.error(e.files[i]);
		    		console.error(endpic);
		    		plus.zip.compressImage({//压缩方法
						src:e.files[i],
						dst:endpic,
						overwrite:true,
						quality:30
					},
					function() {
						showImg(endpic);
						Apic = []; 
						Apic.push(endpic);
					},function(error) {
						mui.toast('图片获取错误，请重试');  
					});
					//无压缩 
			    	//showImg(e.files[i]);
			    	//Apic = []; 
					//Apic.push(e.files[i]);
		    	}
		    }, function ( e ) {  
//		    },{filter:"image",multiple:true,maximum:1,selected:lfs,system:false,onmaxed:function(){//保存选择记录
		    },{filter:"image",multiple:true,maximum:2,system:false,onmaxed:function(){
				plus.nativeUI.alert('只能选择1张图片');  
		    }});
		}
		function showImg(url){//显示图片
			if(0!=url.indexOf("file://")){        
				url="file://"+url;  
			}
			mui('#nowpic')[0].src = url;    
		} 
}); 
	//选择图片结束
	
	function spanclick(obj){ 
		console.log(obj)
		if(obj.className == 'active'){ 
			obj.className = '';
		}else{
			obj.className = 'active';
		}
	}
	mui.plusReady(function() {
		//返回提示
		$(".back").on("tap", function() {
			var btnArray = ['否', '是'];
			mui.confirm('确定取消吗？', '提示', btnArray, function(e) {
				if(e.index == 1) {
					mui.back()
				} else {}
			})
		})
		
		//地图定位
		var watchId;
		function geoInf(position) {
			var str = "";
			str += "地址：" + position.addresses + "\n"; //获取地址信息
			str += "坐标类型：" + position.coordsType + "\n";
			var timeflag = position.timestamp; //获取到地理位置信息的时间戳；一个毫秒数；
			str += "时间戳：" + timeflag + "\n";
			var codns = position.coords; //获取地理坐标信息；
			var lat = codns.latitude; //获取到当前位置的纬度；
			str += "纬度：" + lat + "\n";
			var longt = codns.longitude; //获取到当前位置的经度
			str += "经度：" + longt + "\n";
			var alt = codns.altitude; //获取到当前位置的海拔信息；
			str += "海拔：" + alt + "\n";
			var accu = codns.accuracy; //地理坐标信息精确度信息；
			str += "精确度：" + accu + "\n";
			var altAcc = codns.altitudeAccuracy; //获取海拔信息的精确度；
			str += "海拔精确度：" + altAcc + "\n";
			var head = codns.heading; //获取设备的移动方向；
			str += "移动方向：" + head + "\n";
			var sped = codns.speed; //获取设备的移动速度；
			str += "移动速度：" + sped;
			console.log(JSON.stringify(position));
			longitude = (position.coords.longitude).toFixed(6);
			latitude = (position.coords.latitude).toFixed(6);
			$('#mapAddress').html(position.addresses);
			
		}
		// 通过定位模块获取位置信息
		function getGeocode() {
			plus.geolocation.getCurrentPosition(geoInf, function(e) {
				mui.toast("获取定位位置信息失败：" + e.message);
			}, {
				geocode: true,
				provider: 'amap'
			});
		}
		//是否显示位置
		$('.mui-switch').click(function() {
			if($(this).hasClass("mui-active")) { 
				getGeocode();
			} else {
				$('#mapAddress').html("我的位置") 
			}
		})
	})//plusready
	
	 
	
	//发送 发布
	mui('.baocun')[0].addEventListener('tap',function(){ 
		var tagstr = ' ';
		mui.each(mui('.biaoqian')[0].getElementsByClassName('active'),function (index,element) {
			if(index == mui('.biaoqian')[0].getElementsByClassName('active').length-1){
				tagstr += element.id;
			}else{
				tagstr += element.id+',';
			}
			
		})
		console.log('图片',Apic);
		console.log('标签',tagstr);
		var content = mui('#textCon')[0].value,mapAddress = $('#mapAddress').html();
		if(mapAddress=="我的位置"){
			mapAddress = "未知"
		}
		if(!content){
			mui.toast('请输入内容');
		}else if(!Apic.length){
			mui.toast('请选择一张照片');
		}else{
			var myuserid = plus.storage.getItem('userid');
			var oldtoken = plus.storage.getItem('oldToken');
			mui.ajax(serverUrl+'/api/useraccount/userinfo',{//请求昵称
				data:{"userid":myuserid},
				type:'post',
				timeout:10000,
				headers:{"token":oldtoken},	              				
				success:function(data,type,xhr){
					console.log('获取用户数据返回'+JSON.stringify(data));
					if(data.errno == 0){ 
//						data.data[0].nickname = 0
						if(!data.data[0].nickname || data.data[0].nickname=='null'){
				mui.confirm('需要设置你的昵称哦？', '提示', ['取消', '确定'], function(e) {
								if(e.index == 1) {
									openview({
										view: "personal/setup.html",
										extrasobj: {
											pageid: "setup"
										}
									})
								} 
							})
						}else{
							plus.nativeUI.showWaiting('发送中 ...',{width:'100px',height:'80px'});
							mui.plusReady(function(){ 
							
								//发送数据
								var task = plus.uploader.createUpload(serverUrl+'/api/news/addnews', 
									{ method:"POST"},
									function(back,status){
										if(status == 200){ 
											console.log(back.responseText);
											var dataobj = JSON.parse(back.responseText);
											if(dataobj.errno == 0){
												if(plus.webview.getWebviewById('Follow')){//触发关注分享刷新，并打开关注分享
													mui.fire(plus.webview.getWebviewById('Follow'),'refresh');
												}
												var time2 = setTimeout(function(){//关闭当前
													if(!plus.webview.getWebviewById('Follow')){
														openview({
															view:'Follow'+'.html',
															id:'Follow'
														});
													}
													plus.nativeUI.closeWaiting();//关闭等待框
													mui.toast('发布成功');
													mui.fire(plus.webview.getWebviewById('find'),"refreshNews");
													mui.fire(plus.webview.getWebviewById('Follow'),"refreshNews");
													mui.fire(plus.webview.getWebviewById('centerPage'),"refreshNews")
													plus.webview.show('Follow',"fade-in",300);
													plus.webview.currentWebview().hide();
													plus.webview.currentWebview().close();
												},1000);
				    						}else{
				    							plus.nativeUI.closeWaiting();//关闭等待框
				    							mui.toast('发布失败，请重试！');	
				    						}
										}else{
											plus.nativeUI.closeWaiting();//关闭等待框
											mui.toast('当前网络不好，请重试！');	
										}
										
									}
								);
								console.log("qid "+qid)
								task.setRequestHeader('token',oldtoken);
								task.addData("userid",myuserid); 
								task.addData("q_id",qid)
								task.addData("content",content);
								task.addData("fix",mapAddress);
								task.addData("tags",tagstr);
								task.addFile(Apic[0], {key:"pic"} );
								task.start();
				
							})
						}
					}else{
						mui.toast('网络不好，请重试'); 
						console.log(data.errmsg);
					}
				},
				error:function(xhr,type,errorThrown){
					console.log('获取用户数据,响应失败');
				}
			});	
			 
		}
	})
</script>

</html>