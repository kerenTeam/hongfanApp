<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>发布发现</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../css/common.css">
		<link rel="stylesheet" type="text/css" href="../css/index.css">
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<link rel="stylesheet" href="../css/reset.css">
		<link rel="stylesheet" href="../css/one.css">
		<link rel="stylesheet" type="text/css" href="../css/find.css" />
		

	</head>
	<style type="text/css">
		#imgUpload {
			display: none;
			width: 0;
		}
		#preview{
			width: 30%;
		}
		.ptet {
			font-size: 12px;
			border: none;
		}
		label {
			vertical-align: top;
			width: calc((100% - 20px) * 2 / 5);
			width: -moz-calc((100% - 20px) * 2 / 5);
			width: -webkit-calc((100% - 20px) * 2 / 5);
		}
		.ptet {
			width: calc((100% - 20px) * 3 / 5);
			width: -webkit-calc((100% - 20px) * 3 / 5);
			width: -moz-calc((100% - 20px) * 3 / 5);
		}
		.publishf {
			padding: 10px;
		}
		.addbg {
			padding: 0 10px;
		}
		.mui-badge {
			padding: 5px 10px;
			margin: 5px;
			background: #eee;
		}
		.mui-badge:not(:last-child) {
			color: palevioletred;
		}
		.location {
			padding: 20px;
			border-top: 10px solid #EEEEEE;
		}
		.location img {
			width: 0.3rem;
			margin-right: 10px;
		}
		.addbgs {
			margin-right: 2px;
			color: coral;
			padding: 0 2px;
		}
		.disbg {
			border: none;
			padding: 0;
			font-size: 0.13rem;
			/*margin: 0 10px;*/
			min-height: 30px;
			line-height: 1.2;
		}
	 	/*图片上传*/
    	*{margin: 0;padding: 0;box-sizing: border-box;}
    	.clearfix:after {content: ""; display: block; clear:both;}
    	.uppics{text-align: center;background-color: #fff;padding: 10px;}
    	.uppics div.onepic{padding: 0 !important;font-size: 14px;}
	    .uppics div.onepic img{width: 90%;}
	    .uppics div.onepic input{width: 0;height: 0;position: absolute;outline: none;}

	    #uppics2 div.onepic{display: inline-block;width: 120px;#uppics2 div.onepicvertical-align: middle;position: relative;text-align: center;padding: 10px;
	    margin-right: 6px;float: left;} 
	    #uppics2 .onepic{width: 120px;}
	    #uppics2 .picimg{width: 100%;}
	    .picimg1{width: 25px;position: absolute;right: 0px;top: 2px;}
	    /*图片上传结束*/
	 
	</style>

	<body>

		<header class="mui-bar mui-bar-nav" id="header">
			<a class="mui-icon mui-pull-left bigSize back" style="font-size: 0.14rem;">取消</a>
			<h1 class="mui-title findUser">发布</h1>
			<a href="javascript:;" style="line-height: 50px;color:#666;" class="fr baocun">发送</a>
		</header>
		<script src="../js/statusBar.js"></script><!--状态栏-->
		
		<div id="main">
			<div class="publishf clearfix"> 
				<div class="<!--ptet fr-->">
					<div class="apsan"></div>
					<textarea id="textCon" class="disbg" rows="5" placeholder="点击输入 文字，心情，胡思乱想。。。"></textarea>
 
				</div>
			</div>
			<style type="text/css">
				.biaoqian span{
					padding: 8px 11px;
					margin: 3px;
					display: inline-block;
					background-color: #eee;
					border-radius: 1px;					
				}
				.biaoqian span.active{background-color: #ea4242;color: #fff;}  
			</style>
			<div id="mainpic" class="biaoqian">
			 
			</div>
			<script type="text/html" id="infolist">
				<%for(var i=0;i<list.length;i++){%>
					<span id="" onclick="spanclick(this)">
					#<%=list[i].tagName%>#
				</span>
				<%}%>
			</script>
			<div class="uppics clearfix" id="uppics2"> 
		        <div class="onepic">
		            <!--<input type="file" id="file_input"/>--> 
		            <img id="nowpic" src="../img/publisf.svg">
		        </div>
		    </div> 
		    
			<!--地理定位-->
			<div class="location">
				<img src="../img/location.svg" alt="" /><span id="mapAddress">我的位置</span>
				<div class="fr">
					<span></span>
					<div class="mui-switch mui-switch-mini">
						<div class="mui-switch-handle"></div>
					</div>
				</div>
			</div>

		</div>

	</body>
<script type="text/javascript" src="../js/jquery.min.js"></script>  
<script src="../js/mui.min.js"></script>
<script src="../js/app.js"></script> 
<script src="../js/common.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/image-new.js" type="text/javascript" charset="utf-8"></script>
<!--引入模板引擎-->
<script src="../js/artTemplate-native.js"></script>
<script type="text/javascript">
	//选择图片
	var Apic = [];//图片存放数组 
	mui.plusReady(function() {
		mui('#nowpic')[0].addEventListener('tap',function(){
			plus.nativeUI.actionSheet({
					cancel: "取消",
					buttons: [{
						title: "相册选择"
					}, {
						title: '拍照'
					}]
				},
				function(e) {
					if (e.index == 1) { //点击从相册选择
						galleryImgsSelected();
					} else if (e.index == 2) {
						getImage();
					}
				}
			);
		})
		var oldtoken = plus.storage.getItem('oldToken');
		
		mui.ajax(serverUrl+'/api/news/tags',{//请求id列表
			dataType:'json',
			type:'post',
			timeout:10000,
			headers:{"token":oldtoken},
			success:function(data,type,xhr){ 
				console.log('列表',data);
				if(data.errno==0){
					var dataobj = {};
					if(data.data.length){
						 
						dataobj.list = data.data;
						mui('#mainpic')[0].innerHTML = template('infolist',dataobj);
						console.log(template('infolist',dataobj))
					} 
				}else{
					mui.toast('当前网络不好，请重试！');	
				}
				plus.nativeUI.closeWaiting();
			},
			error:function(xhr,type,errorThrown){
				plus.nativeUI.closeWaiting(); 
				mui.toast('当前网络不好，请重试！');
				console.log('登录响应失败');
			}
		});
		
		function getImage(){//拍照并保存
			var cmr = plus.camera.getCamera();
			cmr.captureImage( function ( path ) {
				plus.io.resolveLocalFileSystemURL(path,function(entry){ 
					//把拍摄图片的路径转化成 本地文件url
					path = plus.io.convertLocalFileSystemURL(path);
					var nowpic = Math.random().toString(36).substr(2) + '.jpg';
					plus.zip.compressImage({//压缩方法
						src:path,
						dst:"file:///storage/emulated/0/androidesk/portrait/"+nowpic,
						overwrite:true,
						quality:30
					},
					function() {
						showImg('file:///storage/emulated/0/androidesk/portrait/'+nowpic);
						Apic = [];
						Apic.push('file:///storage/emulated/0/androidesk/portrait/'+nowpic);
					},function(error) {
						mui.toast('图片获取错误，请重试');
					}); 
					//无压缩
					//showImg(path);
					//Apic = [];
					//Apic.push(path);
					//plus.gallery.save( path ); 
				});
			}, function ( e ) { 
			}, {filename:"_doc/gallery/",index:1} );
		}
		//var lfs=null;// 保留上次选择图片列表
		function galleryImgsSelected(){//从相册中选择图片
		    plus.gallery.pick( function(e){
		    	lfs=e.files;
		    	for(var i in e.files){
		    		console.log(e.files[i]);
		    		var nowpic = Math.random().toString(36).substr(2) + '.jpg';
		    		plus.zip.compressImage({//压缩方法
						src:e.files[i],
						dst:"file:///storage/emulated/0/androidesk/portrait/"+nowpic,
						overwrite:true,
						quality:30
					},
					function() {
						showImg('file:///storage/emulated/0/androidesk/portrait/'+nowpic);
						Apic = []; 
						Apic.push('file:///storage/emulated/0/androidesk/portrait/'+nowpic);
					},function(error) {
						mui.toast('图片获取错误，请重试'); 
					});
					//无压缩
			    	//showImg(e.files[i]);
			    	//Apic = [];
					//Apic.push(e.files[i]);
		    	}
		    }, function ( e ) {
//		    },{filter:"image",multiple:true,maximum:1,selected:lfs,system:false,onmaxed:function(){//保存选择记录
		    },{filter:"image",multiple:true,maximum:1,system:false,onmaxed:function(){
				plus.nativeUI.alert('只能选择1张图片');  
		    }});
		}
		function showImg(url){//显示图片
			if(0!=url.indexOf("file://")){
				url="file://"+url; 
			}
			mui('#nowpic')[0].src = url;
		}
	});
	//选择图片结束
	
	function spanclick(obj){
		console.log(obj)
		if(obj.className == 'active'){
			obj.className = '';
		}else{
			obj.className = 'active';
		}
	}
	mui.plusReady(function() {
		//返回提示
		$(".back").on("tap", function() {
			var btnArray = ['否', '是'];
			mui.confirm('确定取消吗？', '提示', btnArray, function(e) {
				if(e.index == 1) {
					mui.back()
				} else {}
			})
		})
		
		//地图定位
		var watchId;
		function geoInf(position) {
			var str = "";
			str += "地址：" + position.addresses + "\n"; //获取地址信息
			str += "坐标类型：" + position.coordsType + "\n";
			var timeflag = position.timestamp; //获取到地理位置信息的时间戳；一个毫秒数；
			str += "时间戳：" + timeflag + "\n";
			var codns = position.coords; //获取地理坐标信息；
			var lat = codns.latitude; //获取到当前位置的纬度；
			str += "纬度：" + lat + "\n";
			var longt = codns.longitude; //获取到当前位置的经度
			str += "经度：" + longt + "\n";
			var alt = codns.altitude; //获取到当前位置的海拔信息；
			str += "海拔：" + alt + "\n";
			var accu = codns.accuracy; //地理坐标信息精确度信息；
			str += "精确度：" + accu + "\n";
			var altAcc = codns.altitudeAccuracy; //获取海拔信息的精确度；
			str += "海拔精确度：" + altAcc + "\n";
			var head = codns.heading; //获取设备的移动方向；
			str += "移动方向：" + head + "\n";
			var sped = codns.speed; //获取设备的移动速度；
			str += "移动速度：" + sped;
			console.log(JSON.stringify(position));
			longitude = (position.coords.longitude).toFixed(6);
			latitude = (position.coords.latitude).toFixed(6);
			$('#mapAddress').html(position.addresses);
			
		}
		// 通过定位模块获取位置信息
		function getGeocode() {
			plus.geolocation.getCurrentPosition(geoInf, function(e) {
				mui.toast("获取定位位置信息失败：" + e.message);
			}, {
				geocode: true,
				provider: 'amap'
			});
		}
		//是否显示位置
		$('.mui-switch').click(function() {
			if($(this).hasClass("mui-active")) {
				getGeocode();
			} else {
				$('#mapAddress').html("我的位置")
			}
		})

	})//plusready
		
	//发送 发布
	mui('.baocun')[0].addEventListener('tap',function(){ 
		var tagstr = ' ';
		mui.each(mui('.biaoqian')[0].getElementsByClassName('active'),function (index,element) {
			tagstr += element.innerText;
		})
		console.log('图片',Apic);
		console.log('标签',tagstr);
		var content = mui('#textCon')[0].value,mapAddress = $('#mapAddress').html();
		if(mapAddress=="我的位置"){ 
			mapAddress = "未知"
		}
		if(!content){
			mui.toast('请输入内容');
		}else if(!Apic.length){
			mui.toast('请选择一张照片');
		}else{
			plus.nativeUI.showWaiting('发送中 ...',{width:'100px',height:'80px'});
			mui.plusReady(function(){ 
				var myuserid = plus.storage.getItem('userid');
				var oldtoken = plus.storage.getItem('oldToken');
				//发送数据
				var task = plus.uploader.createUpload(serverUrl+'/api/news/addnews', 
					{ method:"POST"},
					function(back,status){
						if(status == 200){ 
							console.log(back.responseText);
							var dataobj = JSON.parse(back.responseText);
							if(dataobj.errno == 0){ 
								if(plus.webview.getWebviewById('Follow')){//触发关注分享刷新，并打开关注分享
									mui.fire(plus.webview.getWebviewById('Follow'),'refresh');
								}
								var time2 = setTimeout(function(){//关闭当前
									if(!plus.webview.getWebviewById('Follow')){
										openview({
											view:'Follow'+'.html',
											id:'Follow'
										});
									}
									plus.nativeUI.closeWaiting();//关闭等待框
									mui.toast('发布成功');
									plus.webview.show('Follow',"fade-in",300);
									plus.webview.currentWebview().hide();
									plus.webview.currentWebview().close();
								},1000);
    						}else{
    							plus.nativeUI.closeWaiting();//关闭等待框
    							mui.toast('发布失败，请重试！');	
    						}
						}else{
							plus.nativeUI.closeWaiting();//关闭等待框
							mui.toast('当前网络不好，请重试！');	
						}
						
					}
				);
				task.setRequestHeader('token',oldtoken);
				task.addData("userid",myuserid); 
				task.addData("content",content);
				task.addData("fix",mapAddress);
				task.addData("tags",tagstr);
				task.addFile(Apic[0], {key:"pic"} );
				task.start();

			})
		}
	})
</script>

</html>