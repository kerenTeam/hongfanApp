<html>
	<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>为民服务-邻水帮帮团请求发布</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/reset.css">
		<script src="../../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script type="text/javascript" src="../../js/app.js"></script>
		<style>
			header{
				height: 50px !important;
			}
			header h1,.mui-bar-nav.mui-bar .mui-icon, .mui-title, #theSearch{
				line-height: 50px !important;
				padding: 0;
			}
			.mui-bar-nav.mui-bar .mui-icon,.mui-title,#theSearch{
				color: #fff;
			}
			.mui-bar-nav{
				box-shadow: none;
			}
			.dealcard, .cinemacard{
				margin-top: 45px;
			}
			.dealcard .dealcard-img img{
				height: 60px;
				overflow: hidden;
			}
			#main{
				margin-top: 50px;
				padding-bottom: 50px;
			}
			.recharge .addtu ul li{
				border: none;
				overflow: hidden;
				padding: 10px 5px;
			}
			.recharge .addtu ul li img{
				width: 100% !important;
				max-width: 100%; 
				max-height: 100%;
			}
			.mui-input-row{
				margin:0 2%;
			}
			.mui-input-row p{
				line-height: 30px;
				padding:0;
				color:#666;
			}
			/*图片上传*/
	    	*{margin: 0;padding: 0;box-sizing: border-box;}
	    	.clearfix:after {content: ""; display: block; clear:both;}
	    	.uppics{text-align: center;border-bottom: 1px solid rgba(0,0,0,0.1);overflow-y: hidden;background-color: #efeff4;}
	    	.uppics div.onepic{height: 120px;padding: 0 !important;padding-top: 31px !important;font-size: 14px;}
		    .uppics div.onepic img{width: 50px;}
		    .uppics div.onepic input{width: 0;height: 0;position: absolute;outline: none;}
		    #uppics2{text-align: left;white-space: nowrap;overflow-x: scroll;}
		    #uppics2 div{display: inline-block;width: 120px;height:120px;vertical-align: middle;position: relative;text-align: center;padding: 10px;
		    background-color: #EFEFF4;margin-right: 6px;}
		    #uppics2 .onepic{width: 120px;background-color: #fff;}
		    #uppics2 .picimg{width: 100%;}
		    .picimg1{width: 25px;position: absolute;right: 0px;top: 2px;}
		    .uppics{
		    	border-bottom: none;
		    }
		    input[type=text],textarea{
		    	border: 1px solid #eee;
		    	font-size: 14px;
		    }
		</style>
	</head>

	<body>
		<!--header star-->
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
		    <h1 class="mui-title">帮帮请求发布</h1>
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div class="warp warpthree clearfloat" id="main">
			<!--上传图片-->
			<div class="uppics clearfix">
		        <div class="onepic" >
		            <input type="file" id="file_input"/> 
		            <img src="../../img/zhaoxiangji.svg">
		            <p>添加图片</p>
		        </div>
		    </div>
			<!--上传图片结束-->
	    	<div class="recharge clearfloat">
	    		<div class="mui-input-row">
	    			<p>问题名称：</p>
	    			<input type="text" name="" id="title" value=""/>
	    		</div>
	    		<div class="mui-input-row">
	    			<p>问题内容：</p>
	    			<textarea name="" rows="6" cols="30" id="content"></textarea>
	    		</div>
	    	</div>	    	
	   	</div>
	    <div class="renting-footer renting-footertwo clearfloat">
			<ul>
				<li><a onclick="send()">免费发布</a></li>
			</ul>
		</div>
	<script type="text/javascript">
		//选择图片
		var onepic = document.getElementsByClassName('onepic')[0];
   		var uppics = document.getElementsByClassName('uppics')[0];
	    var p = document.getElementById('p');
	    var time1 = null;
	    var Apic = [];//存放图片数组
	    var Indexes = 0;//当前删除
	    onepic.onclick = function(){
	    	var file_input = document.getElementById('file_input');
	    	if(Apic.length<=4){
	    		if(Apic.length ==4){
	    			file_input.style.display = 'none';
	    		}else{
	    			file_input.style.display = 'inline-block';
	    		}
	        uppics.id = 'uppics2';
	        var imgnode = document.createElement("div");
	        clearInterval(time1);
	        time1 = setInterval(function(){
	            console.log('加载中');
	            if (file_input.files[0]) {
	                clearInterval(time1);
	                var reader = new FileReader();
	                Apic.push(file_input.files[0]);
	                var picname = file_input.files[0].name;
	                reader.readAsDataURL(file_input.files[0]); 
	                reader.onload = function(e){
	                    imgnode.innerHTML = '<img class="picimg1 '+picname+'" src="../../img/shanchu.svg"/><img class="picimg" src="'+this.result+'"/>';
	                    document.getElementsByClassName('picimg1')[Indexes].onclick = function(){
	                        this.parentNode.parentNode.removeChild(this.parentNode);
	                        var dename = this.className.slice(8);
	                        for (var i = 0; i < Apic.length; i++) {
	                            if (Apic[i].name == dename) {
	                               Apic.splice(i,1);
	                            }
	                        }
	                        Indexes--;
	                    }
	                    Indexes++;
	                }
	                uppics.appendChild(imgnode);
	                file_input.value = '';
	            }
	        },500)
	       }else{
	       	file_input.style.display = 'none';
	       	mui.toast('最多选择五张');
	       }
	    }
		//选择图片结束
		
		//上传部分
		mui.plusReady(function(){
			var userId = plus.storage.getItem('userid');
			var oldToken = plus.storage.getItem('oldToken');
			var helper_id = plus.webview.currentWebview().helpId;
			//点击发送
			window.send = function(){
				var formD = new FormData();
				var content = $('#content').val();
				var title = $('#title').val();
				
				for (var j=0; j<Apic.length; j++) {
					console.log('添加评论图片');
					formD.append('file_obj',Apic[j]);
				} 
				formD.append('userid',userId);
				formD.append('title',title);
				formD.append('content',content);
				formD.append('helper_id',helper_id);
				var xhr = new XMLHttpRequest(); 
				if(title == ''){
					$('#title').focus(); 
					mui.toast('请填写问题内容!');
				}else if(content == ''){
					$('#content').focus(); 
					mui.toast('请填写问题名称!');
				}else{
					plus.nativeUI.showWaiting('跳转中 ...',{width:'100px',height:'80px'});//显示等待框
	    			xhr.open('POST',serverUrl+'/api/localservice/addhelp'); 
	    			xhr.onreadystatechange = function(){
	    				if (xhr.readyState===4) {  
	    					if (xhr.status===200) {
	    						console.log(xhr.responseText)
	    						var dataobj = eval("("+xhr.responseText+")");
	    						console.log(dataobj);
	    						if(dataobj.errno == 0){
	    							mui.toast('发布成功');	
	    							//触发跳转页面刷新
									mui.fire(plus.webview.getWebviewById('personal/my-help.html'),'refreshHelp');//打开指定页面
									var time1 = setTimeout(function(){
										plus.webview.currentWebview().close();//关闭当前页面
										plus.nativeUI.closeWaiting();
									},500)
	    						}else{
	    							mui.toast('发布失败');	
	    						}
	    					}
	    				}
			        }
	    			xhr.setRequestHeader("token",oldToken);
	    			xhr.send(formD);
	    		}
    		}
		})
	</script>
</html>