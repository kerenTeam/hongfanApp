<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<title>添加地址</title>
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<!--标准mui.css-->
		
		<link href="../../css/mui.min.css" rel="stylesheet">
		<link href="../../css/public.css" rel="stylesheet">
		<link href="../../css/personal.css" rel="stylesheet">
		<link rel="stylesheet" href="../../css/address.css" />
		<style>
			.add_wrap {
				font-weight: bold;
			}
			
			.add_phone a img {
				width: 62%;
			}
			
			.checke_list input:before{
				color: #d52d20 !important;
				font-size: 2rem !important;
				font-weight: bold !important;
			}
			.checke_list .mui-input-row{
				float: left;
				clear: none;
				padding: 5.5% 20%;
				padding-left: 0;
			}
			.checke_list .mui-input-row label{
				margin: 0;
				padding: 0;
			}
			.mui-checkbox.mui-left input[type=checkbox],
			.mui-radio.mui-left input[type=radio] {
				left: 41px;
			}
			.mui-checkbox input[type=checkbox], .mui-radio input[type=radio]{
				top: 50%;
				right: inherit;
				left: 4rem;
				-webkit-transform: translateY(-50%);
				transform: translateY(-50%);
			}
		</style>
	</head>

	<body class="paddfoot">
		<!--header-->
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title white">添加地址</h1>
		</header>
		<form class="add_wrap">
			<div class="add_list">
				<span>联系人</span>
				<input type="text" name="" onchange="AddressCookie()" placeholder="您的姓名" class="youname" />
			</div>
			<div class="checke_list">
				
				<div class="mui-input-row mui-radio">
					<label>
					<input name="radio1" type="radio" value="1" checked>先生
					</label>
				</div>
				<div class="mui-input-row mui-radio">
					<label>
					<input name="radio1" type="radio" value ="0">女士
					</label>
				</div>
			</div>
			<div class="add_list add_phone">
				<span>联系电话</span>
				<input type="text" name="" onchange="AddressCookie()" placeholder="您的手机号" id="phone" value="" />
			</div>
			<div class="add_list">
				<span>收货地址</span>
				 <div id="mapAddress"><b id="address1" class="gray">小区 / 写字楼 / 学校等（点击定位）</b></div>
			</div>
			<div class="add_list " style="padding-top: 10%">
				<span style="color: transparent;">收货地址</span>
				<!-- 占位子 -->
				<input type="text" name="" id="Address" placeholder="详细地址（如门牌号等）" class="detailed_address" />
			</div>
			<div class="add_f_btn">
				<!-- 添加地址成功跳转address.html -->
				<input type="button" name="" class="redbtn " value="确定" />
			</div>

		</form> 
		<div id="tip"></div>
    <div id="result"></div>
	<script type="text/javascript" src="../../js/jquery.min.js"></script>
	<script src="../../js/mui.min.js"></script> 
	<script src="../../js/touchLR.js"></script>
	<script src="../../js/BombBox.js"></script>
    <script type="text/javascript" src="../../js/common.js"></script>
    <script type="text/javascript" src="../../js/immersed.js" ></script>
 
	<script type="text/javascript">
			
			// 新增地址缓 存
			function AddressCookie(){
				plus.storage.setItem('$addname',JSON.stringify($('.youname').val()));
				plus.storage.setItem('$addphone',JSON.stringify($('#phone').val()));
				//alert(plus.storage.getItem('$addphone')+" "+plus.storage.getItem('$addname'));
			}
			var latitude=0;//经度
			var longitude=0;//纬度
			$('#mapAddress').click(function(){
				//alert('点击:'+latitude+" "+longitude);
				console.log(latitude+" "+longitude);
				if(latitude!=0){
					mui.openWindow({
						url: encodeURI('mMap.html?keywords=写字楼,学校,小区&center='+longitude+','+latitude+'&key=8f29aefac8547821425571df8852f64b'),
						id: 'mMap',
						show: {
							aniShow:'pop-in'
							},
							styles: {
								popGesture: 'hide',
								top:0,
							},
							extras: { 
							  pageid:'addAddress'
						   },
							waiting: {
								autoShow: false
							}
						})
				}
				
			})
			var network = true;
			if(mui.os.plus) {
				mui.plusReady(function() {
					if(plus.networkinfo.getCurrentType() == plus.networkinfo.CONNECTION_NONE) {
						network = false;
					}
				});
			}	 
			 
						
						
			mui.plusReady(function() {  
				
				if(network) {
					
					var users = JSON.parse(plus.storage.getItem('$users') || '[]'); 
                	if(users.length ==0){
                    	signin();
                   }else{
	               		var userphone = users[0].account;
	               		var phone = document.getElementById('phone')
	               		phone.value=userphone;
	               		document.getElementsByClassName('redbtn')[0].onclick = function(){
	               			var youname = document.getElementsByClassName('youname')[0];
	               			 var phonenum = phone.value;
	               			var sex = $('input:radio:checked').val();
	               			 var reg = /^1((3|4|5|8|7){1}\d{1}|70)\d{8}$/;
			                var mph = $("#Address").val();
			                var mapaddress = $("#mapAddress").html(); 
			                if (youname.value== '') {
			                	var tip2 = new confirmbox();
											tip2.canshu = {
													nocancel: false,
													Prompt: '请输入姓名',
													myFocus: youname
												}
												//调用方法
											tip2.fun();
				            } else if (phonenum == '' || !reg.test(phonenum)) {
				            	var tip2 = new confirmbox();
											tip2.canshu = {
													nocancel: false,
													Prompt: '请输入正确的电话号码',
													myFocus: $('#mapAddress')
												}
												//调用方法
											tip2.fun();
				                
				            } else if (mapaddress == '<b id="address1" class="gray">小区 / 写字楼 / 学校等（点击定位）</b>' || mapaddress=='定位失败') {
				                var tip2 = new confirmbox();
											tip2.canshu = {
													nocancel: false,
													Prompt: '请重新定位',
													myFocus: $("#Address")
												}
												//调用方法
											tip2.fun();
				            }else if (mph == '') {
				                var tip2 = new confirmbox();
											tip2.canshu = {
													nocancel: false,
													Prompt: '请输入门牌号',
													myFocus: $("#Address")
												}
												//调用方法
											tip2.fun();
				            } else { 
	                   	mui.ajax('http://www.ban9wan.com/API/API_MenberAddress',{
	                   		data:{"dis":"xz","address":{"UserPhone":userphone,"Name":youname.value,"Address":mapaddress,"IsDefault":0,"GoodsPhone":phonenum,"SparePhone":"","DetailsAddress":mph,"Gender":sex}},
							dataType:'json',
							type:'post',
							timeout:10000,           
							success:function(backdata){  
								var list = plus.webview.getWebviewById('address'); 
 								setTimeout(function() {mui.back();},0);
									mui.toast('新增成功');
								 	mui.fire(list,'refreshaddress'); 
								},
							error:function(xhr,type,errorThrown){
								console.log(type);
							}
						}); 
				            }
	               		}

						//地图定位
						var watchId;
						function geoInf( position ) {
							alert('成功');
							var str = "";
							str += "地址："+position.addresses+"\n";//获取地址信息
							str += "坐标类型："+position.coordsType+"\n";
							var timeflag = position.timestamp;//获取到地理位置信息的时间戳；一个毫秒数；
							str += "时间戳："+timeflag+"\n";
							var codns = position.coords;//获取地理坐标信息；
							var lat = codns.latitude;//获取到当前位置的纬度；
							str += "纬度："+lat+"\n";
							var longt = codns.longitude;//获取到当前位置的经度
							str += "经度："+longt+"\n";
							var alt = codns.altitude;//获取到当前位置的海拔信息；
							str += "海拔："+alt+"\n";
							var accu = codns.accuracy;//地理坐标信息精确度信息；
							str += "精确度："+accu+"\n";
							var altAcc = codns.altitudeAccuracy;//获取海拔信息的精确度；
							str += "海拔精确度："+altAcc+"\n";
							var head = codns.heading;//获取设备的移动方向；
							str += "移动方向："+head+"\n";
							var sped = codns.speed;//获取设备的移动速度；
							str += "移动速度："+sped;
							console.log(JSON.stringify(position));
							//outLine( str );
							//alert(position.addresses);
							longitude=(position.coords.longitude).toFixed(6);
							latitude=(position.coords.latitude).toFixed(6);
							//alert("当前位置的纬度："+latitude+" 经度："+longitude);
							//alert(position.addresses)
							$('#mapAddress').html(position.addresses)
						}
						// 通过定位模块获取位置信息
						function getGeocode(){
							alert('looo')
							//outSet( "获取定位位置信息:" );
							plus.geolocation.getCurrentPosition( geoInf, function ( e ) {
								alert('失败');
								outSet( "获取定位位置信息失败："+e.message );
							},{geocode:true,provider:'amap'});
						}
						getGeocode();
						
						 
                   				} 
                   	
			} else {
				mui.toast("当前网络不给力，请稍后再试");
			}
		});
		
		function signin(){  
        	var tip = new confirmbox();
			tip.canshu = { 
				nocancel:true,
				Prompt:'请登录',
				pageid:'addAddress',
				myLink:'../signIn/signin.html'
			}
			tip.fun();
		} 
                   		 
               
	</script>
	</body>

</html>