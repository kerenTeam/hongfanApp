<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>我的优惠券</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" href="../../css/reset.css">
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<!--<script type="text/javascript" src="../../js/jquery.flexslider-min.js"></script>-->
		<script src="../../js/hmt.js" type="text/javascript"></script>
		<script src="../../js/mui.min.js" type="text/javascript"></script>
		<script src="../../js/app.js" type="text/javascript"></script>
		<!--引入模板引擎-->
		<script src="../../js/artTemplate-native.js" type="text/javascript"></script>
		<style type="text/css">
			.coupons .list .right {
				padding: 4% 0 5% 3%;
			}
			
			/*图片预览*/
			.mui-preview-image.mui-fullscreen {
				position: fixed;
				z-index: 20;
				background-color: #000;
			}
			.mui-preview-header,
			.mui-preview-footer {
				position: absolute;
				width: 100%;
				left: 0;
				z-index: 10;
			}
			.mui-preview-header {
				height: 44px;
				top: 0;
			}
			.mui-preview-footer {
				height: 50px;
				bottom: 0px;
			}
			.mui-preview-header .mui-preview-indicator {
				display: block;
				line-height: 25px;
				color: #fff;
				text-align: center;
				margin: 15px auto 4;
				width: 70px;
				background-color: rgba(0, 0, 0, 0.4);
				border-radius: 12px;
				font-size: 16px;
			}
			.mui-preview-image {
				display: none;
				-webkit-animation-duration: 0.5s;
				animation-duration: 0.5s;
				-webkit-animation-fill-mode: both;
				animation-fill-mode: both;
			}
			.mui-preview-image.mui-preview-in {
				-webkit-animation-name: fadeIn;
				animation-name: fadeIn;
			}
			.mui-preview-image.mui-preview-out {
				background: none;
				-webkit-animation-name: fadeOut;
				animation-name: fadeOut;
			}
			.mui-preview-image.mui-preview-out .mui-preview-header,
			.mui-preview-image.mui-preview-out .mui-preview-footer {
				display: none;
			}
			.mui-zoom-scroller {
				position: absolute;
				display: -webkit-box;
				display: -webkit-flex;
				display: flex;
				-webkit-box-align: center;
				-webkit-align-items: center;
				align-items: center;
				-webkit-box-pack: center;
				-webkit-justify-content: center;
				justify-content: center;
				left: 0;
				right: 0;
				bottom: 0;
				top: 0;
				width: 100%;
				height: 100%;
				margin: 0;
				-webkit-backface-visibility: hidden;
			}
			.mui-zoom {
				-webkit-transform-style: preserve-3d;
				transform-style: preserve-3d;
			}
			.mui-slider .mui-slider-group .mui-slider-item img {
				width: auto;
				height: auto;
				max-width: 100%;
				max-height: 100%;
			}
			.mui-android-4-1 .mui-slider .mui-slider-group .mui-slider-item img {
				width: 100%;
			}
			.mui-android-4-1 .mui-slider.mui-preview-image .mui-slider-group .mui-slider-item {
				display: inline-table;
			}
			.mui-android-4-1 .mui-slider.mui-preview-image .mui-zoom-scroller img {
				display: table-cell;
				vertical-align: middle;
			}
			.mui-preview-loading {
				position: absolute;
				width: 100%;
				height: 100%;
				top: 0;
				left: 0;
				display: none;
			}
			.mui-preview-loading.mui-active {
				display: block;
			}
			.mui-preview-loading .mui-spinner-white {
				position: absolute;
				top: 50%;
				left: 50%;
				margin-left: -25px;
				margin-top: -25px;
				height: 50px;
				width: 50px;
			}
			.mui-preview-image img.mui-transitioning {
				-webkit-transition: -webkit-transform 0.5s ease, opacity 0.5s ease;
				transition: transform 0.5s ease, opacity 0.5s ease;
			}
			@-webkit-keyframes fadeIn {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
			@keyframes fadeIn {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
			@-webkit-keyframes fadeOut {
				0% {
					opacity: 1;
				}
				100% {
					opacity: 0;
				}
			}
			@keyframes fadeOut {
				0% {
					opacity: 1;
				}
				100% {
					opacity: 0;
				}
			}
			p img {
				max-width: 100%;
				height: auto;
			}
			
			
			/*修改*/
			.fl{
				position: relative;
			}
			.qrcode{
				position: absolute;
				right: 0;
				top: 0;
				width: 40px;
				height: 40px;
				overflow: hidden;
			}
			.qrcode img{
				width: 100%;
			}
			.activeImg img{
				width: 40%;
			}
			.notice .tab-bd .tab-pal{
				border: none;
			}
			.nothing img{
				display: block;
				margin: 20px auto;
				width: 80px;
			}
			.nothing p{
				text-align: center;
			}
			.notice .tab-bd{
				padding-top: 0;
			}
			.notice .tab-hd li{width: 50%;}
			.coupons .list{border-radius: 2px;}
		</style>
	</head>
	<body>
		<!--header star-->
		 <header class="mui-bar mui-bar-nav">
			    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
			    <h1 class="mui-title">优惠券</h1>  
			 
			</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
	    <!--header end-->
		<!--<div id="main">-->
			<div class="notice" style="margin:50px auto">
				<div class="tab-hd">
					<ul class="tab-nav">
					  <li>全部</li>
					  <li>可用</li>
					  <!--<li>已使用</li>-->
					</ul>
				</div>
				<div class="tab-bd">
					<div class="tab-pal">
						<div class="coupons clearfloat box-s" id="allC"></div>
					</div>
					<div class="tab-pal">
						<div class="coupons clearfloat box-s" id="ableC"></div>
					</div>	
					<div class="tab-pal">
						<div class="coupons clearfloat box-s" id="disableC">
							<div class="nothing">
								<img src="../../img/theList/coupon.png"/>
								<p>你没有已使用的优惠券哟！</p>
							</div>
						</div>
					</div>
					<!--全部-->
					<script type="text/html" id="allC-detail">
						<% for(var i=0;i<allLi.length;i++){ %>
							<div class="list clearfloat fl" onclick="Cdetail(<%= allLi[i].user_coupon_id %>)">
								<% if(allLi[i].user_coupon_state == 1){ %>
									<% if(allLi[i].typeid == 2){ %>
										<div class="left clearfloat fl">
											<%= allLi[i].discountstr%><span>折</span>
										</div>
									<% }else if(allLi[i].typeid == 1){ %>
										<div class="left clearfloat fl">
											<span>¥</span><%= allLi[i].coupon_amount %>
										</div>
									<% }else{ %>
										<div class="left clearfloat fl activeImg">
											<img src="../../img/active.png"/>
										</div>
									<% } %>
								<% }else{ %>
									<% if(allLi[i].typeid == 2){ %>
										<div class="left leftwo clearfloat fl">
											<%= allLi[i].discountstr%><span>折</span>
										</div>
									<% }else if(allLi[i].typeid == 1){ %>
										<div class="left leftwo clearfloat fl">
											<span>¥</span><%= allLi[i].coupon_amount %>
										</div>
									<% }else{ %>
										<div class="left leftwo clearfloat fl activeImg">
											<img src="../../img/active.png"/>
										</div>
									<% } %>
								<% } %>
								<div class="right clearfloat fl box-s">
									<p class="tit">
										<%= allLi[i].name %>
									</p>
									<p class="time">
										<% if(allLi[i].typeid == 1){ %>
											无限制
										<%}else{%>
											满<%= allLi[i].discountnum %> 元 <%= allLi[i].discountstr %>折
										<%} %>
									</p>
									<p class="time">
										有效时间：<%= allLi[i].begin_date %>到<%= allLi[i].end_date %>
									</p>
								</div>
								<!--<div class="qrcode mui-content-padded">
									<img src="<%= allLi[i].qrcode %>"  onerror="javascript:this.src='../../img/market/nodata.svg';" data-preview-src="" data-preview-group="1" />
								</div>-->
							</div>
						<% } %>
					</script>
					<!--未使用-->
					<script type="text/html" id="ableC-detail">
						<% for(var i=0;i<allLi.length;i++){ %>
							<% if(allLi[i].user_coupon_state == 1){ %>
								<div class="list clearfloat fl" onclick="Cdetail(<%= allLi[i].user_coupon_id %>)">
									<% if(allLi[i].typeid == 2){ %>
										<div class="left clearfloat fl">
											<%= allLi[i].discountstr%><span>折</span>
										</div>
									<% }else if(allLi[i].typeid == 1){ %>
										<div class="left clearfloat fl">
											<span>¥</span><%= allLi[i].coupon_amount %>
										</div>
									<% }else{ %>
										<div class="left clearfloat fl activeImg">
											<img src="../../img/active.png"/>
										</div>
									<% } %>
									<div class="right clearfloat fl box-s">
										<p class="tit">
											<%= allLi[i].name %>
										</p>
										<p class="time">
											<% if(allLi[i].typeid == 1){ %>
											无限制
											<%}else{%>
												满<%= allLi[i].discountnum %> 元 <%= allLi[i].discountstr %>折
											<%} %>
										</p>
										<p class="time">
											有效时间：<%= allLi[i].begin_date %>到<%= allLi[i].end_date %>
										</p>
									</div>
									<!--<div class="qrcode mui-content-padded">
										<img src="<%= allLi[i].qrcode %>" data-preview-src="" onerror="javascript:this.src='../../img/market/nodata.svg';" data-preview-group="1" />
									</div>-->
								</div>
							<% } %>
						<% } %>
					</script>
					<!--已使用-->
					<script type="text/html" id="disableC-detail">
						<% for(var i=0;i<allLi.length;i++){ %>
							<% if(allLi[i].user_coupon_state == 0){ %>
								<% if(allLi[i]){%>
									<div class="list clearfloat fl" onclick="Cdetail(<%= allLi[i].user_coupon_id %>)">
										<% if(allLi[i].typeid == 2){ %>
											<div class="left leftwo clearfloat fl">
												<%= allLi[i].discountstr%><span>折</span>
											</div>
										<% }else if(allLi[i].typeid == 1){ %>
											<div class="left leftwo clearfloat fl">
												<span>¥</span><%= allLi[i].coupon_amount %>
											</div>
										<% }else{ %>
											<div class="left leftwo clearfloat fl activeImg" >
												<img src="../../img/active.png"/>
											</div>
										<% } %>
										<div class="right clearfloat fl box-s">
											<p class="tit">
												<%= allLi[i].name %>
											</p>
											<p class="time">
												<% if(allLi[i].typeid == 1){ %>
													无限制
												<%}else{%>
													满<%= allLi[i].discountnum %> 元 <%= allLi[i].discountstr %>折
												<%} %>
											</p>
											<p class="time">
												有效时间：<%= allLi[i].begin_date %>到<%= allLi[i].end_date %>
											</p>
										</div>
										<!--<div class="qrcode mui-content-padded">
											<img src="<%= allLi[i].qrcode %>" data-preview-src="" onerror="javascript:this.src='../../img/market/nodata.svg';" data-preview-group="1" />
										</div>--> 
									</div>
								<% } %>
							<% } %>
						<% } %>
					</script>
				</div>
			</div>
		</div>
		<script src="../../js/jquery.SuperSlide.2.1.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			jQuery(".notice").slide({ titCell:".tab-hd li", mainCell:".tab-bd",delayTime:0 });
		</script>
		<!--图片预览-->
		<script src="../../js/mui.zoom.js"></script>
		<script src="../../js/mui.previewimage.js"></script>
		<script>
			mui.previewImage();
		</script>
		
		<script type="text/javascript">
			mui.init();
			mui.plusReady(function(){
				//判断是否登录并获取缓存token
				if(plus.storage.getItem('myToken')){
					var oldToken = plus.storage.getItem('oldToken');
				}else{
					mui.toast('请登录！');
					openview({
						view:'../login.html'
					})
				}
				var userId = plus.storage.getItem("userid");
				plus.nativeUI.showWaiting('加载中 ...',{width:'100px',height:'80px'});//显示等待框
				mui.ajax(serverUrl+'/api/useraccount/mycoupon',{ 
					data:{userid : userId},
					dataType:'json',
					type:'post',
					timeout:10000,
					headers:{"token":oldToken},	 
					success:function(data,type,xhr){
						console.log('data',data);
						if (data.errno == 0) { 
							if(!data.data.user_coupon.length){   
									mui('.notice')[0].innerHTML='<div class="nothing" style="margin-top:40%"><img src="../../img/theList/coupon.png"/><p>你没有未使用的优惠券哟！</p></div>';
								}else{
									mui.each(data.data.user_coupon,function (index,element) {
										element.coupon_amount && (element.discountstr = element.coupon_amount.split(',')[1]*10);
										element.coupon_amount && (element.discountnum = element.coupon_amount.split(',')[0]);
									})
	//								for(var m=0; m < data.data.user_coupon.length; m++){ 
	//									console.error(data.data.user_coupon[m].salerule); 
	//								if(data.data.user_coupon[m].salerule==null || data.data.user_coupon[m].salerule==''){
	//								 	data.data.user_coupon[m].salerule=null;
	//								}else{	
	////									data.data.user_coupon[m].salerule1= eval("("+ data.data.user_coupon[m].salerule +")").overflowValue;
	//									data.data.user_coupon[m].salerule1= 100;
	//									
	////									data.data.user_coupon[m].salerule2= eval("("+data.data.user_coupon[m].salerule+")").cutValue;
	//									data.data.user_coupon[m].salerule2= 200;
	//								}
	//								 
	//							}   
								var allC = {}; 
								allC.allLi = data.data.user_coupon;
								if(allC.allLi.length > 0){
									
									var html = template('allC-detail',allC);
									document.getElementById('allC').innerHTML = html;
									//未使用的优惠券
									for(var i=0;i<allC.allLi.length;i++){
										if(allC.allLi[i].user_coupon_state == 1){
											console.log(allC);
											var html2 = template('ableC-detail',allC);
											document.getElementById('ableC').innerHTML = html2;
//											alert(2);
											break;
										}else{
//											alert(1);
											mui('#ableC-detail')[0].innerHTML='<div class="nothing"><img src="../../img/theList/coupon.png"/><p>你没有未使用的优惠券哟！</p></div>';
										}
									}
									
									//已使用优惠券
									for(var i=0;i<allC.allLi.length;i++){
										if(allC.allLi[i].user_coupon_state == 0){ 
											var html3 = template('disableC-detail',allC);
											document.getElementById('disableC').innerHTML = html3;
										}else{
											//mui('#disableC-detail')[0].innerHTML='<div class="nothing"><img src="../../img/theList/coupon.png"/><p>你没有已使用的优惠券哟！</p></div>';
										}
									}
								}else{
									mui('#allC-detail')[0].innerHTML='<div class="nothing"><img src="../../img/theList/coupon.png"/><p>你没有未使用的优惠券哟！</p></div>';
									mui('#ableC-detail')[0].innerHTML='<div class="nothing"><img src="../../img/theList/coupon.png"/><p>你没有未使用的优惠券哟！</p></div>';
									mui('#disableC-detail')[0].innerHTML='<div class="nothing"><img src="../../img/theList/coupon.png"/><p>你没有已使用的优惠券哟！</p></div>';
								}
							}
							
							
							
							
							
							//点击进入券的详情
							window.Cdetail = function(Cid){
								openview({
									view:'coupon-detail.html',
									extrasobj:{couponId:Cid}
								});
							}
						} else{
							mui('#ableC-detail')[0].innerHTML='<div class="nothing"><img src="../../img/theList/coupon.png"/><p>你没有未使用的优惠券哟！</p></div>';
						}
					plus.nativeUI.closeWaiting();//关闭等待框
					},
					error:function(xhr,type,errorThrown){
						mui('#ableC-detail')[0].innerHTML='<div class="nothing"><img src="../../img/theList/coupon.png"/><p>你没有未使用的优惠券哟！</p></div>';
						console.log('响应失败  !');
					}
				});
				
			})();
		</script>
	</body>
</html>
