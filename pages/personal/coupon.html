<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>我的优惠券</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" href="../../css/reset.css">
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script src="../../js/mui.min.js" type="text/javascript"></script>
		<script src="../../js/app.js" type="text/javascript"></script>
		<script src="../../js/artTemplate-native.js" type="text/javascript"></script>
		<style type="text/css">
			.coupons .list .right { padding: 4% 0 5% 3%; }
			.fl{ position: relative; }
			.qrcode{ position: absolute; right: 0; top: 0; width: 40px; height: 40px; overflow: hidden; }
			.qrcode img{ width: 100%; }
			.activeImg img{ width: 40%; }
			.notice .tab-bd .tab-pal{ border: none; }
			.nothing img{ display: block; margin: 20px auto; width: 80px; }
			.nothing p{ text-align: center; }
			.notice .tab-bd{ padding-top: 0; }
			.notice .tab-hd li{width: 50%;}
			.coupons .list{border-radius: 2px;}
			/*新的优惠卷*/
			body{ background-color: #f3f3f3; }
			#offerId{ margin-top: 50px; padding: 3%; }
			.offerWrap2 .offerTop{ background: url(../../img/market/youhuimianfei.png) 0 0 no-repeat; background-size: 100% 100%; }
			.offerWrap3 .offerTop{ background: url(../../img/market/youhuishixiao.png) 0 0 no-repeat; background-size: 100% 100%; }
			.offerTop{ background: url(../../img/market/youhuihong.png) 0 0 no-repeat; background-size: 100% 100%; }
			.offerTop h4{ padding: 1.5% 0 1.5% 10%; }
			.b1{ color: #fff; font-size: 15px; font-weight: 500; }
			.b2{ font-weight: 500; color: #fff; font-size: 30px; margin-right: 0.5%; }
			.span1{ color: #fedddd; font-size: 13px; }
			.offerWrap2 .span1, .offerWrap2 .span2, .offerWrap2 .offerTop p{ color: #dddffe; }
			.offerWrap3 .span1, .offerWrap3 .span2, .offerWrap3 .offerTop p{ color: #fff; }
			.offerWrap2 .span3{ color: #5195f8; }
			.offerWrap3 .span3{ color: #999; }
			.span2{  color: #fedddd;  font-size: 12px; float: right; margin-top: 16px; margin-right: 2%; }
			.offerTop p{ color: #fedddd; padding: 2.5%; padding-top: 2%; padding-bottom: 4%; font-size: 12px; width: 100%; }
			.span3{ background-color: #fff; color: #fd6363;  border-radius: 3px; float: right; padding: 1.4%;  margin-top: -2.5%; font-size: 14px;display: inline-block;
	      		white-space: nowrap; padding-right: calc(100vw * 0.025); }
			.offerFoot{ overflow: hidden; }
			.offerFoot img{  width: 22.5%; margin-right: 2%; float: left; padding: 2.5% 0; }
			.offerFoot img:first-child{ margin-left: 2%; }
			.offerWrap{ background-color: #fff; border-radius: 4px; margin-top: 18PX; }
			#offerId .offerWrap:first-child{ margin-top: 0; }
			.mui-bar-nav{box-shadow: none !important;}
			.notice .tab-hd {
			    height: 0.4rem;
			    background-color: #fff;
			     border-bottom: none; 
			}
			.notice .tab-hd li {
			    height: 0.4rem;
			    line-height: 0.4rem;
			}
			.coupons{padding-top: 0;}
			.answerImf{margin: 1px;width:calc((100vw - 50px) / 4);height:calc((100vw - 50px) / 4);border-radius:3px;display: inline-block;overflow: hidden;}
			.anImg{width: 100%!important;opacity: 0;}
		</style>
	</head>
	<body>
	 	<header class="mui-bar mui-bar-nav fineB">
	    	<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
	    	<h1 class="mui-title">优惠券</h1>  
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div class="notice" style="margin:50px auto;">
			<div class="tab-hd">
				<ul class="tab-nav">
				  <li>全部</li>
				  <li>可用</li>
				</ul>
			</div>
			<div class="tab-bd">
				<div class="tab-pal">
					<div class="coupons clearfloat box-s" id="allC"></div>
				</div>
				
				<div class="tab-pal">
					<div class="coupons clearfloat box-s" id="ableC"></div>
				</div>	
				
				<div class="tab-pal">
					<div class="coupons clearfloat box-s" id="disableC">
						<div class="nothing">
							<img src="../../img/theList/coupon.png"/>
							<p>你没有已使用的优惠券哟！</p>
						</div>
					</div>
				</div>
				<!--全部--> 
				<script type="text/html" id="allC-detail">
					<% for(var i=0;i<allLi.length;i++){ %> 
						<%if(allLi[i].id){%>
							<% if(allLi[i].user_coupon_state == 1){ %> <!--可用状态--> 
								<%if(allLi[i].typeid == 5){%>
								<div onclick="Cdetail(<%= allLi[i].id %>)" class="offerWrap">
								<%}else{%>
									<div class="offerWrap">
								<%}%>
								 	<%if(allLi[i].typeid == 5){%>
										<div style="padding:5px!important;">团购优惠券</div>
									<%}else{%>
										<div style="padding:5px!important;">电商优惠券</div>
									<%}%>
									<div class="offerTop">
										<h4><b class="b2"></b><span class="span1"><%= allLi[i].title %></span> <span class="span2"><%= allLi[i].begin_date %> ~ <%= allLi[i].end_date %></span></h4>
										<p><%= allLi[i].name %><span style="visibility: hidden;">wu</span>
											<%if(allLi[i].typeid == 5){%>
												<span class="span3">立即使用</span>
											<%}else{%>
											<%}%>
										</p>
									</div>
									<div class="offerFoot">
										<%if(allLi[i].pic){%>
											<img class="anImg loadPics picOp" onload="imgHeight(this)" src="<%=allLi[i].pic%>" alt="" />
										<%}%>
									</div>
								</div>
							<% }else{ %><!--不可用状态-->
								<div class="offerWrap offerWrap3"> 	
									<div class="offerTop">
											<h4> <b class="b2"></b><span class="span1"><%= allLi[i].title %></span> <span class="span2"><%= allLi[i].begin_date %> ~ <%= allLi[i].end_date %></span></h4>
											<p><%= allLi[i].name %> <span style="visibility: hidden;">wu</span> <span class="span3">已失效</span></p>
										</div>
									<div class="offerFoot">
										<%if(allLi[i].pic){%>
											<img class="anImg loadPics picOp" onload="imgHeight(this)" src="<%=allLi[i].pic%>" alt="" />
										<%}%>
									</div>
								</div>
							<% } %>
						<%}%>
						 
					<% } %>
				</script>
				<!--可用-->
				<script type="text/html" id="ableC-detail">
					<% for(var i=0;i<allLi.length;i++){ %> 
						<% if(allLi[i].id && allLi[i].user_coupon_state == 1){ %>
 							<%if(allLi[i].typeid == 5){%>
								<div onclick="Cdetail(<%= allLi[i].id %>)" class="offerWrap">
								<%}else{%>
									<div class="offerWrap">
								<%}%>
								 	<%if(allLi[i].typeid == 5){%>
										<div style="padding:5px!important;">团购优惠券</div>
									<%}else{%>
										<div style="padding:5px!important;">电商优惠券</div>
									<%}%>	
								<div class="offerTop"> 
										<h4><b class="b2"></b><span class="span1"><%= allLi[i].title %></span> <span class="span2"><%= allLi[i].begin_date %> ~ <%= allLi[i].end_date %></span></h4>
										<p><%= allLi[i].name %> <span style="visibility: hidden;">wu</span>
											<%if(allLi[i].typeid == 5){%>
												<span class="span3">立即使用</span>
											<%}else{%>
											<%}%>
										</p>
									</div>
								<div class="offerFoot">
									<%if(allLi[i].pic){%>
										<img class="anImg loadPics picOp" onload="imgHeight(this)" src="<%=allLi[i].pic%>" alt="" />
									<%}%>
								</div>
							</div>
						<% } %>
					<% } %>
				</script>
				
			</div>
		</div>
		
		<div id="offerId" style="display: none;">
			<div class="offerWrap">
				<div class="offerTop">
					<h4> <b class="b1">¥</b> <b class="b2">100</b><span class="span1">满199元减100元</span> <span class="span2">还剩40天到期</span></h4>
					<p>宏帆XX商家抵用卷 <span class="span3">付10元购买</span></p>
				</div>
				<div class="offerFoot">
					<img src="../../img/market/chanpingkuang.png"/>
					<img src="../../img/market/chanpingkuang.png"/>
					<img src="../../img/market/chanpingkuang.png"/>
					<img src="../../img/market/chanpingkuang.png"/>
				</div>
			</div>
			<div class="offerWrap offerWrap2">
				<div class="offerTop">
					<h4> <b class="b1">¥</b> <b class="b2">100</b><span class="span1">满199元减100元</span> <span class="span2">还剩40天到期</span></h4>
					<p>宏帆XX商家抵用卷 <span class="span3">免费领取</span></p>
				</div>
				<div class="offerFoot">
					<img src="../../img/market/chanpingkuang.png"/>
					<img src="../../img/market/chanpingkuang.png"/>
					<img src="../../img/market/chanpingkuang.png"/>
					<img src="../../img/market/chanpingkuang.png"/>
				</div>
			</div>
			<div class="offerWrap offerWrap3">
				<div class="offerTop">
					<h4><b class="b2"></b><span class="span1">满199元减100元</span> <span class="span2">还剩40天到期</span></h4>
					<p>宏帆XX商家抵用卷 <span class="span3">已失效</span></p>
				</div>
				<div class="offerFoot">
					<img src="../../img/market/chanpingkuang.png"/>
					<img src="../../img/market/chanpingkuang.png"/>
					<img src="../../img/market/chanpingkuang.png"/>
					<img src="../../img/market/chanpingkuang.png"/>
				</div>
			</div>
		</div>
		
		
		<script src="../../js/jquery.SuperSlide.2.1.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			jQuery(".notice").slide({ titCell:".tab-hd li", mainCell:".tab-bd",delayTime:0 });//tab切换
		</script>
		<script type="text/javascript">
			
			mui.plusReady(function(){
				var oldToken = plus.storage.getItem('oldToken');
				var userId = plus.storage.getItem("userid");
				var cityNum = plus.storage.getItem('cityNum');
				plus.nativeUI.showWaiting('加载中 ...',{width:'100px',height:'80px'});//显示等待框
				mui.ajax(serverUrl+'/api/useraccount/mycoupon',{  
					data:{userid: userId}, 
					dataType:'json',
					type:'post',
					timeout:10000,
					headers:{"token": oldToken,'city': cityNum},	 
					success:function(data,type,xhr){
						console.log('data',data);
						if (data.errno == 0) { 
							if(!data.data.user_coupon.length){   
									mui('.notice')[0].innerHTML='<div class="nothing" style="margin-top:40%"><img src="../../img/theList/coupon.png"/><p>你没有未使用的优惠券哟！</p></div>';
								}else{
									for(var i = 0;i < data.data.user_coupon.length;i++){
//										 
									}
									var allC = {}; 
									allC.allLi = data.data.user_coupon;
									if(allC.allLi.length > 0){
										//可用的优惠券
										for(var i=0;i<allC.allLi.length;i++){
											var nowdate = new Date;
				    						var endDate = new Date(allC.allLi[i].end_date);
											if(allC.allLi[i].end_date && endDate<nowdate){//判断时间过期
												allC.allLi[i].user_coupon_state = 0;
											}
											var html = template('allC-detail',allC);
											document.getElementById('allC').innerHTML = html;//铺全部
											if(allC.allLi[i].user_coupon_state == 1){
												console.log('可用',allC);
												var html2 = template('ableC-detail',allC);
												document.getElementById('ableC').innerHTML = html2;//铺可用
												break;
											} 
											if(i == allC.allLi.length-1){
												mui('#ableC')[0].innerHTML='<div class="nothing"><img src="../../img/theList/coupon.png"/><p>你没有未使用的优惠券哟！</p></div>';
											}
										}
									}else{
										mui('#allC')[0].innerHTML='<div class="nothing"><img src="../../img/theList/coupon.png"/><p>你没有未使用的优惠券哟！</p></div>';
										mui('#ableC')[0].innerHTML='<div class="nothing"><img src="../../img/theList/coupon.png"/><p>你没有未使用的优惠券哟！</p></div>';
										mui('#disableC-detail')[0].innerHTML='<div class="nothing"><img src="../../img/theList/coupon.png"/><p>你没有已使用的优惠券哟！</p></div>';
									}
									if(!$('.offerWrap')){
										mui('#ableC')[0].innerHTML='<div class="nothing"><img src="../../img/theList/coupon.png"/><p>你没有优惠券哟！</p></div>';
									}
								}
							
							//点击进入券的详情
							window.Cdetail = function(Cid){
								openview({ 
									view:'coupon-detail.html',
									extrasobj:{couponId:Cid}
								});
							}
						} else{
							mui('#ableC-detail')[0].innerHTML='<div class="nothing"><img src="../../img/theList/coupon.png"/><p>你没有未使用的优惠券哟！</p></div>';
						}
					plus.nativeUI.closeWaiting();//关闭等待框
					},
					error:function(xhr,type,errorThrown){
						mui('#ableC-detail')[0].innerHTML='<div class="nothing"><img src="../../img/theList/coupon.png"/><p>你没有未使用的优惠券哟！</p></div>';
						mui.toast('响应失败  !');
					}
				});
				
			})();
		</script>
	</body>
</html>
