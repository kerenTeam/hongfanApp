<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>商城订单详情</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" href="../../css/reset.css"> 
		<script type="text/javascript" src="../../js/jquery.min.js"></script> 
		<script src="../../js/mui.min.js" type="text/javascript" charset="utf-8"></script> 
	</head>
	<style type="text/css">
	.gray{
		color: gray;
		font-size: 12px!important;
	}
	.sjname{
		border: 0;
		background-color: white!important;	
	}
	dl.list {
		border: 0!important;
		border-bottom: 0!important;
	}
		dl.listtwo dd{ 
			background: #eeeeee!important;
			border-bottom: 0;
			border-top: 2px solid white;
			padding-bottom: 0.19rem;
		}
		dl.listtwo dd:first-child{
			border-top: 0;
		}
		dl.listtwo dd:last-child{
			padding-bottom: 0.1rem;
		}
		.renting-footer { 
			background-color: white; 
			border-top: 1px solid #ddd;
		}
		.renting-footer button{
			margin-top: 0.1rem;
    		margin-right: 0.15rem;
		}
		.BC{
			background-color: #ec4d1c;
			color: white;
			border: 1px solid #ec4d1c;
		}
		dl.listtwo dd>.react {
		    padding: .15rem .12rem 0rem .15rem;
		}
	</style>
	<body>
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
		    <h1 class="mui-title">订单详情</h1>  
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div id="container">		
			<div id="main">
				<div class="list">
					<div class="guess-like guess-liketwo">
						<div class="sjname mui-row box-s">
							<div class="mui-col-xs-1">
								<img src="../../img/market/map.png" style="width: 0.2rem;" alt="" />
							</div>
							<div class="mui-col-xs-11">
								<span class="fl">收 货 人：<span id="person"></span> </span><span id="phone"></span>
								<div class="clear"></div>
								<div class="fl">收货地址：<span id="address"></span></div>
							</div>
						</div>
										
					</div>			 
				</div>	
				<div id="orderInfo"></div>
				<script type="text/html" id="orderTpl">
					<div class="deal" data-orderId="<%=data.order_id%>">
						<div class="sjname box-s" onclick="goStore('<%=data.goods_data.Params.goodsData[0].store_id%>')">
									<img src="../../img/market/shop.png" style="width: 0.2rem;vertical-align: middle;margin-right: 4px;" alt="" /> <span style="vertical-align: middle;"><%=data.goods_data.Params.goodsData[0].stores.store_name%></span>
									 <span class="mui-icon mui-icon-arrowright" style="vertical-align: middle;"></span>
								</div>
								<dl class="list listtwo">
									 <%for(var i = 0;i<data.goods_data.Params.goodsData[0].goods_Data.length;i++){%>
									 	<dd onclick="goGoods('<%=data.goods_data.Params.goodsData[0].goods_Data[i].g_id%>')">
											<div class="react">												
												<div class="dealcard">
													<div class="dealcard-img imgbox">
														<span></span>
															<%if(data.goods_data.Params.goodsData[0].goods_Data[i].storeid == 0){%>
															<img src="<%=data.goods_data.Params.goodsData[0].goods_Data[i].thumb%>" onerror="javascript:this.src='../../img/market/nodata.svg';"/>
															<%}else{%>
																<img src="<%=myUrl%><%=data.goods_data.Params.goodsData[0].goods_Data[i].thumb%>" onerror="javascript:this.src='../../img/market/nodata.svg';"/>
															<%}%>
														
													</div>
													<div class="dealcard-block-right">
														<div class="dealcard-brand single-line"><span style="display: inline-block;width: 83%"><%=data.goods_data.Params.goodsData[0].goods_Data[i].title%></span> <span class="fr">￥<b><%=data.goods_data.Params.goodsData[0].goods_Data[i].price%></b></span></div>
														<div class="title text-block fl">
														</div>
														<div class="title text-block fr">
															x <%=data.goods_data.Params.goodsData[0].goods_Data[i].nums%>															
														</div>
														<div class="clear">
															
														</div>
														<%if(data.goods_data.Params.goodsData[0].goods_Data[i].Floating_price){%>
														<li class="gray">
															<div class="tip-title">商品属性加价<span class="fr">￥ <%=data.goods_data.Params.goodsData[0].goods_Data[i].Floating_price%></span></div>
														</li>
														<%}%>
														<div class="clear"></div>
														<%if(data.order_status==2 || data.order_status==3){%>
															<span class="mui-badge mui-badge-danger">
																七天退换
															</span>
														<%}%>
														
													</div>
													<!--<%if(data.order_status==2 || data.order_status==3){%>
														<button class="fr" style="margin-top: 0.2rem;">退款</button>
													<%}%>-->
													
													
												</div>
											</div>
										</dd> 
									 	<%}%> 
								</dl>
						
						<dl id="deal-terms" class="list">
							<dd class="dd-padding dd-paddingfour">
								<ul>
									
									<%if(data.goods_data.fee){%>
									<li class="gray">
										<div class="tip-title">运费<span class="fr">￥ <%=data.goods_data.fee%></span></div>
									</li>
									<%}else{%>
										<li class="gray">
											<div class="tip-title">运费<span class="fr">包邮</span></div>
										</li>
										<%}%>
										<%if(data.is_intergal){%>
											<li class="gray">
												<div class="tip-title">积分抵扣<span class="fr">-￥ <%=data.is_intergal%></span></div>
											</li>
										<%}%>
										<%if(data.goods_data.Params.couponData && data.goods_data.Params.couponData.coupon_amount){%>
										<li class="gray">
											<div class="tip-title">优惠券抵扣<span class="fr">-￥<%=data.goods_data.Params.couponData.coupon_amount%></span></div>
										</li>
										<%}%>
										 
										<li>
											<div class="tip-title">实付款<span class="fr" style="color:#f53c42;">￥ <%=data.goods_data.PriceCalculValue%></span></div>
										</li> 
								</ul>
							</dd>
						</dl>
						<dl id="deal-terms" class="list" style="margin-bottom:60px;">
							<dd class="dd-padding dd-paddingfour gray">
								<ul>
									<li>
										<div class="tip-title">订单编号：<%=data.order_id%></div>
									</li>
									<%if(data.order_status!=0){%> 
									<li>
										<%if(data.goods_data.Params.postData.payType == 'alipay'){%> 
										   <div class="tip-title">支付方式：支付宝</div>
										<%}%>
										<%if(data.goods_data.Params.postData.payType == 'wxpay'){%> 
										   <div class="tip-title">支付方式：微信</div>
										<%}%>
									</li>
									<!--<li>
										<div class="tip-title">交易号：<%=out_trade_no%></div>
									</li>-->
									<!--<li>
										<div class="tip-title">付款时间：2016-01-01&nbsp;16:25</div>
									</li>-->
									<%}%> 
									<li>
										<div class="tip-title">创建时间：<%=data.create_time%></div>
									</li>
									<%if(data.order_status==3 || data.order_status==4 || data.order_status==5){%>
									<!--<li>
										<div class="tip-title">发货时间：2016-01-01&nbsp;17:25</div>
									</li>-->
									<%}%>
								</ul>
							</dd>
						</dl>								
					</div>
				</script> 
			</div>
		</div> 
		<div id="button"></div>
		<script id="buttonTpl" type="text/html">
			<div class="renting-footer clearfloat" id="footer"> 
				<%if(data.order_status==1){%>
					<button class="fr BC" onclick="goOrder('<%=data.order_UUID%>','<%=data.goods_data.totalMoney%>')">付款</button>
				 	<button class="fr" onclick="delOrder(this,'<%=data.order_id%>','取消')">取消订单</button> 
				<%}%>
				
				<%if(data.order_status==2){%>
					<button class="fr BC" onclick="tuiOrder('<%=data.order_id%>','<%=data.goods_data.totalMoney%>')">申请退款</button> 
				<%}%>
				
				<%if(data.order_status==3){%>
					<button class="fr BC" onclick="orderConfirm('<%=data.order_id%>')">确认收货</button>
					<button class="fr BC" onclick="tuiOrder('<%=data.order_id%>','<%=data.goods_data.totalMoney%>')">申请退款</button>
				 	<button class="fr" onclick="viewLogistics('<%=data.order_id%>','<%=data.logistic_code%>','<%=data.shipper_code%>')">查看物流</button> 
				<%}%>
				
				<%if(data.order_status==4){%>
					<button class="fr BC" onclick="goComment('<%=data.order_id%>')">评价</button>
					<button class="fr BC" onclick="tuiOrder('<%=data.order_id%>','<%=data.goods_data.totalMoney%>')">申请退款</button>
				 	<!--<button class="fr" onclick="viewLogistics('<%=data.order_id%>','<%=data.logistic_code%>','<%=data.shipper_code%>')">查看物流</button>--> 
				<%}%>
				
				<%if(data.order_status==5){%> 
				 	<button class="fr BC" onclick="tuiOrder('<%=data.order_id%>','<%=data.goods_data.totalMoney%>')">申请退款</button>
				 	<!--<button class="fr" onclick="viewLogistics('<%=data.order_id%>','<%=data.logistic_code%>','<%=data.shipper_code%>')">查看物流</button>-->
				 	<button class="fr" onclick="delOrder(this,'<%=data.order_id%>','删除')">删除订单</button>
				<%}%>
				<%if(data.order_status==6){%>
					<span class="fr" style="margin-right: 15px;">交易金额:<%=total_fee%>  退款金额：￥<%=data.goods_data.PriceCalculValue%></span>
				<%}%> 
				<%if(data.order_status==7){%>
					<button class="fr BC" onclick="cmtwl(this,'<%=data.order_id%>')">填写退货物流</button>
					 
				<%}%> 
				<%if(data.order_status==8){%>
					<button class="fr BC">退款成功</button>
				<%}%> 
				<%if(data.order_status==10){%>
					<button class="fr BC">等待退款</button>
				<%}%>
			</div>
		</script>
	</body>
	<script src="../../js/app.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/artTemplate-native.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		mui.plusReady(function(){
			
			window.addEventListener('refresh',function(event){  
				load();
			})
			
			var myuserid = plus.storage.getItem('userid');
			var orderId = plus.webview.currentWebview().orderId;
			var oldtoken = plus.storage.getItem('oldToken');
			plus.nativeUI.showWaiting('加载中 ...',{width:'100px',height:'80px'});//显示等待框
			
			load();
			function load(){
				mui.ajax(serverUrl+'/api/mall/orderinfo',{
					data:{order_id:orderId},
					dataType:'json',
					type:'post',
					timeout:10000,
					headers:{"token":oldtoken},	 
					success:function(data,type,xhr){ 
						plus.nativeUI.closeWaiting();
//						alert(JSON.stringify(data.data)) ;
				       if(data.errno===0){
					       	 data.data[0].goods_data=eval("("+data.data[0].goods_data+")");
					       	 if(data.data[0].fee){
									
									data.data[0].goods_data.totalMoney = parseFloat(data.data[0].goods_data.totalMoney+data.data[0].fee).toFixed(2)
									
									if(data.data[0].fee>0){
										data.data[0].fee = "+￥"+data.data[0].fee;
									}else{
										data.data[0].fee = "-￥"+data.data[0].fee;
									}
									 
								}
					       	 var dt = new Date(data.data[0].create_time);
									var date = [
									  [dt.getFullYear(), dt.getMonth() + 1, dt.getDate()].join('-'),
									  [dt.getHours(), dt.getMinutes(), dt.getSeconds()].join(':')
									].join(' ').replace(/(?=\b\d\b)/g, '0'); // 正则补零
									data.data[0].create_time = date
					       	 var orderInfo = {};
//					       	 if(data.data[0].pay_no){
//					       	 	data.data[0].pay_no = eval("("+data.data[0].pay_no+")");
//					       	 	var aa = JSON.parse(data.data[0].pay_no.rawdata);
//								var out_trade_no = queryStr(aa.result).out_trade_no;
//								out_trade_no = out_trade_no.replace(/\"/g, "");
//								var total_fee =queryStr(aa.result).total_fee; 
//								total_fee = total_fee.replace(/\"/g, "");
//								orderInfo.out_trade_no = out_trade_no;
//					        	orderInfo.total_fee =parseFloat(total_fee);
//					       	 }
//					       
					        orderInfo.myUrl = serverimgUrl;
					        orderInfo.data= data.data[0];
					        console.log("orderInfo.data "+JSON.stringify(data.data[0]))
					        document.getElementById("orderInfo").innerHTML = template("orderTpl",orderInfo);
					        document.getElementById("button").innerHTML = template("buttonTpl",orderInfo);
					        getadd(data.data[0].goods_data.Params.postData.address_id)
					        
				       }
					},
					error:function(xhr,type,errorThrown){
						plus.nativeUI.closeWaiting()
						console.log('响应失败  !');
					}
				});
			}
			
			function getadd(adid){
				//请求地址
		        mui.ajax(serverUrl+'/api/useraccount/addresslist',{
					data:{userid : myuserid},
					dataType:'json',
					type:'post',
					timeout:1000,
					headers:{"token":oldtoken},	 
					success:function(data,type,xhr){
						var thisAddArray = data.data;
						for (var k = 0; k < thisAddArray.length; k++) {
							if(thisAddArray[k].id == adid){
								$('#person').html(thisAddArray[k].person);
								$('#phone').html(thisAddArray[k].phone);
								$('#address').html(thisAddArray[k].province+thisAddArray[k].city+thisAddArray[k].area+thisAddArray[k].address);
								 
							}
						}
					},
					error:function(xhr,type,errorThrown){
						console.log('响应失败  !');
					}
				});
			}
			
			window.delOrder=function(obj,id,txt){ 
				mui.confirm('确认'+txt+'订单？', '提示', ['取消', '确定'], function(e) {
					 
					plus.nativeUI.showWaiting('加载中 ...',{width:'100px',height:'80px'});//显示等待框 
						if(e.index == 1) {
							mui.ajax(serverUrl+'/api/mall/deleteorder',{
								data:{userId:myuserid,orderId:id},
								dataType:'json',
								type:'post',
								timeout:1000,
								headers:{"token":oldtoken},	 
								success:function(data,type,xhr){ 
									plus.nativeUI.closeWaiting();
							       if(data.data==1){ 
							       	
							       	var listpage = plus.webview.getWebviewById("personal/sc-order.html"); 
							       	mui.fire(listpage,'refresh');
							       	mui.toast("订单已取消");
							       	setTimeout(function(){mui.back();},1000)
							       	
							       }
							 },  
								error:function(xhr,type,errorThrown){
									plus.nativeUI.closeWaiting()
									console.log('响应失败  !');
								} 
							});
						}else{
							plus.nativeUI.closeWaiting();
						}
						
				})   
			}
			window.goStore=function(storeId){
				openview({
							view:'../market/shophome.html',
							extrasobj:{storeId:storeId}
						})
			}
			window.goGoods=function(goodsId){
				 openview({
				 	view:"../market/mall-detail.html",
				 	extrasobj:{goodsId:goodsId}
				 })
			}
			window.goOrder=function(id,payment){
				openview({
					view:"../market/pay.html",
					extrasobj:{payMent:payment,uuid:id}
				})
			} 
			window.goComment=function(orderId){
				openview({
					view:'comment.html',
					extrasobj:{orderId:orderId,pageid:'orderDetail'}
				})
			}
			window.viewLogistics=function(id,deliveryNo,shipper){
				openview({ 
							view:'../localLife/deliveryTrace.html',
							extrasobj:{deliveryNo:deliveryNo,shipper:shipper}
						})
			}
			window.orderConfirm=function(id){
				mui.confirm('确认收货？', '提示', ['取消', '确定'], function(e) {
					 
					plus.nativeUI.showWaiting('加载中 ...',{width:'100px',height:'80px'});//显示等待框 
						if(e.index == 1) { 
							mui.ajax(serverUrl+'/api/mall/completeorder',{
								data:{userId:myuserid,orderId:id},
								dataType:'json',
								type:'post',
								timeout:1000,
								headers:{"token":oldtoken},	 
								success:function(data,type,xhr){ 
									plus.nativeUI.closeWaiting();
							       if(data.data==1){  
							       	 	var listpage = plus.webview.getWebviewById("personal/sc-order.html"); 
								       	mui.fire(listpage,'refresh');
								       	mui.toast("已确认收货");
								       	setTimeout(function(){mui.back();},1000)
							       }
							 },  
								error:function(xhr,type,errorThrown){
									plus.nativeUI.closeWaiting()
									console.log('响应失败  !');
								} 
							});
						}else{
							plus.nativeUI.closeWaiting();
						}
						
				})
			}
			window.tuiOrder=function(id,price){ 
				openview({
					view:'../market/ruturnList.html', 
					extrasobj:{orderId:id,price:price} 
				})
			}
			//填写退货物流
			window.cmtwl = function(id){
				openview({
					view:'comitdelivery.html', 
					extrasobj:{orderId:id,page:"orderDetail"} 
				})
			}
		})
		function queryStr(str) {
		    var r = str.slice(1).split("&"),
		        e = {};
		    return r.forEach(function(r) {
		        var t;
		        r && (t = r.split("="), 2 === t.length && (e[t[0]] = t[1]))
		    }), e
		}
	</script>
	
</html>
