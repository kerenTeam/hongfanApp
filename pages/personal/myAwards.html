<!doctype html>
<html>

<head>
	<meta charset="UTF-8">
	<title>中奖纪录</title>
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<link rel="stylesheet" type="text/css" href="../../css/common.css"> 
	<link href="../../css/mui.min.css" rel="stylesheet" />
	<link rel="stylesheet" type="text/css" href="../../css/config.css"/> 
</head> 
	<style type="text/css">
		.list_lh {
			height: 300px;
			overflow: hidden;
		}
		
		.list_lh ul {
			padding: 10px 10px 0 10px;
		}
		
		.list_lh ul li {
			padding: 10px;
			margin-bottom: 5px;
			border-radius: 3px;
		}
		
		.flexx {
			display: flex;
			align-items: center;
			background-color: white;
		}
		
		.avtar {
			width: 50px;
			height: 50px;
			margin-right: 10px;
			overflow: hidden;
		}
		
		.avtar img {
			border-radius: 50%;
			width: 50px;
			height: 50px;
		}
	</style>
	<body>
		<header class="mui-bar mui-bar-nav" id="header">
			<a class="goBack mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
			<h1 class="mui-title">中奖纪录</h1> 
			<!--<img src="../../img/makeFriend/userCenter.png" class="mui-pull-right circleCenter" style="width:20px;margin-top: 15px; margin-right: 6px;"/>-->
		</header>
		<div id="main">
			<div class="list_lh">
				<ul id="recordList"></ul>
			</div>
			<script type="text/html" id="recordTpl">
				<%for(var i= 0 ; i<list.length;i++){%>
					<li class="flexx">
						<div class="avtar">
							<img src="<%= list[i].avatar%>" alt="" />
						</div>
						<div style="flex-grow: 1;">
							<div class="flexx" style="justify-content: space-between;">
								<div class="ft14 maincl">
									恭喜你
								</div>
								<div class="disablecl ft12">
									<%= list[i].createTime%>
								</div>
							</div>
							<div class="ft14">
								抽得<%= list[i].title%>
							</div>
						</div>
					</li>
				<%}%>
					
			</script>
		</div>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<script src="../../js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/app.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/artTemplate-native.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			mui.init()
		</script>
	</body>
	<script type="text/javascript">
		//获取中奖纪录
		mui.plusReady(function(){
			var myuserid = plus.storage.getItem('userid');
			var oldtoken = plus.storage.getItem('oldToken');
			var cityNum = plus.storage.getItem('cityNum');
			plus.nativeUI.showWaiting();
			mui.ajax(serverUrl + '/api/index/prizehistory', {
				data:{userId:myuserid},
                type: 'post',
                timeout: 10000,
                headers: { "token": oldtoken ,'city':cityNum},
                success: function(data, type, xhr) {
                    console.log("中奖记录 ",data) 
                    if(data.errno == 0){
                    	if(data.data && data.data.length){
                    		for(var i = 0; i<data.data.length;i++){
                    			if(!data.data[i].nickname){ 
                                    data.data[i].nickname =  '匿名'
                                }else{
									if(/^(\(\d{3,4}\)|\d{3,4}-|\s)?\d{7,14}$/.test(data.data[i].nickname)){
										data.data[i].nickname = data.data[i].nickname.substring(0,3)+"****"+data.data[i].nickname.substring(7,11)
									}
								}
                                
                                if(data.data[i].avatar && data.data[i].avatar!='null'){
                                    if(JSON.parse(data.data[i].avatar)[0].picImg.indexOf('http') == -1){
                                        data.data[i].avatar = serverimgUrl + JSON.parse(data.data[i].avatar)[0].picImg;
                                    }else{
                                        data.data[i].avatar = JSON.parse(data.data[i].avatar)[0].picImg
                                    }
                                }else{
                                    data.data[i].avatar = '../img/10.png'
                                }
                               		data.data[i].createTime = getDateDiff(data.data[i].createTime); 
                    		}
                    		
                    		$('#recordList').html(template('recordTpl',{list:data.data}));
                    		plus.nativeUI.closeWaiting();
                    		
                    	}else{
                    		plus.nativeUI.closeWaiting();
                    		$('#recordList').html('<div style="text-align: center;padding: 50px;">暂无记录</div>');
                    		$('#crTit').css('display','none')
                    	}
                    	
                    }      
                },
                error: function(xhr, type, errorThrown) {
                    console.log('响应失败');
                   	plus.nativeUI.closeWaiting();
                }
            });
		})
		
		//发布时间判断 
		var minute = 1000 * 60;
		var hour = minute * 60;
		var day = hour * 24;
		var halfamonth = day * 15;
		var month = day * 30;
		function getDateDiff(dateTimeStamp){ 
			var now = new Date().getTime(); 
			var diffValue = now - dateTimeStamp; 
			var monthC =diffValue/month;
			var weekC =diffValue/(7*day);
			var dayC =diffValue/day;
			var hourC =diffValue/hour;
			var minC =diffValue/minute;
			if(monthC>=1){
			 result=parseInt(monthC) + "月前";
			 }
			 else if(weekC>=1){
			 result=parseInt(weekC) + "周前";
			 }
			 else if(dayC>=1){
			 result=parseInt(dayC) +"天前";
			 }
			 else if(hourC>=1){
			 result=parseInt(hourC) +"小时前";
			 }
			 else if(minC>=1){
			 result=parseInt(minC) +"分钟前";
			 }else{ 
			 result="刚刚";
			 }
			return result;
		}
	</script>
</html>