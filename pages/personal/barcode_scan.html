<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
		<meta name="HandheldFriendly" content="true"/>
		<meta name="MobileOptimized" content="320"/>
		<title>扫描二维码</title>
		<link rel="stylesheet" href="../../css/common.css" type="text/css" charset="utf-8"/>
		<link rel="stylesheet" href="../../css/mui.min.css" type="text/css" charset="utf-8"/>
		<script type="text/javascript" src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/common.js"></script>  
		<script type="text/javascript" src="../../js/app.js"></script>  

		<script type="text/javascript">
			var ws=null,wo=null;
			var scan=null,domready=false;
			// H5 plus事件处理
			function plusReady(){
				if(ws||!window.plus||!domready){
					return;
				}
				// 获取窗口对象
				ws=plus.webview.currentWebview();
				wo=ws.opener();
				// 开始扫描
				ws.addEventListener('show',function(){
					scan=new plus.barcode.Barcode('bcid');
				    scan.onmarked=onmarked;
				    scan.start({conserve:true,filename:"_doc/barcode/"});
//				    scan.innerHTML = "<div class="goBack" onclick="back();"><a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize fl fanhui"></a></div>"
				});
			}
			if(window.plus){
				plusReady();
			}else{
				document.addEventListener("plusready",plusReady,false);
			}
			// 监听DOMContentLoaded事件
			document.addEventListener("DOMContentLoaded",function(){
				domready=true;
				plusReady();
			},false);
			// 二维码扫描成功
			function onmarked(type,result,file){
			    switch(type){
			    	case plus.barcode.QR:
			    	type = "QR";
			    	break;
			    	case plus.barcode.EAN13:
			    	type = "EAN13";
			    	break;
			    	case plus.barcode.EAN8:
			    	type = "EAN8";
			    	break;
			    	default:
			    	type = "其它"+type;
			    	break;
			    }
			    //result = result.replace(/\n/g, ''); 
			    if(result.indexOf('begin_date')>-1){ //判断数据是否可用 
			    	var dataobj = JSON.parse(result);
			    	if(dataobj.begin_date && dataobj.end_date){
			    		var nowdate = new Date;
				    	var beginDate = new Date(dataobj.begin_date); 
				    	var endDate = new Date(dataobj.end_date);
				    	console.log('核销数据',dataobj);
				    	if(dataobj.user_coupon_state == 0){//判断是否已经使用
				    		alert('该核销卷已经使用');
				    		mui.back();
				    	}else if(nowdate < beginDate){//判断时间开始
				    		alert('对不起，使用时间没到！');
				    		mui.back();
				    	}else if(nowdate > endDate){//判断时间结束
				    		alert('对不起，该卷已经过期!');
				    		mui.back();
				    	}else{
							alert(dataobj.id);	
							alert(result);	
				    		updatafun(dataobj.id,result);
				    	}
			    	}else{
			    		console.error('没有typeid，核销失败！');
			    		alert('核销失败，请重试！');
			    	}
			    }else{
			    	console.error('没有typeid，核销失败！');
			    	alert('核销失败，请重试！');
			    }
			    
			   
			    function updatafun(codeid,result){ //上传数据
				    mui.plusReady(function(){
				    	var myuserid = plus.storage.getItem('userid');
						var oldtoken = plus.storage.getItem('oldToken');
						plus.nativeUI.showWaiting('核销中 ...',{width:'100px',height:'80px'});
					    mui.ajax(serverUrl+'/api/mall/couponverify',{
							data:{"userid":myuserid,"couponid":codeid,'qrcode':result},
							type:'post',
							timeout:10000,
							headers:{"token":oldtoken},
							success:function(data,type,xhr){
								plus.nativeUI.closeWaiting();
								alert('上传核销返回'+JSON.stringify(data));
								console.log('上传核销返回'+JSON.stringify(data));
								console.log('上传核销返回'+data);
								if(data.errno == 0){
									mui.toast('核销成功');
								}else{
									mui.toast('核销失败'); 
								}
								mui.back();							
							},
							error:function(xhr,type,errorThrown){
								plus.nativeUI.closeWaiting();
								mui.toast('核销失败'); 
								mui.back();	
							}
						});
					})  
				}	
			}
		</script>
		
		<style type="text/css">
			#bcid {
				width: 100%;
				position: absolute;
				top: 0px;
				bottom: 44px;
				text-align: center;
			}
			.tip {
				color: #FFFFFF;
				font-weight: bold;
				text-shadow: 0px -1px #103E5C;
			}
			footer {
				width: 100%;
				height: 44px;
				position: absolute;
				bottom: 0px;
				line-height: 44px;
				text-align: center;
				color: #FFF;
			}
			.fbt {
				width: 50%;
				height: 100%;
				background-color: #FFCC33;
				float: left;
			}
			.fbt:active {
			  	-webkit-box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.5);
				box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.5);
			}
			
			.mui-icon {
			    line-height: 40px;
			    color: #FFF;
			    display: inline-block;
			    width: 40px;
			    text-align: center;
			    font-size: 26px;
			}
			.goBack {
			    position: absolute;
			    left: 15px;
			    top: 40px;
			    background-color: rgba(255, 255, 255, 0.25);
			    width: 40px;
			    height: 40px;
			    z-index: 9;
			    border-radius: 50%;
			}
		</style>
	</head>
	<script type="text/javascript" src="../../js/common.js"></script>  
	<!--<script type="text/javascript" src="../../js/mui.min.js"></script>-->
	<body style="background-color: #000000;">
		<div class="goBack" onclick="back();"> 
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize fl fanhui"></a>
		</div>
		<div id="bcid">
			<div style="height:40%"></div>
			<p class="tip">...载入中...</p>
		</div> 
		<!--<footer>
			<div class="fbt" onclick="back();">取　 消</div>
			<div class="fbt" onclick="scanPicture();">从相册选择二维码</div>
		</footer>-->
	</body>
</html>
