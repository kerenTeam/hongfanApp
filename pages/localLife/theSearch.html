<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>搜索</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/reset.css">
		<script src="../../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<style type="text/css">
			.mui-search:before {
				top: 58%;
			}
			
			.mui-bar {
				height: 50px;
			}
			
			.mui-title,
			.mui-action-back {
				line-height: 50px !important;
			}
			
			.mui-bar .mui-icon {
				padding: 0;
			}
			
			.mui-bar-nav.mui-bar .mui-icon,
			.mui-title,
			.mui-icon {
				color: #fff;
			}
			
			.mui-bar-nav {
				box-shadow: none;
			}
			
			.mui-icon .iconfont {
				font-size: 18px;
			}
			
			.theSearch {
				width: 100%;
				background-color: #fff;
				margin-top: 50px;
				padding-top: 1px;
			}
			
			.mui-input-row .mui-btn+input,
			.mui-input-row label+input,
			.mui-input-row:last-child {
				margin: 10px;
			}
			
			input[type=search] {
				margin-bottom: 10px;
			}
			
			.mui-icon-search,
			.mui-icon-arrowright {
				color: #ddd;
				vertical-align: middle;
			}
			
			.searchOut {
				display: none;
				position: absolute;
				top: 0px;
				width: 100%;
			}
			
			.mui-icon-back:before,
			.mui-icon-left-nav:before {
				margin-left: 10%;
			}
			
			#searchdiv {
				position: relative;
				display: inline-block;
				width: 70%;
				border-bottom: 1px solid #e4e3e3;
				height: 45px;
			}
			
			.mui-bar {
				padding: 0 1%;
			}
			
			#words {
				height: 100%;
				background: none;
				border: none;
				padding: 0;
				margin: 0;
				padding-top: 8px;
				padding-left: 7px;
				padding-right: 8px;
				color: #555;
				width: 100%;
				text-align: left;
			}
			
			#words::-webkit-input-placeholder {
				color: #999;
			}
			
			#searchdiv img {
				position: absolute;
				width: 22px;
				top: 15px;
				right: 0;
			}
			
			.historyBox {
				padding-top: 63px;
			}
			
			#searchf {
				display: inline-block;
				width: 87%;
				margin-top: 5px;
			}
			
			#searchOut {
				padding-top: 95px;
			}
			
			.historyBox li {
				padding-right: 60px;
				overflow: hidden;
				white-space: nowrap;
				text-overflow: ellipsis;
			}
			
			.historyBox li span:last-child {
				position: absolute;
				right: 10px;
			}
			.searchtype{
			    width: 15%;
			    display: inline-block;
			    border: 1px solid #e4e3e3;
			    height: 40px;
				border-radius: 3px;
			    vertical-align: bottom;
			    /*pointer-events:auto ;*/
			}
			.alltype{
				padding: 0!important;
				margin: 0!important;
				text-align: center;
				line-height: 40px!important;
				position: relative;
			}
			.otherstype{
				margin-top: -2px;
				margin-left: -1px;
				width: 125%;
				border: 1px solid #e4e3e3;
				background-color: white;
				border-radius: 3px;
			}
			.otherstype .alltype:not(:last-child){
				border-bottom: 1px solid #e4e3e3;
			}
			.curtype:after{
				content: "";
			    display: inline-block;
			    margin-left: 6px;
			    width: 8px;
			    height: 8px;
			    border: 1px solid coral;
			    border-width: 0 1px 1px 0;
			    border-top-width: 0px;
			    border-right-width: 1px;
			    border-bottom-width: 1px;
			    border-left-width: 0px;
			    -webkit-transform: rotate(45deg);
			    margin-top: 12px;
			    vertical-align: top;
			}
			.searchover{
				width: 12%;
				display: inline-block;
				text-align: center;
				height: 40px;
				line-height: 40px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<!--<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize" style="width: 12%;float: left;margin: 0;padding: 0;"></a>-->
			<!--<h1 class="mui-title">搜索</h1>-->
			<div class="searchtype">
					<div class="alltype curtype" data-id='1'>全部</div>
					<div class="otherstype" style="display: none;">
						<div class="alltype" data-id='1'>全部</div>
						<div class="alltype" data-id='2'>店铺</div>
						<div class="alltype" data-id='3'>商品</div>
					</div>
					
				</div>
			<div id="searchdiv">
				
				<form onsubmit="submitTest();return false;" id="searchf">
					<input type="search" id="words" class="" placeholder="请输入搜索内容">
				</form>

				<img src="../../img/sousuo.svg" / onclick="submitTest();">
			</div>
			 <div class="mui-action-back searchover">取消</div>
		</header> 
		<script src="../../js/statusBar.js"></script>
		<!--状态栏-->
		<div id="container">
			<section class="hotBox" style="display: none;">
				<div class="title">热门搜索</div>
				<ul class="hotKeyUl">
					<li>
						<a href="#">酒店</a>
					</li>
					<li>
						<a href="#">火锅</a>
					</li>
					<li>
						<a href="#">料理</a>
					</li>
					<li>
						<a href="#">酒店</a>
					</li>
					<li>
						<a href="#">电影</a>
					</li>
					<li>
						<a href="#">家政</a>
					</li>
					<li>
						<a href="#">洗车</a>
					</li>
					<li>
						<a href="#">美妆</a>
					</li>
				</ul>
			</section>

			<!--搜索历史-->

			<div id="record">

			</div>
			<script id="recordTpt2" type="text/html">
				<section class="historyBox" style="">
					<div class="title">搜索历史</div>
					<ul>
						<li class="clear clearStr">暂无搜索历史</li>
					</ul>
				</section>
			</script>
			<script id="recordTpt" type="text/html">
				<%if(data.length==0){%>
				<!--<div class="searchRecord">
							&nbsp;&nbsp;搜索记录:无
						</div> -->
				<%}else{%>
				<section class="historyBox" style="">
					<div class="title">搜索历史</div>
					<ul>
						<%for(var i=data.length-1;i>=0;i--){%>
						<li class="link-url searchli"><span class="mui-icon mui-icon-search"></span>
							<%=data[i]%><span class="mui-icon mui-icon-arrowright fr"></span></li>
						<%}%>
						<li class="clear clearStr">清除搜索记录</li>
					</ul>
				</section>
				<%}%>

			</script>
		</div>
		<!--搜索结果-->
		<section class="historyBox searchOut" id="searchOut" style="margin-top: -13px;font-size: 14px;color: #777;">

		</section>
		<script type="text/html" id="searchOutTpl">
			<ul>
				<!--房产-->
				<%if(searchData.local_house.length!=0){%>
				<%for(var i=0;i < searchData.local_house.length;i++){%>
				<li onclick="opendetails1('<%=searchData.local_house[i].house_id%>')" class="link-url"><span class="mui-icon mui-icon-search"></span>
					<%=searchData.local_house[i].name%><span class="mui-icon mui-icon-arrowright fr"></span></li>
				<%}%>
				<%}%>
				<!--商城-->
				<%if(searchData.goods.length!=0){%>
				<%for(var i=0;i < searchData.goods.length;i++){%>
				<li onclick="opendetails3('<%=searchData.goods[i].goods_id%>','<%=searchData.goods[i].differentiate%>')" class="link-url"><span class="mui-icon mui-icon-search"></span>
					<%=searchData.goods[i].title%><span class="mui-icon mui-icon-arrowright fr"></span></li>
				<%}%>
				<%}%>
				<!--二手市场-->
				<%if(searchData.local_used_market.length!=0){%>
				<%for(var i=0;i < searchData.local_used_market.length;i++){%>
				<li onclick="opendetails4('<%=searchData.local_used_market[i].id%>')" class="link-url"><span class="mui-icon mui-icon-search"></span>
					<%=searchData.local_used_market[i].title%><span class="mui-icon mui-icon-arrowright fr"></span></li>
				<%}%>
				<%}%>
				<!--活动-->
				<%if(searchData.system_activity.length!=0){%>
				<%for(var i=0;i < searchData.system_activity.length;i++){%>
				<li onclick="opendetails7('<%=searchData.system_activity[i].id%>','<%=searchData.system_activity[i].type%>')" class="link-url"><span class="mui-icon mui-icon-search"></span>
					<%=searchData.system_activity[i].title%><span class="mui-icon mui-icon-arrowright fr"></span></li>
				<%}%>
				<%}%>
			</ul>
		</script>
	</body>
	<script src="../../js/app.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/artTemplate-native.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		$('.curtype').click(function(){
			 if($('.otherstype').css('display') == 'none'){
//			 	$('.curtype:after').css('transform','rotate(-180deg)'); 
			 	$('.otherstype').css('display','block');
			 }else{
			 	$('.otherstype').css('display','none')
			 }
		})
		
		$('.otherstype .alltype').click(function(){
			
			$('.curtype').html($(this).html());
			$('.curtype').attr('data-id',$(this).attr('data-id'));
			$('.otherstype').css('display','none');
			$('.otherstype .alltype').each(function(){
				if($(this).attr('data-id')==$('.curtype').attr('data-id')){
					$(this).css('color','coral')
				}else{
					$(this).css('color','black')
				}
			})
		})
		
		$('.otherstype .alltype').each(function(){
			if($(this).attr('data-id')==$('.curtype').attr('data-id')){
				$(this).css('color','coral')
			}else{
				$(this).css('color','black')
			}
		})
		document.getElementById('words').onfocus= function(){
			$('.otherstype').css('display','none')
		}
		mui.plusReady(function() {
			//自动弹出输入法
			var nativeWebview, imm, InputMethodManager;
			var initNativeObjects = function() {
				if(mui.os.android) {
					var main = plus.android.runtimeMainActivity();
					var Context = plus.android.importClass("android.content.Context");
					InputMethodManager = plus.android.importClass("android.view.inputmethod.InputMethodManager");
					imm = main.getSystemService(Context.INPUT_METHOD_SERVICE);
				} else {
					nativeWebview = plus.webview.currentWebview().nativeInstanceObject();
				}
			};
			var showSoftInput = function() {
				if(mui.os.android) {
					imm.toggleSoftInput(0, InputMethodManager.SHOW_FORCED);
				} else {
					nativeWebview.plusCallMethod({
						"setKeyboardDisplayRequiresUserAction": false
					});
				}
				//此处可写具体逻辑设置获取焦点的input
				setTimeout(function() {
					var inputElem = document.getElementById('words');
					inputElem.focus();
				}, 0);
			};
			initNativeObjects();
			showSoftInput();

			//缓存记录
			var searchStorage = JSON.parse(plus.storage.getItem("$searchStorage") || '[]');
			//搜索方法
			window.submitTest = function() {
				if($("input").val() != '') {
					var words = $("input").val();
					if(searchStorage.length != 0) {
						var flag = false;
						for(var i = 0; i < searchStorage.length; i++) {
							if(searchStorage[i] == words) {
								searchStorage[i] = words;
								flag = false;
								break;
							} else {
								flag = true;
							}
						}
						if(flag) {
							searchStorage.push(words);
						}
					} else {
						searchStorage.push(words);

					}
					plus.storage.setItem('$searchStorage', JSON.stringify(searchStorage));
					$("#container").css("display", "none");
					$(".searchOut").css("display", "block");
					//执行搜索
					doSearch(words);
				} else {
					mui.toast("请输入搜索内容！");
					$("#container").css("display", "block");
					$(".searchOut").css("display", "none");
				}
			}

			function doSearch(words) {
				plus.nativeUI.showWaiting()
				var oldtoken = plus.storage.getItem('oldToken');
				mui.ajax(serverUrl + '/api/index/search', {
					data: {
						search: words
					},
					dataType: 'json',
					type: 'post',
					timeout: 10000,
					headers: {
						"token": oldtoken
					},
					success: function(data, type, xhr) {
						plus.nativeUI.closeWaiting();

						if(data.errno == 0) {
							if(data.data.local_house.length != 0 || data.data.local_used_market.length != 0 || data.data.goods.length != 0 || data.data.system_activity.length != 0) {
								var searchObj = {};
								searchObj.searchData = data.data;
								document.getElementById("searchOut").innerHTML = template("searchOutTpl", searchObj);
							} else {
								document.getElementById("searchOut").innerHTML = "<div style='text-align: center;padding-top: 60%;'>换其它的试试呢</div>"
							}
						}
					},
					error: function(xhr, type, errorThrown) {
						plus.nativeUI.closeWaiting()
						console.log('响应失败  !');
					}
				});
			}
			//缓存记录 渲染
			var recordObj = {};
			recordObj.data = searchStorage;
			if(searchStorage.length) {
				var htmlrecord = template('recordTpt', recordObj);
			} else {
				var htmlrecord = template('recordTpt2', recordObj);
			}
			document.getElementById('record').innerHTML = htmlrecord;
			//清除记录
			mui('.clearStr')[0].addEventListener('tap', function() {
				plus.storage.removeItem("$searchStorage");
				$('.link-url').css("display", "none");
				mui(".clearStr")[0].innerHTML = "暂无搜索历史";
			})
			//搜索某一条 缓存 
			$('.searchli').click(function(e) {
				e.preventDefault();
				$("#container").css("display", "none");
				$(".searchOut").css("display", "block");
				$("input").val($(this).text());
				doSearch($.trim($(this).text()))
			})
		})

		//跳转   房产详情
		function opendetails1(id) {
			openview({
				view: 'build-detail.html',
				extrasobj: {
					name: id
				}
			})
		}
		//跳转 服务详情
		function opendetails2(id) {
			openview({
				view: 'theDetail.html',
				extrasobj: {
					name: id
				}
			})
		}
		//跳转 商品详情
		function opendetails3(id, did) {
			if(did == 1 || did == 4) {
				openview({
					view: '../market/mall-detail.html',
					extrasobj: {
						goodsId: id
					}
				})
			}
			if(did == 2) {
				openview({
					view: '../market/jifen-detail.html',
					extrasobj: {
						goodsId: id
					}
				})
			}

		}
		//跳转 跳蚤市场
		function opendetails4(id) {
			openview({
				view: 'Fleadetails.html',
				extrasobj: {
					name: id
				}
			})
		}
		//跳转 帮帮团
		function opendetails5(id) {
			openview({
				view: '../serveForPeople/around.html',
				id: 'volunActivityDetail',
				extrasobj: {
					activityId: id
				}
			})
		}
		//跳转 义工团队
		function opendetails6(id) {
			openview({
				view: '../serveForPeople/volunActivityDetail.html',
				id: 'volunActivityDetail',
				extrasobj: {
					activityId: id
				}
			})
		}
		//跳转活动
		function opendetails7(id, typeid) {
			if(typeid == 1) {
				openview({
					view: '../activity/activityDetail.html',
					extrasobj: {
						activityId: id
					}
				})
			}
			if(typeid == 2) {
				openview({
					view: '../activity/couponDetail.html',
					extrasobj: {
						storeCouponId: id
					}
				})
			}

		}
	</script>

</html>