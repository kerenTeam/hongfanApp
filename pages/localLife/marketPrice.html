<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>超市比价</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/reset.css">
		<link href="../../css/mui.picker.min.css" rel="stylesheet" />
		<link href="../../css/mui.poppicker.css" rel="stylesheet" />
		<script src="../../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script type="text/javascript" src="../../js/jquery.flexslider-min.js"></script>
		<script type="text/javascript" src="../../js/swiper.min.js"></script>
		<script src="../../js/mui.picker.min.js"></script>
		<script src="../../js/mui.poppicker.js"></script>
		<script src="../../js/app.js"></script>
		<script src="../../js/artTemplate-native.js"></script>
		
		
		<style type="text/css">
			/*banner底部导航*/
			.mui-slider-indicator .mui-indicator{
				width: 10px;
				height: 10px;
				border-radius: 8px;
				background: black;
				margin-right: 5px;
				opacity: 0.3;
				cursor: pointer;
				border: none;
				box-shadow: none;
			}
			.mui-slider-indicator .mui-active.mui-indicator{
				background-color: rgba(245,60,66,0.8);
				box-shadow: none;
				opacity: 1;
				border: none;
			}
			.mui-slider-item{
				position: relative;
				width: 100%;
				padding-top: 42%; 
				overflow: hidden;
			}
			.mui-slider-item img{
				position: absolute;
				width: 100%; 
				height:100%;
				top: 0;
			}
			.mui-slider{
				margin-top: 50px;
			}
			
			.caiPrice{
				margin: 20px 0 10px;
			}
			.caiPrice .mui-col-xs-6{
				padding: 0 5px;
				float: left;
			}
			.caiPrice .mui-col-xs-6 button{
				border-radius: 0;
				padding-right: 15px;
				background-color: #f53c42;
				color: #FFFFFF;
				font-size: 14px;
				border: none;
				overflow: hidden;
				text-overflow: ellipsis;
				line-height: 14px;
				padding-top: 12px;
			}
			.caiPrice .mui-col-xs-4 button span{
				display: block;
				margin-right: 10px;
				overflow: hidden;
				text-overflow: ellipsis;
			}
			.caiPrice .mui-col-xs-4 button:after {
			    content: '';
			    position: absolute;
			    top: 50%;
			    right: 5px;
			    width: 0;
			    height: 0;
			    border: 5px solid transparent;
			    border-top: 5px solid #FFFFFF;
			    margin-top: -2px;
			}
			.pricetable{
				border-top: 2px solid #ddd;
			}
			.pricetable ul{
				margin: 0 10px;
			}
			.pricetable ul li.th{
				font-weight: 800;
			}
			.pricetable ul li.row{
				width: 100%;
				border-bottom: none;
				font-weight: 800;
			}
			.pricetable ul li{
				width: 33.33%;
				padding: 8px;
				float: left;
				border-bottom: 1px solid #ddd;
			}
			.pricetable ul li p{
				margin: 10px;
				color: #333;
			}
			
			.mui-btn-blue, .mui-btn-primary, input[type=submit]{
				border: 1px solid #f53c42;
				background-color: #f53c42;
			}
			.ui-alert {
				text-align: center;
				padding: 20px 10px;
				font-size: 16px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left normalSize"></a>
		    <h1 class="mui-title">超市比价</h1>
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div id="main">
			<div id="scroller">
				<!--轮播图-->
				<div class="mui-slider" id="banner"></div>
				<!--banner数据渲染-->
				<script type="text/html" id="banner-detail">
					<div class="mui-slider-group mui-slider-loop">
					    <!--支持循环，需要重复图片节点-->
					    <div class="mui-slider-item mui-slider-item-duplicate">
					    	<img src="<%= url %><%= bannerList[bannerList.length-1].bannerPic %>" onerror="javascript:this.src='../img/market/nodata.svg';" />
					    </div>
						<% for(var i=0;i<bannerList.length;i++){ %> 
					    	<div class="mui-slider-item">
					    		<img src="<%= url %><%=bannerList[i].bannerPic %>" onerror="javascript:this.src='../img/market/nodata.svg';" />
					    	</div>
					     <% } %>
					    <!--支持循环，需要重复图片节点-->
					    <div class="mui-slider-item mui-slider-item-duplicate">
					    	<img src="<%= url %><%= bannerList[0].bannerPic %>" onerror="javascript:this.src='../img/market/nodata.svg';" />
					    </div>
					</div>
					<div class="mui-slider-indicator">
						<div class="mui-indicator mui-active"></div>
						<% for(var i=0;i<bannerList.length-1;i++){ %>
					    	<div class="mui-indicator"></div>
					    <% } %>
		            </div> 
				</script>
			</div>
			<!--比较选项-->
			<div class="mui-table clear caiPrice">
				<div class="mui-col-xs-6">
					<button id='showUserPicker1' class="mui-btn mui-btn-block showUserPicker" type='button'></button>
					<div id='userResult1' class="ui-alert"></div>
				</div>
				</span>
				<div class="mui-col-xs-6">
					<button id='showUserPicker2' class="mui-btn mui-btn-block showUserPicker" type='button'></button>、
					<div id='userResult2' class="ui-alert"></div>
				</div>
			</div>	
			<div class="pricetable">
			<ul>
				<li class="th">商品</li>
				<li class="th">规格</li>
				<li class="th">价格</li>
			</ul>
			<div id="caiList">
				<ul>
					<li class="row"><p>没有最新菜价！换一天试试。</p></li>
				</ul>
			</div>
		</div>
	</body>
	<script type="text/javascript">
//		mui.init();
		mui.ready(function() {
//			//获取缓存
			var oldToken = plus.storage.getItem('oldToken');
			console.log(oldToken)
			
			//banner
			mui.ajax(serverUrl+'/api/index/banner',{
				data:{banner_type:9},
				dataType:'json',
				type:'post',
				timeout:10000,
				headers:{"token":oldToken},	 
				success:function(data,type,xhr){
					alert(JSON.stringify(data))
					bannerObj={};
					if(data.data.banner){
						bannerObj.bannerList = eval("("+data.data.banner+")");
					}
					bannerObj.url = serverimgUrl;
					var html=template('banner-detail',bannerObj);
					document.getElementById('banner').innerHTML = html;
					plus.nativeUI.closeWaiting();//关闭等待框
					//轮播图,获得slider插件对象
					var gallery = mui('.mui-slider');
					gallery.slider({
					  	interval:5000//自动轮播周期，若为0则不自动播放，默认为0；
					});
				},
				error:function(xhr,type,errorThrown){
					mui.toast('响应失败  !');
				}
			}); 
			//获取超市名称
			var marketName,goodsName,dateTime;
			var userPicker1 = new mui.PopPicker();
			var userPicker2 = new mui.PopPicker();
			var userPicker3 = new mui.PopPicker();
			var data1 = [];
			var data2 = [];
			var data3 = [];
			mui.ajax(serverUrl+'/api/localservice/marhetandgoods',{
//				data:{marketName:marketName,goodsName:goodsName,dateTime:dateTime},
				dataType:'json',
				type:'post',
				timeout:1000,
				headers:{"token":oldToken},	 
				success:function(data,type,xhr){
//					alert(JSON.stringify(data.data.goods_name));
					//超市名数据
					var shuju = data.data.market_name;
					for (var i = 0;i < shuju.length;i++) {
						var obj = {};
						obj.text = shuju[i].market_name;
//						obj.text = shuju[i].foodmarket;
						data1.push(obj);
					}
					userPicker1.setData(data1);
					var showUserPickerButton1 = document.getElementById('showUserPicker1');
					showUserPickerButton1.innerHTML = data1[0].text;
					marketName = data1[0].text;
					showUserPickerButton1.addEventListener('tap', function(event) {
						userPicker1.show(function(items) {
							showUserPicker1.innerText = items[0].text;
							marketName = showUserPicker1.innerText;
						});
					})
					//商品数据
					var shuju2 = data.data.goods_name;
					for (var i = 0;i < shuju2.length;i++) {
						var obj2 = {};
						obj2.text = shuju2[i].goods_name;
						data2.push(obj2);
					}
					userPicker2.setData(data2);
					var showUserPickerButton2 = document.getElementById('showUserPicker2');
					showUserPickerButton2.innerHTML = data2[0].text;
					goodsName = data2[0].text;
					showUserPickerButton2.addEventListener('tap', function(event) {
						userPicker2.show(function(items) {
							showUserPicker2.innerText = items[0].text;
							goodsName = showUserPicker2.innerText;
						});
					})
					//时间选择
			        var date = new Date();
				    var month = date.getMonth() + 1;
				    var strDate = date.getDate();
				    if (month >= 1 && month <= 9) {
				        month = "0" + month;
				    }
				    if (strDate >= 0 && strDate <= 9) {
				        strDate = "0" + strDate;
				    }
				    var dateTime = date.getFullYear() + "-" + month + "-" + strDate;
//					alert(dateTime);
					//查询菜价
					getPrice(marketName,goodsName,dateTime);
					function getPrice(marketName,goodsName,dateTime){
						mui.ajax(serverUrl+'/api/localservice/parity',{
							data:{marketName:marketName,goodsName:goodsName,dateTime:dateTime},
							dataType:'json',
							type:'post',
							timeout:1000,
							headers:{"token":oldToken},	 
							success:function(data,type,xhr){
								alert(JSON.stringify(data));
								//超市名数据
								
								
								
							},
							error:function(xhr,type,errorThrown){
								alert('响应失败  !');
							}
						}); 
					}
				},
				error:function(xhr,type,errorThrown){
					alert('响应失败  !');
				}
			}); 
//			
//		//查询菜价
//		function caiPrice(){
//			var showUserPickerButton1 = document.getElementById('showUserPicker1').innerHTML;
//			var showUserPickerButton2 = document.getElementById('showUserPicker2').innerHTML;
//			var showUserPickerButton3 = document.getElementById('showUserPicker3').innerHTML;
//			mui.ajax('http://www.krfer.com/API/API_Common',{
//				data:{"str":showUserPickerButton1+showUserPickerButton2+showUserPickerButton3,"number":7},
//				dataType:'json',//服务器返回json格式数据
//				type:'post',//HTTP请求类型
//				timeout:10000,//超时时间设置为10秒；	              
//				success:function(data){
//					var key = data;
//					mui.ajax('http://www.krfer.com/API/API_Vegetable',{
//						data:{
//							"dis":"xc",
//							"miyao": key,
//							"number":7,
//							"vegetable":{
//								"FoodMarket":showUserPickerButton1,
//								"MarketCategorie":showUserPickerButton2,
//								"time":showUserPickerButton3
//							}
//						},
//						dataType:'json',//服务器返回json格式数据
//						type:'post',//HTTP请求类型
//						timeout:10000,//超时时间设置为10秒；	 
//						success:function(data){
////									'-3程序出错  -2验证错误  -1密钥错误 0没有数据  正确（返回菜价信息）'
//							if(data == -3){
//								plus.nativeUI.toast('程序出错');
//							}
//							else if(data == -2){
//								plus.nativeUI.toast('验证错误');
//							}
//							else if(data == -1){
//								plus.nativeUI.toast('密钥错误');
//							}
//							else if(data == 0){
//								document.getElementById('caiList').innerHTML = '<ul class="clear"><li class="row"><p>没有最新菜价！换一天试试。</p></li></ul>';
//							}
//							else{
//								var obj = eval('('+data+')');
//								var _data = {};
//								_data.list = obj;
//								var html = template('test', _data);
//								document.getElementById('caiList').innerHTML = html;
//								//alert(data)
//							}
//						},
//						error: function(xhr,type,errorThrown){
//							//异常处理；
//							plus.nativeUI.toast('请求出错');
//						}
//					})
//				},
//				error: function(xhr,type,errorThrown){
//					//异常处理；
//					plus.nativeUI.toast('请求密钥出错');
//				}
//		 	});
		})
</script>
	
</html>